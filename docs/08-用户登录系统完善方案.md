# 08-用户登录系统完善方案

## 📋 现状分析

### 已完成功能 ✅
- 微信登录（真实API集成）- `wechatLogin()`
- 管理员认证体系（JWT + 角色权限）
- 完整的用户数据模型
- 多API版本支持（v1/v2）
- 钱包和订单系统

### 关键缺失 🔴
- **微信手机号绑定** - 功能占位但未实现
- **新用户注册流程** - 缺少用户创建逻辑
- **数据库Schema同步** - 迁移脚本分散，新部署不一致

## 🎯 方案选择

### 方案A：完整微信生态集成（复杂）
**特点**：严格按微信官方标准实现
- 实现微信access_token机制
- 调用官方手机号解密API `/wxa/business/getuserphonenumber`
- 完整的token刷新和缓存
- 符合生产环境最佳实践

**复杂度**：⭐⭐⭐⭐⭐
**开发周期**：1-2周

### 方案B：简化快速实现（推荐✅）
**特点**：绕过复杂的微信API，快速可用
- 用户手动输入手机号 + 短信验证（可选）
- 直接绑定到openid
- 最小化微信依赖
- 开发测试友好

**复杂度**：⭐⭐
**开发周期**：2-3小时

## 🚀 方案B实施详情（推荐）

### 1. 🔴 微信手机号绑定 - 简化实现

#### 核心思路
让用户主动输入手机号，而不是依赖微信API解密

#### API流程设计
```
1. 微信登录 → 获得openid（已完成✅）
2. 用户输入手机号 → 发送验证码（可选，先跳过）
3. 提交手机号+验证码 → 绑定成功并创建用户
```

#### 需要修改的文件

**`src/services/v2/userService.js`**
```javascript
// 替换现有的bindPhone方法（当前抛出错误）
async bindPhone({ openid, phone, smsCode = null }) {
    // 1. 参数验证
    if (!openid || !phone) {
        throw new Error('openid和手机号是必填的');
    }

    // 2. 手机号格式验证
    const phoneRegex = /^1[3-9]\d{9}$/;
    if (!phoneRegex.test(phone)) {
        throw new Error('手机号格式不正确');
    }

    // 3. 检查手机号是否已被其他用户使用
    const existingUser = await db.get('SELECT * FROM users WHERE phone = ? AND openid != ?', [phone, openid]);
    if (existingUser) {
        throw new Error('该手机号已被其他用户使用');
    }

    // 4. 查找或创建用户
    let user = await db.get('SELECT * FROM users WHERE openid = ?', [openid]);

    if (user) {
        // 更新现有用户的手机号
        await db.run('UPDATE users SET phone = ?, updated_at = CURRENT_TIMESTAMP WHERE openid = ?', [phone, openid]);
        user = await db.get('SELECT * FROM users WHERE openid = ?', [openid]);
    } else {
        // 创建新用户
        const newUserId = await this.createUser({ phone, openid, nickname: '微信用户' });
        user = await db.get('SELECT * FROM users WHERE id = ?', [newUserId]);
    }

    return {
        userId: user.id,
        phone: user.phone,
        membershipNumber: user.membership_number,
        message: '手机号绑定成功'
    };
}

// 新增：创建用户方法
async createUser({ phone, openid, nickname = '微信用户' }) {
    // 生成会员号：VIP + 年月 + 4位随机数
    const membershipNumber = 'VIP' +
        new Date().getFullYear() +
        String(new Date().getMonth() + 1).padStart(2, '0') +
        String(Math.floor(Math.random() * 10000)).padStart(4, '0');

    // 插入用户记录
    const result = await db.run(`
        INSERT INTO users (
            name, phone, openid, nickname,
            member_level, balance, points, discount_rate,
            membership_number, total_visits, total_spent,
            created_at, updated_at
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
    `, [
        nickname, phone, openid, nickname,
        'normal', 0, 0, 1.0,
        membershipNumber, 0, 0
    ]);

    return result.lastID;
}
```

### 2. 🟡 新用户注册流程优化

#### 修改微信登录逻辑
在 `wechatLogin()` 方法中优化用户检查逻辑：

```javascript
// src/services/v2/userService.js - wechatLogin方法
async wechatLogin({ code }) {
    // ... 现有的微信API调用逻辑 ...

    // 检查用户是否已存在（基于openid）
    const existingUser = await db.get('SELECT * FROM users WHERE openid = ?', [openid]);

    return {
        needBindPhone: !existingUser || !existingUser.phone,
        openid,
        sessionKey: session_key,
        unionid: unionid || null,
        userInfo: existingUser ? {
            id: existingUser.id,
            phone: existingUser.phone,
            username: existingUser.username || existingUser.name,
            nickname: existingUser.nickname,
            avatar: existingUser.avatar,
            membershipNumber: existingUser.membership_number
        } : null,
        // 新增：明确指示用户状态
        userStatus: existingUser ?
            (existingUser.phone ? 'complete' : 'need_bind_phone') :
            'need_register'
    };
}
```

### 3. 🟡 数据库Schema同步

#### 创建统一同步脚本
**新建文件：`scripts/sync-database.js`**

```javascript
const { getInstance } = require('../src/database/db');
const fs = require('fs');
const path = require('path');

async function syncDatabase() {
    const db = getInstance();
    console.log('🔄 开始数据库同步...');

    try {
        // 1. 检查users表是否有openid字段
        const columns = await db.all("PRAGMA table_info(users)");
        const hasOpenid = columns.some(col => col.name === 'openid');

        if (!hasOpenid) {
            console.log('📝 添加微信相关字段...');
            await db.run('ALTER TABLE users ADD COLUMN openid VARCHAR(100)');
            await db.run('ALTER TABLE users ADD COLUMN avatar VARCHAR(500)');
            await db.run('ALTER TABLE users ADD COLUMN nickname VARCHAR(100)');
            await db.run('ALTER TABLE users ADD COLUMN session_key VARCHAR(255)');
            await db.run('CREATE UNIQUE INDEX IF NOT EXISTS idx_users_openid_unique ON users(openid) WHERE openid IS NOT NULL');
        }

        // 2. 检查并创建钱包交易表
        const tables = await db.all("SELECT name FROM sqlite_master WHERE type='table'");
        const hasWalletTransactions = tables.some(table => table.name === 'wallet_transactions');

        if (!hasWalletTransactions) {
            console.log('📝 创建钱包交易表...');
            const walletSql = fs.readFileSync(path.join(__dirname, '../migrations/create_user_api_tables.sql'), 'utf8');
            await db.exec(walletSql);
        }

        console.log('✅ 数据库同步完成');

        // 3. 验证同步结果
        const newColumns = await db.all("PRAGMA table_info(users)");
        console.log('📊 users表字段:', newColumns.map(col => col.name).join(', '));

    } catch (error) {
        console.error('❌ 数据库同步失败:', error);
        throw error;
    }
}

// 如果直接运行此脚本
if (require.main === module) {
    syncDatabase()
        .then(() => {
            console.log('🎉 同步完成，可以启动服务了');
            process.exit(0);
        })
        .catch(error => {
            console.error('💥 同步失败:', error);
            process.exit(1);
        });
}

module.exports = { syncDatabase };
```

#### 更新schema-latest.sql
将 `migrations/create_user_api_tables.sql` 的内容合并到主schema文件中：

```sql
-- 在users表定义中添加微信字段
CREATE TABLE IF NOT EXISTS users (
    -- ... 现有字段 ...

    -- 微信集成字段
    openid VARCHAR(100),
    avatar VARCHAR(500),
    nickname VARCHAR(100),
    session_key VARCHAR(255),

    -- ... 其他字段 ...
);

-- 添加唯一索引
CREATE UNIQUE INDEX IF NOT EXISTS idx_users_openid_unique ON users(openid) WHERE openid IS NOT NULL;
```

### 4. 📱 API接口优化

#### 可能需要新增的路由
**`src/routes/v2/users.js`** - 检查是否需要新的endpoint：

```javascript
// 可选：专门的手机号验证接口
router.post('/verify-phone', async (req, res, next) => {
    try {
        const { phone } = req.body;

        // 检查手机号是否可用
        const exists = await userServiceV2.checkPhoneExists(phone);

        res.json({
            code: 0,
            message: 'success',
            data: {
                available: !exists,
                message: exists ? '手机号已被使用' : '手机号可用'
            }
        });
    } catch (error) {
        next(error);
    }
});
```

## 📋 实施清单

### 需要修改的文件
1. **`src/services/v2/userService.js`** ⭐⭐⭐ - 核心业务逻辑修改
2. **`schema-latest.sql`** ⭐⭐ - 添加微信字段定义
3. **`scripts/sync-database.js`** ⭐⭐ - 新建同步脚本
4. **`package.json`** ⭐ - 添加同步命令
5. **`.env.example`** ⭐ - 更新环境变量说明（可选）

### 实施顺序（推荐）
1. **创建数据库同步脚本** (30分钟)
2. **修改userService核心逻辑** (1-1.5小时)
3. **更新schema文件** (15分钟)
4. **测试完整流程** (30分钟)

### 测试验证
```bash
# 1. 运行数据库同步
npm run db:sync

# 2. 启动服务
npm run dev

# 3. 测试微信登录
curl -X POST http://localhost:3001/api/v2/users/wechat-login \
  -H "Content-Type: application/json" \
  -d '{"code": "test_code"}'

# 4. 测试手机号绑定
curl -X POST http://localhost:3001/api/v2/users/bind-phone \
  -H "Content-Type: application/json" \
  -d '{"openid": "test_openid", "phone": "13800138000"}'
```

## 🎯 预期成果

完成后的用户登录流程：
1. **微信小程序授权** → 获取openid ✅
2. **检查用户状态** → 返回是否需要绑定手机号 ✅
3. **手机号绑定** → 创建用户账户 ✅
4. **完整用户体验** → 可以正常预约和使用系统 ✅

### 关键优势
- ✅ **快速实现** - 2-3小时即可完成
- ✅ **测试友好** - 不依赖复杂的微信API
- ✅ **向后兼容** - 后续可升级到完整微信手机号解密方案
- ✅ **风险可控** - 修改范围明确，不影响现有功能

### 后续优化方向
1. **短信验证** - 增加手机号验证码校验
2. **微信手机号解密** - 升级到官方API方案
3. **用户资料完善** - 支持更多个人信息设置

---

*此方案优先保证系统快速可用，同时为未来功能扩展预留空间。*