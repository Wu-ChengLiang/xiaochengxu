# 微信小程序支付密钥配置调研报告

**调研时间**: 2025-10-19
**项目**: 名医堂数据平台3.0
**目标**: 明确开通微信小程序支付功能所需的所有密钥和配置参数

---

## 一、准入条件

### 1. 主体类型要求
支持以下主体类型：
- ✅ 个体工商户
- ✅ 企业
- ✅ 事业单位
- ✅ 政府机关
- ✅ 社会组织

### 2. 小程序类型要求
- ✅ 已认证的服务号
- ✅ 已认证的政府或媒体类公众号

---

## 二、必需的密钥和证书配置

### 📋 配置清单总览

| 配置项 | 用途 | 获取途径 | 保密级别 | 是否必需 |
|--------|------|----------|----------|----------|
| **APPID** | 小程序唯一标识 | 微信公众平台 | 一般 | ✅ 必需 |
| **AppSecret** | 小程序密钥 | 微信公众平台 | 🔒 高度保密 | ✅ 必需 |
| **商户号(MCHID)** | 商户唯一标识 | 微信支付商户平台 | 一般 | ✅ 必需 |
| **APIv3密钥** | API请求签名密钥 | 微信支付商户平台 | 🔒 高度保密 | ✅ 必需 |
| **商户API证书** | 敏感操作双向认证 | 微信支付商户平台 | 🔒 最高保密 | ✅ 必需 |
| **微信支付平台证书** | 验证微信应答签名 | API自动下载 | 一般 | ✅ 必需 |
| **证书序列号** | 标识证书版本 | 从证书文件中提取 | 一般 | ✅ 必需 |

---

## 三、详细配置说明

### 1️⃣ 小程序基础配置（已有✅）

#### WECHAT_APPID
- **说明**: 微信小程序唯一标识符
- **当前值**: `wx385b678dec9cb632`
- **获取路径**:
  1. 登录[微信公众平台](https://mp.weixin.qq.com)
  2. 开发 → 开发管理 → 开发设置 → 开发者ID
- **用途**:
  - 微信登录授权
  - 调用微信API
  - 支付订单创建

#### WECHAT_SECRET (AppSecret)
- **说明**: 小程序密钥，用于获取access_token
- **当前值**: `cdd2ce727fff7fc81c6748ee24a71e41`
- **获取路径**: 同AppID位置，点击"生成"或"重置"
- **用途**:
  - 获取access_token
  - 解密用户手机号
  - 服务器端API调用
- **⚠️ 安全提示**: 切勿泄露，不要提交到公开代码仓库

---

### 2️⃣ 微信支付商户配置（需申请❌）

#### WECHAT_MCHID (商户号)
- **说明**: 微信支付商户平台分配的商户唯一标识
- **格式**: 10位数字，如 `1234567890`
- **获取路径**:
  1. 登录[微信支付商户平台](https://pay.weixin.qq.com)
  2. 账户中心 → 商户信息 → 商户号
- **用途**:
  - 所有支付API调用必需参数
  - 标识收款商户
  - 资金结算凭证
- **当前状态**: ❌ 未配置

#### WECHAT_PAY_API_V3_KEY (APIv3密钥)
- **说明**: 用于API请求签名和应答解密的密钥（32字节）
- **格式**: 32位字符串，如 `Axyz1234567890abcdefghijklmnopqr`
- **获取/设置路径**:
  1. 登录[微信支付商户平台](https://pay.weixin.qq.com)
  2. 账户中心 → API安全 → APIv3密钥 → 设置密钥
  3. 首次使用需要自行生成并设置（需超级管理员权限）
- **生成建议**: 使用强随机字符串，包含大小写字母+数字
- **用途**:
  - 对API请求进行签名
  - 解密微信支付回调通知
  - 下载平台证书
- **⚠️ 安全提示**:
  - 最高保密级别
  - 定期更换（建议每3-6个月）
  - 更换后旧密钥立即失效
- **当前状态**: ❌ 未设置

---

### 3️⃣ 商户API证书（需下载❌）

#### 证书说明
微信支付APIv3使用证书进行双向认证，需要以下三个文件：

| 文件名 | 说明 | 用途 |
|--------|------|------|
| `apiclient_cert.pem` | 商户证书公钥 | 上传到微信服务器 |
| `apiclient_key.pem` | 商户证书私钥 | 本地签名使用（🔒最高保密） |
| `apiclient_cert.p12` | PKCS12格式证书 | 部分SDK需要 |

#### 获取路径
1. 登录[微信支付商户平台](https://pay.weixin.qq.com)
2. 账户中心 → API安全 → 申请API证书
3. 下载证书工具
4. 使用证书工具生成证书请求
5. 提交并下载证书文件包

#### 证书序列号 (WECHAT_MERCHANT_SERIAL_NO)
- **说明**: 商户证书的唯一标识
- **获取方式**:
  ```bash
  # 方法1: 使用openssl命令提取
  openssl x509 -in apiclient_cert.pem -noout -serial

  # 方法2: 在微信支付商户平台查看
  # 账户中心 → API安全 → API证书 → 查看证书
  ```
- **格式**: 大写十六进制字符串，如 `5157F09EFDC096DE15EBE81A47057A7232F1B8E1`
- **用途**:
  - API请求时放入HTTP头部 `Wechatpay-Serial-No`
  - 标识使用哪个证书进行签名
- **当前状态**: ❌ 未获取

#### 存储路径建议
```bash
# 推荐项目结构
/home/chengliang/workspace/mytdatabse/
├── certs/                          # 证书目录（必须加入.gitignore）
│   ├── wechat/
│   │   ├── apiclient_cert.pem     # 商户证书公钥
│   │   ├── apiclient_key.pem      # 商户证书私钥（🔒严格保密）
│   │   └── wechatpay_cert.pem     # 微信支付平台证书
│   └── README.md                   # 证书说明文档
└── .env                            # 环境变量配置
```

⚠️ **安全配置**:
```bash
# .gitignore中必须添加
certs/
*.pem
*.p12
```

#### 文件权限设置
```bash
# Linux环境下设置严格权限
chmod 600 certs/wechat/apiclient_key.pem
chmod 644 certs/wechat/apiclient_cert.pem
```

---

### 4️⃣ 微信支付平台证书（自动下载❌）

#### WECHAT_PLATFORM_SERIAL_NO (平台证书序列号)
- **说明**: 微信支付平台证书的序列号
- **用途**:
  - 验证微信支付的应答签名
  - 确保响应来自微信官方服务器
- **获取方式**:
  - 首次需通过API下载: `GET /v3/certificates`
  - 微信会将序列号放入HTTP头部 `Wechatpay-Serial`
- **更新机制**:
  - 微信支付会定期更换平台证书
  - 建议实现自动下载和更新机制
- **当前状态**: ❌ 未下载

#### 平台证书下载流程
```javascript
// 示例代码：下载平台证书
const axios = require('axios');
const crypto = require('crypto');

async function downloadPlatformCertificate() {
  // 1. 调用证书下载API
  const response = await axios.get('https://api.mch.weixin.qq.com/v3/certificates', {
    headers: {
      'Authorization': buildAuthHeader(), // 需要商户证书签名
      'User-Agent': 'Mingyi-Platform/3.0'
    }
  });

  // 2. 使用APIv3密钥解密证书
  const encryptedCert = response.data.data[0].encrypt_certificate;
  const certificate = decryptCertificate(encryptedCert, process.env.WECHAT_PAY_API_V3_KEY);

  // 3. 保存到本地
  fs.writeFileSync('certs/wechat/wechatpay_cert.pem', certificate);

  // 4. 提取序列号
  const serialNo = response.data.data[0].serial_no;
  console.log('平台证书序列号:', serialNo);

  return { certificate, serialNo };
}
```

---

### 5️⃣ 其他支付相关配置

#### WECHAT_PAY_NOTIFY_URL (支付回调URL)
- **说明**: 微信支付成功后的通知接收地址
- **格式**: `https://yourdomain.com/api/v2/payments/wechat/notify`
- **要求**:
  - ✅ 必须是HTTPS协议
  - ✅ 必须是公网可访问地址（不能是localhost或内网IP）
  - ✅ 端口仅支持443和80
- **示例值**: `https://api.mingyitang.com/api/v2/payments/wechat/notify`
- **当前状态**: ❌ 未配置

#### WECHAT_PAY_REFUND_NOTIFY_URL (退款回调URL)
- **说明**: 微信退款成功后的通知接收地址（可选）
- **格式**: `https://yourdomain.com/api/v2/payments/wechat/refund-notify`
- **当前状态**: ❌ 未配置（可选）

---

## 四、环境变量配置模板

### 完整 .env 配置
```bash
# ========================================
# 微信小程序基础配置（已有✅）
# ========================================
WECHAT_APPID=wx385b678dec9cb632
WECHAT_SECRET=cdd2ce727fff7fc81c6748ee24a71e41

# ========================================
# 微信支付商户配置（待申请❌）
# ========================================
# 商户号（10位数字）
WECHAT_MCHID=your_mchid_here

# APIv3密钥（32位字符串，自行生成并在商户平台设置）
WECHAT_PAY_API_V3_KEY=your_api_v3_key_32_characters

# 商户证书序列号（从证书文件中提取）
WECHAT_MERCHANT_SERIAL_NO=your_merchant_cert_serial_no

# 微信支付平台证书序列号（通过API下载后获取）
WECHAT_PLATFORM_SERIAL_NO=your_platform_cert_serial_no

# ========================================
# 证书文件路径配置
# ========================================
# 商户API证书路径（相对于项目根目录）
WECHAT_MERCHANT_CERT_PATH=./certs/wechat/apiclient_cert.pem
WECHAT_MERCHANT_KEY_PATH=./certs/wechat/apiclient_key.pem

# 微信支付平台证书路径
WECHAT_PLATFORM_CERT_PATH=./certs/wechat/wechatpay_cert.pem

# ========================================
# 支付回调配置
# ========================================
# 支付成功回调URL（必须HTTPS公网地址）
WECHAT_PAY_NOTIFY_URL=https://api.mingyitang.com/api/v2/payments/wechat/notify

# 退款回调URL（可选）
WECHAT_PAY_REFUND_NOTIFY_URL=https://api.mingyitang.com/api/v2/payments/wechat/refund-notify

# ========================================
# 支付配置参数
# ========================================
# 商户名称（显示在支付界面）
WECHAT_PAY_MERCHANT_NAME=名医堂养生馆

# 支付描述（默认订单描述）
WECHAT_PAY_BODY_DEFAULT=名医堂-按摩服务

# 订单超时时间（分钟，默认30分钟）
WECHAT_PAY_TIMEOUT=30

# 是否启用沙箱环境（开发测试用）
WECHAT_PAY_SANDBOX=false
```

---

## 五、申请和配置流程

### 🚀 Step 1: 申请微信支付商户号
1. 登录[微信公众平台](https://mp.weixin.qq.com)
2. 左侧菜单：微信支付 → 开通
3. 提交资质材料：
   - 营业执照
   - 法人身份证
   - 银行开户许可证
   - 门店照片（如适用)
4. 等待审核（通常1-3个工作日）
5. 审核通过后收到商户号（MCHID）

### 🔑 Step 2: 设置APIv3密钥
1. 登录[微信支付商户平台](https://pay.weixin.qq.com)
2. 账户中心 → API安全 → APIv3密钥
3. 点击"设置密钥"（需超级管理员权限）
4. 生成32位强随机字符串
   ```bash
   # Linux/Mac生成示例
   openssl rand -base64 32 | cut -c1-32

   # 或使用在线工具生成
   ```
5. 输入并确认密钥
6. 妥善保存（无法再次查看）

### 📜 Step 3: 申请并下载API证书
1. 账户中心 → API安全 → 申请API证书
2. 下载"微信支付商户平台证书工具"
3. 运行工具生成证书请求
4. 在商户平台提交证书请求
5. 下载证书文件压缩包（包含3个文件）
6. 解压并存储到项目的 `certs/wechat/` 目录

### 📥 Step 4: 下载平台证书
1. 实现证书下载接口（参考第4节示例代码）
2. 运行下载脚本获取平台证书
3. 提取证书序列号
4. 保存到环境变量和文件

### 🔗 Step 5: 绑定小程序与商户号
1. 登录[微信支付商户平台](https://pay.weixin.qq.com)
2. 产品中心 → APPID账号管理
3. 关联小程序APPID：`wx385b678dec9cb632`
4. 小程序管理员扫码确认授权

### ✅ Step 6: 配置支付授权目录（重要！）
1. 登录[微信公众平台](https://mp.weixin.qq.com)
2. 设置 → 支付设置 → 支付授权目录
3. 添加支付页面所在目录，如：
   - `https://api.mingyitang.com/`（后端API域名）
4. 最多配置5个目录

### 🧪 Step 7: 开发环境测试
1. 更新 `.env` 文件配置所有密钥
2. 确保证书文件正确放置
3. 重启服务器加载新配置
   ```bash
   pm2 restart mingyi-server
   ```
4. 使用测试接口验证配置
   ```bash
   # 测试创建支付订单
   curl -X POST http://localhost:3001/api/v2/orders/create \
     -H "Content-Type: application/json" \
     -d '{
       "orderType": "service",
       "userId": 123,
       "title": "测试订单",
       "amount": 100,
       "paymentMethod": "wechat"
     }'
   ```

---

## 六、安全建议

### 🔒 密钥管理
1. **分离环境配置**
   - 开发环境使用测试商户号
   - 生产环境使用正式商户号
   - 绝不在代码中硬编码密钥

2. **访问控制**
   - `.env` 文件权限设为 `600`（仅所有者可读写）
   - 证书私钥权限设为 `600`
   - 限制服务器SSH访问人员

3. **定期轮换**
   - APIv3密钥每3-6个月更换一次
   - API证书每年更新
   - 平台证书自动更新机制

4. **监控告警**
   - 支付异常时短信/邮件通知
   - 异常IP访问告警
   - 大额订单人工审核

### 🛡️ 代码安全
```javascript
// ❌ 错误示例：硬编码密钥
const apiKey = 'Axyz1234567890abcdefghijklmnopqr';

// ✅ 正确示例：从环境变量读取
const apiKey = process.env.WECHAT_PAY_API_V3_KEY;
if (!apiKey) {
  throw new Error('WECHAT_PAY_API_V3_KEY not configured');
}
```

### 📝 日志脱敏
```javascript
// 记录日志时脱敏处理
logger.info('支付请求', {
  orderNo: 'ORDER123',
  amount: 100,
  mchid: process.env.WECHAT_MCHID?.replace(/(\d{3})\d{4}(\d{3})/, '$1****$2')
});
```

---

## 七、现有代码改造点

### 当前状态分析
项目中 `src/services/v2/orderService.js` 中的微信支付实现为**模拟数据**：

```javascript
// 现有代码（第83-93行）- 仅返回模拟支付参数
if (paymentMethod === 'wechat') {
    result.wxPayParams = {
        prepayId: 'wx_prepay_' + Math.random().toString(36).substr(2, 16),
        timeStamp: String(Math.floor(Date.now() / 1000)),
        nonceStr: Math.random().toString(36).substr(2, 16),
        package: 'prepay_id=wx_prepay_' + Math.random().toString(36).substr(2, 16),
        signType: 'RSA',
        paySign: 'mock_pay_sign_' + Math.random().toString(36).substr(2, 32)
    };
}
```

### 需要新增的模块

#### 1. 微信支付服务模块
**文件**: `src/services/v2/wechatPayService.js`

**主要功能**:
- ✅ 统一下单（JSAPI支付）
- ✅ 查询订单状态
- ✅ 关闭订单
- ✅ 申请退款
- ✅ 查询退款状态
- ✅ 下载平台证书
- ✅ 验证回调签名

**核心方法**:
```javascript
class WechatPayService {
  // 统一下单（小程序支付）
  async createJsapiOrder(params) {
    // params: { out_trade_no, description, total, openid }
    // out_trade_no: 商户订单号
    // description: 商品描述
    // total: 订单金额(分)
    // openid: 用户openid
    // 返回: { prepay_id, timeStamp, nonceStr, package, signType, paySign }
  }

  // 验证支付回调签名
  async verifyNotifySignature(headers, body) {
    // 验证 Wechatpay-Signature
    // 返回: true/false
  }

  // 查询订单
  async queryOrder(outTradeNo) {
    // 返回: { trade_state, transaction_id, ... }
  }

  // 申请退款
  async refund(params) {
    // params: { out_trade_no, out_refund_no, refund, total, reason }
    // out_trade_no: 原订单号
    // out_refund_no: 退款单号
    // refund: 退款金额(分)
    // total: 原订单金额(分)
    // reason: 退款原因(可选)
    // 返回: { refund_id, ... }
  }
}
```

#### 2. 签名工具模块
**文件**: `src/utils/wechatPaySign.js`

**功能**:
- 生成API请求签名
- 验证微信应答签名
- 构建Authorization头部

#### 3. 证书管理模块
**文件**: `src/utils/wechatPayCert.js`

**功能**:
- 加载商户证书
- 下载平台证书
- 证书有效性检查
- 自动更新平台证书

#### 4. 支付回调接口
**文件**: `src/routes/v2/payments.js`

**端点**:
```javascript
// POST /api/v2/payments/wechat/notify
router.post('/wechat/notify', async (req, res) => {
  // 1. 验证签名
  // 2. 解密报文
  // 3. 处理业务逻辑
  // 4. 返回成功应答
});

// POST /api/v2/payments/wechat/refund-notify
router.post('/wechat/refund-notify', async (req, res) => {
  // 退款回调处理
});
```

---

## 八、开发优先级和时间估算

### 阶段1: 申请资质（外部依赖）⏱️ 3-7个工作日
- [ ] 申请微信支付商户号（1-3天审核）
- [ ] 设置APIv3密钥（10分钟）
- [ ] 申请下载API证书（1小时）
- [ ] 绑定小程序APPID（10分钟）
- [ ] 配置支付授权目录（10分钟）

### 阶段2: 基础设施搭建 ⏱️ 1个工作日
- [ ] 创建证书存储目录结构
- [ ] 更新.gitignore防止证书泄露
- [ ] 配置环境变量模板
- [ ] 编写证书管理工具

### 阶段3: 核心功能开发 ⏱️ 3个工作日
- [ ] 实现WechatPayService核心方法（1.5天）
- [ ] 实现签名和加解密工具（0.5天）
- [ ] 实现支付回调接口（0.5天）
- [ ] 改造现有订单服务对接真实API（0.5天）

### 阶段4: 测试验证 ⏱️ 2个工作日
- [ ] 单元测试（支付接口Mock测试）
- [ ] 集成测试（沙箱环境测试）
- [ ] 端到端测试（小程序真实支付测试）
- [ ] 回调接口压力测试

### 阶段5: 上线部署 ⏱️ 0.5个工作日
- [ ] 生产环境配置审核
- [ ] SSL证书检查
- [ ] 灰度发布
- [ ] 监控告警配置

**总计**: 约6-12个工作日（外部审核时间不可控）

---

## 九、参考资料

### 官方文档
- [微信支付商户平台](https://pay.weixin.qq.com)
- [微信支付API文档](https://pay.weixin.qq.com/wiki/doc/apiv3/index.shtml)
- [小程序支付接入指引](https://pay.weixin.qq.com/wiki/doc/apiv3/open/pay/chapter2_8_2.shtml)
- [API证书管理](https://kf.qq.com/faq/180830E36vyQ180830AZFZvu.html)
- [APIv3密钥设置指引](https://kf.qq.com/faq/180830E36vyQ180830AZFZvu.html)

### SDK和工具
- [微信支付Node.js SDK](https://github.com/wechatpay-apiv3/wechatpay-node-v3)
- [微信支付证书工具](https://pay.weixin.qq.com/index.php/xphp/cmkt_product/product_detail?pid=3183)
- [微信支付参数签名校验工具](https://pay.weixin.qq.com/wiki/doc/apiv3/wechatpay/wechatpay6_0.shtml)

### 社区资源
- [微信支付开发者社区](https://developers.weixin.qq.com/community/pay)
- [常见问题FAQ](https://kf.qq.com/product/wechatpaymentmerchant.html)

---

## 十、总结

### ✅ 已就绪
- 小程序APPID和Secret已配置
- 项目架构已支持订单和支付模块
- 数据库表结构完善

### ❌ 待完成（按优先级）
1. **高优先级**（必须完成才能上线）
   - 申请微信支付商户号
   - 设置APIv3密钥
   - 下载API证书
   - 实现WechatPayService
   - 实现支付回调接口

2. **中优先级**（核心功能）
   - 实现退款功能
   - 证书自动更新机制
   - 订单状态同步

3. **低优先级**（优化功能）
   - 支付数据统计
   - 异常监控告警
   - 支付日志审计

### 💡 建议
1. **先申请资质**: 商户号申请需要时间，建议立即启动申请流程
2. **使用官方SDK**: 不要自己实现签名算法，使用微信官方Node.js SDK更安全可靠
3. **测试环境先行**: 利用微信支付沙箱环境充分测试后再上线
4. **监控很重要**: 支付是核心功能,必须配置完善的监控和告警

---

**文档版本**: v1.0
**最后更新**: 2025-10-19
**维护人**: Claude Code
**联系方式**: 项目负责人
