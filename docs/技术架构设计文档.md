# 推拿预约小程序技术架构设计文档

## 一、技术架构总览

### 1.1 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        前端展示层                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  微信小程序   │  │   H5 网页    │  │  管理后台    │         │
│  │   (Taro)    │  │   (Taro)    │  │  (React)    │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                        网关层                                │
│                   Nginx + API Gateway                        │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      应用服务层                               │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │用户服务   │  │预约服务   │  │门店服务   │  │支付服务   │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │推拿师服务 │  │优惠券服务 │  │消息服务   │  │文件服务   │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                       数据层                                 │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │  MySQL   │  │  Redis   │  │ MongoDB  │  │   OSS    │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 技术选型

#### 前端技术栈
- **框架**：Taro 3.x + React Hooks
- **UI 组件库**：Taro UI / NutUI
- **状态管理**：MobX / Zustand
- **样式**：Sass + CSS Modules
- **请求库**：Taro.request 封装
- **工具库**：dayjs, lodash-es

#### 后端技术栈（当前）
- **开发语言**：Node.js (TypeScript)
- **Web 框架**：Express.js
- **数据库**：SQLite (轻量级嵌入式数据库)
- **API 文档**：Markdown 格式 (见 `api-docs/` 目录)
- **进程管理**：npm scripts / PM2

> **说明**：当前为单体应用架构，后续可按功能模块化升级为微服务

## 二、前端架构设计

### 2.1 项目目录结构（实际）

```
src/
├── app.tsx                   # 应用入口
├── app.config.ts            # 全局配置
├── app.scss                 # 全局样式
├── assets/                  # 静态资源
│   ├── images/              # 图片资源
│   └── icons/               # 图标资源
├── components/              # 可复用UI组件
│   ├── Layout/              # 布局组件
│   ├── Card/                # 卡片组件
│   ├── Loading/             # 加载组件
│   └── ...                  # 其他业务组件
├── config/                  # 配置文件
│   ├── index.ts             # 基础配置
│   ├── api.ts               # API地址配置
│   └── assets.ts            # 资源配置
├── pages/                   # 页面文件
│   ├── appointment/         # 预约相关
│   │   ├── index.tsx        # 首页/预约列表
│   │   ├── store/           # 门店选择
│   │   ├── symptom/         # 症状选择
│   │   └── therapist/       # 推拿师选择
│   ├── booking/             # 预约确认流程
│   │   ├── confirm/         # 确认页
│   │   ├── select-time/     # 时间选择
│   │   └── success/         # 成功页
│   ├── order/               # 订单管理
│   │   ├── list/            # 订单列表
│   │   └── detail/          # 订单详情
│   ├── store/               # 门店相关
│   │   ├── list/            # 门店列表
│   │   └── detail/          # 门店详情
│   ├── therapist/           # 推拿师相关
│   │   └── detail/          # 推拿师详情
│   └── mine/                # 个人中心
│       ├── index.tsx        # 我的页
│       ├── balance/         # 账户余额
│       ├── recharge/        # 充值页
│       ├── vouchers/        # 优惠券
│       └── about/           # 关于页
├── services/                # API 服务层 (见下文3.1)
│   ├── store.ts             # 门店服务
│   ├── therapist.ts         # 推拿师服务
│   ├── order.ts             # 订单服务
│   ├── payment.service.ts   # 支付服务
│   ├── wallet.service.ts    # 钱包服务
│   ├── voucher.service.ts   # 优惠券服务
│   ├── gift.service.ts      # 礼卡服务
│   ├── review.ts            # 评价服务
│   ├── symptom.ts           # 症状服务
│   ├── location.ts          # 位置服务
│   └── __tests__/           # 服务单元测试
├── styles/                  # 全局样式
├── types/                   # TypeScript 类型定义
│   └── index.ts             # 所有业务类型
├── utils/                   # 工具函数
│   ├── request.ts           # 网络请求封装
│   ├── location.ts          # 位置计算 (Haversine)
│   ├── image.ts             # 图片处理 (HTTP→HTTPS)
│   ├── format.ts            # 数据格式化
│   └── user.ts              # 用户工具函数
├── mock/                    # Mock 数据
└── __mocks__/               # 测试 Mock
```

### 2.2 核心模块设计

#### 2.2.1 位置服务模块
```javascript
// utils/location.js
export class LocationService {
  // 获取用户当前位置
  static async getCurrentLocation() {
    const { authSetting } = await Taro.getSetting()
    if (!authSetting['scope.userLocation']) {
      await Taro.authorize({ scope: 'scope.userLocation' })
    }
    return await Taro.getLocation({
      type: 'gcj02'
    })
  }
  
  // 计算两点之间距离
  static calculateDistance(lat1, lng1, lat2, lng2) {
    const rad = Math.PI / 180
    const R = 6371 // 地球半径（公里）
    const dLat = (lat2 - lat1) * rad
    const dLng = (lng2 - lng1) * rad
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * rad) * Math.cos(lat2 * rad) *
              Math.sin(dLng/2) * Math.sin(dLng/2)
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a))
    return (R * c).toFixed(1) // 返回公里数
  }
}
```

#### 2.2.2 请求封装
```javascript
// services/request.js
class Request {
  constructor() {
    this.baseUrl = process.env.NODE_ENV === 'production' 
      ? 'https://api.massage.com'
      : 'http://localhost:3000'
  }
  
  async request(options) {
    const token = Taro.getStorageSync('token')
    
    const { data } = await Taro.request({
      ...options,
      url: this.baseUrl + options.url,
      header: {
        'Content-Type': 'application/json',
        'Authorization': token ? `Bearer ${token}` : '',
        ...options.header
      }
    })
    
    if (data.code === 401) {
      // Token 过期，跳转登录
      Taro.navigateTo({ url: '/pages/login/index' })
      return Promise.reject(new Error('未授权'))
    }
    
    if (data.code !== 200) {
      Taro.showToast({
        title: data.message || '请求失败',
        icon: 'none'
      })
      return Promise.reject(data)
    }
    
    return data.data
  }
  
  get(url, params) {
    return this.request({ url, method: 'GET', data: params })
  }
  
  post(url, data) {
    return this.request({ url, method: 'POST', data })
  }
}

export default new Request()
```

### 2.3 页面组件设计

#### 2.3.1 预约首页组件
```javascript
// pages/tabbar/appointment/index.jsx
import React, { useState, useEffect } from 'react'
import { View, Swiper, SwiperItem, Image, Text, ScrollView } from '@tarojs/components'
import { observer } from 'mobx-react'
import { useStores } from '@/stores'
import StoreCard from '@/components/StoreCard'
import TherapistCard from '@/components/TherapistCard'
import './index.scss'

export default observer(function Appointment() {
  const { locationStore, storeStore } = useStores()
  const [stores, setStores] = useState([])
  const [therapists, setTherapists] = useState([])
  
  useEffect(() => {
    // 获取位置并加载门店
    loadNearbyStores()
  }, [])
  
  const loadNearbyStores = async () => {
    await locationStore.updateLocation()
    const { latitude, longitude } = locationStore.location
    const nearbyStores = await storeStore.getNearbyStores(latitude, longitude)
    setStores(nearbyStores)
    
    // 加载推荐推拿师
    if (nearbyStores.length > 0) {
      const recommendTherapists = await storeStore.getRecommendTherapists(nearbyStores[0].id)
      setTherapists(recommendTherapists)
    }
  }
  
  return (
    <View className='appointment-page'>
      {/* 优惠活动轮播 */}
      <Swiper className='banner' autoplay>
        <SwiperItem>
          <View className='banner-item'>
            <Image src='/assets/images/banner1.jpg' />
            <View className='banner-content'>
              <Text className='title'>拯救上班族</Text>
              <Text className='desc'>17:00-18:00享9.0折</Text>
            </View>
          </View>
        </SwiperItem>
      </Swiper>
      
      {/* 门店列表 */}
      <View className='section'>
        <View className='section-header'>
          <Text className='title'>门店预约</Text>
          <Text className='more' onClick={handleMoreStores}>更多门店</Text>
        </View>
        <ScrollView scrollY className='store-list'>
          {stores.map(store => (
            <StoreCard key={store.id} store={store} />
          ))}
        </ScrollView>
      </View>
      
      {/* 推拿师列表 */}
      <View className='section'>
        <View className='section-header'>
          <Text className='title'>推拿师预约</Text>
          <Text className='more' onClick={handleMoreTherapists}>更多症状</Text>
        </View>
        <ScrollView scrollY className='therapist-list'>
          {therapists.map(therapist => (
            <TherapistCard key={therapist.id} therapist={therapist} />
          ))}
        </ScrollView>
      </View>
    </View>
  )
})
```

## 三、后端架构设计

### 3.1 服务层结构（Express 单体应用）

当前后端采用 **Express.js 单体应用架构**，按功能模块划分服务：

#### 核心服务模块

| 服务模块 | 功能说明 | API文档位置 |
|---------|---------|-----------|
| **用户服务** | 注册/登录、用户信息、会员等级、积分 | `api-docs/04-用户API.md` |
| **门店服务** | 门店列表、门店详情、门店推拿师 | `api-docs/01-门店API.md` |
| **推拿师服务** | 推拿师列表、推拿师详情、排班查询 | `api-docs/02-推拿师API.md` |
| **预约服务** | 创建预约、查询预约、预约核销 | `api-docs/03-预约API.md` |
| **订单支付服务** | 订单创建、微信支付、余额支付、退款 | `api-docs/06-订单支付API.md` |
| **评价服务** | 创建评价、查询评价、评分统计 | `api-docs/07-评价API.md` |
| **微信授权服务** | 手机号绑定、授权查询 | `api-docs/08-微信手机号API.md` |

> **未来规划**：当应用复杂度增加时，可按上述服务模块拆分为微服务架构

### 3.2 API 接口规范

#### 3.2.1 通用规范
详见 `api-docs/00-通用规范.md`，包括：
- RESTful 路由规范（基于 `/api/v2/` 前缀）
- 统一的请求/响应格式
- 错误码定义
- 分页参数规范
- 数据验证规范

#### 3.2.2 API 文档导航

```
api-docs/
├── README.md                      # API文档总览
├── 00-通用规范.md                 # 通用规范（必读）
├── 01-门店API.md                  # 门店相关API
├── 02-推拿师API.md                # 推拿师相关API
├── 03-预约API.md                  # 预约相关API
├── 04-用户API.md                  # 用户相关API
├── 05-实施指南.md                 # 实现指南
├── 06-订单支付API.md              # 订单和支付API
├── 07-评价API.md                  # 评价相关API
├── 08-微信手机号API.md            # 微信授权API
└── 核销方案说明.md                # 核销流程说明
```

**如何查阅**: 根据需要实现的功能，找到对应的API文档，了解：
- 请求参数
- 响应格式
- 错误处理
- TypeScript 接口定义

#### 3.2.3 响应格式（统一）
```json
{
  "code": 0,
  "message": "success",
  "data": {
    // 业务数据
  },
  "pagination": {
    "page": 1,
    "limit": 10,
    "total": 100,
    "totalPages": 10
  }
}
```

### 3.3 数据库设计

详见 `docs/数据库设计文档.md`

---

## 四、前端服务层（Frontend Services）

前端服务层位于 `src/services/`，负责与后端 API 通信和业务逻辑处理。

### 4.1 服务模块详解

#### 4.1.1 门店服务（store.ts）
```typescript
class StoreService {
  // 获取门店列表（带距离排序）
  async getNearbyStores(latitude: number, longitude: number)

  // 获取门店详情
  async getStoreDetail(storeId: string)

  // 搜索门店
  async searchStores(keyword: string)
}
```
**API参考**: `api-docs/01-门店API.md`

#### 4.1.2 推拿师服务（therapist.ts）
```typescript
class TherapistService {
  // 获取推荐推拿师（基于位置和评分）
  async getRecommendedTherapists(
    page: number,
    pageSize: number,
    userLocation?: {latitude, longitude}
  )

  // 获取推拿师详情
  async getTherapistDetail(therapistId: string)

  // 获取推拿师排班
  async getTherapistSchedule(therapistId: string)
}
```
**API参考**: `api-docs/02-推拿师API.md`

#### 4.1.3 订单服务（order.ts）
```typescript
class OrderService {
  // 创建订单（支付/充值/礼卡）
  async createOrder(request: CreateOrderRequest)

  // 获取订单列表
  async getOrders(userId: string, page: number)

  // 获取订单详情
  async getOrderDetail(orderNo: string)

  // 查询订单状态
  async getOrderStatus(orderNo: string)
}
```
**API参考**: `api-docs/06-订单支付API.md`

#### 4.1.4 支付服务（payment.service.ts）⭐
```typescript
class PaymentService {
  // 调用微信支付
  async requestWeChatPayment(wxPayParams: WxPayParams)

  // 支付订单（微信/余额）
  async payOrder(orderNo: string, paymentMethod: 'wechat' | 'balance')

  // 查询支付状态
  async queryPaymentStatus(orderNo: string)
}
```
**重要**: 支付集成涉及敏感操作，详见 `docs/微信小程序支付密钥配置调研.md`

#### 4.1.5 钱包服务（wallet.service.ts）⭐
```typescript
class WalletService {
  // 获取余额
  async getBalance(userId: string): Promise<{balance, frozenBalance}>

  // 余额支付
  async payWithBalance(userId: string, amount: number)

  // 充值逻辑
  async recharge(userId: string, amount: number, paymentMethod: string)
}
```
**注意**: 所有金额以 **分** 为单位（100分 = 1元）

#### 4.1.6 优惠券服务（voucher.service.ts）
```typescript
class VoucherService {
  // 获取用户优惠券列表
  async getUserVouchers(userId: string)

  // 查询可用的优惠券
  async getAvailableVouchers(userId: string, appointmentPrice: number)

  // 使用优惠券
  async useVoucher(voucherId: string, appointmentId: string)
}
```

#### 4.1.7 礼卡服务（gift.service.ts）
```typescript
class GiftService {
  // 获取礼卡列表
  async getGiftCards()

  // 购买礼卡
  async purchaseGiftCard(giftCardId: string, quantity: number)

  // 查询我的礼卡
  async getMyGiftCards(userId: string)
}
```

#### 4.1.8 评价服务（review.ts）
```typescript
class ReviewService {
  // 创建评价
  async createReview(appointmentId: string, rating: number, comment: string)

  // 获取推拿师评价列表
  async getTherapistReviews(therapistId: string, page: number)

  // 获取门店评价统计
  async getStoreRatingStats(storeId: string)
}
```
**API参考**: `api-docs/07-评价API.md`

### 4.2 工具函数

#### 4.2.1 请求封装（utils/request.ts）
- 统一的 HTTP 请求处理
- 自动添加 userId 参数
- 错误处理和日志记录
- Token 管理（如需要）

#### 4.2.2 位置计算（utils/location.ts）
- **Haversine 公式** 计算两点距离
- 用于距离排序（门店、推拿师）
- 返回单位：公里（km）

```typescript
calculateDistance(lat1, lng1, lat2, lng2): number
```

#### 4.2.3 图片处理（utils/image.ts）
- **HTTP → HTTPS 自动转换**
- 微信小程序要求所有图片必须 HTTPS
- API 返回的图片 URL 自动规范化

```typescript
normalizeImageUrl(url: string): string
// 'http://example.com/img.jpg' → 'https://example.com/img.jpg'
```

### 4.3 单元测试

测试文件位于 `src/services/__tests__/`

```bash
# 运行所有测试
npm test

# 监听模式
npm test -- --watch

# 运行特定测试
npm test -- therapist.service.test
```

**测试框架**: Jest + ts-jest

---

## 五、核心流程说明

### 5.1 预约流程

```
选择门店 → 选择推拿师 → 选择时间 → 选择服务 → 确认预约
  ↓          ↓          ↓         ↓          ↓
  API: 01   API: 02    API: 03   API: 01   API: 03 + 06 (支付)
  ↓                                        ↓
  门店列表    推拿师列表   时间排班      创建订单 → 支付 → 预约成功
```

**相关服务**:
- `storeService.getNearbyStores()`
- `therapistService.getRecommendedTherapists()`
- `therapistService.getTherapistSchedule()`
- `orderService.createOrder()`
- `paymentService.payOrder()`

### 5.2 支付流程

```
创建订单 → 选择支付方式 → 发起支付 → 支付回调 → 更新订单状态
   ↓            ↓          ↓        ↓         ↓
API: 06      余额/微信   支付API   后端回调  本地更新
```

**支付方式**:
- 微信支付：`paymentService.requestWeChatPayment()`
- 余额支付：`walletService.payWithBalance()`

> **重要**: 见 `api-docs/06-订单支付API.md` 和 `docs/微信小程序支付密钥配置调研.md`

### 5.3 位置与推荐流程

```
获取用户位置 → 请求门店列表 → 计算距离 → 按距离排序 → 显示门店
    ↓            ↓          ↓        ↓         ↓
Taro API     store.ts    距离公式   前端排序   UI展示
```

**实现细节**:
1. 使用 `Taro.getLocation()` 获取用户位置
2. 调用 `storeService.getNearbyStores(lat, lng)`
3. 使用 `calculateDistance()` 计算每个门店距离
4. 按距离升序排列，显示最近的门店

---

## 六、开发指南

### 如何添加新的 API 集成？

1. **查看 API 文档**: 找到对应的 `api-docs/*.md`
2. **定义 TypeScript 类型**: 更新 `src/types/index.ts`
3. **创建服务方法**: 在 `src/services/` 中实现调用逻辑
4. **页面中使用**: 在页面组件中调用服务方法
5. **添加单元测试**: 在 `src/services/__tests__/` 中测试

### 例子：添加"获取门店评价"功能

```typescript
// 1. 定义类型 (src/types/index.ts)
export interface StoreReview {
  id: string
  rating: number
  comment: string
  createdAt: string
}

// 2. 添加服务方法 (src/services/review.ts)
async getStoreReviews(storeId: string, page: number = 1) {
  const data = await request('/stores/{storeId}/reviews', {
    data: { page, pageSize: 10 }
  })
  return data.data // 返回列表
}

// 3. 在页面中使用
import { reviewService } from '@/services'

const reviews = await reviewService.getStoreReviews(storeId)

// 4. 添加测试
// src/services/__tests__/review.service.test.ts
```