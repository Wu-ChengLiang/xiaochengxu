# ç°æœ‰æ•°æ®åº“ç°çŠ¶åŠä¼˜åŒ–

> ğŸ“Œ **è¯´æ˜**ï¼šæœ¬æ–‡æ¡£åˆ†æå½“å‰æ•°æ®åº“çš„å®é™…çŠ¶æ€ï¼Œä¸ç†æƒ³è®¾è®¡è§„èŒƒï¼ˆè¯¦è§æŠ€æœ¯æ¶æ„æ–‡æ¡£ï¼‰å¯¹æ¯”ã€‚
> åŒ…å«ä¼˜åŒ–å»ºè®®å’Œæ”¹è¿›æ–¹å‘ã€‚

## ä¸€ã€ç°æœ‰æ•°æ®åº“æ¦‚è§ˆ

### æ•°æ®åº“ä¿¡æ¯
- **æ•°æ®åº“æ–‡ä»¶**: `/home/chengliang/workspace/xiaochengxu/backend/database/mingyi.db`
- **æ•°æ®åº“ç±»å‹**: SQLite 3.x
- **è¡¨æ•°é‡**: 8ä¸ªè¡¨
- **ä¸»è¦æ¨¡å—**: ç”¨æˆ·ç®¡ç†ã€é¢„çº¦ç®¡ç†ã€é—¨åº—ç®¡ç†ã€æŠ€å¸ˆç®¡ç†ã€æœåŠ¡é¡¹ç›®ã€å¾®ä¿¡é€šçŸ¥

### è¡¨ç»“æ„æ€»è§ˆ
1. **admins** (34æ¡) - ç®¡ç†å‘˜è´¦æˆ·
2. **appointment_audit_logs** (20æ¡) - é¢„çº¦æ“ä½œæ—¥å¿—
3. **appointments** (45æ¡) - é¢„çº¦è®°å½•
4. **services** (15æ¡) - æœåŠ¡é¡¹ç›®
5. **stores** (31æ¡) - é—¨åº—ä¿¡æ¯
6. **therapists** (162æ¡) - æŠ€å¸ˆä¿¡æ¯
7. **users** (88æ¡) - ç”¨æˆ·ä¿¡æ¯
8. **wechat_notification_tasks** (9æ¡) - å¾®ä¿¡é€šçŸ¥ä»»åŠ¡

## äºŒã€ä¸»è¦å†—ä½™å­—æ®µåˆ†æ

### 1. ä¸¥é‡å†—ä½™ï¼ˆå»ºè®®ç«‹å³åˆ é™¤ï¼‰

#### therapists è¡¨
- **years_experience** - ä¸ `experience_years` å®Œå…¨é‡å¤ï¼Œä½¿ç”¨ç‡0%
- **service_types** - å®Œå…¨æœªä½¿ç”¨ï¼Œä½¿ç”¨ç‡0%

#### appointments è¡¨
- **health_notes** - å®Œå…¨æœªä½¿ç”¨ï¼Œä½¿ç”¨ç‡0%
- **therapist_notes** - å®Œå…¨æœªä½¿ç”¨ï¼Œä½¿ç”¨ç‡0%

### 2. ä¸­åº¦å†—ä½™ï¼ˆéœ€è¦è¯„ä¼°åå¤„ç†ï¼‰

#### admins è¡¨
- **store_id vs store_ids** 
  - `store_id`: å•åº—é“ºIDï¼Œä½¿ç”¨ç‡88.2%
  - `store_ids`: JSONæ ¼å¼å¤šåº—é“ºIDï¼Œä½¿ç”¨ç‡97.1%
  - **å»ºè®®**: ç»Ÿä¸€ä½¿ç”¨ `store_ids`ï¼Œæ”¯æŒå¤šåº—é“ºæƒé™ç®¡ç†

#### appointments è¡¨
- **service_id vs service_type**
  - `service_id`: å…³è”æœåŠ¡è¡¨ï¼Œä½¿ç”¨ç‡24.4%
  - `service_type`: æ–‡æœ¬æè¿°ï¼Œä½¿ç”¨ç‡62.2%
  - **å»ºè®®**: è§„èŒƒåŒ–è®¾è®¡ï¼Œç»Ÿä¸€ä½¿ç”¨ `service_id` å…³è”

### 3. ä½ä½¿ç”¨ç‡å­—æ®µï¼ˆè€ƒè™‘æ˜¯å¦ä¿ç•™ï¼‰

#### users è¡¨
- **username** - ä½¿ç”¨ç‡ä»…9.1%
- **email** - ä½¿ç”¨ç‡ä»…9.1%
- **ä¸»è¦ä½¿ç”¨ phone** - ä½¿ç”¨ç‡86.4%

## ä¸‰ã€ä¸åŸè®¾è®¡æ–‡æ¡£çš„å·®å¼‚

### 1. è¡¨ç»“æ„å·®å¼‚
åŸè®¾è®¡ä¸­çš„è¡¨åœ¨ç°æœ‰æ•°æ®åº“ä¸­çš„å¯¹åº”å…³ç³»ï¼š
- âœ… users - å­˜åœ¨ï¼Œä½†å¢åŠ äº†ä¼šå‘˜å’Œå¥åº·æ¡£æ¡ˆå­—æ®µ
- âœ… stores - å­˜åœ¨ï¼Œç»“æ„ç›¸ä¼¼
- âœ… therapists - å­˜åœ¨ï¼Œæœ‰å†—ä½™å­—æ®µ
- âœ… services - å­˜åœ¨ï¼Œå¢åŠ äº†å›¢è´­ä»·æ ¼ç­‰å­—æ®µ
- âœ… appointments - å­˜åœ¨ï¼Œå­—æ®µè¾ƒå¤šï¼Œæœ‰å†—ä½™
- âŒ user_addresses - ä¸å­˜åœ¨
- âŒ therapist_schedules - ä¸å­˜åœ¨ï¼ˆæ’ç­ä¿¡æ¯åœ¨ therapists.work_schedule å­—æ®µä¸­ï¼‰
- âŒ coupons - ä¸å­˜åœ¨
- âŒ user_coupons - ä¸å­˜åœ¨
- âŒ reviews - ä¸å­˜åœ¨ï¼ˆè¯„ä»·ä¿¡æ¯åœ¨ appointments è¡¨ä¸­ï¼‰

### 2. æ–°å¢çš„è¡¨
- âœ… admins - ç®¡ç†å‘˜ç³»ç»Ÿ
- âœ… appointment_audit_logs - å®¡è®¡æ—¥å¿—
- âœ… wechat_notification_tasks - å¾®ä¿¡é€šçŸ¥é˜Ÿåˆ—

### 3. å­—æ®µè®¾è®¡å·®å¼‚
- ç°æœ‰æ•°æ®åº“ä½¿ç”¨æ›´å¤šçš„ TEXT ç±»å‹è€Œé VARCHAR
- ç¼ºå°‘åœ°ç†ä½ç½®å­—æ®µï¼ˆlatitude, longitudeï¼‰
- ä¼šå‘˜ç³»ç»Ÿç›´æ¥é›†æˆåœ¨ users è¡¨ä¸­
- è¯„ä»·ç³»ç»Ÿé›†æˆåœ¨ appointments è¡¨ä¸­

## å››ã€ä¼˜åŒ–å»ºè®®

### 1. ç«‹å³æ‰§è¡Œçš„ä¼˜åŒ–
```sql
-- åˆ é™¤å†—ä½™å­—æ®µ
ALTER TABLE therapists DROP COLUMN years_experience;
ALTER TABLE therapists DROP COLUMN service_types;
ALTER TABLE appointments DROP COLUMN health_notes;
ALTER TABLE appointments DROP COLUMN therapist_notes;
```

### 2. æ•°æ®è¿ç§»å»ºè®®
```sql
-- ç»Ÿä¸€ä½¿ç”¨ store_ids
UPDATE admins 
SET store_ids = json_array(store_id) 
WHERE store_ids IS NULL AND store_id IS NOT NULL;

-- åç»­å¯ä»¥åˆ é™¤ store_id
-- ALTER TABLE admins DROP COLUMN store_id;
```

### 3. æ–°åŠŸèƒ½è¡¥å……å»ºè®®

#### æ·»åŠ åœ°ç†ä½ç½®æ”¯æŒ
```sql
-- ä¸ºé—¨åº—æ·»åŠ ä½ç½®ä¿¡æ¯
ALTER TABLE stores ADD COLUMN latitude REAL;
ALTER TABLE stores ADD COLUMN longitude REAL;
CREATE INDEX idx_stores_location ON stores(latitude, longitude);
```

#### æ·»åŠ æ’ç­è¡¨
```sql
CREATE TABLE therapist_schedules (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    therapist_id INTEGER NOT NULL,
    schedule_date DATE NOT NULL,
    start_time TIME NOT NULL,
    end_time TIME NOT NULL,
    break_start TIME,
    break_end TIME,
    status INTEGER DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (therapist_id) REFERENCES therapists(id),
    UNIQUE(therapist_id, schedule_date)
);
```

#### æ·»åŠ ä¼˜æƒ åˆ¸ç³»ç»Ÿ
```sql
-- ä¼˜æƒ åˆ¸å®šä¹‰è¡¨
CREATE TABLE coupons (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    type INTEGER NOT NULL, -- 1-æ»¡å‡åˆ¸ï¼Œ2-æŠ˜æ‰£åˆ¸ï¼Œ3-ä»£é‡‘åˆ¸
    value REAL NOT NULL,
    min_amount REAL DEFAULT 0.00,
    total_quantity INTEGER,
    per_user_limit INTEGER DEFAULT 1,
    valid_days INTEGER,
    valid_start DATETIME,
    valid_end DATETIME,
    status INTEGER DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- ç”¨æˆ·ä¼˜æƒ åˆ¸è¡¨
CREATE TABLE user_coupons (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    coupon_id INTEGER NOT NULL,
    coupon_code TEXT NOT NULL UNIQUE,
    status INTEGER DEFAULT 1, -- 1-æœªä½¿ç”¨ï¼Œ2-å·²ä½¿ç”¨ï¼Œ3-å·²è¿‡æœŸ
    received_at DATETIME NOT NULL,
    used_at DATETIME,
    expired_at DATETIME NOT NULL,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (coupon_id) REFERENCES coupons(id)
);
```

### 4. ç´¢å¼•ä¼˜åŒ–å»ºè®®
```sql
-- ä¼˜åŒ–é¢„çº¦æŸ¥è¯¢æ€§èƒ½
CREATE INDEX idx_appointments_user_status_date 
ON appointments(user_id, status, appointment_date);

CREATE INDEX idx_appointments_therapist_date_status 
ON appointments(therapist_id, appointment_date, status);

-- ä¼˜åŒ–æŠ€å¸ˆæŸ¥è¯¢
CREATE INDEX idx_therapists_store_status_rating 
ON therapists(store_id, status, rating);
```

## äº”ã€ä»£ç é€‚é…å»ºè®®

### 1. å®ä½“æ¨¡å‹è°ƒæ•´
åŸºäºç°æœ‰æ•°æ®åº“ï¼Œå‰ç«¯å’Œåç«¯çš„å®ä½“æ¨¡å‹éœ€è¦è°ƒæ•´ï¼š

```typescript
// ç”¨æˆ·æ¨¡å‹ï¼ˆåŒ…å«ä¼šå‘˜ä¿¡æ¯ï¼‰
interface User {
  id: number;
  name: string;
  phone?: string;
  gender: string;
  age?: number;
  // ä¼šå‘˜ç›¸å…³
  memberLevel: string;
  membershipNumber?: string;
  balance: number;
  points: number;
  discountRate: number;
  // å¥åº·æ¡£æ¡ˆ
  healthCondition?: string;
  constitutionType?: string;
  allergies?: string;
}

// é¢„çº¦æ¨¡å‹ï¼ˆåŒ…å«æ›´å¤šä¸šåŠ¡å­—æ®µï¼‰
interface Appointment {
  id: number;
  userId: number;
  therapistId: number;
  storeId: number;
  serviceType?: string; // ç°åœ¨ä¸»è¦ä½¿ç”¨è¿™ä¸ª
  appointmentDate: string;
  startTime: string;
  endTime: string;
  duration: number;
  status: string;
  price?: number;
  paymentStatus: string;
  // ä¼šå‘˜ç›¸å…³
  memberPhone?: string;
  isMemberBooking: boolean;
  memberDiscountApplied: number;
  pointsEarned: number;
  cardAmount: number;
}
```

### 2. API è°ƒæ•´å»ºè®®
- ä½¿ç”¨ `service_type` è€Œé `service_id` è¿›è¡Œé¢„çº¦
- æ”¯æŒ `store_ids` å¤šåº—é“ºæƒé™æŸ¥è¯¢
- ä¼šå‘˜åŠŸèƒ½ç›´æ¥ä½¿ç”¨ users è¡¨çš„å­—æ®µ

## å…­ã€æ€»ç»“

ç°æœ‰æ•°æ®åº“åŸºæœ¬æ»¡è¶³ä¸šåŠ¡éœ€æ±‚ï¼Œä½†å­˜åœ¨ä¸€äº›å†—ä½™å’Œä¸è§„èŒƒçš„åœ°æ–¹ã€‚å»ºè®®ï¼š

1. **çŸ­æœŸ**ï¼šæ¸…ç†æ˜æ˜¾çš„å†—ä½™å­—æ®µï¼Œä¼˜åŒ–ç´¢å¼•
2. **ä¸­æœŸ**ï¼šè¡¥å……ç¼ºå¤±çš„åŠŸèƒ½è¡¨ï¼ˆæ’ç­ã€ä¼˜æƒ åˆ¸ã€åœ°å€ç­‰ï¼‰
3. **é•¿æœŸ**ï¼šè€ƒè™‘æ•°æ®è§„èŒƒåŒ–ï¼Œç»Ÿä¸€å­—æ®µå‘½åå’Œç±»å‹

é€šè¿‡è¿™äº›ä¼˜åŒ–ï¼Œå¯ä»¥æé«˜ç³»ç»Ÿæ€§èƒ½å’Œå¯ç»´æŠ¤æ€§ï¼ŒåŒæ—¶ä¸ºæ–°åŠŸèƒ½å¼€å‘æ‰“å¥½åŸºç¡€ã€‚