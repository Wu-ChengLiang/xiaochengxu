# 现有数据库分析与优化建议

## 一、现有数据库概览

### 数据库信息
- **数据库文件**: `/home/chengliang/workspace/xiaochengxu/backend/database/mingyi.db`
- **数据库类型**: SQLite 3.x
- **表数量**: 8个表
- **主要模块**: 用户管理、预约管理、门店管理、技师管理、服务项目、微信通知

### 表结构总览
1. **admins** (34条) - 管理员账户
2. **appointment_audit_logs** (20条) - 预约操作日志
3. **appointments** (45条) - 预约记录
4. **services** (15条) - 服务项目
5. **stores** (31条) - 门店信息
6. **therapists** (162条) - 技师信息
7. **users** (88条) - 用户信息
8. **wechat_notification_tasks** (9条) - 微信通知任务

## 二、主要冗余字段分析

### 1. 严重冗余（建议立即删除）

#### therapists 表
- **years_experience** - 与 `experience_years` 完全重复，使用率0%
- **service_types** - 完全未使用，使用率0%

#### appointments 表
- **health_notes** - 完全未使用，使用率0%
- **therapist_notes** - 完全未使用，使用率0%

### 2. 中度冗余（需要评估后处理）

#### admins 表
- **store_id vs store_ids** 
  - `store_id`: 单店铺ID，使用率88.2%
  - `store_ids`: JSON格式多店铺ID，使用率97.1%
  - **建议**: 统一使用 `store_ids`，支持多店铺权限管理

#### appointments 表
- **service_id vs service_type**
  - `service_id`: 关联服务表，使用率24.4%
  - `service_type`: 文本描述，使用率62.2%
  - **建议**: 规范化设计，统一使用 `service_id` 关联

### 3. 低使用率字段（考虑是否保留）

#### users 表
- **username** - 使用率仅9.1%
- **email** - 使用率仅9.1%
- **主要使用 phone** - 使用率86.4%

## 三、与原设计文档的差异

### 1. 表结构差异
原设计中的表在现有数据库中的对应关系：
- ✅ users - 存在，但增加了会员和健康档案字段
- ✅ stores - 存在，结构相似
- ✅ therapists - 存在，有冗余字段
- ✅ services - 存在，增加了团购价格等字段
- ✅ appointments - 存在，字段较多，有冗余
- ❌ user_addresses - 不存在
- ❌ therapist_schedules - 不存在（排班信息在 therapists.work_schedule 字段中）
- ❌ coupons - 不存在
- ❌ user_coupons - 不存在
- ❌ reviews - 不存在（评价信息在 appointments 表中）

### 2. 新增的表
- ✅ admins - 管理员系统
- ✅ appointment_audit_logs - 审计日志
- ✅ wechat_notification_tasks - 微信通知队列

### 3. 字段设计差异
- 现有数据库使用更多的 TEXT 类型而非 VARCHAR
- 缺少地理位置字段（latitude, longitude）
- 会员系统直接集成在 users 表中
- 评价系统集成在 appointments 表中

## 四、优化建议

### 1. 立即执行的优化
```sql
-- 删除冗余字段
ALTER TABLE therapists DROP COLUMN years_experience;
ALTER TABLE therapists DROP COLUMN service_types;
ALTER TABLE appointments DROP COLUMN health_notes;
ALTER TABLE appointments DROP COLUMN therapist_notes;
```

### 2. 数据迁移建议
```sql
-- 统一使用 store_ids
UPDATE admins 
SET store_ids = json_array(store_id) 
WHERE store_ids IS NULL AND store_id IS NOT NULL;

-- 后续可以删除 store_id
-- ALTER TABLE admins DROP COLUMN store_id;
```

### 3. 新功能补充建议

#### 添加地理位置支持
```sql
-- 为门店添加位置信息
ALTER TABLE stores ADD COLUMN latitude REAL;
ALTER TABLE stores ADD COLUMN longitude REAL;
CREATE INDEX idx_stores_location ON stores(latitude, longitude);
```

#### 添加排班表
```sql
CREATE TABLE therapist_schedules (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    therapist_id INTEGER NOT NULL,
    schedule_date DATE NOT NULL,
    start_time TIME NOT NULL,
    end_time TIME NOT NULL,
    break_start TIME,
    break_end TIME,
    status INTEGER DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (therapist_id) REFERENCES therapists(id),
    UNIQUE(therapist_id, schedule_date)
);
```

#### 添加优惠券系统
```sql
-- 优惠券定义表
CREATE TABLE coupons (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    type INTEGER NOT NULL, -- 1-满减券，2-折扣券，3-代金券
    value REAL NOT NULL,
    min_amount REAL DEFAULT 0.00,
    total_quantity INTEGER,
    per_user_limit INTEGER DEFAULT 1,
    valid_days INTEGER,
    valid_start DATETIME,
    valid_end DATETIME,
    status INTEGER DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 用户优惠券表
CREATE TABLE user_coupons (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    coupon_id INTEGER NOT NULL,
    coupon_code TEXT NOT NULL UNIQUE,
    status INTEGER DEFAULT 1, -- 1-未使用，2-已使用，3-已过期
    received_at DATETIME NOT NULL,
    used_at DATETIME,
    expired_at DATETIME NOT NULL,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (coupon_id) REFERENCES coupons(id)
);
```

### 4. 索引优化建议
```sql
-- 优化预约查询性能
CREATE INDEX idx_appointments_user_status_date 
ON appointments(user_id, status, appointment_date);

CREATE INDEX idx_appointments_therapist_date_status 
ON appointments(therapist_id, appointment_date, status);

-- 优化技师查询
CREATE INDEX idx_therapists_store_status_rating 
ON therapists(store_id, status, rating);
```

## 五、代码适配建议

### 1. 实体模型调整
基于现有数据库，前端和后端的实体模型需要调整：

```typescript
// 用户模型（包含会员信息）
interface User {
  id: number;
  name: string;
  phone?: string;
  gender: string;
  age?: number;
  // 会员相关
  memberLevel: string;
  membershipNumber?: string;
  balance: number;
  points: number;
  discountRate: number;
  // 健康档案
  healthCondition?: string;
  constitutionType?: string;
  allergies?: string;
}

// 预约模型（包含更多业务字段）
interface Appointment {
  id: number;
  userId: number;
  therapistId: number;
  storeId: number;
  serviceType?: string; // 现在主要使用这个
  appointmentDate: string;
  startTime: string;
  endTime: string;
  duration: number;
  status: string;
  price?: number;
  paymentStatus: string;
  // 会员相关
  memberPhone?: string;
  isMemberBooking: boolean;
  memberDiscountApplied: number;
  pointsEarned: number;
  cardAmount: number;
}
```

### 2. API 调整建议
- 使用 `service_type` 而非 `service_id` 进行预约
- 支持 `store_ids` 多店铺权限查询
- 会员功能直接使用 users 表的字段

## 六、总结

现有数据库基本满足业务需求，但存在一些冗余和不规范的地方。建议：

1. **短期**：清理明显的冗余字段，优化索引
2. **中期**：补充缺失的功能表（排班、优惠券、地址等）
3. **长期**：考虑数据规范化，统一字段命名和类型

通过这些优化，可以提高系统性能和可维护性，同时为新功能开发打好基础。