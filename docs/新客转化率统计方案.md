# 员工新客转化率统计实现方案

## 一、数据基础分析

### 已有数据支持
1. **识别新客户**：
   - `users.created_at` - 客户注册时间
   - `appointments.appointment_date` - 预约时间
   - 当 `DATE(users.created_at) = DATE(appointments.appointment_date)` 时，该客户为新客

2. **识别转化（充值）**：
   - `appointments.recharge_amount` - 充值金额
   - 当 `recharge_amount > 0` 时，表示客户有充值行为

3. **员工归属**：
   - `appointments.therapist_id` - 服务员工ID
   - `therapists.name` - 员工姓名

## 二、新客转化率计算逻辑

### 核心指标定义
```
员工新客转化率 = (该员工服务的新客中有充值的客户数 / 该员工服务的新客总数) × 100%
```

### 详细指标体系
1. **基础转化率**：首次服务即充值的比例
2. **7日转化率**：首次服务后7天内充值的比例
3. **30日转化率**：首次服务后30天内充值的比例

## 三、SQL实现方案

### 1. 实时计算每个员工的新客转化率
```sql
WITH new_customer_appointments AS (
    -- 找出所有新客户的首次预约
    SELECT 
        a.id,
        a.user_id,
        a.therapist_id,
        a.appointment_date,
        a.recharge_amount,
        a.status,
        t.name as therapist_name,
        t.store_id,
        s.name as store_name
    FROM appointments a
    JOIN users u ON a.user_id = u.id
    JOIN therapists t ON a.therapist_id = t.id
    LEFT JOIN stores s ON t.store_id = s.id
    WHERE DATE(u.created_at) = DATE(a.appointment_date)  -- 新客标识
        AND a.status = 'completed'  -- 只统计完成的预约
        AND a.appointment_date BETWEEN ? AND ?  -- 时间范围
),
therapist_conversion AS (
    -- 按员工统计转化情况
    SELECT 
        therapist_id,
        therapist_name,
        store_id,
        store_name,
        COUNT(DISTINCT user_id) as new_customers,  -- 新客总数
        COUNT(DISTINCT CASE WHEN recharge_amount > 0 THEN user_id END) as converted_customers,  -- 转化客户数
        SUM(recharge_amount) as total_recharge  -- 总充值金额
    FROM new_customer_appointments
    GROUP BY therapist_id, therapist_name, store_id, store_name
)
SELECT 
    therapist_id,
    therapist_name,
    store_name,
    new_customers,
    converted_customers,
    ROUND(converted_customers * 100.0 / NULLIF(new_customers, 0), 2) as conversion_rate,
    total_recharge,
    ROUND(total_recharge / NULLIF(converted_customers, 0), 2) as avg_recharge_amount
FROM therapist_conversion
ORDER BY conversion_rate DESC;
```

### 2. 计算延迟转化率（7日/30日）
```sql
WITH new_customer_first_service AS (
    -- 获取每个新客户的首次服务信息
    SELECT 
        u.id as user_id,
        MIN(a.appointment_date) as first_service_date,
        MIN(a.therapist_id) as first_therapist_id
    FROM users u
    JOIN appointments a ON u.id = a.user_id
    WHERE DATE(u.created_at) = DATE(a.appointment_date)
        AND a.status = 'completed'
    GROUP BY u.id
),
customer_recharge_timeline AS (
    -- 获取客户的充值时间线
    SELECT 
        ncfs.user_id,
        ncfs.first_therapist_id,
        ncfs.first_service_date,
        MIN(CASE WHEN a.recharge_amount > 0 THEN a.appointment_date END) as first_recharge_date,
        SUM(a.recharge_amount) as total_recharge
    FROM new_customer_first_service ncfs
    LEFT JOIN appointments a ON ncfs.user_id = a.user_id 
        AND a.appointment_date >= ncfs.first_service_date
        AND a.status = 'completed'
    GROUP BY ncfs.user_id, ncfs.first_therapist_id, ncfs.first_service_date
)
SELECT 
    t.id as therapist_id,
    t.name as therapist_name,
    COUNT(DISTINCT crt.user_id) as total_new_customers,
    -- 即时转化（当天）
    COUNT(DISTINCT CASE 
        WHEN crt.first_recharge_date = crt.first_service_date 
        THEN crt.user_id 
    END) as same_day_conversions,
    -- 7日内转化
    COUNT(DISTINCT CASE 
        WHEN crt.first_recharge_date <= DATE(crt.first_service_date, '+7 days')
        THEN crt.user_id 
    END) as within_7days_conversions,
    -- 30日内转化
    COUNT(DISTINCT CASE 
        WHEN crt.first_recharge_date <= DATE(crt.first_service_date, '+30 days')
        THEN crt.user_id 
    END) as within_30days_conversions
FROM customer_recharge_timeline crt
JOIN therapists t ON crt.first_therapist_id = t.id
WHERE crt.first_service_date BETWEEN ? AND ?
GROUP BY t.id, t.name;
```

## 四、API实现

### 新增API端点
```javascript
// 获取员工新客转化率统计
router.get('/statistics/therapist-conversion-rate', async (req, res) => {
    const { start_date, end_date, store_id, time_range = 'immediate' } = req.query;
    
    try {
        let conversionData;
        
        switch(time_range) {
            case 'immediate':
                conversionData = await getImmediateConversionRate(start_date, end_date, store_id);
                break;
            case '7days':
                conversionData = await get7DaysConversionRate(start_date, end_date, store_id);
                break;
            case '30days':
                conversionData = await get30DaysConversionRate(start_date, end_date, store_id);
                break;
            default:
                conversionData = await getAllConversionRates(start_date, end_date, store_id);
        }
        
        res.json({
            success: true,
            data: {
                conversion_data: conversionData,
                summary: calculateSummaryStats(conversionData)
            }
        });
    } catch (error) {
        res.status(500).json({ success: false, error: error.message });
    }
});
```

## 五、前端展示设计

### 1. 新增转化率统计卡片
```html
<div class="conversion-rate-section">
    <h3>👥 员工新客转化率排行</h3>
    <div class="conversion-filters">
        <select id="conversionTimeRange">
            <option value="immediate">即时转化</option>
            <option value="7days">7日转化</option>
            <option value="30days">30日转化</option>
        </select>
    </div>
    <div class="conversion-chart-container">
        <canvas id="conversionRateChart"></canvas>
    </div>
    <table class="conversion-table">
        <thead>
            <tr>
                <th>员工</th>
                <th>门店</th>
                <th>新客数</th>
                <th>转化数</th>
                <th>转化率</th>
                <th>平均充值</th>
            </tr>
        </thead>
        <tbody id="conversionTableBody">
            <!-- 动态填充 -->
        </tbody>
    </table>
</div>
```

### 2. 可视化图表
- **柱状图**：展示各员工的转化率对比
- **趋势图**：展示转化率的时间变化趋势
- **漏斗图**：展示从新客到充值的转化漏斗

## 六、数据洞察功能

### 1. 转化率影响因素分析
```sql
-- 分析不同因素对转化率的影响
SELECT 
    customer_source,
    COUNT(DISTINCT user_id) as total_customers,
    COUNT(DISTINCT CASE WHEN recharge_amount > 0 THEN user_id END) as converted,
    ROUND(COUNT(DISTINCT CASE WHEN recharge_amount > 0 THEN user_id END) * 100.0 / 
          COUNT(DISTINCT user_id), 2) as conversion_rate
FROM appointments a
JOIN users u ON a.user_id = u.id
WHERE DATE(u.created_at) = DATE(a.appointment_date)
    AND a.status = 'completed'
GROUP BY customer_source
ORDER BY conversion_rate DESC;
```

### 2. 最佳实践识别
- 识别高转化率员工的服务特点
- 分析成功转化的时间规律
- 提供改进建议

## 七、实施步骤

1. **第一阶段**：实现基础转化率统计
   - 即时转化率计算
   - 简单的列表展示

2. **第二阶段**：增加时间维度
   - 7日、30日转化率
   - 趋势分析

3. **第三阶段**：深度分析
   - 影响因素分析
   - 预测模型

这个方案充分利用了现有的数据结构，可以准确计算每个员工的新客转化率，并提供多维度的分析视角。