# å‘˜å·¥æ–°å®¢è½¬åŒ–ç‡ç»Ÿè®¡å®ç°æ–¹æ¡ˆ

## ä¸€ã€æ•°æ®åŸºç¡€åˆ†æ

### å·²æœ‰æ•°æ®æ”¯æŒ
1. **è¯†åˆ«æ–°å®¢æˆ·**ï¼š
   - `users.created_at` - å®¢æˆ·æ³¨å†Œæ—¶é—´
   - `appointments.appointment_date` - é¢„çº¦æ—¶é—´
   - å½“ `DATE(users.created_at) = DATE(appointments.appointment_date)` æ—¶ï¼Œè¯¥å®¢æˆ·ä¸ºæ–°å®¢

2. **è¯†åˆ«è½¬åŒ–ï¼ˆå……å€¼ï¼‰**ï¼š
   - `appointments.recharge_amount` - å……å€¼é‡‘é¢
   - å½“ `recharge_amount > 0` æ—¶ï¼Œè¡¨ç¤ºå®¢æˆ·æœ‰å……å€¼è¡Œä¸º

3. **å‘˜å·¥å½’å±**ï¼š
   - `appointments.therapist_id` - æœåŠ¡å‘˜å·¥ID
   - `therapists.name` - å‘˜å·¥å§“å

## äºŒã€æ–°å®¢è½¬åŒ–ç‡è®¡ç®—é€»è¾‘

### æ ¸å¿ƒæŒ‡æ ‡å®šä¹‰
```
å‘˜å·¥æ–°å®¢è½¬åŒ–ç‡ = (è¯¥å‘˜å·¥æœåŠ¡çš„æ–°å®¢ä¸­æœ‰å……å€¼çš„å®¢æˆ·æ•° / è¯¥å‘˜å·¥æœåŠ¡çš„æ–°å®¢æ€»æ•°) Ã— 100%
```

### è¯¦ç»†æŒ‡æ ‡ä½“ç³»
1. **åŸºç¡€è½¬åŒ–ç‡**ï¼šé¦–æ¬¡æœåŠ¡å³å……å€¼çš„æ¯”ä¾‹
2. **7æ—¥è½¬åŒ–ç‡**ï¼šé¦–æ¬¡æœåŠ¡å7å¤©å†…å……å€¼çš„æ¯”ä¾‹
3. **30æ—¥è½¬åŒ–ç‡**ï¼šé¦–æ¬¡æœåŠ¡å30å¤©å†…å……å€¼çš„æ¯”ä¾‹

## ä¸‰ã€SQLå®ç°æ–¹æ¡ˆ

### 1. å®æ—¶è®¡ç®—æ¯ä¸ªå‘˜å·¥çš„æ–°å®¢è½¬åŒ–ç‡
```sql
WITH new_customer_appointments AS (
    -- æ‰¾å‡ºæ‰€æœ‰æ–°å®¢æˆ·çš„é¦–æ¬¡é¢„çº¦
    SELECT 
        a.id,
        a.user_id,
        a.therapist_id,
        a.appointment_date,
        a.recharge_amount,
        a.status,
        t.name as therapist_name,
        t.store_id,
        s.name as store_name
    FROM appointments a
    JOIN users u ON a.user_id = u.id
    JOIN therapists t ON a.therapist_id = t.id
    LEFT JOIN stores s ON t.store_id = s.id
    WHERE DATE(u.created_at) = DATE(a.appointment_date)  -- æ–°å®¢æ ‡è¯†
        AND a.status = 'completed'  -- åªç»Ÿè®¡å®Œæˆçš„é¢„çº¦
        AND a.appointment_date BETWEEN ? AND ?  -- æ—¶é—´èŒƒå›´
),
therapist_conversion AS (
    -- æŒ‰å‘˜å·¥ç»Ÿè®¡è½¬åŒ–æƒ…å†µ
    SELECT 
        therapist_id,
        therapist_name,
        store_id,
        store_name,
        COUNT(DISTINCT user_id) as new_customers,  -- æ–°å®¢æ€»æ•°
        COUNT(DISTINCT CASE WHEN recharge_amount > 0 THEN user_id END) as converted_customers,  -- è½¬åŒ–å®¢æˆ·æ•°
        SUM(recharge_amount) as total_recharge  -- æ€»å……å€¼é‡‘é¢
    FROM new_customer_appointments
    GROUP BY therapist_id, therapist_name, store_id, store_name
)
SELECT 
    therapist_id,
    therapist_name,
    store_name,
    new_customers,
    converted_customers,
    ROUND(converted_customers * 100.0 / NULLIF(new_customers, 0), 2) as conversion_rate,
    total_recharge,
    ROUND(total_recharge / NULLIF(converted_customers, 0), 2) as avg_recharge_amount
FROM therapist_conversion
ORDER BY conversion_rate DESC;
```

### 2. è®¡ç®—å»¶è¿Ÿè½¬åŒ–ç‡ï¼ˆ7æ—¥/30æ—¥ï¼‰
```sql
WITH new_customer_first_service AS (
    -- è·å–æ¯ä¸ªæ–°å®¢æˆ·çš„é¦–æ¬¡æœåŠ¡ä¿¡æ¯
    SELECT 
        u.id as user_id,
        MIN(a.appointment_date) as first_service_date,
        MIN(a.therapist_id) as first_therapist_id
    FROM users u
    JOIN appointments a ON u.id = a.user_id
    WHERE DATE(u.created_at) = DATE(a.appointment_date)
        AND a.status = 'completed'
    GROUP BY u.id
),
customer_recharge_timeline AS (
    -- è·å–å®¢æˆ·çš„å……å€¼æ—¶é—´çº¿
    SELECT 
        ncfs.user_id,
        ncfs.first_therapist_id,
        ncfs.first_service_date,
        MIN(CASE WHEN a.recharge_amount > 0 THEN a.appointment_date END) as first_recharge_date,
        SUM(a.recharge_amount) as total_recharge
    FROM new_customer_first_service ncfs
    LEFT JOIN appointments a ON ncfs.user_id = a.user_id 
        AND a.appointment_date >= ncfs.first_service_date
        AND a.status = 'completed'
    GROUP BY ncfs.user_id, ncfs.first_therapist_id, ncfs.first_service_date
)
SELECT 
    t.id as therapist_id,
    t.name as therapist_name,
    COUNT(DISTINCT crt.user_id) as total_new_customers,
    -- å³æ—¶è½¬åŒ–ï¼ˆå½“å¤©ï¼‰
    COUNT(DISTINCT CASE 
        WHEN crt.first_recharge_date = crt.first_service_date 
        THEN crt.user_id 
    END) as same_day_conversions,
    -- 7æ—¥å†…è½¬åŒ–
    COUNT(DISTINCT CASE 
        WHEN crt.first_recharge_date <= DATE(crt.first_service_date, '+7 days')
        THEN crt.user_id 
    END) as within_7days_conversions,
    -- 30æ—¥å†…è½¬åŒ–
    COUNT(DISTINCT CASE 
        WHEN crt.first_recharge_date <= DATE(crt.first_service_date, '+30 days')
        THEN crt.user_id 
    END) as within_30days_conversions
FROM customer_recharge_timeline crt
JOIN therapists t ON crt.first_therapist_id = t.id
WHERE crt.first_service_date BETWEEN ? AND ?
GROUP BY t.id, t.name;
```

## å››ã€APIå®ç°

### æ–°å¢APIç«¯ç‚¹
```javascript
// è·å–å‘˜å·¥æ–°å®¢è½¬åŒ–ç‡ç»Ÿè®¡
router.get('/statistics/therapist-conversion-rate', async (req, res) => {
    const { start_date, end_date, store_id, time_range = 'immediate' } = req.query;
    
    try {
        let conversionData;
        
        switch(time_range) {
            case 'immediate':
                conversionData = await getImmediateConversionRate(start_date, end_date, store_id);
                break;
            case '7days':
                conversionData = await get7DaysConversionRate(start_date, end_date, store_id);
                break;
            case '30days':
                conversionData = await get30DaysConversionRate(start_date, end_date, store_id);
                break;
            default:
                conversionData = await getAllConversionRates(start_date, end_date, store_id);
        }
        
        res.json({
            success: true,
            data: {
                conversion_data: conversionData,
                summary: calculateSummaryStats(conversionData)
            }
        });
    } catch (error) {
        res.status(500).json({ success: false, error: error.message });
    }
});
```

## äº”ã€å‰ç«¯å±•ç¤ºè®¾è®¡

### 1. æ–°å¢è½¬åŒ–ç‡ç»Ÿè®¡å¡ç‰‡
```html
<div class="conversion-rate-section">
    <h3>ğŸ‘¥ å‘˜å·¥æ–°å®¢è½¬åŒ–ç‡æ’è¡Œ</h3>
    <div class="conversion-filters">
        <select id="conversionTimeRange">
            <option value="immediate">å³æ—¶è½¬åŒ–</option>
            <option value="7days">7æ—¥è½¬åŒ–</option>
            <option value="30days">30æ—¥è½¬åŒ–</option>
        </select>
    </div>
    <div class="conversion-chart-container">
        <canvas id="conversionRateChart"></canvas>
    </div>
    <table class="conversion-table">
        <thead>
            <tr>
                <th>å‘˜å·¥</th>
                <th>é—¨åº—</th>
                <th>æ–°å®¢æ•°</th>
                <th>è½¬åŒ–æ•°</th>
                <th>è½¬åŒ–ç‡</th>
                <th>å¹³å‡å……å€¼</th>
            </tr>
        </thead>
        <tbody id="conversionTableBody">
            <!-- åŠ¨æ€å¡«å…… -->
        </tbody>
    </table>
</div>
```

### 2. å¯è§†åŒ–å›¾è¡¨
- **æŸ±çŠ¶å›¾**ï¼šå±•ç¤ºå„å‘˜å·¥çš„è½¬åŒ–ç‡å¯¹æ¯”
- **è¶‹åŠ¿å›¾**ï¼šå±•ç¤ºè½¬åŒ–ç‡çš„æ—¶é—´å˜åŒ–è¶‹åŠ¿
- **æ¼æ–—å›¾**ï¼šå±•ç¤ºä»æ–°å®¢åˆ°å……å€¼çš„è½¬åŒ–æ¼æ–—

## å…­ã€æ•°æ®æ´å¯ŸåŠŸèƒ½

### 1. è½¬åŒ–ç‡å½±å“å› ç´ åˆ†æ
```sql
-- åˆ†æä¸åŒå› ç´ å¯¹è½¬åŒ–ç‡çš„å½±å“
SELECT 
    customer_source,
    COUNT(DISTINCT user_id) as total_customers,
    COUNT(DISTINCT CASE WHEN recharge_amount > 0 THEN user_id END) as converted,
    ROUND(COUNT(DISTINCT CASE WHEN recharge_amount > 0 THEN user_id END) * 100.0 / 
          COUNT(DISTINCT user_id), 2) as conversion_rate
FROM appointments a
JOIN users u ON a.user_id = u.id
WHERE DATE(u.created_at) = DATE(a.appointment_date)
    AND a.status = 'completed'
GROUP BY customer_source
ORDER BY conversion_rate DESC;
```

### 2. æœ€ä½³å®è·µè¯†åˆ«
- è¯†åˆ«é«˜è½¬åŒ–ç‡å‘˜å·¥çš„æœåŠ¡ç‰¹ç‚¹
- åˆ†ææˆåŠŸè½¬åŒ–çš„æ—¶é—´è§„å¾‹
- æä¾›æ”¹è¿›å»ºè®®

## ä¸ƒã€å®æ–½æ­¥éª¤

1. **ç¬¬ä¸€é˜¶æ®µ**ï¼šå®ç°åŸºç¡€è½¬åŒ–ç‡ç»Ÿè®¡
   - å³æ—¶è½¬åŒ–ç‡è®¡ç®—
   - ç®€å•çš„åˆ—è¡¨å±•ç¤º

2. **ç¬¬äºŒé˜¶æ®µ**ï¼šå¢åŠ æ—¶é—´ç»´åº¦
   - 7æ—¥ã€30æ—¥è½¬åŒ–ç‡
   - è¶‹åŠ¿åˆ†æ

3. **ç¬¬ä¸‰é˜¶æ®µ**ï¼šæ·±åº¦åˆ†æ
   - å½±å“å› ç´ åˆ†æ
   - é¢„æµ‹æ¨¡å‹

è¿™ä¸ªæ–¹æ¡ˆå……åˆ†åˆ©ç”¨äº†ç°æœ‰çš„æ•°æ®ç»“æ„ï¼Œå¯ä»¥å‡†ç¡®è®¡ç®—æ¯ä¸ªå‘˜å·¥çš„æ–°å®¢è½¬åŒ–ç‡ï¼Œå¹¶æä¾›å¤šç»´åº¦çš„åˆ†æè§†è§’ã€‚