# æ—¶é—´ä¿®æ”¹é£é™©è¯„ä¼°æŠ¥å‘Š

## æ¦‚è¿°
æœ¬æŠ¥å‘Šé’ˆå¯¹ä¿®æ”¹æ—¶é—´å­˜å‚¨æ–¹å¼ï¼ˆä»UTCåˆ°æœ¬åœ°æ—¶é—´ï¼‰å¯¹æ•´ä¸ªç³»ç»Ÿçš„æ½œåœ¨å½±å“è¿›è¡Œå…¨é¢é£é™©è¯„ä¼°ã€‚

## 1. æ•°æ®åº“å±‚é¢æ—¶é—´ä½¿ç”¨åˆ†æ

### 1.1 CURRENT_TIMESTAMP ä½¿ç”¨ä½ç½®
ä»¥ä¸‹ä½ç½®ä½¿ç”¨äº† `CURRENT_TIMESTAMP`ï¼Œéœ€è¦é‡ç‚¹å…³æ³¨ï¼š

#### æ•°æ®åº“Schemaä¸­çš„é»˜è®¤å€¼ï¼š
- **storesè¡¨**: `created_at`, `updated_at` å­—æ®µ
- **servicesè¡¨**: `created_at` å­—æ®µ  
- **therapistsè¡¨**: `created_at`, `updated_at` å­—æ®µ
- **usersè¡¨**: `created_at`, `updated_at` å­—æ®µ
- **appointmentsè¡¨**: `created_at`, `updated_at` å­—æ®µ
- **audit_logsè¡¨**: `action_at` å­—æ®µ

#### ä¸šåŠ¡ä»£ç ä¸­çš„ç›´æ¥ä½¿ç”¨ï¼š
1. `/database/src/services/adminService.js:42,314` - ç®¡ç†å‘˜æ“ä½œè®°å½•
2. `/database/src/services/authService.js:31` - æœ€åç™»å½•æ—¶é—´æ›´æ–°
3. `/database/src/services/appointmentService.js:667,779,830` - é¢„çº¦æ›´æ–°æ—¶é—´

#### æ•°æ®åº“è§¦å‘å™¨ï¼š
- `update_stores_timestamp` - é—¨åº—æ›´æ–°è§¦å‘å™¨
- `update_therapists_timestamp` - æŠ€å¸ˆæ›´æ–°è§¦å‘å™¨  
- `update_appointments_timestamp` - é¢„çº¦æ›´æ–°è§¦å‘å™¨
- `update_users_timestamp` - ç”¨æˆ·æ›´æ–°è§¦å‘å™¨

**é£é™©ç­‰çº§**: ğŸ”´ **é«˜é£é™©**
**å½±å“**: æ‰€æœ‰è‡ªåŠ¨æ—¶é—´æˆ³å°†ä»UTCæ—¶é—´å˜ä¸ºæœ¬åœ°æ—¶é—´

### 1.2 JavaScript new Date() ä½¿ç”¨ä½ç½®

#### é«˜é£é™©ä½ç½®ï¼ˆä¸šåŠ¡é€»è¾‘ç›¸å…³ï¼‰ï¼š
1. **é¢„çº¦æœåŠ¡** (`/database/src/services/appointmentService.js:112`)
   - ç”Ÿæˆé¢„çº¦ç¡®è®¤ç æ—¶ä½¿ç”¨å½“å‰æ—¥æœŸ
   - **å½±å“**: ç¡®è®¤ç æ ¼å¼å¯èƒ½å‘ç”Ÿå˜åŒ–

2. **æ—¥æœŸé™åˆ¶å·¥å…·** (`/database/src/utils/dateRestriction.js:11`)
   - åŒ—äº¬æ—¶é—´è®¡ç®—å’Œä»Šæ—¥æ—¥æœŸè·å–
   - **å½±å“**: å¯èƒ½å¯¼è‡´æ—¥æœŸæ¯”è¾ƒé”™è¯¯

3. **å‰ç«¯å®¢æˆ·ç«¯** (`/database/frontend/js/client.js:15,19`)
   - è®¾ç½®é¢„çº¦æ—¥æœŸé»˜è®¤å€¼å’Œæœ€å¤§æ—¥æœŸ
   - **å½±å“**: å‰ç«¯æ—¥æœŸé€‰æ‹©å™¨å¯èƒ½æ˜¾ç¤ºé”™è¯¯çš„æ—¥æœŸèŒƒå›´

4. **ç»Ÿè®¡åˆ†æ** (`/database/frontend/js/statistics.js`)
   - å¤šå¤„ç”¨äºæ—¥æœŸèŒƒå›´æŸ¥è¯¢å’Œå›¾è¡¨å±•ç¤º
   - **å½±å“**: ç»Ÿè®¡æ•°æ®æ—¶é—´èŒƒå›´å¯èƒ½é”™è¯¯

#### ä¸­ç­‰é£é™©ä½ç½®ï¼ˆæ—¥å¿—å’Œæ˜¾ç¤ºï¼‰ï¼š
- å„ç§æ—¥å¿—è®°å½•å’Œæ—¶é—´æˆ³ç”Ÿæˆ
- AIå®¢æœæ—¶é—´æ˜¾ç¤º
- å‰ç«¯æ—¶é—´æ ¼å¼åŒ–

**é£é™©ç­‰çº§**: ğŸŸ¡ **ä¸­-é«˜é£é™©**

## 2. é¢„çº¦æ—¶é—´å†²çªæ£€æŸ¥é€»è¾‘åˆ†æ

### 2.1 æ ¸å¿ƒå†²çªæ£€æŸ¥æ–¹æ³•
ä½ç½®ï¼š`/database/src/services/appointmentService.js:999-1023`

```sql
SELECT id FROM appointments 
WHERE therapist_id = ? 
  AND appointment_date = ? 
  AND status IN ('pending', 'confirmed', 'in_progress')
  AND (
      (start_time < ? AND end_time > ?) OR
      (start_time < ? AND end_time > ?) OR
      (start_time >= ? AND end_time <= ?)
  )
```

**åˆ†æ**ï¼š
- ä¸»è¦ä¾èµ– `appointment_date`ï¼ˆDATEç±»å‹ï¼‰å’Œ `start_time`/`end_time`ï¼ˆTIMEç±»å‹ï¼‰
- æ—¶é—´æ¯”è¾ƒé€»è¾‘ç›¸å¯¹ç‹¬ç«‹ï¼Œä¸ç›´æ¥ä¾èµ–UTC/æœ¬åœ°æ—¶é—´è½¬æ¢
- ä½† `appointment_date` çš„ç”Ÿæˆå¯èƒ½å—åˆ°æ—¶åŒºå˜åŒ–å½±å“

**é£é™©ç­‰çº§**: ğŸŸ¡ **ä¸­ç­‰é£é™©**

### 2.2 æ—¶é—´è®¡ç®—æ–¹æ³•
```javascript
calculateEndTime(startTime, duration) {
    const [hours, minutes] = startTime.split(':').map(Number);
    const totalMinutes = hours * 60 + minutes + duration;
    const endHours = Math.floor(totalMinutes / 60);
    const endMinutes = totalMinutes % 60;
    return `${endHours.toString().padStart(2, '0')}:${endMinutes.toString().padStart(2, '0')}`;
}
```

**åˆ†æ**ï¼š
- çº¯æ—¶é—´ç®—æœ¯è¿ç®—ï¼Œä¸æ¶‰åŠæ—¶åŒº
- **é£é™©ç­‰çº§**: ğŸŸ¢ **ä½é£é™©**

## 3. æ—¶é—´èŒƒå›´æŸ¥è¯¢åˆ†æ

### 3.1 æ•°æ®åº“æŸ¥è¯¢ä¸­çš„æ—¶é—´è¿‡æ»¤
å¸¸è§æ¨¡å¼ï¼š
```sql
-- æŒ‰æ—¥æœŸè¿‡æ»¤
WHERE appointment_date >= DATE('now')
WHERE appointment_date = ?

-- æŒ‰åˆ›å»ºæ—¶é—´è¿‡æ»¤  
WHERE created_at >= ? AND created_at <= ?
```

**å…³é”®é£é™©ç‚¹**ï¼š
- `DATE('now')` å°†å—åˆ°æ—¶åŒºæ›´æ”¹å½±å“
- å‰ç«¯ä¼ å…¥çš„æ—¥æœŸå‚æ•°ä¸æ•°æ®åº“å­˜å‚¨æ—¶é—´å¯èƒ½å‡ºç°æ—¶åŒºä¸åŒ¹é…

**é£é™©ç­‰çº§**: ğŸ”´ **é«˜é£é™©**

### 3.2 å‰ç«¯æ—¥æœŸèŒƒå›´é€‰æ‹©
ä½ç½®ï¼š`/database/frontend/js/statistics.js`, `/database/frontend/js/client.js`

**é—®é¢˜**ï¼š
- å‰ç«¯è·å–"ä»Šå¤©"çš„æ–¹å¼ï¼š`new Date().toISOString().split('T')[0]`
- å¯èƒ½ä¸åç«¯çš„"ä»Šå¤©"å®šä¹‰ä¸ä¸€è‡´

## 4. APIæ—¶é—´æ ¼å¼åˆ†æ

### 4.1 APIè¿”å›çš„æ—¶é—´å­—æ®µ
ä¸»è¦å­—æ®µï¼š
- `appointment_date` - é¢„çº¦æ—¥æœŸ
- `start_time`/`end_time` - å¼€å§‹/ç»“æŸæ—¶é—´  
- `created_at`/`updated_at` - åˆ›å»º/æ›´æ–°æ—¶é—´
- `action_at` - å®¡è®¡æ—¥å¿—æ“ä½œæ—¶é—´

### 4.2 å‰ç«¯æ—¶é—´æ˜¾ç¤º
å¸¸è§æ ¼å¼åŒ–æ–¹æ³•ï¼š
```javascript
new Date(dateTime).toLocaleString('zh-CN')
new Date().toLocaleTimeString('zh-CN')
```

**é£é™©ç­‰çº§**: ğŸŸ¡ **ä¸­ç­‰é£é™©**
**å½±å“**: å‰ç«¯æ˜¾ç¤ºçš„æ—¶é—´å¯èƒ½ä¸å®é™…ä¸šåŠ¡æ—¶é—´ä¸ä¸€è‡´

## 5. å®¡è®¡æ—¥å¿—æ—¶é—´è¿½è¸ª

### 5.1 å®¡è®¡è¡¨ç»“æ„
```sql
CREATE TABLE appointment_audit_logs (
    action_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    -- å…¶ä»–å­—æ®µ
);
```

### 5.2 å®¡è®¡æ—¥å¿—æŸ¥è¯¢
å®¡è®¡æ—¥å¿—çš„æ—¶é—´æŸ¥è¯¢å¯¹åˆè§„æ€§è‡³å…³é‡è¦ï¼Œæ—¶é—´ä¿®æ”¹å¯èƒ½å½±å“ï¼š
- æ“ä½œæ—¶é—´çš„å‡†ç¡®æ€§
- æ—¶é—´èŒƒå›´æŸ¥è¯¢çš„æ­£ç¡®æ€§
- åˆè§„æŠ¥å‘Šçš„æ—¶é—´ç»Ÿè®¡

**é£é™©ç­‰çº§**: ğŸ”´ **é«˜é£é™©**

## 6. å®šæ—¶ä»»åŠ¡å’Œè°ƒåº¦

### 6.1 ç°æœ‰å®šæ—¶é€»è¾‘
ä¸»è¦ä½¿ç”¨ `setTimeout` å’Œ `setInterval`ï¼š
- æœåŠ¡å™¨çŠ¶æ€æ£€æŸ¥
- é‡è¯•æœºåˆ¶
- æ•°æ®æŠ½å–ä»»åŠ¡

**åˆ†æ**ï¼š
- è¿™äº›ä¸»è¦æ˜¯ç›¸å¯¹æ—¶é—´é—´éš”ï¼Œå—æ—¶åŒºå½±å“è¾ƒå°
- **é£é™©ç­‰çº§**: ğŸŸ¢ **ä½é£é™©**

## 7. ç»¼åˆé£é™©è¯„ä¼°

### 7.1 é«˜é£é™©åŒºåŸŸ ğŸ”´
1. **æ•°æ®åº“è‡ªåŠ¨æ—¶é—´æˆ³**
   - æ‰€æœ‰ `CURRENT_TIMESTAMP` é»˜è®¤å€¼
   - è§¦å‘å™¨ä¸­çš„æ—¶é—´æˆ³æ›´æ–°
   - å½±å“ï¼šå†å²æ•°æ®å’Œæ–°æ•°æ®çš„æ—¶é—´åŸºå‡†ä¸ä¸€è‡´

2. **æ—¥æœŸæ¯”è¾ƒå’ŒæŸ¥è¯¢**
   - `DATE('now')` æŸ¥è¯¢
   - å‰åç«¯æ—¥æœŸèŒƒå›´ä¸åŒ¹é…
   - å½±å“ï¼šé¢„çº¦æŸ¥è¯¢ã€ç»Ÿè®¡åˆ†æé”™è¯¯

3. **å®¡è®¡æ—¥å¿—**
   - åˆè§„æ€§è¦æ±‚çš„æ—¶é—´å‡†ç¡®æ€§
   - å½±å“ï¼šå¯èƒ½è¿åå®¡è®¡è¦æ±‚

### 7.2 ä¸­ç­‰é£é™©åŒºåŸŸ ğŸŸ¡
1. **é¢„çº¦ç¡®è®¤ç ç”Ÿæˆ**
   - æ—¥æœŸéƒ¨åˆ†å¯èƒ½å‘ç”Ÿå˜åŒ–
   - å½±å“ï¼šç¡®è®¤ç æ ¼å¼ä¸€è‡´æ€§

2. **å‰ç«¯æ—¶é—´æ˜¾ç¤º**
   - ç”¨æˆ·ç•Œé¢æ—¶é—´æ˜¾ç¤º
   - å½±å“ï¼šç”¨æˆ·ä½“éªŒå’Œæ“ä½œåˆ¤æ–­

3. **ç»Ÿè®¡æŠ¥è¡¨**
   - æ—¶é—´èŒƒå›´ç»Ÿè®¡å¯èƒ½ä¸å‡†ç¡®
   - å½±å“ï¼šä¸šåŠ¡å†³ç­–æ•°æ®

### 7.3 ä½é£é™©åŒºåŸŸ ğŸŸ¢
1. **æ—¶é—´è®¡ç®—é€»è¾‘**
   - çº¯ç®—æœ¯è¿ç®—
   - ç›¸å¯¹æ—¶é—´é—´éš”

2. **å®šæ—¶ä»»åŠ¡**
   - åŸºäºé—´éš”çš„è°ƒåº¦

## 8. å»ºè®®çš„è¿ç§»ç­–ç•¥

### 8.1 å‡†å¤‡é˜¶æ®µ
1. **æ•°æ®å¤‡ä»½**ï¼šå®Œæ•´å¤‡ä»½ç°æœ‰æ•°æ®åº“
2. **æµ‹è¯•ç¯å¢ƒ**ï¼šå»ºç«‹å®Œæ•´çš„æµ‹è¯•ç¯å¢ƒ
3. **æ—¶é—´å¯¹ç…§è¡¨**ï¼šè®°å½•å…³é”®æ—¶é—´ç‚¹çš„UTCå’Œæœ¬åœ°æ—¶é—´å¯¹åº”å…³ç³»

### 8.2 æ¸è¿›å¼è¿ç§»
1. **ç¬¬ä¸€é˜¶æ®µ**ï¼šä¿®æ”¹æ–°å¢æ•°æ®çš„æ—¶é—´å¤„ç†
2. **ç¬¬äºŒé˜¶æ®µ**ï¼šæ›´æ–°æŸ¥è¯¢é€»è¾‘å’ŒAPI
3. **ç¬¬ä¸‰é˜¶æ®µ**ï¼šå†å²æ•°æ®æ—¶é—´åŸºå‡†ç»Ÿä¸€ï¼ˆå¦‚éœ€è¦ï¼‰

### 8.3 éªŒè¯æ£€æŸ¥ç‚¹
1. **é¢„çº¦å†²çªæ£€æŸ¥**ï¼šéªŒè¯æ—¶é—´å†²çªé€»è¾‘æ­£ç¡®æ€§
2. **ç»Ÿè®¡æ•°æ®**ï¼šå¯¹æ¯”è¿ç§»å‰åçš„ç»Ÿè®¡ç»“æœ
3. **å®¡è®¡æ—¥å¿—**ï¼šç¡®ä¿æ—¶é—´è¿½è¸ªçš„è¿ç»­æ€§
4. **å‰ç«¯æ˜¾ç¤º**ï¼šæ£€æŸ¥æ‰€æœ‰æ—¶é—´æ˜¾ç¤ºçš„æ­£ç¡®æ€§

## 9. æ½œåœ¨è§£å†³æ–¹æ¡ˆ

### 9.1 æ—¶é—´æ ‡å‡†åŒ–
- ç»Ÿä¸€ä½¿ç”¨ä¸€ä¸ªæ—¶é—´åŸºå‡†ï¼ˆå»ºè®®ç»§ç»­ä½¿ç”¨UTCï¼Œåœ¨å±•ç¤ºå±‚è½¬æ¢ï¼‰
- æˆ–è€…å…¨é¢è¿ç§»åˆ°æœ¬åœ°æ—¶é—´ï¼Œä½†éœ€è¦å¤„ç†å†å²æ•°æ®

### 9.2 å…¼å®¹æ€§å¤„ç†
- åœ¨è¿‡æ¸¡æœŸæä¾›æ—¶é—´è½¬æ¢å‡½æ•°
- åœ¨APIå±‚ç»Ÿä¸€å¤„ç†æ—¶é—´æ ¼å¼è½¬æ¢
- ä¸ºå†å²æ•°æ®æ·»åŠ æ—¶åŒºæ ‡è¯†

### 9.3 ç›‘æ§å’ŒæŠ¥è­¦
- å»ºç«‹æ—¶é—´ç›¸å…³çš„ç›‘æ§æŒ‡æ ‡
- è®¾ç½®å¼‚å¸¸æ—¶é—´æ•°æ®çš„æŠ¥è­¦æœºåˆ¶

## 10. æ€»ç»“

ä¿®æ”¹æ—¶é—´å­˜å‚¨æ–¹å¼æ˜¯ä¸€ä¸ª**é«˜é£é™©æ“ä½œ**ï¼Œä¸»è¦é£é™©é›†ä¸­åœ¨ï¼š

1. **æ•°æ®ä¸€è‡´æ€§**ï¼šæ–°æ—§æ•°æ®æ—¶é—´åŸºå‡†ä¸ä¸€è‡´
2. **ä¸šåŠ¡é€»è¾‘**ï¼šé¢„çº¦å†²çªæ£€æŸ¥ã€ç»Ÿè®¡æŸ¥è¯¢å¯èƒ½å‡ºé”™  
3. **åˆè§„é£é™©**ï¼šå®¡è®¡æ—¥å¿—æ—¶é—´è¿½è¸ªå¯èƒ½å—å½±å“
4. **ç”¨æˆ·ä½“éªŒ**ï¼šå‰ç«¯æ—¶é—´æ˜¾ç¤ºå¯èƒ½æ··ä¹±

å»ºè®®åœ¨å……åˆ†æµ‹è¯•å’Œå‡†å¤‡çš„åŸºç¡€ä¸Šï¼Œé‡‡ç”¨æ¸è¿›å¼è¿ç§»ç­–ç•¥ï¼Œç¡®ä¿æ¯ä¸ªæ­¥éª¤éƒ½æœ‰å……åˆ†çš„éªŒè¯å’Œå›æ»šèƒ½åŠ›ã€‚

---
*æŠ¥å‘Šç”Ÿæˆæ—¶é—´ï¼š2025-07-24*
*é£é™©è¯„ä¼°æ¶µç›–èŒƒå›´ï¼šæ•´ä¸ªaicustomerserviceé¡¹ç›®*