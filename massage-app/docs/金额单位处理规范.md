# 金额单位处理规范

## 核心原则

**全系统统一使用分为单位（不使用浮点数）**，避免精度问题。

### 金额流转过程

```
API返回（分）→ 服务层（分）→ 页面层（转元显示）
```

| 层级 | 金额单位 | 说明 |
|------|--------|------|
| **API** | 分 | 所有API返回金额都是分为单位（整数） |
| **服务层** | 分 | 直接返回API数据，不做转换 |
| **类型定义** | 分 | 所有TypeScript接口中的金额字段都是分 |
| **页面层** | 元 | 使用 `formatAmount()` 工具函数转换为元显示 |

---

## 关键规范

### 1. API返回金额（分）

**原始数据 - 不要修改：**
```typescript
// API返回
{
  "code": 0,
  "data": {
    "price": 12800,      // ✅ 分为单位（128元）
    "balance": 50000,    // ✅ 分为单位（500元）
    "discountAmount": 2000  // ✅ 分为单位（20元）
  }
}
```

### 2. 服务层返回金额（分）

**服务层直接返回分为单位，不转换：**

#### ✅ 正确做法

```typescript
// wallet.service.ts - 余额查询
async getBalance(): Promise<number> {
  const response = await get<BalanceResponse>('/users/wallet/balance', { userId })
  // ✅ 直接返回API返回的分为单位
  return response.data.balance  // 分
}

// order.ts - 订单详情
async getOrderDetail(orderNo: string): Promise<OrderData> {
  const response = await get(`/orders/${orderNo}`)
  const order = response.data

  // ✅ 保持分为单位，不转换
  return {
    ...order,
    amount: order.amount  // 分（不是除以100）
  }
}
```

#### ❌ 错误做法

```typescript
// ❌ 不要在服务层转换单位
async getBalance(): Promise<number> {
  const response = await get<BalanceResponse>('/users/wallet/balance', { userId })
  return response.data.balance / 100  // ❌ 错误！在服务层转换了
}

// ❌ 不要在服务层创建新字段
async getOrderDetail(orderNo: string): Promise<OrderData> {
  const response = await get(`/orders/${orderNo}`)
  return {
    ...response.data,
    totalAmount: response.data.amount / 100  // ❌ 错误！创建了新字段
  }
}
```

### 3. 类型定义（分）

**所有TypeScript接口中的金额都是分：**

```typescript
// ✅ 正确的类型定义
export interface OrderData {
  amount: number;        // 分为单位 ✅
  discountPrice?: number; // 分为单位 ✅
}

export interface Product {
  price: number;         // 分为单位 ✅
  originalPrice: number; // 分为单位 ✅
}

export interface RechargeOption {
  amount: number;        // 分为单位 ✅
  bonus: number;         // 分为单位 ✅
}

// ❌ 不要混用单位
export interface BadInterface {
  amountInYuan: number;     // ❌ 不清楚单位
  balanceInCents: number;   // ❌ 混淆（API返回的是分，字段名说是"分"却实际是元）
  price: number;            // ❌ 不知道是分还是元
}
```

### 4. 页面层显示（元）

**在组件中使用 `formatAmount()` 函数转换并显示：**

```typescript
// components/OrderCard.tsx
import { formatAmount, centsToYuan } from '@/utils/amount'

export function OrderCard({ order }: { order: OrderData }) {
  return (
    <View>
      {/* ✅ 正确：使用formatAmount显示 */}
      <Text>{formatAmount(order.amount)}</Text>

      {/* ✅ 正确：或使用centsToYuan转换后显示 */}
      <Text>￥{centsToYuan(order.amount).toFixed(2)}</Text>

      {/* ❌ 错误：直接显示分 */}
      <Text>{order.amount}</Text>
    </View>
  )
}
```

**常用工具函数：**

```typescript
import {
  formatAmount,           // 格式化为 "￥99.99元"
  centsToYuan,           // 转换为元（数字）
  yuanToCents,           // 转换为分（数字）
  getSavingsText,        // 获取"节省￥10.00"文本
  getDiscountRate        // 获取折扣率（0.8表示8折）
} from '@/utils/amount'

// 使用示例
formatAmount(12800)                         // "￥128.00元"
centsToYuan(12800)                          // 128
yuanToCents(128)                            // 12800
getSavingsText(29900, 19900)                // "节省￥100.00"
getDiscountRate(29900, 19900)               // 0.7 (7折)
```

---

## 实际应用例子

### 例子1：钱包余额显示

```typescript
// services/wallet.service.ts
class WalletService {
  async getBalance(): Promise<number> {
    const response = await get<BalanceResponse>('/users/wallet/balance', { userId })
    // ✅ 返回分（整数）
    return response.data.balance
  }
}

// pages/Balance.tsx
export function BalancePage() {
  const [balance, setBalance] = useState<number>(0)

  useEffect(() => {
    walletService.getBalance().then(balanceInCents => {
      setBalance(balanceInCents)  // 存储分
    })
  }, [])

  return (
    <View>
      {/* ✅ 显示时转换为元 */}
      <Text>余额：{formatAmount(balance)}</Text>
      {/* 输出：余额：￥512.50元 */}
    </View>
  )
}
```

### 例子2：商品价格显示

```typescript
// services/gift.service.ts
const PRODUCTS: Product[] = [
  {
    id: 'pillow',
    name: '护颈助眠小枕',
    price: 29900,         // ✅ 分为单位（299元）
    originalPrice: 39900, // ✅ 分为单位（399元）
  }
]

// pages/GiftShop.tsx
export function ProductCard({ product }: { product: Product }) {
  return (
    <View>
      <Text>商品：{product.name}</Text>

      {/* ✅ 现价 */}
      <Text>现价：{formatAmount(product.price)}</Text>

      {/* ✅ 原价 */}
      <Text>原价：{formatAmount(product.originalPrice)}</Text>

      {/* ✅ 节省金额 */}
      <Text>{getSavingsText(product.originalPrice, product.price)}</Text>

      {/* 输出示例：
        现价：￥299.00元
        原价：￥399.00元
        节省￥100.00
      */}
    </View>
  )
}
```

### 例子3：订单创建（前端发送分）

```typescript
// pages/Booking.tsx
async function handleCreateOrder(therapistId: string, price: number) {
  const orderParams = {
    therapistId,
    price,  // ✅ price已经是分为单位（来自API）
    duration: 60,
    appointmentDate: '2024-12-25'
  }

  // ✅ 直接发送分，不转换
  const result = await orderService.createAppointmentOrder(orderParams)
}
```

### 例子4：充值选项展示

```typescript
// services/wallet.service.ts
class WalletService {
  async getRechargeOptions(): Promise<RechargeOption[]> {
    const response = await get<RechargeOption[]>('/recharge/configs')

    // ✅ 返回分为单位（不转换）
    return response.data
  }
}

// pages/Recharge.tsx
export function RechargeOptions() {
  const [options, setOptions] = useState<RechargeOption[]>([])

  useEffect(() => {
    walletService.getRechargeOptions().then(opts => {
      setOptions(opts)  // options中的amount和bonus都是分
    })
  }, [])

  return (
    <ScrollView>
      {options.map(option => (
        <View key={option.id}>
          {/* ✅ 显示时转换为元 */}
          <Text>{formatAmount(option.amount)}</Text>

          {option.bonus > 0 && (
            <Text>赠送：{formatAmount(option.bonus)}</Text>
          )}

          {/* 输出示例：
            ￥100.00元
            赠送：￥0.00元

            ￥500.00元
            赠送：￥50.00元
          */}
        </View>
      ))}
    </ScrollView>
  )
}
```

---

## 常见错误及修复

### 错误1：在服务层进行转换

❌ **错误代码**
```typescript
// wallet.service.ts
async getBalance(): Promise<number> {
  const response = await get<BalanceResponse>('/users/wallet/balance', { userId })
  const balanceInCents = response.data.balance || 0
  const balanceInYuan = balanceInCents / 100  // ❌ 错误：在服务层转换
  return balanceInYuan  // ❌ 返回元，违反规范
}
```

✅ **正确代码**
```typescript
async getBalance(): Promise<number> {
  const response = await get<BalanceResponse>('/users/wallet/balance', { userId })
  // ✅ 直接返回分
  return response.data.balance || 0
}
```

### 错误2：混淆API返回的单位

❌ **错误代码**
```typescript
// gift.service.ts
static async createGiftCardOrder(params: {
  amount: number  // 调用者认为这是元
}): Promise<OrderResponse> {
  const orderData: CreateOrderRequest = {
    amount: params.amount * params.quantity,  // ❌ 如果params.amount是元就成了两倍
  }
}
```

✅ **正确代码**
```typescript
static async createGiftCardOrder(params: {
  amount: number  // 明确说明：分为单位
}): Promise<OrderResponse> {
  // ✅ params.amount已经是分，直接使用
  const orderData: CreateOrderRequest = {
    amount: params.amount * params.quantity,
  }
}
```

### 错误3：在UI层不转换

❌ **错误代码**
```typescript
export function OrderItem({ order }: { order: OrderData }) {
  return (
    <View>
      <Text>金额：{order.amount}</Text>  // ❌ 直接显示分，显示为"12800"
    </View>
  )
}
```

✅ **正确代码**
```typescript
export function OrderItem({ order }: { order: OrderData }) {
  return (
    <View>
      <Text>金额：{formatAmount(order.amount)}</Text>  // ✅ 显示为"￥128.00元"
    </View>
  )
}
```

---

## 检查清单

在进行金额相关的开发时，请按以下清单检查：

- [ ] **API文档检查**：确认API返回的金额单位（应为分）
- [ ] **类型定义检查**：所有接口中的金额字段都标注为分
- [ ] **服务层检查**：服务不进行金额转换，直接返回API数据
- [ ] **页面层检查**：使用 `formatAmount()` 等工具函数显示金额
- [ ] **请求参数检查**：发送API请求时，金额参数必须是分
- [ ] **测试检查**：验证各金额流程的完整性和精度

---

## 参考资源

- **金额工具库**：`src/utils/amount.ts`
- **类型定义**：`src/types/index.ts`
- **API文档**：`api-docs/06-订单支付API.md`
