# 推拿预约小程序技术架构设计文档

## 一、技术架构总览

### 1.1 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        前端展示层                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  微信小程序   │  │   H5 网页    │  │  管理后台    │         │
│  │   (Taro)    │  │   (Taro)    │  │  (React)    │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                        网关层                                │
│                   Nginx + API Gateway                        │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      应用服务层                               │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │用户服务   │  │预约服务   │  │门店服务   │  │支付服务   │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │推拿师服务 │  │优惠券服务 │  │消息服务   │  │文件服务   │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                       数据层                                 │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │  MySQL   │  │  Redis   │  │ MongoDB  │  │   OSS    │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 技术选型

#### 前端技术栈
- **框架**：Taro 3.x + React Hooks
- **UI 组件库**：Taro UI / NutUI
- **状态管理**：MobX / Zustand
- **样式**：Sass + CSS Modules
- **请求库**：Taro.request 封装
- **工具库**：dayjs, lodash-es

#### 后端技术栈
- **开发语言**：Node.js (TypeScript)
- **Web 框架**：Nest.js
- **ORM**：TypeORM
- **API 文档**：Swagger
- **进程管理**：PM2

#### 基础设施
- **数据库**：SQLite (轻量级嵌入式数据库)
- **缓存**：内存缓存 / Node.js Cache
- **文件存储**：本地存储 / 阿里云 OSS / 腾讯云 COS
- **日志系统**：Winston + 文件日志

## 二、前端架构设计

### 2.1 项目目录结构

```
src/
├── app.js                    # 应用入口
├── app.config.js            # 全局配置
├── app.scss                 # 全局样式
├── assets/                  # 静态资源
│   ├── images/             
│   └── icons/              
├── components/              # 公共组件
│   ├── Layout/             
│   ├── Card/               
│   └── Loading/            
├── pages/                   # 页面文件
│   ├── tabbar/             # TabBar 页面
│   │   ├── appointment/    # 预约
│   │   ├── gift/          # 好礼
│   │   └── mine/          # 我的
│   ├── appointment/        # 预约相关页面
│   │   ├── store-list/    # 门店列表
│   │   ├── store-detail/  # 门店详情
│   │   ├── therapist/     # 推拿师详情
│   │   └── booking/       # 预约确认
│   └── user/              # 用户相关页面
├── services/               # API 服务
│   ├── api.js             # API 配置
│   ├── request.js         # 请求封装
│   ├── user.js            # 用户相关 API
│   ├── appointment.js     # 预约相关 API
│   └── store.js           # 门店相关 API
├── stores/                 # 状态管理
│   ├── user.js            # 用户状态
│   ├── location.js        # 位置状态
│   └── appointment.js     # 预约状态
├── utils/                  # 工具函数
│   ├── auth.js            # 认证相关
│   ├── location.js        # 位置计算
│   └── format.js          # 格式化工具
└── config/                 # 配置文件
    ├── index.js            # 基础配置
    └── api.js              # API 地址配置
```

### 2.2 核心模块设计

#### 2.2.1 位置服务模块
```javascript
// utils/location.js
export class LocationService {
  // 获取用户当前位置
  static async getCurrentLocation() {
    const { authSetting } = await Taro.getSetting()
    if (!authSetting['scope.userLocation']) {
      await Taro.authorize({ scope: 'scope.userLocation' })
    }
    return await Taro.getLocation({
      type: 'gcj02'
    })
  }
  
  // 计算两点之间距离
  static calculateDistance(lat1, lng1, lat2, lng2) {
    const rad = Math.PI / 180
    const R = 6371 // 地球半径（公里）
    const dLat = (lat2 - lat1) * rad
    const dLng = (lng2 - lng1) * rad
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * rad) * Math.cos(lat2 * rad) *
              Math.sin(dLng/2) * Math.sin(dLng/2)
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a))
    return (R * c).toFixed(1) // 返回公里数
  }
}
```

#### 2.2.2 请求封装
```javascript
// services/request.js
class Request {
  constructor() {
    this.baseUrl = process.env.NODE_ENV === 'production' 
      ? 'https://api.massage.com'
      : 'http://localhost:3000'
  }
  
  async request(options) {
    const token = Taro.getStorageSync('token')
    
    const { data } = await Taro.request({
      ...options,
      url: this.baseUrl + options.url,
      header: {
        'Content-Type': 'application/json',
        'Authorization': token ? `Bearer ${token}` : '',
        ...options.header
      }
    })
    
    if (data.code === 401) {
      // Token 过期，跳转登录
      Taro.navigateTo({ url: '/pages/login/index' })
      return Promise.reject(new Error('未授权'))
    }
    
    if (data.code !== 200) {
      Taro.showToast({
        title: data.message || '请求失败',
        icon: 'none'
      })
      return Promise.reject(data)
    }
    
    return data.data
  }
  
  get(url, params) {
    return this.request({ url, method: 'GET', data: params })
  }
  
  post(url, data) {
    return this.request({ url, method: 'POST', data })
  }
}

export default new Request()
```

### 2.3 页面组件设计

#### 2.3.1 预约首页组件
```javascript
// pages/tabbar/appointment/index.jsx
import React, { useState, useEffect } from 'react'
import { View, Swiper, SwiperItem, Image, Text, ScrollView } from '@tarojs/components'
import { observer } from 'mobx-react'
import { useStores } from '@/stores'
import StoreCard from '@/components/StoreCard'
import TherapistCard from '@/components/TherapistCard'
import './index.scss'

export default observer(function Appointment() {
  const { locationStore, storeStore } = useStores()
  const [stores, setStores] = useState([])
  const [therapists, setTherapists] = useState([])
  
  useEffect(() => {
    // 获取位置并加载门店
    loadNearbyStores()
  }, [])
  
  const loadNearbyStores = async () => {
    await locationStore.updateLocation()
    const { latitude, longitude } = locationStore.location
    const nearbyStores = await storeStore.getNearbyStores(latitude, longitude)
    setStores(nearbyStores)
    
    // 加载推荐推拿师
    if (nearbyStores.length > 0) {
      const recommendTherapists = await storeStore.getRecommendTherapists(nearbyStores[0].id)
      setTherapists(recommendTherapists)
    }
  }
  
  return (
    <View className='appointment-page'>
      {/* 优惠活动轮播 */}
      <Swiper className='banner' autoplay>
        <SwiperItem>
          <View className='banner-item'>
            <Image src='/assets/images/banner1.jpg' />
            <View className='banner-content'>
              <Text className='title'>拯救上班族</Text>
              <Text className='desc'>17:00-18:00享9.0折</Text>
            </View>
          </View>
        </SwiperItem>
      </Swiper>
      
      {/* 门店列表 */}
      <View className='section'>
        <View className='section-header'>
          <Text className='title'>门店预约</Text>
          <Text className='more' onClick={handleMoreStores}>更多门店</Text>
        </View>
        <ScrollView scrollY className='store-list'>
          {stores.map(store => (
            <StoreCard key={store.id} store={store} />
          ))}
        </ScrollView>
      </View>
      
      {/* 推拿师列表 */}
      <View className='section'>
        <View className='section-header'>
          <Text className='title'>推拿师预约</Text>
          <Text className='more' onClick={handleMoreTherapists}>更多症状</Text>
        </View>
        <ScrollView scrollY className='therapist-list'>
          {therapists.map(therapist => (
            <TherapistCard key={therapist.id} therapist={therapist} />
          ))}
        </ScrollView>
      </View>
    </View>
  )
})
```

## 三、后端架构设计

### 3.1 微服务划分

#### 3.1.1 用户服务（User Service）
- 用户注册/登录
- 用户信息管理
- 会员等级管理
- 积分管理

#### 3.1.2 预约服务（Appointment Service）
- 创建预约
- 预约查询
- 预约状态管理
- 预约核销

#### 3.1.3 门店服务（Store Service）
- 门店信息管理
- 推拿师管理
- 排班管理
- 服务项目管理

#### 3.1.4 支付服务（Payment Service）
- 微信支付集成
- 订单管理
- 退款处理
- 账单对账

### 3.2 API 接口设计

#### 3.2.1 RESTful API 规范
```
GET    /api/v1/stores                 # 获取门店列表
GET    /api/v1/stores/:id            # 获取门店详情
GET    /api/v1/stores/:id/therapists # 获取门店推拿师列表

GET    /api/v1/therapists/:id        # 获取推拿师详情
GET    /api/v1/therapists/:id/schedule # 获取推拿师排班

POST   /api/v1/appointments          # 创建预约
GET    /api/v1/appointments          # 获取预约列表
GET    /api/v1/appointments/:id      # 获取预约详情
PUT    /api/v1/appointments/:id      # 更新预约状态
DELETE /api/v1/appointments/:id      # 取消预约

POST   /api/v1/auth/login            # 登录
POST   /api/v1/auth/refresh          # 刷新 token
GET    /api/v1/users/profile         # 获取用户信息
PUT    /api/v1/users/profile         # 更新用户信息
```

#### 3.2.2 接口响应格式
```json
{
  "code": 200,
  "message": "success",
  "data": {
    // 业务数据
  },
  "timestamp": 1234567890
}
```

### 3.3 数据库设计

<function_calls>
<invoke name="TodoWrite">
<parameter name="todos">[{"id": "1", "content": "\u5206\u6790\u9700\u6c42\u5e76\u67e5\u770b\u793a\u4f8b\u56fe\u7247", "status": "completed", "priority": "high"}, {"id": "2", "content": "\u8bbe\u8ba1\u524d\u540e\u7aef\u67b6\u6784\u65b9\u6848", "status": "completed", "priority": "high"}, {"id": "3", "content": "\u521b\u5efa\u4ea7\u54c1\u9700\u6c42\u6587\u6863(PRD)", "status": "completed", "priority": "high"}, {"id": "4", "content": "\u521b\u5efa\u6280\u672f\u67b6\u6784\u6587\u6863", "status": "completed", "priority": "high"}, {"id": "5", "content": "\u8bbe\u8ba1\u6570\u636e\u5e93\u7ed3\u6784", "status": "in_progress", "priority": "medium"}]