# 推拿预约小程序数据库设计文档

## 一、数据库总体设计

### 1.1 数据库选型
- **主数据库**：SQLite（轻量级嵌入式数据库，适合小程序后端）
- **缓存**：内存缓存或 SQLite 内存模式

### 1.2 设计原则
- 遵循三范式，适当反范式优化查询性能
- 利用 SQLite 的轻量级特性，简化部署
- 所有表都包含基础字段：id, created_at, updated_at, deleted_at
- 使用 INTEGER PRIMARY KEY 作为自增主键

## 二、数据表设计

### 2.1 用户相关表

#### users（用户表）
```sql
CREATE TABLE users (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  openid TEXT NOT NULL UNIQUE,
  unionid TEXT,
  nickname TEXT,
  avatar TEXT,
  phone TEXT,
  gender INTEGER DEFAULT 0, -- 0-未知，1-男，2-女
  birthday DATE,
  member_level INTEGER DEFAULT 1,
  points INTEGER DEFAULT 0,
  balance REAL DEFAULT 0.00,
  status INTEGER DEFAULT 1, -- 1-正常，0-禁用
  last_login_at DATETIME,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  deleted_at DATETIME
);

CREATE INDEX idx_users_phone ON users(phone);
CREATE INDEX idx_users_unionid ON users(unionid);
```

#### user_addresses（用户地址表）
```sql
CREATE TABLE `user_addresses` (
  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT,
  `user_id` bigint(20) unsigned NOT NULL COMMENT '用户ID',
  `contact_name` varchar(50) NOT NULL COMMENT '联系人姓名',
  `contact_phone` varchar(20) NOT NULL COMMENT '联系人电话',
  `province` varchar(50) NOT NULL COMMENT '省',
  `city` varchar(50) NOT NULL COMMENT '市',
  `district` varchar(50) NOT NULL COMMENT '区',
  `address` varchar(255) NOT NULL COMMENT '详细地址',
  `latitude` decimal(10,6) DEFAULT NULL COMMENT '纬度',
  `longitude` decimal(10,6) DEFAULT NULL COMMENT '经度',
  `is_default` tinyint(1) DEFAULT 0 COMMENT '是否默认地址',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户地址表';
```

### 2.2 门店相关表

#### stores（门店表）
```sql
CREATE TABLE `stores` (
  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '门店ID',
  `store_code` varchar(50) NOT NULL COMMENT '门店编码',
  `name` varchar(100) NOT NULL COMMENT '门店名称',
  `cover_image` varchar(255) DEFAULT NULL COMMENT '门店封面图',
  `images` text COMMENT '门店图片（JSON数组）',
  `phone` varchar(20) NOT NULL COMMENT '联系电话',
  `province` varchar(50) NOT NULL COMMENT '省',
  `city` varchar(50) NOT NULL COMMENT '市',
  `district` varchar(50) NOT NULL COMMENT '区',
  `address` varchar(255) NOT NULL COMMENT '详细地址',
  `latitude` decimal(10,6) NOT NULL COMMENT '纬度',
  `longitude` decimal(10,6) NOT NULL COMMENT '经度',
  `business_hours` varchar(50) NOT NULL COMMENT '营业时间',
  `parking_info` varchar(255) DEFAULT NULL COMMENT '停车信息',
  `transport_info` text COMMENT '交通信息',
  `facilities` text COMMENT '设施信息（JSON数组）',
  `introduction` text COMMENT '门店介绍',
  `status` tinyint(1) DEFAULT 1 COMMENT '状态：1-营业中，2-休息中，0-已关闭',
  `sort_order` int(11) DEFAULT 0 COMMENT '排序权重',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `deleted_at` datetime DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_store_code` (`store_code`),
  KEY `idx_status` (`status`),
  KEY `idx_location` (`latitude`, `longitude`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='门店表';
```

#### therapists（推拿师表）
```sql
CREATE TABLE `therapists` (
  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '推拿师ID',
  `store_id` bigint(20) unsigned NOT NULL COMMENT '所属门店ID',
  `employee_no` varchar(50) NOT NULL COMMENT '工号',
  `name` varchar(50) NOT NULL COMMENT '姓名',
  `avatar` varchar(255) DEFAULT NULL COMMENT '头像',
  `gender` tinyint(1) NOT NULL COMMENT '性别：1-男，2-女',
  `phone` varchar(20) DEFAULT NULL COMMENT '电话',
  `specialties` varchar(255) DEFAULT NULL COMMENT '擅长项目（逗号分隔）',
  `introduction` text COMMENT '个人介绍',
  `certificates` text COMMENT '资质证书（JSON数组）',
  `working_years` int(11) DEFAULT 0 COMMENT '从业年限',
  `service_count` int(11) DEFAULT 0 COMMENT '服务次数',
  `rating` decimal(2,1) DEFAULT 5.0 COMMENT '评分',
  `status` tinyint(1) DEFAULT 1 COMMENT '状态：1-在职，2-休息，0-离职',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `deleted_at` datetime DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_employee_no` (`employee_no`),
  KEY `idx_store_id` (`store_id`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='推拿师表';
```

#### services（服务项目表）
```sql
CREATE TABLE `services` (
  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '服务ID',
  `category_id` bigint(20) unsigned DEFAULT NULL COMMENT '分类ID',
  `name` varchar(100) NOT NULL COMMENT '服务名称',
  `description` text COMMENT '服务描述',
  `duration` int(11) NOT NULL COMMENT '服务时长（分钟）',
  `price` decimal(10,2) NOT NULL COMMENT '原价',
  `member_price` decimal(10,2) DEFAULT NULL COMMENT '会员价',
  `image` varchar(255) DEFAULT NULL COMMENT '服务图片',
  `benefits` text COMMENT '功效说明',
  `notice` text COMMENT '注意事项',
  `status` tinyint(1) DEFAULT 1 COMMENT '状态：1-上架，0-下架',
  `sort_order` int(11) DEFAULT 0 COMMENT '排序',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_category_id` (`category_id`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='服务项目表';
```

### 2.3 预约相关表

#### appointments（预约表）
```sql
CREATE TABLE `appointments` (
  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '预约ID',
  `appointment_no` varchar(50) NOT NULL COMMENT '预约编号',
  `user_id` bigint(20) unsigned NOT NULL COMMENT '用户ID',
  `store_id` bigint(20) unsigned NOT NULL COMMENT '门店ID',
  `therapist_id` bigint(20) unsigned NOT NULL COMMENT '推拿师ID',
  `service_id` bigint(20) unsigned NOT NULL COMMENT '服务ID',
  `appointment_date` date NOT NULL COMMENT '预约日期',
  `appointment_time` time NOT NULL COMMENT '预约时间',
  `duration` int(11) NOT NULL COMMENT '服务时长（分钟）',
  `price` decimal(10,2) NOT NULL COMMENT '实付金额',
  `original_price` decimal(10,2) NOT NULL COMMENT '原价',
  `discount_amount` decimal(10,2) DEFAULT 0.00 COMMENT '优惠金额',
  `coupon_id` bigint(20) unsigned DEFAULT NULL COMMENT '使用的优惠券ID',
  `status` tinyint(2) NOT NULL DEFAULT 1 COMMENT '状态：1-待支付，2-已支付，3-进行中，4-已完成，5-已取消，6-已退款',
  `payment_method` varchar(20) DEFAULT NULL COMMENT '支付方式',
  `payment_time` datetime DEFAULT NULL COMMENT '支付时间',
  `service_time` datetime DEFAULT NULL COMMENT '开始服务时间',
  `finish_time` datetime DEFAULT NULL COMMENT '完成时间',
  `cancel_time` datetime DEFAULT NULL COMMENT '取消时间',
  `cancel_reason` varchar(255) DEFAULT NULL COMMENT '取消原因',
  `remark` varchar(500) DEFAULT NULL COMMENT '备注',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_appointment_no` (`appointment_no`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_store_id` (`store_id`),
  KEY `idx_therapist_id` (`therapist_id`),
  KEY `idx_appointment_date` (`appointment_date`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='预约表';
```

#### therapist_schedules（推拿师排班表）
```sql
CREATE TABLE `therapist_schedules` (
  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT,
  `therapist_id` bigint(20) unsigned NOT NULL COMMENT '推拿师ID',
  `schedule_date` date NOT NULL COMMENT '排班日期',
  `start_time` time NOT NULL COMMENT '开始时间',
  `end_time` time NOT NULL COMMENT '结束时间',
  `break_start` time DEFAULT NULL COMMENT '休息开始时间',
  `break_end` time DEFAULT NULL COMMENT '休息结束时间',
  `status` tinyint(1) DEFAULT 1 COMMENT '状态：1-正常，0-请假',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_therapist_date` (`therapist_id`, `schedule_date`),
  KEY `idx_schedule_date` (`schedule_date`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='推拿师排班表';
```

### 2.4 营销相关表

#### coupons（优惠券表）
```sql
CREATE TABLE `coupons` (
  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '优惠券ID',
  `name` varchar(100) NOT NULL COMMENT '优惠券名称',
  `type` tinyint(2) NOT NULL COMMENT '类型：1-满减券，2-折扣券，3-代金券',
  `value` decimal(10,2) NOT NULL COMMENT '优惠值（金额或折扣）',
  `min_amount` decimal(10,2) DEFAULT 0.00 COMMENT '最低使用金额',
  `applicable_services` text COMMENT '适用服务（JSON数组，null表示全部）',
  `applicable_stores` text COMMENT '适用门店（JSON数组，null表示全部）',
  `total_quantity` int(11) DEFAULT NULL COMMENT '发放总量',
  `received_quantity` int(11) DEFAULT 0 COMMENT '已领取数量',
  `used_quantity` int(11) DEFAULT 0 COMMENT '已使用数量',
  `per_user_limit` int(11) DEFAULT 1 COMMENT '每人限领数量',
  `valid_type` tinyint(1) NOT NULL COMMENT '有效期类型：1-固定日期，2-领取后N天',
  `valid_days` int(11) DEFAULT NULL COMMENT '有效天数（当valid_type=2时）',
  `valid_start` datetime DEFAULT NULL COMMENT '有效期开始（当valid_type=1时）',
  `valid_end` datetime DEFAULT NULL COMMENT '有效期结束（当valid_type=1时）',
  `status` tinyint(1) DEFAULT 1 COMMENT '状态：1-启用，0-禁用',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_status` (`status`),
  KEY `idx_valid_end` (`valid_end`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='优惠券表';
```

#### user_coupons（用户优惠券表）
```sql
CREATE TABLE `user_coupons` (
  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT,
  `user_id` bigint(20) unsigned NOT NULL COMMENT '用户ID',
  `coupon_id` bigint(20) unsigned NOT NULL COMMENT '优惠券ID',
  `coupon_code` varchar(50) NOT NULL COMMENT '优惠券码',
  `status` tinyint(1) NOT NULL DEFAULT 1 COMMENT '状态：1-未使用，2-已使用，3-已过期',
  `received_at` datetime NOT NULL COMMENT '领取时间',
  `used_at` datetime DEFAULT NULL COMMENT '使用时间',
  `expired_at` datetime NOT NULL COMMENT '过期时间',
  `used_order_id` bigint(20) unsigned DEFAULT NULL COMMENT '使用的订单ID',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_coupon_code` (`coupon_code`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_coupon_id` (`coupon_id`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户优惠券表';
```

### 2.5 评价相关表

#### reviews（评价表）
```sql
CREATE TABLE `reviews` (
  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '评价ID',
  `appointment_id` bigint(20) unsigned NOT NULL COMMENT '预约ID',
  `user_id` bigint(20) unsigned NOT NULL COMMENT '用户ID',
  `store_id` bigint(20) unsigned NOT NULL COMMENT '门店ID',
  `therapist_id` bigint(20) unsigned NOT NULL COMMENT '推拿师ID',
  `service_id` bigint(20) unsigned NOT NULL COMMENT '服务ID',
  `rating` tinyint(1) NOT NULL COMMENT '评分（1-5）',
  `service_rating` tinyint(1) DEFAULT NULL COMMENT '服务态度评分',
  `skill_rating` tinyint(1) DEFAULT NULL COMMENT '专业技能评分',
  `environment_rating` tinyint(1) DEFAULT NULL COMMENT '环境评分',
  `content` text COMMENT '评价内容',
  `images` text COMMENT '评价图片（JSON数组）',
  `is_anonymous` tinyint(1) DEFAULT 0 COMMENT '是否匿名',
  `reply_content` text COMMENT '商家回复',
  `reply_time` datetime DEFAULT NULL COMMENT '回复时间',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_appointment_id` (`appointment_id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_store_id` (`store_id`),
  KEY `idx_therapist_id` (`therapist_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='评价表';
```

## 三、索引优化策略

### 3.1 查询优化索引
```sql
-- 门店距离查询优化
ALTER TABLE stores ADD SPATIAL INDEX `spatial_location` (`latitude`, `longitude`);

-- 预约查询优化
ALTER TABLE appointments ADD INDEX `idx_user_status_date` (`user_id`, `status`, `appointment_date`);
ALTER TABLE appointments ADD INDEX `idx_therapist_date_status` (`therapist_id`, `appointment_date`, `status`);

-- 推拿师查询优化
ALTER TABLE therapists ADD INDEX `idx_store_status_rating` (`store_id`, `status`, `rating`);
```

### 3.2 统计查询优化
```sql
-- 创建汇总表用于统计
CREATE TABLE `daily_statistics` (
  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT,
  `date` date NOT NULL COMMENT '统计日期',
  `store_id` bigint(20) unsigned NOT NULL COMMENT '门店ID',
  `appointment_count` int(11) DEFAULT 0 COMMENT '预约数',
  `completed_count` int(11) DEFAULT 0 COMMENT '完成数',
  `cancel_count` int(11) DEFAULT 0 COMMENT '取消数',
  `total_amount` decimal(12,2) DEFAULT 0.00 COMMENT '总金额',
  `new_user_count` int(11) DEFAULT 0 COMMENT '新用户数',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_date_store` (`date`, `store_id`),
  KEY `idx_date` (`date`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='每日统计表';
```

## 四、数据库维护计划

### 4.1 备份策略
- 全量备份：每天凌晨2点
- 增量备份：每4小时一次
- binlog：实时同步到备份服务器

### 4.2 归档策略
- 预约数据：6个月后归档到历史表
- 日志数据：3个月后归档到 MongoDB
- 统计数据：永久保留

### 4.3 性能监控
- 慢查询日志：记录超过1秒的查询
- 定期分析表：每周执行 ANALYZE TABLE
- 索引使用率监控：每月评估索引效率

## 五、Redis 缓存设计

### 5.1 缓存策略
```
# 用户信息缓存
user:{userId} -> User对象, TTL: 1小时

# 门店信息缓存
store:{storeId} -> Store对象, TTL: 6小时

# 附近门店缓存
nearby:stores:{lat}:{lng}:{radius} -> Store列表, TTL: 10分钟

# 推拿师排班缓存
schedule:{therapistId}:{date} -> Schedule对象, TTL: 30分钟

# 热门服务缓存
hot:services -> Service列表, TTL: 1小时
```

### 5.2 分布式锁
```
# 预约锁，防止重复预约
lock:appointment:{therapistId}:{date}:{time} -> 1, TTL: 5秒

# 库存锁，防止超售
lock:coupon:{couponId} -> 1, TTL: 5秒
```

## 六、数据安全措施

### 6.1 敏感数据加密
- 用户手机号：AES 加密存储
- 支付信息：不存储，仅保存交易号
- 密码信息：不适用（使用微信授权）

### 6.2 数据脱敏
- 日志记录：手机号中间4位脱敏
- 数据导出：敏感信息自动脱敏

### 6.3 访问控制
- 数据库用户权限最小化
- 应用使用专用数据库账号
- 定期更换数据库密码