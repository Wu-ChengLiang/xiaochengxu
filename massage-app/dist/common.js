"use strict";var e=Object.defineProperty,t=Object.defineProperties,r=Object.getOwnPropertyDescriptors,a=Object.getOwnPropertySymbols,n=Object.prototype.hasOwnProperty,o=Object.prototype.propertyIsEnumerable,s=(t,r,a)=>r in t?e(t,r,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[r]=a,i=(e,t)=>{for(var r in t||(t={}))n.call(t,r)&&s(e,r,t[r]);if(a)for(var r of a(t))o.call(t,r)&&s(e,r,t[r]);return e},c=(e,a)=>t(e,r(a)),l=(e,t,r)=>new Promise((a,n)=>{var o=e=>{try{i(r.next(e))}catch(t){n(t)}},s=e=>{try{i(r.throw(e))}catch(t){n(t)}},i=e=>e.done?a(e.value):Promise.resolve(e.value).then(o,s);i((r=r.apply(e,t)).next())});const d=require("./taro.js"),u={baseURL:"https://mingyitang1024.com/api/v2",timeout:1e4,retry:3},p={SUCCESS:0,PARAM_ERROR:1001,INVALID_INPUT:1002,NOT_FOUND:1003,DUPLICATE:1004,INVALID_STATE:1005,OPERATION_FAILED:1006,INSUFFICIENT_BALANCE:1007,QUOTA_EXCEEDED:1008,INVALID_PHONE:1009,USER_NOT_FOUND:1010,UNAUTHORIZED:2001,FORBIDDEN:2002,TOKEN_EXPIRED:2003,INVALID_TOKEN:2004,SESSION_EXPIRED:2005,INTERNAL_ERROR:3001,SERVICE_UNAVAILABLE:3002,DATABASE_ERROR:3003,EXTERNAL_API_ERROR:3004,PAYMENT_ERROR:4001,PAYMENT_TIMEOUT:4002,SMS_ERROR:4003,WECHAT_ERROR:4004},h={[p.SUCCESS]:"\u64cd\u4f5c\u6210\u529f",[p.PARAM_ERROR]:"\u53c2\u6570\u9519\u8bef\uff0c\u8bf7\u68c0\u67e5\u8f93\u5165",[p.INVALID_INPUT]:"\u8f93\u5165\u683c\u5f0f\u4e0d\u6b63\u786e",[p.NOT_FOUND]:"\u8bf7\u6c42\u7684\u8d44\u6e90\u4e0d\u5b58\u5728",[p.DUPLICATE]:"\u64cd\u4f5c\u91cd\u590d\uff0c\u8bf7\u52ff\u91cd\u590d\u63d0\u4ea4",[p.INVALID_STATE]:"\u5f53\u524d\u72b6\u6001\u4e0d\u5141\u8bb8\u6b64\u64cd\u4f5c",[p.OPERATION_FAILED]:"\u64cd\u4f5c\u5931\u8d25\uff0c\u8bf7\u91cd\u8bd5",[p.INSUFFICIENT_BALANCE]:"\u4f59\u989d\u4e0d\u8db3\uff0c\u8bf7\u5145\u503c",[p.QUOTA_EXCEEDED]:"\u8d85\u51fa\u914d\u989d\u9650\u5236",[p.INVALID_PHONE]:"\u624b\u673a\u53f7\u683c\u5f0f\u4e0d\u6b63\u786e",[p.USER_NOT_FOUND]:"\u7528\u6237\u4e0d\u5b58\u5728",[p.UNAUTHORIZED]:"\u8bf7\u5148\u767b\u5f55",[p.FORBIDDEN]:"\u60a8\u65e0\u6743\u6267\u884c\u6b64\u64cd\u4f5c",[p.TOKEN_EXPIRED]:"\u767b\u5f55\u5df2\u8fc7\u671f\uff0c\u8bf7\u91cd\u65b0\u767b\u5f55",[p.INVALID_TOKEN]:"\u65e0\u6548\u7684\u767b\u5f55\u72b6\u6001",[p.SESSION_EXPIRED]:"\u4f1a\u8bdd\u5df2\u8fc7\u671f\uff0c\u8bf7\u91cd\u65b0\u767b\u5f55",[p.INTERNAL_ERROR]:"\u670d\u52a1\u5668\u9519\u8bef\uff0c\u8bf7\u7a0d\u540e\u91cd\u8bd5",[p.SERVICE_UNAVAILABLE]:"\u670d\u52a1\u7ef4\u62a4\u4e2d\uff0c\u8bf7\u7a0d\u540e\u91cd\u8bd5",[p.DATABASE_ERROR]:"\u6570\u636e\u5e93\u9519\u8bef\uff0c\u8bf7\u7a0d\u540e\u91cd\u8bd5",[p.EXTERNAL_API_ERROR]:"\u7b2c\u4e09\u65b9\u670d\u52a1\u5f02\u5e38\uff0c\u8bf7\u7a0d\u540e\u91cd\u8bd5",[p.PAYMENT_ERROR]:"\u652f\u4ed8\u5931\u8d25\uff0c\u8bf7\u91cd\u8bd5",[p.PAYMENT_TIMEOUT]:"\u652f\u4ed8\u8d85\u65f6\uff0c\u8bf7\u91cd\u65b0\u652f\u4ed8",[p.SMS_ERROR]:"\u77ed\u4fe1\u53d1\u9001\u5931\u8d25\uff0c\u8bf7\u7a0d\u540e\u91cd\u8bd5",[p.WECHAT_ERROR]:"\u5fae\u4fe1\u63a5\u53e3\u5f02\u5e38\uff0c\u8bf7\u7a0d\u540e\u91cd\u8bd5"};function m(e,t){return h[e]||t||"\u64cd\u4f5c\u5931\u8d25\uff0c\u8bf7\u7a0d\u540e\u91cd\u8bd5"}function g(e){return[p.UNAUTHORIZED,p.TOKEN_EXPIRED,p.INVALID_TOKEN,p.SESSION_EXPIRED].includes(e)}function y(e){return l(this,arguments,function*(e,t={}){const{method:r="GET",data:a,header:n={},showLoading:o=!1,loadingTitle:s="\u52a0\u8f7d\u4e2d..."}=t;o&&d.Taro.showLoading({title:s,mask:!0});try{const t=yield d.Taro.request({url:`${u.baseURL}${e}`,method:r,data:a,header:i({"Content-Type":"application/json"},n),timeout:u.timeout});o&&d.Taro.hideLoading();const s=t.data;if(s.code!==p.SUCCESS){console.error(`API\u4e1a\u52a1\u9519\u8bef: ${e}`,{code:s.code,message:s.message,data:s}),g(s.code)&&(console.warn("\u8ba4\u8bc1\u8fc7\u671f\uff0c\u8df3\u8f6c\u5230\u767b\u5f55\u9875"),d.Taro.removeStorageSync("userInfo"),d.Taro.removeStorageSync("userToken"));const r=m(s.code,s.message),a=new Error(r);throw a.code=s.code,a.response={status:t.statusCode,data:s},a}return s}catch(c){throw o&&d.Taro.hideLoading(),console.error(`API\u7f51\u7edc\u9519\u8bef: ${e}`,c),c}})}const x=(e,t,r)=>{const a=t?"?"+Object.keys(t).filter(e=>void 0!==t[e]&&null!==t[e]).map(e=>`${e}=${encodeURIComponent(t[e])}`).join("&"):"";return y(e+a,c(i({},r),{method:"GET"}))},f=(e,t,r)=>y(e,c(i({},r),{method:"POST",data:t})),I="https://mingyitang1024.com/static",S={baseUrl:I,giftCard:{member:`${I}/card/member-card.png`,electronic:`${I}/card/gift-card.png`},product:{},banners:{goodnight:""},therapists:{baseUrl:`${I}/therapists/\u8001\u5e08\u6536\u96c6\u4e2d\u6587\u539f\u7248`},default:`${I}/default.png`},w=()=>{try{const e=d.Taro.getStorageSync("userInfo");return e||null}catch(e){return console.error("\u83b7\u53d6\u7528\u6237\u4fe1\u606f\u5931\u8d25:",e),null}},E=()=>{const e=w();return(null==e?void 0:e.id)||1},N=()=>{const e=w();return(null==e?void 0:e.phone)||"13800138000"},T=e=>{try{d.Taro.setStorageSync("userInfo",e)}catch(t){console.error("\u8bbe\u7f6e\u7528\u6237\u4fe1\u606f\u5931\u8d25:",t)}},v=e=>e?e.replace(/(\d{3})\d{4}(\d{4})/,"$1****$2"):"\u672a\u8bbe\u7f6e",R=()=>l(exports,null,function*(){try{const{code:e}=yield d.Taro.login(),t=yield f("/users/wechat-login",{code:e});if(t.data)return t.data.userInfo&&!t.data.needBindPhone&&T(t.data.userInfo),t.data;throw new Error("\u5fae\u4fe1\u767b\u5f55\u5931\u8d25\uff1a\u8fd4\u56de\u6570\u636e\u5f02\u5e38")}catch(e){throw console.error("\u5fae\u4fe1\u767b\u5f55\u5931\u8d25:",e),e}}),j=e=>l(exports,null,function*(){try{if(!e){const t=w();e=null==t?void 0:t.phone}if(!e)return console.warn("\u65e0\u6cd5\u83b7\u53d6\u7528\u6237\u4fe1\u606f\uff1a\u7f3a\u5c11\u624b\u673a\u53f7"),null;const t=yield x(`/users/info?phone=${e}`);if(t.data){const e={id:t.data.id,phone:t.data.phone,username:t.data.username,nickname:t.data.nickname,avatar:t.data.avatar,openid:t.data.openid,membershipNumber:t.data.membershipNumber,memberLevel:t.data.memberLevel,balance:t.data.balance,totalSpent:t.data.totalSpent,totalVisits:t.data.totalVisits,discountRate:t.data.discount_rate||t.data.discountRate};return T(e),e}return null}catch(t){return console.error("\u83b7\u53d6\u7528\u6237\u4fe1\u606f\u5931\u8d25:",t),null}}),A=()=>l(exports,null,function*(){try{const e=w();if(e&&e.phone){const t=yield j(e.phone);return t||e}const t=yield R();return!t.needBindPhone&&t.userInfo?t.userInfo:null}catch(e){return console.error("\u81ea\u52a8\u767b\u5f55\u5931\u8d25:",e),null}}),P=[{id:"member-card",type:"member",name:"\u4f1a\u5458\u793c\u5361",image:S.giftCard.member,description:"\u5c0a\u4eab\u4f1a\u5458\u4e13\u5c5e\u4f18\u60e0",features:["\u5168\u95e8\u5e97\u901a\u7528","\u957f\u671f\u6709\u6548","\u53ef\u7d2f\u8ba1\u79ef\u5206","\u4eab\u53d7\u4f1a\u5458\u4ef7"],terms:"\u672c\u5361\u4e3a\u4e0d\u8bb0\u540d\u5361\u7247\uff0c\u8bf7\u59a5\u5584\u4fdd\u7ba1"},{id:"electronic-card",type:"electronic",name:"\u7535\u5b50\u793c\u5361",image:S.giftCard.electronic,description:"\u4fbf\u6377\u7684\u7535\u5b50\u793c\u54c1\u5361",features:["\u5373\u4e70\u5373\u7528","\u53ef\u8f6c\u8d60\u597d\u53cb","\u7ebf\u4e0a\u8d2d\u4e70","\u626b\u7801\u4f7f\u7528"],terms:"\u7535\u5b50\u5361\u6709\u6548\u671f\u4e3a\u8d2d\u4e70\u4e4b\u65e5\u8d77\u4e00\u5e74\u5185"}],D=[{id:"nuantie-waist",name:"\u8572\u827e\u8170\u8179\u6696\u8d34",image:"https://mingyitang1024.com/static/gift/product/nuantie/yaofu.jpg",price:9900,originalPrice:9900,unit:"\u8d34",description:"\u81ea\u53d1\u70ed\u827e\u8349\u6696\u62a4\u8170\u8d34",features:[],specifications:{}},{id:"nuantie-knee",name:"\u8572\u827e\u62a4\u819d\u6696\u8d34",image:"https://mingyitang1024.com/static/gift/product/nuantie/huxi.jpg",price:9900,originalPrice:9900,unit:"\u8d34",description:"\u81ea\u53d1\u70ed\u827e\u8349\u62a4\u819d \u9a71\u5bd2\u4fdd\u6696",features:[],specifications:{}},{id:"nuantie-moxa",name:"\u8572\u827e\u7078\u8d34",image:"https://mingyitang1024.com/static/gift/product/nuantie/xinai.jpg",price:9900,originalPrice:9900,unit:"\u8d34",description:"\u81ea\u53d1\u70ed\u827e\u8349\u7cbe\u6cb9\u7a74\u4f4d\u7078\u8d34",features:[],specifications:{}}],b=[{id:"aijiu-stick",name:"\u8572\u827e\u6761",image:"https://mingyitang1024.com/static/gift/product/aijiu/xinaitiao.jpg",price:9900,originalPrice:9900,unit:"\u6761",description:"\u827e\u7078\u827e\u6761 3\u5e74\u9648\u827e",features:[],specifications:{}},{id:"aijiu-moxa-ball",name:"\u8572\u827e\u997c",image:"https://mingyitang1024.com/static/gift/product/aijiu/xinaibing.jpg",price:9900,originalPrice:9900,unit:"\u997c",description:"\u9053\u5730\u8572\u827e\u6ce1\u811a\u6ce1\u6fa1\u827e\u8349\u997c",features:[],specifications:{}},{id:"aijiu-column",name:"\u65b0\u827e\u67f1",image:"https://mingyitang1024.com/static/gift/product/aijiu/xinaizhu.jpg",price:9900,originalPrice:9900,unit:"\u67f1",description:"\u674e\u65f6\u73cd\u6545\u91cc\u7279\u4ea7\u65b0\u827e\u67f1",features:[],specifications:{}}],O=[...D,...b];class ${static getAllGiftCards(){return P}static getGiftCardById(e){return P.find(t=>t.id===e)}static getAllProducts(){return O}static getProductById(e){return O.find(t=>t.id===e)}static getNuantieProducts(){return D}static getAijiuProducts(){return b}static createGiftCardOrder(e){return l(this,null,function*(){try{const t=E(),r={orderType:"product",userId:t,title:`\u7535\u5b50\u793c\u5361 \xa5${(e.amount/100).toFixed(2)}`,amount:e.amount*e.quantity,paymentMethod:e.paymentMethod,extraData:{productType:"gift_card",productId:e.cardId,productName:"\u7535\u5b50\u793c\u5361",quantity:e.quantity,cardType:"electronic",faceValue:e.amount,customMessage:e.customMessage||"\u4e16\u754c\u4e0a\u6700\u597d\u7684\u7238\u7238"}};console.log("\ud83c\udf81 \u521b\u5efa\u793c\u5361\u8ba2\u5355"),console.log("\ud83d\udc64 \u5f53\u524d\u7528\u6237ID:",t),console.log("\ud83d\udce6 \u8ba2\u5355\u6570\u636e:",{orderType:r.orderType,userId:r.userId,title:r.title,amount:`${r.amount}\u5206 (\xa5${(r.amount/100).toFixed(2)})`,paymentMethod:r.paymentMethod,extraData:r.extraData});const a=yield f("/orders/create",r,{showLoading:!0,loadingTitle:"\u521b\u5efa\u8ba2\u5355\u4e2d..."});return console.log("\u2705 \u793c\u5361\u8ba2\u5355\u521b\u5efa\u6210\u529f"),console.log("\ud83d\udccb \u8ba2\u5355\u54cd\u5e94:",{orderNo:a.data.orderNo,amount:`${a.data.amount}\u5206 (\xa5${(a.data.amount/100).toFixed(2)})`,paymentStatus:a.data.paymentStatus,hasWxPayParams:!!a.data.wxPayParams}),a.data}catch(t){throw console.error("\u274c \u521b\u5efa\u793c\u5361\u8ba2\u5355\u5931\u8d25:",t),new Error(t.message||"\u521b\u5efa\u793c\u5361\u8ba2\u5355\u5931\u8d25")}})}static createProductOrder(e){return l(this,null,function*(){try{const t=this.getProductById(e.productId);if(!t)throw new Error("\u5546\u54c1\u4e0d\u5b58\u5728");const r={orderType:"product",userId:E(),title:t.name,amount:t.price*e.quantity,paymentMethod:e.paymentMethod,extraData:{productType:"merchandise",productId:e.productId,productName:t.name,quantity:e.quantity,specifications:t.specifications}};console.log("\ud83d\udce6 \u521b\u5efa\u5546\u54c1\u8ba2\u5355"),console.log("\ud83d\udc64 \u5f53\u524d\u7528\u6237ID:",E()),console.log("\ud83d\udccb \u8ba2\u5355\u6570\u636e:",{orderType:r.orderType,userId:r.userId,title:r.title,amount:`${r.amount}\u5206 (\xa5${(r.amount/100).toFixed(2)})`,paymentMethod:r.paymentMethod,extraData:r.extraData});const a=yield f("/orders/create",r,{showLoading:!0,loadingTitle:"\u521b\u5efa\u8ba2\u5355\u4e2d..."});return console.log("\u2705 \u5546\u54c1\u8ba2\u5355\u521b\u5efa\u6210\u529f"),console.log("\ud83d\udccb \u8ba2\u5355\u54cd\u5e94:",{orderNo:a.data.orderNo,amount:`${a.data.amount}\u5206 (\xa5${(a.data.amount/100).toFixed(2)})`,paymentStatus:a.data.paymentStatus,hasWxPayParams:!!a.data.wxPayParams}),a.data}catch(t){throw console.error("\u274c \u521b\u5efa\u5546\u54c1\u8ba2\u5355\u5931\u8d25:",t),new Error(t.message||"\u521b\u5efa\u5546\u54c1\u8ba2\u5355\u5931\u8d25")}})}}class M{constructor(){this.config={useMockPayment:!1,enableBalancePayment:!0,enableWechatPayment:!0}}pay(e){return l(this,null,function*(){const{paymentMethod:t}=e;if("balance"===t)return this.payWithBalance(e);if("wechat"===t)return this.payWithWechat(e);throw new Error("\u4e0d\u652f\u6301\u7684\u652f\u4ed8\u65b9\u5f0f")})}payWithBalance(e){return l(this,null,function*(){try{d.Taro.showLoading({title:"\u652f\u4ed8\u4e2d..."}),console.log("\ud83d\udcb0 \u4f59\u989d\u652f\u4ed8\u8bf7\u6c42\u53c2\u6570:",{orderNo:e.orderNo,paymentMethod:"balance"});const t=yield f("/orders/pay",{orderNo:e.orderNo,paymentMethod:"balance"});if(console.log("\ud83d\udcb0 \u4f59\u989d\u652f\u4ed8\u54cd\u5e94:",t),d.Taro.hideLoading(),0===t.code){const e=(t.data.balance||0)/100;return d.Taro.showToast({title:`\u652f\u4ed8\u6210\u529f\n\u4f59\u989d\uff1a\xa5${e.toFixed(2)}`,icon:"success",duration:2e3}),!0}throw new Error(t.message||"\u4f59\u989d\u4e0d\u8db3")}catch(t){return console.error("\ud83d\udcb0 \u4f59\u989d\u652f\u4ed8\u5931\u8d25:",t),console.error("\ud83d\udcb0 \u9519\u8bef\u8be6\u60c5:",t.response||t.message),d.Taro.hideLoading(),d.Taro.showToast({title:t.message||"\u652f\u4ed8\u5931\u8d25",icon:"none"}),!1}})}payWithWechat(e){return l(this,null,function*(){var t,r;try{console.log("\ud83d\udcb3 \u5f00\u59cb\u771f\u5b9e\u5fae\u4fe1\u652f\u4ed8\uff0c\u8ba2\u5355\u53f7:",e.orderNo);const a=e.wxPayParams;if(!a)throw new Error("\u7f3a\u5c11\u5fae\u4fe1\u652f\u4ed8\u53c2\u6570\uff0c\u8bf7\u5148\u521b\u5efa\u8ba2\u5355");const n=["timeStamp","nonceStr","package","signType","paySign"],o=n.filter(e=>!a[e]);if(o.length>0)throw console.error("\u274c \u5fae\u4fe1\u652f\u4ed8\u53c2\u6570\u4e0d\u5b8c\u6574\uff0c\u7f3a\u5c11\u5b57\u6bb5:",o),new Error(`\u5fae\u4fe1\u652f\u4ed8\u53c2\u6570\u7f3a\u5931: ${o.join(", ")}`);return console.log("\ud83d\udcb3 \u5fae\u4fe1\u652f\u4ed8\u53c2\u6570:",{timeStamp:a.timeStamp,nonceStr:(null==(t=a.nonceStr)?void 0:t.substring(0,8))+"...",package:a.package,signType:a.signType,paySign:(null==(r=a.paySign)?void 0:r.substring(0,16))+"..."}),yield d.Taro.requestPayment({timeStamp:a.timeStamp,nonceStr:a.nonceStr,package:a.package,signType:a.signType,paySign:a.paySign}),console.log("\ud83d\udcb3 \u7528\u6237\u5b8c\u6210\u652f\u4ed8\uff0c\u7b49\u5f85\u5fae\u4fe1\u56de\u8c03\u540e\u7aef\u66f4\u65b0\u8ba2\u5355\u72b6\u6001"),d.Taro.showToast({title:"\u652f\u4ed8\u6210\u529f",icon:"success"}),!0}catch(a){if("requestPayment:fail cancel"===a.errMsg)return console.log("\ud83d\udcb3 \u7528\u6237\u53d6\u6d88\u652f\u4ed8"),!1;throw console.error("\ud83d\udcb3 \u5fae\u4fe1\u652f\u4ed8\u5931\u8d25:",a),console.error("\ud83d\udcb3 \u9519\u8bef\u8be6\u60c5:",{errMsg:a.errMsg,errCode:a.errCode,message:a.message}),d.Taro.showToast({title:a.errMsg||a.message||"\u652f\u4ed8\u5931\u8d25",icon:"none",duration:3e3}),a}})}checkPaymentEnvironment(){return l(this,null,function*(){return{canUseWechatPay:this.config.enableWechatPayment,canUseBalance:this.config.enableBalancePayment,message:"\u652f\u6301\u5fae\u4fe1\u652f\u4ed8\u548c\u4f59\u989d\u652f\u4ed8"}})}generateRechargeCode(e){return l(this,null,function*(){const t=yield f("/recharge/generate-code",{amount:e});return t.data})}delay(e){return new Promise(t=>setTimeout(t,e))}}const V=new M,C=e=>{if(e)return e.startsWith("https://")?e:e.startsWith("http://")?e.replace("http://","https://"):e.startsWith("/")?`https://mingyitang1024.com${e}`:`https://mingyitang1024.com/static${e.startsWith("/")?e:"/"+e}`};class _{getUserInfo(){return{userId:E(),userPhone:N()}}getDisplayStatus(e){if("pending"===e.paymentStatus)return"pending";if("cancelled"===e.paymentStatus||"refunded"===e.paymentStatus)return e.paymentStatus;if("paid"===e.paymentStatus&&"service"===e.orderType){if(e.appointmentStatus)switch(e.appointmentStatus){case"completed":return"completed";case"serving":return"serving";case"cancelled":return"cancelled";case"pending":case"confirmed":default:return"paid"}if(e.appointmentDate&&e.startTime){const t=new Date(`${e.appointmentDate} ${e.startTime}`),r=new Date(t.getTime()+6e4*(e.duration||60)),a=new Date;if(r<a)return"paid"}}return e.paymentStatus}enrichOrderWithStoreAndTherapistInfo(e){return l(this,null,function*(){try{const t=[];e.storeId&&!e.storeName&&t.push(x(`/stores/${e.storeId}`).then(t=>{const r=t.data;e.storeName=r.name,e.storeAddress=r.address}).catch(t=>l(this,null,function*(){console.error(`\u83b7\u53d6\u95e8\u5e97\u4fe1\u606f\u5931\u8d25 (storeId: ${e.storeId}):`,t);const r=yield this.getDefaultStoreInfo();r?(e.storeName=`${r.name}\uff08\u66ff\u4ee3\u663e\u793a\uff09`,e.storeAddress=r.address):(e.storeName="\u95e8\u5e97\u4fe1\u606f\u6682\u65f6\u65e0\u6cd5\u83b7\u53d6",e.storeAddress="\u8bf7\u8054\u7cfb\u5ba2\u670d\u83b7\u53d6\u8be6\u60c5")}))),e.therapistId&&!e.therapistAvatar&&t.push(x(`/therapists/${e.therapistId}`).then(t=>{const r=t.data;e.therapistAvatar=r.avatar,e.therapistName||(e.therapistName=r.name)}).catch(t=>{console.error(`\u83b7\u53d6\u6280\u5e08\u4fe1\u606f\u5931\u8d25 (therapistId: ${e.therapistId}):`,t),e.therapistAvatar||(e.therapistAvatar="https://img.yzcdn.cn/vant/cat.jpeg")})),t.length>0&&(yield Promise.allSettled(t))}catch(t){console.error("\u8865\u5168\u8ba2\u5355\u4fe1\u606f\u5931\u8d25:",t)}})}getDefaultStoreInfo(){return l(this,null,function*(){var e,t;try{const r=yield x("/stores/nearby",{page:1,pageSize:1});if(null==(t=null==(e=r.data)?void 0:e.list)?void 0:t[0]){const e=r.data.list[0];return{name:e.name,address:e.address}}}catch(r){console.error("\u83b7\u53d6\u9ed8\u8ba4\u95e8\u5e97\u4fe1\u606f\u5931\u8d25:",r)}return null})}enrichOrderListWithStoreAndTherapistInfo(e){return l(this,null,function*(){try{const t=new Set,r=new Set;e.forEach(e=>{e.storeId&&!e.storeName&&t.add(e.storeId.toString()),e.therapistId&&!e.therapistAvatar&&r.add(e.therapistId.toString())});const a=[],n=new Map,o=new Map,s=new Set;Array.from(t).forEach(e=>{a.push(x(`/stores/${e}`).then(t=>{n.set(e,t.data)}).catch(t=>{console.warn(`\u95e8\u5e97\u4e0d\u5b58\u5728\uff0c\u5c06\u8fc7\u6ee4\u76f8\u5173\u8ba2\u5355 (storeId: ${e}):`,t.message),s.add(e)}))}),Array.from(r).forEach(e=>{a.push(x(`/therapists/${e}`).then(t=>{o.set(e,t.data)}).catch(t=>{console.error(`\u6279\u91cf\u83b7\u53d6\u6280\u5e08\u4fe1\u606f\u5931\u8d25 (therapistId: ${e}):`,t)}))}),a.length>0&&(yield Promise.allSettled(a));const i=e.filter(e=>!e.storeId||!s.has(e.storeId.toString())||(console.warn(`\u8fc7\u6ee4\u65e0\u6548\u8ba2\u5355: ${e.orderNo}\uff08\u95e8\u5e97 ${e.storeId} \u4e0d\u5b58\u5728\uff09`),!1));return i.forEach(e=>{if(e.storeId&&!e.storeName){const t=n.get(e.storeId.toString());t&&(e.storeName=t.name,e.storeAddress=t.address)}if(e.therapistId&&!e.therapistAvatar){const t=o.get(e.therapistId.toString());t?(e.therapistAvatar=t.avatar,e.therapistName||(e.therapistName=t.name)):e.therapistAvatar="https://img.yzcdn.cn/vant/cat.jpeg"}}),i}catch(t){return console.error("\u6279\u91cf\u8865\u5168\u8ba2\u5355\u5217\u8868\u4fe1\u606f\u5931\u8d25:",t),e}})}createAppointmentOrder(e){return l(this,null,function*(){try{const{userId:t,userPhone:r}=this.getUserInfo();console.log("\ud83d\udcdd \u521b\u5efa\u8ba2\u5355\u539f\u59cb\u53c2\u6570:",e),console.log("\ud83d\udcdd therapistId\u7c7b\u578b:",typeof e.therapistId,"\u503c:",e.therapistId);const a={therapistId:Number(e.therapistId),storeId:Number(e.storeId),userId:t,userPhone:r,appointmentDate:e.appointmentDate,startTime:e.appointmentTime,duration:e.duration||60,serviceId:e.serviceId,serviceName:e.serviceName,price:100*(e.discountPrice||e.price)};console.log("\ud83d\udce4 \u5b9e\u9645\u53d1\u9001\u7684\u8bf7\u6c42\u6570\u636e:",a),console.log("\ud83d\udce4 \u8f6c\u6362\u540e\u7684therapistId:",a.therapistId,"\u662f\u5426\u4e3aNaN:",isNaN(a.therapistId));const n=yield f("/appointments/create-with-order",a,{showLoading:!0,loadingTitle:"\u521b\u5efa\u8ba2\u5355\u4e2d..."}),o=c(i({},n.data.order),{therapistName:e.therapistName,therapistAvatar:e.therapistAvatar,serviceName:e.serviceName,duration:e.duration,appointmentDate:e.appointmentDate,startTime:e.appointmentTime});return{order:o,appointment:n.data.appointment}}catch(t){throw console.error("\u521b\u5efa\u8ba2\u5355\u5931\u8d25:",t),new Error(t.message||"\u521b\u5efa\u8ba2\u5355\u5931\u8d25")}})}getPaymentParams(e){return l(this,null,function*(){var t,r,a;try{const a=yield f("/orders/pay",{orderNo:e,paymentMethod:"wechat"});if(console.log("\ud83d\udcb3 \u540e\u7aef\u652f\u4ed8\u53c2\u6570\u54cd\u5e94:",a.data),a.data.wxPayParams){const e=a.data.wxPayParams;return!e.total_fee&&a.data.amount&&(e.total_fee=a.data.amount),console.log("\ud83d\udcb3 \u5fae\u4fe1\u652f\u4ed8\u53c2\u6570\u5df2\u63d0\u53d6:",{timeStamp:e.timeStamp,nonceStr:(null==(t=e.nonceStr)?void 0:t.substring(0,8))+"...",package:e.package,signType:e.signType,paySign:(null==(r=e.paySign)?void 0:r.substring(0,16))+"...",total_fee:e.total_fee}),e}throw new Error("\u540e\u7aef\u672a\u8fd4\u56de\u5fae\u4fe1\u652f\u4ed8\u53c2\u6570")}catch(n){throw console.error("\ud83d\udcb3 \u83b7\u53d6\u652f\u4ed8\u53c2\u6570\u5931\u8d25:",n),console.error("\ud83d\udcb3 \u9519\u8bef\u8be6\u60c5:",{message:n.message,response:null==(a=n.response)?void 0:a.data}),new Error("\u83b7\u53d6\u652f\u4ed8\u53c2\u6570\u5931\u8d25")}})}updateOrderStatus(e,t){return l(this,null,function*(){try{const t=yield f("/orders/pay",{orderNo:e,paymentMethod:"balance"});return{orderNo:e,paymentStatus:"paid",paidAt:t.data.paidAt||(new Date).toISOString()}}catch(t){throw console.error("\u66f4\u65b0\u8ba2\u5355\u72b6\u6001\u5931\u8d25:",t),new Error(t.message||"\u652f\u4ed8\u5931\u8d25")}})}getOrderDetail(e){return l(this,null,function*(){try{const t=yield x(`/orders/${e}`),r=t.data;return r.extraData&&(r.appointmentId=r.extraData.appointmentId,r.therapistId=r.extraData.therapistId,r.therapistName=r.extraData.therapistName,r.therapistAvatar=C(r.extraData.therapistAvatar),r.storeId=r.extraData.storeId,r.appointmentDate=r.extraData.appointmentDate,r.startTime=r.extraData.startTime,r.duration=r.extraData.duration,r.serviceName=r.extraData.serviceName||r.title,r.appointmentStatus=r.extraData.appointmentStatus,yield this.enrichOrderWithStoreAndTherapistInfo(r)),r.displayStatus=this.getDisplayStatus(r),r}catch(t){throw console.error("\u83b7\u53d6\u8ba2\u5355\u8be6\u60c5\u5931\u8d25:",t),new Error("\u8ba2\u5355\u4e0d\u5b58\u5728\u6216\u5df2\u5220\u9664")}})}getOrderList(e,t,r=1,a=20){return l(this,null,function*(){try{const{userId:n}=this.getUserInfo(),o={userId:n,page:r,pageSize:a};e&&(o.status=e),t&&(o.orderType=t);const s=yield x("/orders",o),i=s.data.list.map(e=>(e.extraData&&(e.appointmentId=e.extraData.appointmentId,e.therapistId=e.extraData.therapistId,e.therapistName=e.extraData.therapistName,e.therapistAvatar=C(e.extraData.therapistAvatar),e.storeId=e.extraData.storeId,e.storeName=e.extraData.storeName,e.storeAddress=e.extraData.storeAddress,e.appointmentDate=e.extraData.appointmentDate,e.startTime=e.extraData.startTime,e.duration=e.extraData.duration,e.serviceName=e.extraData.serviceName||e.title,e.appointmentStatus=e.extraData.appointmentStatus),e.displayStatus=this.getDisplayStatus(e),e)),c=yield this.enrichOrderListWithStoreAndTherapistInfo(i);return c}catch(n){return console.error("\u83b7\u53d6\u8ba2\u5355\u5217\u8868\u5931\u8d25:",n),[]}})}cancelOrder(e,t="\u7528\u6237\u53d6\u6d88"){return l(this,null,function*(){try{const{userId:r}=this.getUserInfo(),a=yield f("/orders/cancel",{orderNo:e,userId:r,reason:t},{showLoading:!0,loadingTitle:"\u53d6\u6d88\u4e2d..."});return a.data}catch(r){throw console.error("\u53d6\u6d88\u8ba2\u5355\u5931\u8d25:",r),new Error(r.message||"\u53d6\u6d88\u8ba2\u5355\u5931\u8d25")}})}requestRefund(e,t){return l(this,null,function*(){try{const{userId:r}=this.getUserInfo(),a=yield f(`/orders/${e}/refund`,{userId:r,reason:t||"\u7528\u6237\u7533\u8bf7\u9000\u6b3e"},{showLoading:!0,loadingTitle:"\u7533\u8bf7\u9000\u6b3e\u4e2d..."});return a.data}catch(r){throw console.error("\u7533\u8bf7\u9000\u6b3e\u5931\u8d25:",r),new Error(r.message||"\u7533\u8bf7\u9000\u6b3e\u5931\u8d25")}})}getRefundDetail(e){return l(this,null,function*(){try{const t=yield x(`/refunds/${e}`);return t.data}catch(t){throw console.error("\u83b7\u53d6\u9000\u6b3e\u8be6\u60c5\u5931\u8d25:",t),new Error("\u9000\u6b3e\u5355\u4e0d\u5b58\u5728\u6216\u5df2\u5220\u9664")}})}rebookOrder(e){return l(this,null,function*(){try{const t=yield this.getOrderDetail(e);return d.Taro.setStorageSync("rebookOrderInfo",{therapistId:t.therapistId,therapistName:t.therapistName,storeId:t.storeId,storeName:t.storeName,serviceId:t.serviceId,serviceName:t.serviceName,duration:t.duration}),!0}catch(t){return console.error("\u91cd\u65b0\u9884\u7ea6\u5931\u8d25:",t),!1}})}getOrderStatistics(){return l(this,null,function*(){try{const{userId:e}=this.getUserInfo(),t=yield x("/orders",{userId:e,page:1,pageSize:100}),r=t.data.list;return{total:r.length,pendingPayment:r.filter(e=>"pending"===e.paymentStatus).length,paid:r.filter(e=>"paid"===e.paymentStatus).length,completed:r.filter(e=>"paid"===e.paymentStatus&&new Date(e.appointmentDate+" "+e.startTime)<new Date).length,cancelled:r.filter(e=>"cancelled"===e.paymentStatus).length}}catch(e){return console.error("\u83b7\u53d6\u8ba2\u5355\u7edf\u8ba1\u5931\u8d25:",e),{total:0,pendingPayment:0,paid:0,completed:0,cancelled:0}}})}}const L=new _;function U(e){return e||0===e?Math.round(e)/100:0}function k(e,t){const{symbol:r="\uffe5",suffix:a="\u5143",precision:n=2}=t||{};if(void 0===e||null===e)return`${r}0.00${a}`;if("number"!==typeof e||isNaN(e))return console.warn("\u26a0\ufe0f formatAmount: \u65e0\u6548\u7684\u91d1\u989d\u8f93\u5165",{amountInCents:e,type:typeof e}),`${r}0.00${a}`;const o=U(e);return isNaN(o)?(console.error("\u274c formatAmount: \u91d1\u989d\u8f6c\u6362\u7ed3\u679c\u4e3aNaN",{amountInCents:e,yuan:o}),`${r}0.00${a}`):`${r}${o.toFixed(n)}${a}`}class z{getCurrentUserId(){return E()}getBalance(){return l(this,null,function*(){try{const e=this.getCurrentUserId(),t=yield x("/users/wallet/balance",{userId:e}),r=t.data.balance||0;return console.log("\ud83d\udcb0 \u4f59\u989d\u67e5\u8be2:",{"\u5206":r,"\u5143":(r/100).toFixed(2)}),r}catch(e){throw console.error("\u83b7\u53d6\u4f59\u989d\u5931\u8d25:",e),new Error("\u83b7\u53d6\u4f59\u989d\u5931\u8d25\uff0c\u8bf7\u91cd\u8bd5")}})}getBalanceDetails(){return l(this,null,function*(){try{const e=this.getCurrentUserId(),t=yield x("/users/wallet/balance",{userId:e});return t.data}catch(e){throw console.error("\u83b7\u53d6\u4f59\u989d\u8be6\u60c5\u5931\u8d25:",e),new Error("\u83b7\u53d6\u4f59\u989d\u8be6\u60c5\u5931\u8d25\uff0c\u8bf7\u91cd\u8bd5")}})}getRechargeOptions(){return l(this,null,function*(){try{const e=yield x("/recharge/configs");return e.data}catch(e){return console.error("\u83b7\u53d6\u5145\u503c\u914d\u7f6e\u5931\u8d25:",e),this.getDefaultRechargeOptions()}})}getDefaultRechargeOptions(){return[{id:1,amount:1e4,bonus:0,label:"100\u5143",sortOrder:1},{id:2,amount:2e4,bonus:0,label:"200\u5143",sortOrder:2},{id:3,amount:5e4,bonus:5e3,label:"500\u5143",sortOrder:3,promotionTag:"\u8d6050\u5143"},{id:4,amount:1e5,bonus:1e4,label:"1000\u5143",sortOrder:4,promotionTag:"\u8d60100\u5143"},{id:5,amount:2e5,bonus:3e4,label:"2000\u5143",sortOrder:5,promotionTag:"\u8d60300\u5143"},{id:6,amount:5e5,bonus:1e5,label:"5000\u5143",sortOrder:6,promotionTag:"\u8d601000\u5143",isRecommended:!0}]}createRechargeOrder(e,t=0){return l(this,null,function*(){try{const r=this.getCurrentUserId(),a=N(),n=100*e,o={orderType:"recharge",userId:r,userPhone:a,title:t>0?`\u5145\u503c${e}\u5143\uff0c\u8d60\u9001${t}\u5143`:`\u5145\u503c${e}\u5143`,amount:n,paymentMethod:"wechat",extraData:{rechargeAmount:100*e,bonus:100*t,actualAmount:100*(e+t)}};console.log("\ud83d\udcb0 \u521b\u5efa\u5145\u503c\u8ba2\u5355"),console.log("\ud83d\udc64 \u5f53\u524d\u7528\u6237ID:",r),console.log("\ud83d\udcde \u7528\u6237\u624b\u673a\u53f7:",a),console.log("\ud83d\udce6 \u8ba2\u5355\u6570\u636e:",{orderType:o.orderType,userId:o.userId,title:o.title,amount:`${o.amount}\u5206 (\xa5${(o.amount/100).toFixed(2)})`,paymentMethod:o.paymentMethod,extraData:o.extraData});const s=yield f("/orders/create",o,{showLoading:!0,loadingTitle:"\u521b\u5efa\u8ba2\u5355\u4e2d..."});return console.log("\u2705 \u5145\u503c\u8ba2\u5355\u521b\u5efa\u6210\u529f"),console.log("\ud83d\udccb \u8ba2\u5355\u54cd\u5e94:",{orderNo:s.data.orderNo,amount:`${s.data.amount}\u5206 (\xa5${(s.data.amount/100).toFixed(2)})`,paymentStatus:s.data.paymentStatus,hasWxPayParams:!!s.data.wxPayParams}),s.data}catch(r){throw console.error("\u274c \u521b\u5efa\u5145\u503c\u8ba2\u5355\u5931\u8d25:",r),new Error(r.message||"\u521b\u5efa\u5145\u503c\u8ba2\u5355\u5931\u8d25")}})}getTransactions(e=1,t=20,r){return l(this,null,function*(){try{const a=this.getCurrentUserId(),n={userId:a,page:e,pageSize:t};r&&(n.type=r);const o=yield x("/users/wallet/transactions",n);return o.data.list}catch(a){return console.error("\u83b7\u53d6\u4ea4\u6613\u8bb0\u5f55\u5931\u8d25:",a),[]}})}payWithBalance(e,t){return l(this,null,function*(){try{const t=yield f("/orders/pay",{orderNo:e,paymentMethod:"balance"},{showLoading:!0,loadingTitle:"\u652f\u4ed8\u4e2d..."});return{success:!0,balance:t.data.balance,message:"\u652f\u4ed8\u6210\u529f"}}catch(t){throw console.error("\u4f59\u989d\u652f\u4ed8\u5931\u8d25:",t),new Error(t.message||"\u4f59\u989d\u4e0d\u8db3\u6216\u652f\u4ed8\u5931\u8d25")}})}refundToBalance(e,t,r="\u8ba2\u5355\u9000\u6b3e"){return l(this,null,function*(){try{const a=yield f("/users/wallet/refund",{phone:N(),amount:t,orderNo:e,description:r},{showLoading:!0,loadingTitle:"\u9000\u6b3e\u4e2d..."});return{success:!0,balance:a.data.balance,transactionId:a.data.transactionId,message:"\u9000\u6b3e\u6210\u529f"}}catch(a){throw console.error("\u9000\u6b3e\u5931\u8d25:",a),new Error(a.message||"\u9000\u6b3e\u5931\u8d25")}})}clearCache(){try{d.Taro.removeStorageSync("userInfo"),d.Taro.removeStorageSync("walletCache"),console.log("\u94b1\u5305\u7f13\u5b58\u5df2\u6e05\u7a7a")}catch(e){console.error("\u6e05\u7a7a\u7f13\u5b58\u5931\u8d25:",e)}}}const B=new z;function F(e,t){if(!e||e>=1)return null;const r=Math.round(100*(1-e)),a=new Date,n=new Date(a.getTime()+31536e6);return{id:`virtual_${t}_discount`,userId:t.toString(),type:"discount",name:r>=30?"\u65b0\u4eba\u4e13\u4eab\u5238":"\u4f1a\u5458\u6298\u6263\u5238",description:`\u5168\u573a\u670d\u52a1${Math.round(100*e)}\u6298`,discountRate:e,discountPercentage:r,validFrom:a.toISOString(),validTo:n.toISOString(),status:"unused",isAutoApply:!0}}function W(e,t){const r=Math.round(e*t),a=e-r,n=Math.round(100*t);return{originalPrice:e,finalPrice:r,savedAmount:a,discountDisplay:`${n}\u6298`}}class q{constructor(){this.vouchers=[],this.currentVoucher=null}getMyVouchers(){return l(this,null,function*(){const e=w();if(!e)return[];if(e.discountRate&&e.discountRate<1){const t=F(e.discountRate,e.id.toString());if(t)return this.vouchers=[t],[t]}return[]})}getAvailableVouchers(e){return l(this,null,function*(){const t=yield this.getMyVouchers(),r=new Date;return t.filter(t=>{if("unused"!==t.status)return!1;const a=new Date(t.validFrom),n=new Date(t.validTo);return!(r<a||r>n)&&!(t.minAmount&&e<t.minAmount)})})}setCurrentVoucher(e){this.currentVoucher=e,e?d.Taro.setStorageSync("selectedVoucher",e):d.Taro.removeStorageSync("selectedVoucher")}getCurrentVoucher(){if(!this.currentVoucher)try{this.currentVoucher=d.Taro.getStorageSync("selectedVoucher")}catch(e){console.error("\u83b7\u53d6\u9009\u4e2d\u793c\u5238\u5931\u8d25:",e)}return this.currentVoucher}markVoucherAsUsed(e,t){const r=this.vouchers.find(t=>t.id===e);r&&(r.status="used",r.usedAt=(new Date).toISOString(),r.orderNo=t),this.setCurrentVoucher(null)}isNewUser(){const e=w();if(!e||!e.discountRate)return!1;const t=Math.round(100*(1-e.discountRate));return t>=30}getNewUserVoucherInfo(){const e=w();if(!e||!e.discountRate||e.discountRate>=1)return{hasVoucher:!1};const t=Math.round(100*(1-e.discountRate));return{hasVoucher:!0,discountPercentage:t,description:`\u606d\u559c\u83b7\u5f97\u65b0\u4eba\u4e13\u4eab${t}%\u4f18\u60e0\u5238\uff01`}}}const X=new q;class H{getNearbyStores(e,t,r=1,a=10){return l(this,null,function*(){try{const n=yield y("/stores/nearby",{data:{latitude:e,longitude:t,page:r,pageSize:a}});console.log("\u2705 \u95e8\u5e97\u5217\u8868API\u8c03\u7528\u6210\u529f:",n);const o=n.data.list.map(e=>{var t;return c(i({},e),{image:C(e.image),images:null==(t=e.images)?void 0:t.map(e=>C(e))})});return c(i({},n.data),{list:o})}catch(n){throw console.error("\u274c \u95e8\u5e97\u5217\u8868API\u8c03\u7528\u5931\u8d25:",n),n}})}getStoreDetail(e){return l(this,null,function*(){var t;try{const r=yield y(`/stores/${e}`);return console.log("\u2705 \u95e8\u5e97\u8be6\u60c5API\u8c03\u7528\u6210\u529f:",r),(null==r?void 0:r.data)?c(i({},r),{data:c(i({},r.data),{image:C(r.data.image),images:null==(t=r.data.images)?void 0:t.map(e=>C(e))})}):r}catch(r){return console.log("\u26a0\ufe0f \u95e8\u5e97\u8be6\u60c5API\u8c03\u7528\u5931\u8d25:",r),null}})}searchStores(e,t=1,r=10){return l(this,null,function*(){try{const a=yield y("/stores/search",{data:{keyword:e,page:t,pageSize:r}});return console.log("\u2705 \u95e8\u5e97\u641c\u7d22API\u8c03\u7528\u6210\u529f:",a),a.data||{list:[],total:0,page:1,pageSize:10,hasMore:!1}}catch(a){return console.log("\u26a0\ufe0f \u95e8\u5e97\u641c\u7d22API\u8c03\u7528\u5931\u8d25:",a),{list:[],total:0,page:1,pageSize:10,hasMore:!1}}})}getStoresByStatus(e,t=1,r=10){return l(this,null,function*(){try{const a=yield y("/stores/filter",{data:{status:e,page:t,pageSize:r}});return console.log("\u2705 \u95e8\u5e97\u7b5b\u9009API\u8c03\u7528\u6210\u529f:",a),a.data||{list:[],total:0,page:1,pageSize:10,hasMore:!1}}catch(a){return console.log("\u26a0\ufe0f \u95e8\u5e97\u7b5b\u9009API\u8c03\u7528\u5931\u8d25:",a),{list:[],total:0,page:1,pageSize:10,hasMore:!1}}})}}const G=new H;class K{getCurrentLocation(){return l(this,null,function*(){try{const t=yield d.Taro.getSetting(),r=(null==t?void 0:t.authSetting)||{};let a;r["scope.userLocation"]||(yield d.Taro.authorize({scope:"scope.userLocation"}));try{a=yield d.Taro.getLocation({type:"gcj02",isHighAccuracy:!0})}catch(e){console.warn("gcj02\u5750\u6807\u7cfb\u4e0d\u652f\u6301\uff0c\u5c1d\u8bd5wgs84:",e),a=yield d.Taro.getLocation({type:"wgs84"})}return{latitude:a.latitude,longitude:a.longitude}}catch(t){console.error("\u83b7\u53d6\u4f4d\u7f6e\u5931\u8d25:",t);const e=(null==t?void 0:t.errMsg)||"";return(e.includes("auth deny")||e.includes("authorize:fail"))&&d.Taro.showModal({title:"\u63d0\u793a",content:"\u9700\u8981\u83b7\u53d6\u60a8\u7684\u4f4d\u7f6e\u4fe1\u606f\u6765\u63a8\u8350\u9644\u8fd1\u95e8\u5e97",confirmText:"\u53bb\u8bbe\u7f6e",success:e=>{e.confirm&&d.Taro.openSetting()}}),console.log("\u4f7f\u7528\u9ed8\u8ba4\u4f4d\u7f6e\uff1a\u4e0a\u6d77\u5e02\u4e2d\u5fc3"),{latitude:31.2304,longitude:121.4737}}})}calculateDistance(e,t,r,a){const n=Math.PI/180,o=6371,s=(r-e)*n,i=(a-t)*n,c=Math.sin(s/2)*Math.sin(s/2)+Math.cos(e*n)*Math.cos(r*n)*Math.sin(i/2)*Math.sin(i/2),l=2*Math.atan2(Math.sqrt(c),Math.sqrt(1-c));return Number((o*l).toFixed(1))}formatDistance(e){return e<1?`${Math.round(1e3*e)}m`:`${e}km`}}const Y=new K;class Z{getRecommendedTherapists(e=1,t=10,r){return l(this,null,function*(){try{const a=yield y("/therapists/recommended",{data:{page:e,pageSize:t,latitude:null==r?void 0:r.latitude,longitude:null==r?void 0:r.longitude}});return console.log("\u2705 \u63a8\u8350\u63a8\u62ff\u5e08API\u8c03\u7528\u6210\u529f:",a),a.data||{list:[],total:0,page:1,pageSize:10,hasMore:!1}}catch(a){return console.log("\u26a0\ufe0f \u63a8\u8350\u63a8\u62ff\u5e08API\u8c03\u7528\u5931\u8d25\uff0c\u4f7f\u7528mock\u6570\u636e:",a),{list:[],total:0,page:1,pageSize:10,hasMore:!1}}})}getRecommendedTherapistsWithDistance(e=1,t=10){return l(this,null,function*(){var r,a,n,o,s;try{const d=yield Y.getCurrentLocation(),u=yield y("/therapists/recommended",{data:{page:e,pageSize:t,latitude:d.latitude,longitude:d.longitude}});console.log("\u2705 \u63a8\u8350\u63a8\u62ff\u5e08API\u8c03\u7528\u6210\u529f:",u);const p=(null==(r=u.data)?void 0:r.list)||[],h=p.map(e=>c(i({},e),{avatar:C(e.avatar)})),m=yield Promise.all(h.map(e=>l(this,null,function*(){try{const t=yield G.getStoreDetail(e.storeId),r=(null==t?void 0:t.data)||t;let a=null;return(null==r?void 0:r.latitude)&&(null==r?void 0:r.longitude)&&(a=Y.calculateDistance(d.latitude,d.longitude,r.latitude,r.longitude)),c(i({},e),{distance:a})}catch(t){return console.warn(`\u83b7\u53d6\u6280\u5e08 ${e.id} \u95e8\u5e97\u4fe1\u606f\u5931\u8d25:`,t),c(i({},e),{distance:null})}})));return m.sort((e,t)=>null===e.distance&&null===t.distance?0:null===e.distance?1:null===t.distance?-1:e.distance-t.distance),{list:m,total:(null==(a=u.data)?void 0:a.total)||m.length,page:(null==(n=u.data)?void 0:n.page)||e,pageSize:(null==(o=u.data)?void 0:o.pageSize)||t,hasMore:(null==(s=u.data)?void 0:s.hasMore)||!1}}catch(d){return console.log("\u26a0\ufe0f \u63a8\u8350\u63a8\u62ff\u5e08\u8ddd\u79bb\u8ba1\u7b97API\u8c03\u7528\u5931\u8d25:",d),{list:[],total:0,page:1,pageSize:10,hasMore:!1}}})}getTherapistsByStore(e,t=1,r=10){return l(this,null,function*(){const a=yield y(`/stores/${e}/therapists`,{data:{page:t,pageSize:r}});console.log("\u2705 \u95e8\u5e97\u63a8\u62ff\u5e08API\u8c03\u7528\u6210\u529f:",a);const n=Array.isArray(a.data)?a.data:[];return{list:n,total:n.length,page:1,pageSize:n.length,hasMore:!1}})}getTherapistDetail(e){return l(this,null,function*(){try{const t=yield y(`/therapists/${e}`);return console.log("\u2705 \u63a8\u62ff\u5e08\u8be6\u60c5API\u8c03\u7528\u6210\u529f:",t),t}catch(t){throw console.log("\u26a0\ufe0f \u63a8\u62ff\u5e08\u8be6\u60c5API\u8c03\u7528\u5931\u8d25:",t),t}})}getTherapistsByExpertise(e,t=1,r=10){return l(this,null,function*(){const a=yield y("/therapists/search",{data:{expertise:e,page:t,pageSize:r}});return console.log("\u2705 \u4e13\u957f\u7b5b\u9009\u63a8\u62ff\u5e08API\u8c03\u7528\u6210\u529f:",a),a.data})}searchTherapists(e,t=1,r=10){return l(this,null,function*(){const a=yield y("/therapists/search",{data:{keyword:e,page:t,pageSize:r}});return console.log("\u2705 \u641c\u7d22\u63a8\u62ff\u5e08API\u8c03\u7528\u6210\u529f:",a),a.data})}getAvailableSlots(e,t,r=60){return l(this,null,function*(){try{const a=yield y("/appointments/available-slots",{data:{therapistId:e,date:t,duration:r}});return console.log("\u2705 \u83b7\u53d6\u53ef\u9884\u7ea6\u65f6\u6bb5API\u8c03\u7528\u6210\u529f:",a),a.data}catch(a){throw console.error("\u274c \u83b7\u53d6\u53ef\u9884\u7ea6\u65f6\u6bb5API\u8c03\u7528\u5931\u8d25:",a),a}})}}const Q=new Z;class J{createReview(e){return l(this,null,function*(){if(e.content.length<1)throw new Error("\u8bc4\u4ef7\u5185\u5bb9\u4e0d\u80fd\u4e3a\u7a7a");if(e.content.length>500)throw new Error("\u8bc4\u4ef7\u5185\u5bb9\u4e0d\u80fd\u8d85\u8fc7500\u5b57");if(e.rating<1||e.rating>5)throw new Error("\u8bc4\u5206\u5fc5\u987b\u57281-5\u4e4b\u95f4");try{const t=yield f("/reviews",e,{showLoading:!0,loadingTitle:"\u63d0\u4ea4\u8bc4\u4ef7\u4e2d..."});return d.Taro.eventCenter.trigger("review:created",t.data),t.data}catch(t){throw console.error("\u521b\u5efa\u8bc4\u4ef7\u5931\u8d25:",t),new Error(t.message||"\u521b\u5efa\u8bc4\u4ef7\u5931\u8d25")}})}getTherapistReviews(e,t=1,r=10,a){return l(this,null,function*(){try{const n={page:t,pageSize:r};a&&(n.rating=a);const o=yield x(`/therapists/${e}/reviews`,n);return o.data}catch(n){return console.error("\u83b7\u53d6\u63a8\u62ff\u5e08\u8bc4\u4ef7\u5931\u8d25:",n),{list:[],total:0,page:t,pageSize:r,hasMore:!1}}})}getUserReviews(e,t=1,r=10){return l(this,null,function*(){try{const a=yield x(`/users/${e}/reviews`,{page:t,pageSize:r});return a.data}catch(a){return console.error("\u83b7\u53d6\u7528\u6237\u8bc4\u4ef7\u5931\u8d25:",a),{list:[],total:0,page:t,pageSize:r,hasMore:!1}}})}getReviewDetail(e){return l(this,null,function*(){try{const t=yield x(`/reviews/${e}`);return t.data}catch(t){throw console.error("\u83b7\u53d6\u8bc4\u4ef7\u8be6\u60c5\u5931\u8d25:",t),new Error(t.message||"\u8bc4\u4ef7\u4e0d\u5b58\u5728")}})}getReviewStats(e){return l(this,null,function*(){try{const t=yield x(`/therapists/${e}/review-stats`);return t.data}catch(t){return console.error("\u83b7\u53d6\u8bc4\u4ef7\u7edf\u8ba1\u5931\u8d25:",t),{totalCount:0,averageRating:0,ratingBreakdown:{1:0,2:0,3:0,4:0,5:0}}}})}checkCanReview(e){return l(this,null,function*(){var t;try{const r=yield d.Taro.request({url:`${u.baseURL}/reviews/${e}`,method:"GET",header:{"Content-Type":"application/json"},timeout:u.timeout}),a=r.data;return 1002===a.code?(console.log("\u8bc4\u4ef7\u4e0d\u5b58\u5728\uff0c\u53ef\u4ee5\u521b\u5efa\u8bc4\u4ef7"),!0):0!==a.code||!(null==(t=a.data)?void 0:t.reviewId)||(console.log("\u8bc4\u4ef7\u5df2\u5b58\u5728\uff0c\u4e0d\u80fd\u518d\u8bc4\u4ef7"),!1)}catch(r){return console.warn("\u68c0\u67e5\u8bc4\u4ef7\u72b6\u6001\u65f6\u53d1\u751f\u9519\u8bef\uff0c\u9ed8\u8ba4\u5141\u8bb8\u8bc4\u4ef7"),!0}})}batchCheckReviewStatus(e){return l(this,null,function*(){const t={},r=e.map(e=>l(this,null,function*(){const r=yield this.checkCanReview(e);t[e]=r}));return yield Promise.allSettled(r),t})}clearCache(){try{const e=d.Taro.getStorageInfoSync().keys;e.forEach(e=>{e.startsWith("review_cache_")&&d.Taro.removeStorageSync(e)})}catch(e){console.error("\u6e05\u9664\u8bc4\u4ef7\u7f13\u5b58\u5931\u8d25:",e)}}}const ee=new J,te=[{id:"1",name:"\u9888\u80a9\u8170\u817f\u75db\u8c03\u7406",order:1},{id:"2",name:"\u809d\u80c6\u813e\u80c3\u8c03\u7406",order:2},{id:"3",name:"\u5931\u7720\u8c03\u7406",order:3},{id:"4",name:"\u5bab\u5bd2\u75db\u7ecf\u8c03\u7406",order:4},{id:"5",name:"\u8159\u7b4b\u6839\u9ab6",order:5},{id:"6",name:"\u8fd0\u52a8\u62c9\u4f38",order:6},{id:"7",name:"\u4f53\u6001\u8c03\u7406",order:7}],re=[{id:"s1",categoryId:"1",name:"\u3010\u4e0d\u6ee1\u610f\u9000\u3011\u9888\u80a9\u8170\u817f\u75db\u7279\u8272\u8c03\u740660\u5206\u949f",description:"\u4e13\u4e1a\u624b\u6cd5\u8c03\u7406\u5404\u7c7b\u75db\u75c7",duration:60,price:298,discountPrice:258,availability:"available",tag:"\u4e0d\u6ee1\u610f\u9000"},{id:"s2",categoryId:"1",name:"\u3010\u51ac\u5b63\u517b\u751f\u3011\u80a9\u9888\u8170\u80cc\u63a8\u62ff+\u70ed\u759760\u5206\u949f",description:"\u6e29\u7ecf\u901a\u7edc\uff0c\u9a71\u5bd2\u517b\u751f",duration:60,price:268,discountPrice:238,availability:"available",tag:"\u51ac\u5b63\u517b\u751f"},{id:"s3",categoryId:"1",name:"\u3010\u521d\u6b21\u4e13\u4eab\u3011\u80a9\u9888\u758f\u901a+\u808c\u8089\u653e\u677e",description:"\u65b0\u5ba2\u7279\u60e0\uff0c\u6df1\u5ea6\u653e\u677e",duration:60,price:198,discountPrice:98,availability:"available",tag:"\u521d\u6b21\u4e13\u4eab"},{id:"s4",categoryId:"2",name:"\u3010\u8212\u809d\u6da6\u80ba\u3011\u63a8\u62ff+\u827e\u7078\uff5c\u517b\u8eab\u4f34\u4fa390\u5206\u949f",description:"\u758f\u809d\u7406\u6c14\uff0c\u6da6\u80ba\u517b\u9634",duration:90,price:398,discountPrice:358,availability:"available",tag:"\u70ed\u9500"},{id:"s5",categoryId:"2",name:"\u3010\u4e13\u9879\u8c03\u7406\u3011\u7ea4\u517b\u7626\u8eab\xb7\u813e\u80c3\u810f\u8151\u8c03\u740660\u5206\u949f",description:"\u8c03\u7406\u813e\u80c3\uff0c\u5065\u5eb7\u7626\u8eab",duration:60,price:318,discountPrice:288,availability:"available",tag:"\u4e13\u9879\u8c03\u7406"},{id:"s6",categoryId:"3",name:"\u3010\u6df1\u5ea6\u653e\u677e\u3011\u5168\u8eab\u63a8\u62ff20\u5e74\u7ecf\u517860\u5206\u949f",description:"\u7ecf\u5178\u624b\u6cd5\uff0c\u6df1\u5ea6\u52a9\u7720",duration:60,price:268,discountPrice:238,availability:"available",tag:"\u7ecf\u5178"},{id:"s7",categoryId:"4",name:"\u3010\u7279\u8272\u517b\u751f\u3011\u5173\u5143\u7078\u624b\u5de5\u60ac\u707860\u5206\u949f",description:"\u6e29\u8865\u80be\u9633\uff0c\u8c03\u7406\u5bab\u5bd2",duration:60,price:288,discountPrice:258,availability:"available",tag:"\u7279\u8272"},{id:"s8",categoryId:"4",name:"\u3010\u672c\u5e97\u70ed\u9500\u3011\u7279\u8272\u94fa\u59dc\u5173\u5143\u707860\u5206\u949f",description:"\u94fa\u59dc\u6e29\u7078\uff0c\u6696\u5bab\u8c03\u7ecf",duration:60,price:298,discountPrice:268,availability:"busy",tag:"\u70ed\u9500"},{id:"s9",categoryId:"5",name:"\u3010\u4f53\u6001\u8c03\u6574\u3011\u5927\u5e08\u624b\u6cd5\u4e2d\u5f0f\u6574\u810a60\u5206\u949f",description:"\u6b63\u9aa8\u6574\u810a\uff0c\u8c03\u6574\u4f53\u6001",duration:60,price:398,discountPrice:368,availability:"available",tag:"\u5927\u5e08\u624b\u6cd5"},{id:"s10",categoryId:"6",name:"\u8fd0\u52a8\u6062\u590d\u62c9\u4f38",description:"\u4e13\u4e1a\u8fd0\u52a8\u540e\u6062\u590d",duration:45,price:198,discountPrice:168,availability:"available"},{id:"s11",categoryId:"7",name:"\u3010\u51c0\u6392\u5bd2\u6c14\u3011\u62d4\u7f50/\u522e\u75e7\u4e8c\u9009\u4e00",description:"\u795b\u6e7f\u6392\u5bd2\uff0c\u758f\u901a\u7ecf\u7edc",duration:30,price:128,discountPrice:98,availability:"available",tag:"\u4e8c\u9009\u4e00"},{id:"s12",categoryId:"7",name:"\u3010\u82b3\u9999\u6ecb\u517b\u3011\u6c89\u6d78\u5f0f\u7cbe\u6cb9SPA",description:"\u7cbe\u6cb9\u62a4\u7406\uff0c\u8eab\u5fc3\u653e\u677e",duration:90,price:428,discountPrice:398,availability:"available",tag:"\u7cbe\u6cb9SPA"}],ae="",ne=({items:e,therapist:t,onCheckout:r,onMaskClick:a,onRemoveItem:n})=>{const[o,s]=d.reactExports.useState(!1),[i,c]=d.reactExports.useState(180),l=d.reactExports.useRef(null),u=e.reduce((e,t)=>e+t.price,0),p=e.reduce((e,t)=>e+(t.discountPrice||t.price),0),h=u-p,m=e.length>0;d.reactExports.useEffect(()=>(m&&o?l.current=setInterval(()=>{c(e=>e<=1?(clearInterval(l.current),d.Taro.showToast({title:"\u652f\u4ed8\u8d85\u65f6\u4e86\u5466\uff0c\u5feb\u5feb\u91cd\u65b0\u4e0b\u5355\u5427~",icon:"none"}),s(!1),180):e-1)},1e3):l.current&&clearInterval(l.current),()=>{l.current&&clearInterval(l.current)}),[m,o]);const g=e=>{const t=Math.floor(e/60),r=e%60;return`${t.toString().padStart(2,"0")}:${r.toString().padStart(2,"0")}`},y=e=>{const t=new Date(e),r=new Date,a=t.toDateString()===r.toDateString();if(a)return"\u4eca\u5929";const n=t.getMonth()+1,o=t.getDate();return`${n}\u6708${o}\u65e5`},x=()=>{m?s(!0):d.Taro.showToast({title:"\u8bf7\u5148\u9009\u62e9\u670d\u52a1",icon:"none"})},f=()=>{a&&a(),s(!1)},I=()=>{r()};return d.jsxRuntimeExports.jsxs(d.jsxRuntimeExports.Fragment,{children:[o&&d.jsxRuntimeExports.jsx(d.View,{className:"cart-mask",onClick:f}),d.jsxRuntimeExports.jsx(d.View,{className:"shopping-cart",children:d.jsxRuntimeExports.jsxs(d.View,{className:"cart-bar",children:[d.jsxRuntimeExports.jsx(d.View,{className:"cart-info",children:m?d.jsxRuntimeExports.jsxs(d.jsxRuntimeExports.Fragment,{children:[d.jsxRuntimeExports.jsxs(d.Text,{className:"total-price",children:["\xa5",p]}),h>0&&d.jsxRuntimeExports.jsxs(d.Text,{className:"savings",children:["\u5df2\u4f18\u60e0\xa5",h]})]}):d.jsxRuntimeExports.jsx(d.Text,{className:"empty-text",children:"\u8bf7\u9009\u62e9\u670d\u52a1\u9879\u76ee"})}),d.jsxRuntimeExports.jsx(d.View,{className:"checkout-btn "+(m?"":"disabled"),onClick:x,children:"\u53bb\u7ed3\u7b97"})]})}),o&&d.jsxRuntimeExports.jsxs(d.View,{className:"cart-expanded",children:[d.jsxRuntimeExports.jsx(d.View,{className:"expanded-header",children:d.jsxRuntimeExports.jsx(d.Text,{className:"title",children:"\u9884\u7ea6\u8be6\u60c5"})}),d.jsxRuntimeExports.jsx(d.View,{className:"service-list",children:e.map((e,r)=>d.jsxRuntimeExports.jsxs(d.View,{className:"service-item",children:[d.jsxRuntimeExports.jsx(d.Image,{className:"therapist-avatar",src:e.therapistAvatar||(null==t?void 0:t.avatar)||""}),d.jsxRuntimeExports.jsxs(d.View,{className:"service-info",children:[d.jsxRuntimeExports.jsxs(d.View,{className:"info-header",children:[d.jsxRuntimeExports.jsx(d.Text,{className:"therapist-name",children:e.therapistName}),d.jsxRuntimeExports.jsxs(d.Text,{className:"duration",children:[e.duration,"\u5206\u949f"]})]}),d.jsxRuntimeExports.jsx(d.View,{className:"info-detail",children:d.jsxRuntimeExports.jsx(d.Text,{className:"service-name",children:e.serviceName})}),d.jsxRuntimeExports.jsx(d.View,{className:"info-time",children:d.jsxRuntimeExports.jsxs(d.Text,{className:"time-text",children:[y(e.date)," ",e.time," \u81f3 ",(()=>{const[t,r]=e.time.split(":").map(Number),a=r+e.duration,n=t+Math.floor(a/60),o=a%60;return`${n}:${o.toString().padStart(2,"0")}`})()]})})]}),d.jsxRuntimeExports.jsxs(d.View,{className:"item-actions",children:[d.jsxRuntimeExports.jsx(d.View,{className:"price-info",children:d.jsxRuntimeExports.jsxs(d.Text,{className:"price",children:["\xa5",e.discountPrice||e.price]})}),n&&d.jsxRuntimeExports.jsx(d.View,{className:"remove-btn",onClick:()=>n(r),children:"\u2715"})]})]},r))}),d.jsxRuntimeExports.jsxs(d.View,{className:"addon-section",children:[d.jsxRuntimeExports.jsx(d.Text,{className:"section-title",children:"\u53ef\u9009\u589e\u503c\u9879\u76ee"}),d.jsxRuntimeExports.jsxs(d.View,{className:"addon-list",children:[d.jsxRuntimeExports.jsxs(d.View,{className:"addon-item",children:[d.jsxRuntimeExports.jsxs(d.View,{className:"addon-info",children:[d.jsxRuntimeExports.jsx(d.Text,{className:"addon-name",children:"\u522e\u75e720\u5206\u949f"}),d.jsxRuntimeExports.jsx(d.Text,{className:"addon-price",children:"\xa5 99"})]}),d.jsxRuntimeExports.jsx(d.View,{className:"addon-action",children:"+"})]}),d.jsxRuntimeExports.jsxs(d.View,{className:"addon-item",children:[d.jsxRuntimeExports.jsxs(d.View,{className:"addon-info",children:[d.jsxRuntimeExports.jsx(d.Text,{className:"addon-name",children:"\u52a0\u949f20\u5206\u949f"}),d.jsxRuntimeExports.jsx(d.Text,{className:"addon-price",children:"\xa5 99"})]}),d.jsxRuntimeExports.jsx(d.View,{className:"addon-action",children:"+"})]})]})]}),d.jsxRuntimeExports.jsxs(d.View,{className:"checkout-section",children:[d.jsxRuntimeExports.jsxs(d.View,{className:"price-summary",children:[d.jsxRuntimeExports.jsxs(d.View,{className:"cart-icon",children:[d.jsxRuntimeExports.jsx(d.Text,{className:"icon",children:"\ud83d\uded2"}),d.jsxRuntimeExports.jsx(d.View,{className:"badge",children:"1"})]}),d.jsxRuntimeExports.jsxs(d.View,{className:"price-detail",children:[d.jsxRuntimeExports.jsxs(d.Text,{className:"final-price",children:["\xa5 ",p]}),u>p&&d.jsxRuntimeExports.jsxs(d.Text,{className:"original-price",children:["\xa5 ",u]})]}),d.jsxRuntimeExports.jsx(d.Text,{className:"discount-tip",children:"\u5df2\u4eab\u53d7\u6700\u5927\u4f18\u60e0\u51cf20\u5143"})]}),d.jsxRuntimeExports.jsxs(d.View,{className:"checkout-footer",children:[d.jsxRuntimeExports.jsxs(d.Text,{className:"countdown",children:["\u652f\u4ed8\u5012\u8ba1\u65f6: ",g(i)]}),d.jsxRuntimeExports.jsx(d.View,{className:"confirm-btn",onClick:I,children:"\u53bb\u7ed3\u7b97"})]})]})]})]})},oe="",se=({size:e="medium",text:t="\u9884\u7ea6"})=>d.jsxRuntimeExports.jsx(d.View,{className:`booking-button booking-button-${e}`,children:d.jsxRuntimeExports.jsx(d.Text,{className:"button-text",children:t})});exports.BookingButton=se,exports.GiftService=$,exports.ShoppingCart=ne,exports.calculateDiscountPrice=W,exports.checkAndAutoLogin=A,exports.fetchUserInfo=j,exports.formatAmount=k,exports.getCurrentUserInfo=w,exports.getLocationService=Y,exports.maskPhone=v,exports.normalizeImageUrl=C,exports.orderService=L,exports.paymentService=V,exports.post=f,exports.request=y,exports.reviewService=ee,exports.setUserInfo=T,exports.storeService=G,exports.symptomCategories=te,exports.symptomServices=re,exports.therapistService=Q,exports.voucherService=X,exports.walletService=B,exports.wechatLogin=R;
