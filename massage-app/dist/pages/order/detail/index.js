"use strict";var e=Object.defineProperty,t=Object.defineProperties,s=Object.getOwnPropertyDescriptors,a=Object.getOwnPropertySymbols,r=Object.prototype.hasOwnProperty,i=Object.prototype.propertyIsEnumerable,n=(t,s,a)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[s]=a,o=(e,t)=>{for(var s in t||(t={}))r.call(t,s)&&n(e,s,t[s]);if(a)for(var s of a(t))i.call(t,s)&&n(e,s,t[s]);return e},c=(e,a)=>t(e,s(a)),l=(e,t,s)=>new Promise((a,r)=>{var i=e=>{try{o(s.next(e))}catch(t){r(t)}},n=e=>{try{o(s.throw(e))}catch(t){r(t)}},o=e=>e.done?a(e.value):Promise.resolve(e.value).then(i,n);o((s=s.apply(e,t)).next())});const x=require("../../../taro.js"),m=require("../../../vendors.js"),u=require("../../../common.js"),p="",d=({visible:e,orderInfo:t,onClose:s,onSubmit:a})=>{const[r,i]=x.reactExports.useState(5),[n,o]=x.reactExports.useState(""),[c,u]=x.reactExports.useState([]),[p,d]=x.reactExports.useState(!1),j=["\u624b\u6cd5\u4e13\u4e1a","\u670d\u52a1\u6001\u5ea6\u597d","\u6548\u679c\u663e\u8457","\u73af\u5883\u8212\u9002","\u51c6\u65f6\u5b88\u7ea6","\u7269\u8d85\u6240\u503c"],h=e=>{const t={1:"\u5f88\u4e0d\u6ee1\u610f",2:"\u4e0d\u6ee1\u610f",3:"\u4e00\u822c",4:"\u6ee1\u610f",5:"\u975e\u5e38\u6ee1\u610f"};return t[e]||""},E=e=>{u(t=>t.includes(e)?t.filter(t=>t!==e):[...t,e])},R=n.length>=10&&!p,N=()=>l(exports,null,function*(){var e;if(R){d(!0);try{const l=t.appointmentId||(null==(e=t.extraData)?void 0:e.appointmentId);if(!l)throw new Error("\u65e0\u6cd5\u83b7\u53d6\u9884\u7ea6\u4fe1\u606f\uff0c\u65e0\u6cd5\u63d0\u4ea4\u8bc4\u4ef7\u3002\u8bf7\u7a0d\u540e\u91cd\u8bd5\u3002");yield a({appointmentId:l,rating:r,content:n,tags:c}),i(5),o(""),u([]),x.Taro.showToast({title:"\u8bc4\u4ef7\u6210\u529f",icon:"success",duration:2e3}),setTimeout(()=>{s()},2e3)}catch(l){x.Taro.showToast({title:l.message||"\u8bc4\u4ef7\u5931\u8d25",icon:"none",duration:2e3})}finally{d(!1)}}}),w=()=>{n.length>0||c.length>0?x.Taro.showModal({title:"\u786e\u8ba4\u53d6\u6d88",content:"\u5df2\u586b\u5199\u7684\u5185\u5bb9\u5c06\u4e0d\u4f1a\u4fdd\u5b58\uff0c\u786e\u5b9a\u53d6\u6d88\u5417\uff1f",success:e=>{e.confirm&&(i(5),o(""),u([]),s())}}):s()};return x.jsxRuntimeExports.jsx(m.AtFloatLayout,{isOpened:e,title:"\u8bc4\u4ef7\u670d\u52a1",onClose:w,children:x.jsxRuntimeExports.jsxs(x.View,{className:"review-modal",children:[x.jsxRuntimeExports.jsx(x.View,{className:"modal-header",children:x.jsxRuntimeExports.jsxs(x.View,{className:"therapist-info",children:[x.jsxRuntimeExports.jsx(x.Image,{className:"avatar",src:t.therapistAvatar||"https://img.yzcdn.cn/vant/cat.jpeg",mode:"aspectFill"}),x.jsxRuntimeExports.jsxs(x.View,{className:"info",children:[x.jsxRuntimeExports.jsx(x.Text,{className:"name",children:t.therapistName}),x.jsxRuntimeExports.jsx(x.Text,{className:"service",children:t.serviceName})]})]})}),x.jsxRuntimeExports.jsxs(x.View,{className:"rating-section",children:[x.jsxRuntimeExports.jsx(x.Text,{className:"rating-label",children:"\u670d\u52a1\u8bc4\u5206"}),x.jsxRuntimeExports.jsxs(x.View,{className:"star-container",children:[x.jsxRuntimeExports.jsx(m.AtRate,{value:r,onChange:e=>i(e),size:28,max:5}),x.jsxRuntimeExports.jsx(x.Text,{className:"rating-text",children:h(r)})]})]}),r>=4&&x.jsxRuntimeExports.jsxs(x.View,{className:"quick-tags",children:[x.jsxRuntimeExports.jsx(x.Text,{className:"tags-label",children:"\u5feb\u901f\u8bc4\u4ef7"}),x.jsxRuntimeExports.jsx(x.View,{className:"tags-container",children:j.map(e=>x.jsxRuntimeExports.jsx(x.View,{className:"tag "+(c.includes(e)?"active":""),onClick:()=>E(e),children:e},e))})]}),x.jsxRuntimeExports.jsxs(x.View,{className:"content-section",children:[x.jsxRuntimeExports.jsx(x.Text,{className:"content-label",children:"\u8be6\u7ec6\u8bc4\u4ef7"}),x.jsxRuntimeExports.jsx(m.AtTextarea,{value:n,onChange:e=>o(e),placeholder:"\u5206\u4eab\u60a8\u7684\u670d\u52a1\u4f53\u9a8c\uff0c\u5e2e\u52a9\u5176\u4ed6\u987e\u5ba2\uff081-500\u5b57\uff09",maxLength:500,height:120,count:!0,className:"content-textarea"})]}),x.jsxRuntimeExports.jsx(x.View,{className:"modal-footer",children:x.jsxRuntimeExports.jsxs(x.View,{className:"buttons",children:[x.jsxRuntimeExports.jsx(x.View,{className:"btn-cancel",onClick:w,children:"\u53d6\u6d88"}),x.jsxRuntimeExports.jsx(x.View,{className:"btn-submit "+(R?"":"disabled"),onClick:N,children:p?"\u63d0\u4ea4\u4e2d...":"\u63d0\u4ea4\u8bc4\u4ef7"})]})})]})})},j="",h=()=>{const e=x.taroExports.useRouter(),{orderNo:t}=e.params,[s,a]=x.reactExports.useState(null),[r,i]=x.reactExports.useState(!0),[n,p]=x.reactExports.useState(!1),[j,h]=x.reactExports.useState(!1);x.reactExports.useEffect(()=>{E()},[t]),x.reactExports.useEffect(()=>{if(s&&t){const e=u.getOrderDetailShareConfig(t);x.Taro.useShareAppMessage(()=>({title:e.title,path:e.path}));const s=u.getOrderDetailShareTimelineConfig();x.Taro.useShareTimeline(()=>({title:s.title,imageUrl:s.imageUrl}))}},[s,t]);const E=()=>l(exports,null,function*(){var e;if(!t)return x.Taro.showToast({title:"\u8ba2\u5355\u53f7\u7f3a\u5931",icon:"none"}),void setTimeout(()=>{x.Taro.navigateBack()},1500);try{const s=yield u.orderService.getOrderDetail(t);if(console.log("\ud83d\udccb \u8ba2\u5355\u8be6\u60c5\u83b7\u53d6\u6210\u529f:",{orderNo:s.orderNo,amount:s.amount,amountType:typeof s.amount,therapistAvatar:s.therapistAvatar,therapistName:s.therapistName,displayStatus:s.displayStatus}),s.amount||0===s.amount||console.warn("\u26a0\ufe0f \u8b66\u544a\uff1a\u8ba2\u5355\u91d1\u989d\u4e3a\u7a7a",{orderNo:t,amount:s.amount}),"number"!==typeof s.amount&&console.error("\u274c \u9519\u8bef\uff1a\u8ba2\u5355\u91d1\u989d\u7c7b\u578b\u4e0d\u6b63\u786e",{orderNo:t,amount:s.amount,type:typeof s.amount}),a(s),null==(e=s.extraData)?void 0:e.appointmentId){const e=yield u.reviewService.checkCanReview(s.extraData.appointmentId);h(!e)}else h(!1);i(!1)}catch(s){i(!1),console.error("\u274c \u83b7\u53d6\u8ba2\u5355\u8be6\u60c5\u5931\u8d25:",s),x.Taro.showToast({title:"\u83b7\u53d6\u8ba2\u5355\u5931\u8d25",icon:"none"})}}),R=()=>{x.Taro.makePhoneCall({phoneNumber:"4008888888"})},N=()=>l(exports,null,function*(){x.Taro.showModal({title:"\u53d6\u6d88\u8ba2\u5355",content:"\u786e\u5b9a\u8981\u53d6\u6d88\u8be5\u8ba2\u5355\u5417\uff1f",success:e=>l(exports,null,function*(){if(e.confirm)try{const e=yield u.orderService.cancelOrder(t);"pending"===(null==s?void 0:s.paymentStatus)?x.Taro.showToast({title:"\u53d6\u6d88\u8ba2\u5355",icon:"success"}):"paid"===(null==s?void 0:s.paymentStatus)&&e.refundAmount&&e.refundAmount>0?(x.Taro.showToast({title:"\u53d6\u6d88\u8ba2\u5355",icon:"success"}),setTimeout(()=>{x.Taro.showToast({title:`\u9000\u6b3e\uffe5${(e.refundAmount/100).toFixed(2)}`,icon:"success",duration:2500})},500)):x.Taro.showToast({title:"\u53d6\u6d88\u8ba2\u5355",icon:"success"}),setTimeout(()=>{E()},1500)}catch(a){x.Taro.showToast({title:"\u53d6\u6d88\u5931\u8d25",icon:"none"})}})})}),w=()=>{x.Taro.switchTab({url:"/pages/appointment/index"})},T=()=>{p(!0)},g=()=>l(exports,null,function*(){var e;if(null==(e=null==s?void 0:s.extraData)?void 0:e.appointmentId)try{const e=yield u.reviewService.getReviewDetail(s.extraData.appointmentId);x.Taro.showModal({title:"\u6211\u7684\u8bc4\u4ef7",content:`\u8bc4\u5206\uff1a${e.rating}\u661f\n${e.content}`,showCancel:!1})}catch(t){x.Taro.showToast({title:"\u8bc4\u4ef7\u4fe1\u606f\u83b7\u53d6\u5931\u8d25",icon:"none"})}else x.Taro.showToast({title:"\u6682\u65e0\u8bc4\u4ef7",icon:"none"})}),v=e=>l(exports,null,function*(){try{const t=c(o({},e),{therapistId:null==s?void 0:s.therapistId});yield u.reviewService.createReview(t),h(!0),p(!1),E()}catch(t){throw t}}),f=()=>{s&&x.Taro.openLocation({latitude:31.189,longitude:121.43,name:s.storeName,address:s.storeAddress})},y=e=>`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${e}`,b=e=>{const t=e.displayStatus||e.paymentStatus,s={pending:"\u5f85\u652f\u4ed8",paid:"\u5f85\u670d\u52a1",serving:"\u670d\u52a1\u4e2d",completed:"\u5df2\u5b8c\u6210",cancelled:"\u5df2\u53d6\u6d88",refunded:"\u5df2\u9000\u6b3e"};return s[t]||t},V=e=>{const t=e.displayStatus||e.paymentStatus,s=["\u4e0b\u5355","\u652f\u4ed8","\u5230\u5e97\u670d\u52a1","\u5b8c\u6210"];let a=0;switch(t){case"pending":a=0;break;case"paid":a=1;break;case"serving":a=2;break;case"completed":a=3;break;case"cancelled":case"refunded":return{steps:["\u5df2\u53d6\u6d88"],current:0}}return{steps:s,current:a}},S=e=>{const t=new Date(e),s=t.getFullYear(),a=t.getMonth()+1,r=t.getDate(),i=t.getHours(),n=t.getMinutes();return`${s}-${a.toString().padStart(2,"0")}-${r.toString().padStart(2,"0")} ${i.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`};if(r)return x.jsxRuntimeExports.jsx(x.View,{className:"order-detail-page",children:x.jsxRuntimeExports.jsx(x.View,{className:"loading",children:"\u52a0\u8f7d\u4e2d..."})});if(!s)return x.jsxRuntimeExports.jsx(x.View,{className:"order-detail-page",children:x.jsxRuntimeExports.jsx(x.View,{className:"empty",children:"\u8ba2\u5355\u4e0d\u5b58\u5728"})});const{steps:A,current:C}=V(s),k=s.displayStatus||s.paymentStatus;return x.jsxRuntimeExports.jsxs(x.View,{className:"order-detail-page",children:[x.jsxRuntimeExports.jsxs(x.View,{className:"status-section",children:[x.jsxRuntimeExports.jsxs(x.View,{className:"status-header",children:[x.jsxRuntimeExports.jsx(m.AtIcon,{value:"paid"===k?"check-circle":"clock",size:"40",color:"#fff"}),x.jsxRuntimeExports.jsx(x.Text,{className:"status-text",children:b(s)})]}),"cancelled"!==k&&"refunded"!==k&&x.jsxRuntimeExports.jsx(x.View,{className:"steps-container",children:x.jsxRuntimeExports.jsx(m.AtSteps,{items:A.map(e=>({title:e})),current:C,className:"order-steps"})})]}),"paid"===k&&x.jsxRuntimeExports.jsxs(x.View,{className:"qrcode-section",children:[x.jsxRuntimeExports.jsx(x.Text,{className:"section-title",children:"\u5230\u5e97\u6838\u9500\u7801"}),x.jsxRuntimeExports.jsxs(x.View,{className:"qrcode-card",children:[x.jsxRuntimeExports.jsx(x.Image,{className:"qrcode-image",src:y(s.orderNo),mode:"aspectFit"}),x.jsxRuntimeExports.jsx(x.Text,{className:"qrcode-no",children:s.orderNo}),x.jsxRuntimeExports.jsx(x.Text,{className:"qrcode-tip",children:"\u8bf7\u5411\u95e8\u5e97\u5de5\u4f5c\u4eba\u5458\u51fa\u793a\u6b64\u4e8c\u7ef4\u7801"})]})]}),x.jsxRuntimeExports.jsxs(x.View,{className:"info-section",children:[x.jsxRuntimeExports.jsx(x.Text,{className:"section-title",children:"\u8ba2\u5355\u4fe1\u606f"}),x.jsxRuntimeExports.jsxs(x.View,{className:"info-card",children:[x.jsxRuntimeExports.jsxs(x.View,{className:"info-item",children:[x.jsxRuntimeExports.jsx(x.Text,{className:"label",children:"\u8ba2\u5355\u7f16\u53f7"}),x.jsxRuntimeExports.jsx(x.Text,{className:"value",children:s.orderNo})]}),x.jsxRuntimeExports.jsxs(x.View,{className:"info-item",children:[x.jsxRuntimeExports.jsx(x.Text,{className:"label",children:"\u4e0b\u5355\u65f6\u95f4"}),x.jsxRuntimeExports.jsx(x.Text,{className:"value",children:S(s.createdAt)})]}),s.paidAt&&x.jsxRuntimeExports.jsxs(x.View,{className:"info-item",children:[x.jsxRuntimeExports.jsx(x.Text,{className:"label",children:"\u652f\u4ed8\u65f6\u95f4"}),x.jsxRuntimeExports.jsx(x.Text,{className:"value",children:S(s.paidAt)})]}),x.jsxRuntimeExports.jsxs(x.View,{className:"info-item",children:[x.jsxRuntimeExports.jsx(x.Text,{className:"label",children:"\u9884\u7ea6\u65f6\u95f4"}),x.jsxRuntimeExports.jsxs(x.Text,{className:"value highlight",children:[s.appointmentDate," ",s.startTime,"  "]})]})]})]}),x.jsxRuntimeExports.jsxs(x.View,{className:"store-section",children:[x.jsxRuntimeExports.jsx(x.Text,{className:"section-title",children:"\u95e8\u5e97\u4fe1\u606f"}),x.jsxRuntimeExports.jsxs(x.View,{className:"store-card",onClick:f,children:[x.jsxRuntimeExports.jsxs(x.View,{className:"store-info",children:[x.jsxRuntimeExports.jsx(x.Text,{className:"store-name",children:s.storeName}),x.jsxRuntimeExports.jsx(x.Text,{className:"store-address",children:s.storeAddress})]}),x.jsxRuntimeExports.jsx(m.AtIcon,{value:"map-pin",size:"20",color:"#a40035"})]})]}),x.jsxRuntimeExports.jsxs(x.View,{className:"therapist-section",children:[x.jsxRuntimeExports.jsx(x.Text,{className:"section-title",children:"\u63a8\u62ff\u5e08\u4fe1\u606f"}),x.jsxRuntimeExports.jsxs(x.View,{className:"therapist-card",children:[s.therapistAvatar&&x.jsxRuntimeExports.jsx(x.Image,{className:"therapist-avatar",src:s.therapistAvatar}),x.jsxRuntimeExports.jsxs(x.View,{className:"therapist-info",children:[x.jsxRuntimeExports.jsx(x.Text,{className:"therapist-name",children:s.therapistName}),x.jsxRuntimeExports.jsx(x.Text,{className:"service-name",children:s.serviceName}),x.jsxRuntimeExports.jsxs(x.Text,{className:"service-duration",children:["\u670d\u52a1\u65f6\u957f\uff1a",s.duration,"\u5206\u949f"]})]}),x.jsxRuntimeExports.jsx(x.Text,{className:"price",children:u.formatAmount(s.amount)}),"  "]})]}),x.jsxRuntimeExports.jsxs(x.View,{className:"action-section",children:["paid"===k&&x.jsxRuntimeExports.jsxs(x.jsxRuntimeExports.Fragment,{children:[x.jsxRuntimeExports.jsxs(x.View,{className:"button secondary",onClick:R,children:[x.jsxRuntimeExports.jsx(m.AtIcon,{value:"phone",size:"18"}),x.jsxRuntimeExports.jsx(x.Text,{children:"\u8054\u7cfb\u95e8\u5e97"})]}),x.jsxRuntimeExports.jsx(x.View,{className:"button danger",onClick:N,children:"\u53d6\u6d88\u8ba2\u5355"})]}),"serving"===k&&x.jsxRuntimeExports.jsxs(x.View,{className:"button secondary",onClick:R,children:[x.jsxRuntimeExports.jsx(m.AtIcon,{value:"phone",size:"18"}),x.jsxRuntimeExports.jsx(x.Text,{children:"\u8054\u7cfb\u95e8\u5e97"})]}),("completed"===k||"paid"===k)&&x.jsxRuntimeExports.jsxs(x.jsxRuntimeExports.Fragment,{children:[j?x.jsxRuntimeExports.jsx(x.View,{className:"button secondary",onClick:g,children:"\u67e5\u770b\u8bc4\u4ef7"}):x.jsxRuntimeExports.jsxs(x.View,{className:"button primary",onClick:T,children:[x.jsxRuntimeExports.jsx(m.AtIcon,{value:"star",size:"16"}),x.jsxRuntimeExports.jsx(x.Text,{children:" \u8bc4\u4ef7\u670d\u52a1"})]}),x.jsxRuntimeExports.jsx(x.View,{className:"button primary",onClick:w,children:"\u518d\u6b21\u9884\u7ea6"})]}),["cancelled","refunded"].includes(k)&&x.jsxRuntimeExports.jsx(x.View,{className:"button primary",onClick:w,children:"\u518d\u6b21\u9884\u7ea6"})]}),s&&x.jsxRuntimeExports.jsx(d,{visible:n,orderInfo:s,onClose:()=>p(!1),onSubmit:v})]})};var E={navigationBarTitleText:"\u8ba2\u5355\u8be6\u60c5",enableShareAppMessage:!0,enableShareTimeline:!0};h.enableShareTimeline=!0,h.enableShareAppMessage=!0,Page(x.createPageConfig(h,"pages/order/detail/index",{root:{cn:[]}},E||{}));
