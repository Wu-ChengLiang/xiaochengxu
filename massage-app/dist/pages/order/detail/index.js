"use strict";var e=Object.defineProperty,s=Object.defineProperties,t=Object.getOwnPropertyDescriptors,r=Object.getOwnPropertySymbols,a=Object.prototype.hasOwnProperty,i=Object.prototype.propertyIsEnumerable,n=(s,t,r)=>t in s?e(s,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):s[t]=r,o=(e,s)=>{for(var t in s||(s={}))a.call(s,t)&&n(e,t,s[t]);if(r)for(var t of r(s))i.call(s,t)&&n(e,t,s[t]);return e},c=(e,r)=>s(e,t(r)),x=(e,s,t)=>new Promise((r,a)=>{var i=e=>{try{o(t.next(e))}catch(s){a(s)}},n=e=>{try{o(t.throw(e))}catch(s){a(s)}},o=e=>e.done?r(e.value):Promise.resolve(e.value).then(i,n);o((t=t.apply(e,s)).next())});const l=require("../../../taro.js"),m=require("../../../vendors.js"),p=require("../../../common.js"),u="",d=({visible:e,orderInfo:s,onClose:t,onSubmit:r})=>{const[a,i]=l.reactExports.useState(5),[n,o]=l.reactExports.useState(""),[c,p]=l.reactExports.useState([]),[u,d]=l.reactExports.useState(!1),j=["\u624b\u6cd5\u4e13\u4e1a","\u670d\u52a1\u6001\u5ea6\u597d","\u6548\u679c\u663e\u8457","\u73af\u5883\u8212\u9002","\u51c6\u65f6\u5b88\u7ea6","\u7269\u8d85\u6240\u503c"],h=e=>{const s={1:"\u5f88\u4e0d\u6ee1\u610f",2:"\u4e0d\u6ee1\u610f",3:"\u4e00\u822c",4:"\u6ee1\u610f",5:"\u975e\u5e38\u6ee1\u610f"};return s[e]||""},E=e=>{p(s=>s.includes(e)?s.filter(s=>s!==e):[...s,e])},R=n.length>=10&&!u,N=()=>x(exports,null,function*(){var e;if(R){d(!0);try{const x=s.appointmentId||(null==(e=s.extraData)?void 0:e.appointmentId);if(!x)throw new Error("\u65e0\u6cd5\u83b7\u53d6\u9884\u7ea6\u4fe1\u606f\uff0c\u65e0\u6cd5\u63d0\u4ea4\u8bc4\u4ef7\u3002\u8bf7\u7a0d\u540e\u91cd\u8bd5\u3002");yield r({appointmentId:x,rating:a,content:n,tags:c}),i(5),o(""),p([]),l.Taro.showToast({title:"\u8bc4\u4ef7\u6210\u529f",icon:"success",duration:2e3}),setTimeout(()=>{t()},2e3)}catch(x){l.Taro.showToast({title:x.message||"\u8bc4\u4ef7\u5931\u8d25",icon:"none",duration:2e3})}finally{d(!1)}}}),w=()=>{n.length>0||c.length>0?l.Taro.showModal({title:"\u786e\u8ba4\u53d6\u6d88",content:"\u5df2\u586b\u5199\u7684\u5185\u5bb9\u5c06\u4e0d\u4f1a\u4fdd\u5b58\uff0c\u786e\u5b9a\u53d6\u6d88\u5417\uff1f",success:e=>{e.confirm&&(i(5),o(""),p([]),t())}}):t()};return l.jsxRuntimeExports.jsx(m.AtFloatLayout,{isOpened:e,title:"\u8bc4\u4ef7\u670d\u52a1",onClose:w,children:l.jsxRuntimeExports.jsxs(l.View,{className:"review-modal",children:[l.jsxRuntimeExports.jsx(l.View,{className:"modal-header",children:l.jsxRuntimeExports.jsxs(l.View,{className:"therapist-info",children:[l.jsxRuntimeExports.jsx(l.Image,{className:"avatar",src:s.therapistAvatar||"https://img.yzcdn.cn/vant/cat.jpeg",mode:"aspectFill"}),l.jsxRuntimeExports.jsxs(l.View,{className:"info",children:[l.jsxRuntimeExports.jsx(l.Text,{className:"name",children:s.therapistName}),l.jsxRuntimeExports.jsx(l.Text,{className:"service",children:s.serviceName})]})]})}),l.jsxRuntimeExports.jsxs(l.View,{className:"rating-section",children:[l.jsxRuntimeExports.jsx(l.Text,{className:"rating-label",children:"\u670d\u52a1\u8bc4\u5206"}),l.jsxRuntimeExports.jsxs(l.View,{className:"star-container",children:[l.jsxRuntimeExports.jsx(m.AtRate,{value:a,onChange:e=>i(e),size:28,max:5}),l.jsxRuntimeExports.jsx(l.Text,{className:"rating-text",children:h(a)})]})]}),a>=4&&l.jsxRuntimeExports.jsxs(l.View,{className:"quick-tags",children:[l.jsxRuntimeExports.jsx(l.Text,{className:"tags-label",children:"\u5feb\u901f\u8bc4\u4ef7"}),l.jsxRuntimeExports.jsx(l.View,{className:"tags-container",children:j.map(e=>l.jsxRuntimeExports.jsx(l.View,{className:"tag "+(c.includes(e)?"active":""),onClick:()=>E(e),children:e},e))})]}),l.jsxRuntimeExports.jsxs(l.View,{className:"content-section",children:[l.jsxRuntimeExports.jsx(l.Text,{className:"content-label",children:"\u8be6\u7ec6\u8bc4\u4ef7"}),l.jsxRuntimeExports.jsx(m.AtTextarea,{value:n,onChange:e=>o(e),placeholder:"\u5206\u4eab\u60a8\u7684\u670d\u52a1\u4f53\u9a8c\uff0c\u5e2e\u52a9\u5176\u4ed6\u987e\u5ba2\uff081-500\u5b57\uff09",maxLength:500,height:120,count:!0,className:"content-textarea"})]}),l.jsxRuntimeExports.jsx(l.View,{className:"modal-footer",children:l.jsxRuntimeExports.jsxs(l.View,{className:"buttons",children:[l.jsxRuntimeExports.jsx(l.View,{className:"btn-cancel",onClick:w,children:"\u53d6\u6d88"}),l.jsxRuntimeExports.jsx(l.View,{className:"btn-submit "+(R?"":"disabled"),onClick:N,children:u?"\u63d0\u4ea4\u4e2d...":"\u63d0\u4ea4\u8bc4\u4ef7"})]})})]})})},j="",h=()=>{const e=l.taroExports.useRouter(),{orderNo:s}=e.params,[t,r]=l.reactExports.useState(null),[a,i]=l.reactExports.useState(!0),[n,u]=l.reactExports.useState(!1),[j,h]=l.reactExports.useState(!1);l.reactExports.useEffect(()=>{E()},[s]);const E=()=>x(exports,null,function*(){var e;if(!s)return l.Taro.showToast({title:"\u8ba2\u5355\u53f7\u7f3a\u5931",icon:"none"}),void setTimeout(()=>{l.Taro.navigateBack()},1500);try{const t=yield p.orderService.getOrderDetail(s);if(r(t),null==(e=t.extraData)?void 0:e.appointmentId){const e=yield p.reviewService.checkCanReview(t.extraData.appointmentId);h(!e)}else h(!1);i(!1)}catch(t){i(!1),l.Taro.showToast({title:"\u83b7\u53d6\u8ba2\u5355\u5931\u8d25",icon:"none"})}}),R=()=>{l.Taro.makePhoneCall({phoneNumber:"4008888888"})},N=()=>x(exports,null,function*(){l.Taro.showModal({title:"\u53d6\u6d88\u8ba2\u5355",content:"\u786e\u5b9a\u8981\u53d6\u6d88\u8be5\u8ba2\u5355\u5417\uff1f",success:e=>x(exports,null,function*(){if(e.confirm)try{yield p.orderService.cancelOrder(s),l.Taro.showToast({title:"\u8ba2\u5355\u5df2\u53d6\u6d88",icon:"success"}),setTimeout(()=>{E()},1500)}catch(t){l.Taro.showToast({title:"\u53d6\u6d88\u5931\u8d25",icon:"none"})}})})}),w=()=>{l.Taro.switchTab({url:"/pages/appointment/index"})},v=()=>{u(!0)},T=()=>x(exports,null,function*(){var e;if(null==(e=null==t?void 0:t.extraData)?void 0:e.appointmentId)try{const e=yield p.reviewService.getReviewDetail(t.extraData.appointmentId);l.Taro.showModal({title:"\u6211\u7684\u8bc4\u4ef7",content:`\u8bc4\u5206\uff1a${e.rating}\u661f\n${e.content}`,showCancel:!1})}catch(s){l.Taro.showToast({title:"\u8bc4\u4ef7\u4fe1\u606f\u83b7\u53d6\u5931\u8d25",icon:"none"})}else l.Taro.showToast({title:"\u6682\u65e0\u8bc4\u4ef7",icon:"none"})}),g=e=>x(exports,null,function*(){try{const s=c(o({},e),{therapistId:null==t?void 0:t.therapistId});yield p.reviewService.createReview(s),h(!0),u(!1),E()}catch(s){throw s}}),f=()=>{t&&l.Taro.openLocation({latitude:31.189,longitude:121.43,name:t.storeName,address:t.storeAddress})},V=e=>`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${e}`,b=e=>{const s=e.displayStatus||e.paymentStatus,t={pending:"\u5f85\u652f\u4ed8",paid:"\u5f85\u670d\u52a1",serving:"\u670d\u52a1\u4e2d",completed:"\u5df2\u5b8c\u6210",cancelled:"\u5df2\u53d6\u6d88",refunded:"\u5df2\u9000\u6b3e"};return t[s]||s},y=e=>{const s=e.displayStatus||e.paymentStatus,t=["\u4e0b\u5355","\u652f\u4ed8","\u5230\u5e97\u670d\u52a1","\u5b8c\u6210"];let r=0;switch(s){case"pending":r=0;break;case"paid":r=1;break;case"serving":r=2;break;case"completed":r=3;break;case"cancelled":case"refunded":return{steps:["\u5df2\u53d6\u6d88"],current:0}}return{steps:t,current:r}},S=e=>{const s=new Date(e),t=s.getFullYear(),r=s.getMonth()+1,a=s.getDate(),i=s.getHours(),n=s.getMinutes();return`${t}-${r.toString().padStart(2,"0")}-${a.toString().padStart(2,"0")} ${i.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`};if(a)return l.jsxRuntimeExports.jsx(l.View,{className:"order-detail-page",children:l.jsxRuntimeExports.jsx(l.View,{className:"loading",children:"\u52a0\u8f7d\u4e2d..."})});if(!t)return l.jsxRuntimeExports.jsx(l.View,{className:"order-detail-page",children:l.jsxRuntimeExports.jsx(l.View,{className:"empty",children:"\u8ba2\u5355\u4e0d\u5b58\u5728"})});const{steps:k,current:C}=y(t),I=t.displayStatus||t.paymentStatus;return l.jsxRuntimeExports.jsxs(l.View,{className:"order-detail-page",children:[l.jsxRuntimeExports.jsxs(l.View,{className:"status-section",children:[l.jsxRuntimeExports.jsxs(l.View,{className:"status-header",children:[l.jsxRuntimeExports.jsx(m.AtIcon,{value:"paid"===I?"check-circle":"clock",size:"40",color:"#fff"}),l.jsxRuntimeExports.jsx(l.Text,{className:"status-text",children:b(t)})]}),"cancelled"!==I&&"refunded"!==I&&l.jsxRuntimeExports.jsx(l.View,{className:"steps-container",children:l.jsxRuntimeExports.jsx(m.AtSteps,{items:k.map(e=>({title:e})),current:C,className:"order-steps"})})]}),"paid"===I&&l.jsxRuntimeExports.jsxs(l.View,{className:"qrcode-section",children:[l.jsxRuntimeExports.jsx(l.Text,{className:"section-title",children:"\u5230\u5e97\u6838\u9500\u7801"}),l.jsxRuntimeExports.jsxs(l.View,{className:"qrcode-card",children:[l.jsxRuntimeExports.jsx(l.Image,{className:"qrcode-image",src:V(t.orderNo),mode:"aspectFit"}),l.jsxRuntimeExports.jsx(l.Text,{className:"qrcode-no",children:t.orderNo}),l.jsxRuntimeExports.jsx(l.Text,{className:"qrcode-tip",children:"\u8bf7\u5411\u95e8\u5e97\u5de5\u4f5c\u4eba\u5458\u51fa\u793a\u6b64\u4e8c\u7ef4\u7801"})]})]}),l.jsxRuntimeExports.jsxs(l.View,{className:"info-section",children:[l.jsxRuntimeExports.jsx(l.Text,{className:"section-title",children:"\u8ba2\u5355\u4fe1\u606f"}),l.jsxRuntimeExports.jsxs(l.View,{className:"info-card",children:[l.jsxRuntimeExports.jsxs(l.View,{className:"info-item",children:[l.jsxRuntimeExports.jsx(l.Text,{className:"label",children:"\u8ba2\u5355\u7f16\u53f7"}),l.jsxRuntimeExports.jsx(l.Text,{className:"value",children:t.orderNo})]}),l.jsxRuntimeExports.jsxs(l.View,{className:"info-item",children:[l.jsxRuntimeExports.jsx(l.Text,{className:"label",children:"\u4e0b\u5355\u65f6\u95f4"}),l.jsxRuntimeExports.jsx(l.Text,{className:"value",children:S(t.createdAt)})]}),t.paidAt&&l.jsxRuntimeExports.jsxs(l.View,{className:"info-item",children:[l.jsxRuntimeExports.jsx(l.Text,{className:"label",children:"\u652f\u4ed8\u65f6\u95f4"}),l.jsxRuntimeExports.jsx(l.Text,{className:"value",children:S(t.paidAt)})]}),l.jsxRuntimeExports.jsxs(l.View,{className:"info-item",children:[l.jsxRuntimeExports.jsx(l.Text,{className:"label",children:"\u9884\u7ea6\u65f6\u95f4"}),l.jsxRuntimeExports.jsxs(l.Text,{className:"value highlight",children:[t.appointmentDate," ",t.startTime,"  "]})]})]})]}),l.jsxRuntimeExports.jsxs(l.View,{className:"store-section",children:[l.jsxRuntimeExports.jsx(l.Text,{className:"section-title",children:"\u95e8\u5e97\u4fe1\u606f"}),l.jsxRuntimeExports.jsxs(l.View,{className:"store-card",onClick:f,children:[l.jsxRuntimeExports.jsxs(l.View,{className:"store-info",children:[l.jsxRuntimeExports.jsx(l.Text,{className:"store-name",children:t.storeName}),l.jsxRuntimeExports.jsx(l.Text,{className:"store-address",children:t.storeAddress})]}),l.jsxRuntimeExports.jsx(m.AtIcon,{value:"map-pin",size:"20",color:"#a40035"})]})]}),l.jsxRuntimeExports.jsxs(l.View,{className:"therapist-section",children:[l.jsxRuntimeExports.jsx(l.Text,{className:"section-title",children:"\u63a8\u62ff\u5e08\u4fe1\u606f"}),l.jsxRuntimeExports.jsxs(l.View,{className:"therapist-card",children:[t.therapistAvatar&&l.jsxRuntimeExports.jsx(l.Image,{className:"therapist-avatar",src:t.therapistAvatar}),l.jsxRuntimeExports.jsxs(l.View,{className:"therapist-info",children:[l.jsxRuntimeExports.jsx(l.Text,{className:"therapist-name",children:t.therapistName}),l.jsxRuntimeExports.jsx(l.Text,{className:"service-name",children:t.serviceName}),l.jsxRuntimeExports.jsxs(l.Text,{className:"service-duration",children:["\u670d\u52a1\u65f6\u957f\uff1a",t.duration,"\u5206\u949f"]})]}),l.jsxRuntimeExports.jsx(l.Text,{className:"price",children:p.formatAmount(t.amount)}),"  "]})]}),l.jsxRuntimeExports.jsxs(l.View,{className:"action-section",children:["paid"===I&&l.jsxRuntimeExports.jsxs(l.jsxRuntimeExports.Fragment,{children:[l.jsxRuntimeExports.jsxs(l.View,{className:"button secondary",onClick:R,children:[l.jsxRuntimeExports.jsx(m.AtIcon,{value:"phone",size:"18"}),l.jsxRuntimeExports.jsx(l.Text,{children:"\u8054\u7cfb\u95e8\u5e97"})]}),l.jsxRuntimeExports.jsx(l.View,{className:"button danger",onClick:N,children:"\u53d6\u6d88\u8ba2\u5355"})]}),"serving"===I&&l.jsxRuntimeExports.jsxs(l.View,{className:"button secondary",onClick:R,children:[l.jsxRuntimeExports.jsx(m.AtIcon,{value:"phone",size:"18"}),l.jsxRuntimeExports.jsx(l.Text,{children:"\u8054\u7cfb\u95e8\u5e97"})]}),("completed"===I||"paid"===I)&&l.jsxRuntimeExports.jsxs(l.jsxRuntimeExports.Fragment,{children:[j?l.jsxRuntimeExports.jsx(l.View,{className:"button secondary",onClick:T,children:"\u67e5\u770b\u8bc4\u4ef7"}):l.jsxRuntimeExports.jsxs(l.View,{className:"button primary",onClick:v,children:[l.jsxRuntimeExports.jsx(m.AtIcon,{value:"star",size:"16"}),l.jsxRuntimeExports.jsx(l.Text,{children:" \u8bc4\u4ef7\u670d\u52a1"})]}),l.jsxRuntimeExports.jsx(l.View,{className:"button primary",onClick:w,children:"\u518d\u6b21\u9884\u7ea6"})]}),["cancelled","refunded"].includes(I)&&l.jsxRuntimeExports.jsx(l.View,{className:"button primary",onClick:w,children:"\u518d\u6b21\u9884\u7ea6"})]}),t&&l.jsxRuntimeExports.jsx(d,{visible:n,orderInfo:t,onClose:()=>u(!1),onSubmit:g})]})};var E={navigationBarTitleText:"\u8ba2\u5355\u8be6\u60c5"};Page(l.createPageConfig(h,"pages/order/detail/index",{root:{cn:[]}},E||{}));
