"use strict";var e=(e,t,s)=>new Promise((r,n)=>{var o=e=>{try{i(s.next(e))}catch(t){n(t)}},a=e=>{try{i(s.throw(e))}catch(t){n(t)}},i=e=>e.done?r(e.value):Promise.resolve(e.value).then(o,a);i((s=s.apply(e,t)).next())});const t=require("../../../taro.js"),s=require("../../../vendors.js"),r=require("../../../common.js"),n=e=>e?e.includes("T")?e:e.replace(" ","T"):null,o=e=>{if(!e)return null;const t=n(e);if(!t)return null;const s=new Date(t);return isNaN(s.getTime())?(console.warn("\u26a0\ufe0f \u65e0\u6548\u7684\u65e5\u671f\u683c\u5f0f:",e),null):s},a="",i=()=>{const[n,a]=t.reactExports.useState(0),[i,c]=t.reactExports.useState([]),[l,x]=t.reactExports.useState(!0),[u,d]=t.reactExports.useState(!1),[p,m]=t.reactExports.useState(1),j=[{title:"\u5168\u90e8"},{title:"\u5f85\u652f\u4ed8"},{title:"\u5f85\u670d\u52a1"},{title:"\u5df2\u5b8c\u6210"}],h={0:void 0,1:"pending",2:"paid",3:"completed"};t.taroExports.useDidShow(()=>{m(1),E(1)}),t.reactExports.useEffect(()=>{m(1),E(1)},[n]),t.taroExports.usePullDownRefresh(()=>e(exports,null,function*(){yield E(1),t.Taro.stopPullDownRefresh()}));const E=(...t)=>e(exports,[...t],function*(e=p){try{x(!0);const t=h[n];let s=yield r.orderService.getOrderList(void 0,void 0,e,100);t&&(s=s.filter(e=>{const s=e.displayStatus||e.paymentStatus;return"completed"===t?"completed"===s:"paid"===t?"paid"===s:"pending"===t?"pending"===s:s===t}));const o=s.slice(0,20);c(1===e?o:e=>[...e,...o]),m(e),d(20===o.length)}catch(t){console.error("\u83b7\u53d6\u8ba2\u5355\u5931\u8d25:",t),1===e&&c([])}finally{x(!1)}}),N=e=>{a(e)},T=e=>{t.Taro.navigateTo({url:`/pages/order/detail/index?orderNo=${e}`})},y=(s,n)=>e(exports,null,function*(){if(s.stopPropagation(),console.log("\ud83d\udcb3 \u51c6\u5907\u652f\u4ed8\u8ba2\u5355:",{orderNo:n.orderNo,amount:n.amount,amountType:typeof n.amount}),!n.amount||"number"!==typeof n.amount||isNaN(n.amount))return t.Taro.showToast({title:"\u8ba2\u5355\u91d1\u989d\u65e0\u6548\uff0c\u65e0\u6cd5\u652f\u4ed8",icon:"none"}),void console.error("\u274c \u652f\u4ed8\u9a8c\u8bc1\u5931\u8d25\uff1a\u65e0\u6548\u7684\u8ba2\u5355\u91d1\u989d",{orderNo:n.orderNo,amount:n.amount});try{const e=yield r.paymentService.pay({orderNo:n.orderNo,amount:n.amount,paymentMethod:"wechat",title:n.title});e&&E()}catch(e){console.error("\u274c \u652f\u4ed8\u5931\u8d25:",e),t.Taro.showToast({title:e.message||"\u652f\u4ed8\u5931\u8d25",icon:"none"})}}),R=(s,n)=>e(exports,null,function*(){s.stopPropagation(),t.Taro.showModal({title:"\u53d6\u6d88\u8ba2\u5355",content:"\u786e\u5b9a\u8981\u53d6\u6d88\u8be5\u8ba2\u5355\u5417\uff1f",success:s=>e(exports,null,function*(){if(s.confirm)try{const e=yield r.orderService.cancelOrder(n.orderNo);"pending"===n.paymentStatus?t.Taro.showToast({title:"\u53d6\u6d88\u8ba2\u5355",icon:"success"}):"paid"===n.paymentStatus&&e.refundAmount&&e.refundAmount>0?(t.Taro.showToast({title:"\u53d6\u6d88\u8ba2\u5355",icon:"success"}),setTimeout(()=>{t.Taro.showToast({title:`\u9000\u6b3e\uffe5${(e.refundAmount/100).toFixed(2)}`,icon:"success",duration:2500})},500)):t.Taro.showToast({title:"\u53d6\u6d88\u8ba2\u5355",icon:"success"}),E(1)}catch(e){t.Taro.showToast({title:e.message||"\u53d6\u6d88\u5931\u8d25",icon:"none"})}})})}),g=(e,s)=>{e.stopPropagation(),t.Taro.switchTab({url:"/pages/appointment/index"})},w=e=>{const t=e.displayStatus||e.paymentStatus,s={pending:"\u5f85\u652f\u4ed8",paid:"\u5f85\u670d\u52a1",serving:"\u670d\u52a1\u4e2d",completed:"\u5df2\u5b8c\u6210",cancelled:"\u5df2\u53d6\u6d88",refunded:"\u5df2\u9000\u6b3e"};return s[t]||t},f=e=>{const t=e.displayStatus||e.paymentStatus,s={pending:"status-pending",paid:"status-paid",serving:"status-serving",completed:"status-completed",cancelled:"status-cancelled",refunded:"status-refunded"};return s[t]||""},v=e=>{const t=o(e);if(!t)return"";const s=t.getMonth()+1,r=t.getDate(),n=t.getHours(),a=t.getMinutes();return`${s}\u6708${r}\u65e5 ${n.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}`},S=e=>{var s;return t.jsxRuntimeExports.jsxs(t.View,{className:"order-item",onClick:()=>T(e.orderNo),children:[t.jsxRuntimeExports.jsxs(t.View,{className:"order-header",children:["service"===e.orderType&&t.jsxRuntimeExports.jsx(t.Text,{className:"store-name",children:e.storeName}),"product"===e.orderType&&t.jsxRuntimeExports.jsx(t.Text,{className:"store-name",children:e.title}),t.jsxRuntimeExports.jsx(t.Text,{className:`order-status ${f(e)}`,children:w(e)})]}),t.jsxRuntimeExports.jsxs(t.View,{className:"order-content",children:["service"===e.orderType&&e.therapistAvatar&&t.jsxRuntimeExports.jsx(t.Image,{className:"therapist-avatar",src:e.therapistAvatar}),t.jsxRuntimeExports.jsxs(t.View,{className:"order-info "+(e.therapistAvatar||"service"!==e.orderType?"":"no-image"),children:["service"===e.orderType&&t.jsxRuntimeExports.jsxs(t.jsxRuntimeExports.Fragment,{children:[t.jsxRuntimeExports.jsxs(t.View,{className:"info-row",children:[t.jsxRuntimeExports.jsx(t.Text,{className:"therapist-name",children:e.therapistName}),t.jsxRuntimeExports.jsx(t.Text,{className:"service-name",children:e.serviceName})]}),t.jsxRuntimeExports.jsx(t.View,{className:"info-row",children:t.jsxRuntimeExports.jsxs(t.Text,{className:"appointment-time",children:["\u9884\u7ea6\u65f6\u95f4\uff1a",v(`${e.appointmentDate} ${e.startTime}`),"  "]})})]}),"product"===e.orderType&&t.jsxRuntimeExports.jsxs(t.jsxRuntimeExports.Fragment,{children:[t.jsxRuntimeExports.jsxs(t.View,{className:"info-row",children:[t.jsxRuntimeExports.jsx(t.Text,{className:"service-name",children:e.title}),(null==(s=e.extraData)?void 0:s.quantity)&&t.jsxRuntimeExports.jsxs(t.Text,{className:"quantity",children:["\xd7",e.extraData.quantity]})]}),t.jsxRuntimeExports.jsx(t.View,{className:"info-row",children:t.jsxRuntimeExports.jsxs(t.Text,{className:"appointment-time",children:["\u8d2d\u4e70\u65f6\u95f4\uff1a",v(e.createdAt)]})})]}),t.jsxRuntimeExports.jsx(t.View,{className:"info-row",children:t.jsxRuntimeExports.jsxs(t.Text,{className:"order-no",children:["\u8ba2\u5355\u53f7\uff1a",e.orderNo]})})]})]}),t.jsxRuntimeExports.jsxs(t.View,{className:"order-footer",children:[t.jsxRuntimeExports.jsxs(t.View,{className:"price-info",children:[t.jsxRuntimeExports.jsx(t.Text,{className:"label",children:"\u5b9e\u4ed8\uff1a"}),t.jsxRuntimeExports.jsx(t.Text,{className:"price",children:r.formatAmount(e.amount)}),"  "]}),t.jsxRuntimeExports.jsxs(t.View,{className:"action-buttons",children:["pending"===(e.displayStatus||e.paymentStatus)&&t.jsxRuntimeExports.jsxs(t.jsxRuntimeExports.Fragment,{children:[t.jsxRuntimeExports.jsx(t.View,{className:"button cancel",onClick:t=>R(t,e),children:"\u53d6\u6d88\u8ba2\u5355"}),t.jsxRuntimeExports.jsx(t.View,{className:"button pay",onClick:t=>y(t,e),children:"\u53bb\u652f\u4ed8"})]}),"paid"===(e.displayStatus||e.paymentStatus)&&"service"===e.orderType&&t.jsxRuntimeExports.jsx(t.View,{className:"button cancel",onClick:t=>R(t,e),children:"\u53d6\u6d88\u8ba2\u5355"}),"serving"===(e.displayStatus||e.paymentStatus)&&null,"completed"===e.displayStatus&&"service"===e.orderType&&t.jsxRuntimeExports.jsx(t.View,{className:"button rebook",onClick:e=>g(e),children:"\u518d\u6b21\u9884\u7ea6"}),["cancelled","refunded"].includes(e.displayStatus||e.paymentStatus)&&"service"===e.orderType&&t.jsxRuntimeExports.jsx(t.View,{className:"button rebook",onClick:e=>g(e),children:"\u518d\u6b21\u9884\u7ea6"})]})]})]},e.orderNo)},V=()=>t.jsxRuntimeExports.jsxs(t.View,{className:"empty-state",children:[t.jsxRuntimeExports.jsx(s.AtIcon,{value:"file-generic",size:"60",color:"#ccc"}),t.jsxRuntimeExports.jsx(t.Text,{className:"empty-text",children:"\u6682\u65e0\u8ba2\u5355"})]}),b=()=>t.jsxRuntimeExports.jsx(t.View,{className:"loading-state",children:t.jsxRuntimeExports.jsx(t.Text,{children:"\u52a0\u8f7d\u4e2d..."})});return t.jsxRuntimeExports.jsx(t.View,{className:"order-list-page",children:t.jsxRuntimeExports.jsx(s.AtTabs,{current:n,tabList:j,onClick:N,className:"order-tabs",children:j.map((e,r)=>t.jsxRuntimeExports.jsx(s.AtTabsPane,{current:n,index:r,children:t.jsxRuntimeExports.jsx(t.ScrollView,{scrollY:!0,className:"order-list",children:l?b():i.length>0?i.map(S):V()})},r))})})};var c={navigationBarTitleText:"\u6211\u7684\u8ba2\u5355",enablePullDownRefresh:!0,backgroundTextStyle:"dark"};Page(t.createPageConfig(i,"pages/order/list/index",{root:{cn:[]}},c||{}));
