"use strict";var e=Object.defineProperty,t=Object.defineProperties,s=Object.getOwnPropertyDescriptors,r=Object.getOwnPropertySymbols,o=Object.prototype.hasOwnProperty,n=Object.prototype.propertyIsEnumerable,a=(t,s,r)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[s]=r,i=(e,t)=>{for(var s in t||(t={}))o.call(t,s)&&a(e,s,t[s]);if(r)for(var s of r(t))n.call(t,s)&&a(e,s,t[s]);return e},c=(e,r)=>t(e,s(r)),l=(e,t,s)=>new Promise((r,o)=>{var n=e=>{try{i(s.next(e))}catch(t){o(t)}},a=e=>{try{i(s.throw(e))}catch(t){o(t)}},i=e=>e.done?r(e.value):Promise.resolve(e.value).then(n,a);i((s=s.apply(e,t)).next())});const p=require("../../../taro.js"),u=require("../../../vendors.js"),x=require("../../../common.js"),d=e=>e?e.includes("T")?e:e.replace(" ","T"):null,m=e=>{if(!e)return null;const t=d(e);if(!t)return null;const s=new Date(t);return isNaN(s.getTime())?(console.warn("\u26a0\ufe0f \u65e0\u6548\u7684\u65e5\u671f\u683c\u5f0f:",e),null):s},j="",h=()=>{const[e,t]=p.reactExports.useState(0),[s,r]=p.reactExports.useState([]),[o,n]=p.reactExports.useState(!0),[a,d]=p.reactExports.useState(!1),[j,h]=p.reactExports.useState(1),g=[{title:"\u5168\u90e8"},{title:"\u5f85\u652f\u4ed8"},{title:"\u5f85\u670d\u52a1"},{title:"\u5df2\u5b8c\u6210"}],y={0:void 0,1:"pending",2:"paid",3:"completed"};p.taroExports.useDidShow(()=>{h(1),T(1)}),p.reactExports.useEffect(()=>{h(1),T(1)},[e]),p.taroExports.usePullDownRefresh(()=>l(exports,null,function*(){yield T(1),p.Taro.stopPullDownRefresh()}));const T=(...t)=>l(exports,[...t],function*(t=j){try{n(!0);const s=y[e];let o=yield x.orderService.getOrderList(void 0,void 0,t,100);s&&(o=o.filter(e=>{const t=e.displayStatus||e.paymentStatus;return"completed"===s?"completed"===t:"paid"===s?"paid"===t:"pending"===s?"pending"===t:t===s}));const a=o.slice(0,20);r(1===t?a:e=>[...e,...a]),h(t),d(20===a.length)}catch(s){console.error("\u83b7\u53d6\u8ba2\u5355\u5931\u8d25:",s),1===t&&r([])}finally{n(!1)}}),E=e=>{t(e)},N=e=>{p.Taro.navigateTo({url:`/pages/order/detail/index?orderNo=${e}`})},f=(e,t)=>l(exports,null,function*(){var s,r;if(e.stopPropagation(),console.log("\ud83d\udcb3 \u51c6\u5907\u652f\u4ed8\u8ba2\u5355:",{orderNo:t.orderNo,amount:t.amount,amountType:typeof t.amount}),!t.amount||"number"!==typeof t.amount||isNaN(t.amount))return p.Taro.showToast({title:"\u8ba2\u5355\u91d1\u989d\u65e0\u6548\uff0c\u65e0\u6cd5\u652f\u4ed8",icon:"none"}),void console.error("\u274c \u652f\u4ed8\u9a8c\u8bc1\u5931\u8d25\uff1a\u65e0\u6548\u7684\u8ba2\u5355\u91d1\u989d",{orderNo:t.orderNo,amount:t.amount});try{const e=yield x.orderService.getPaymentParams(t.orderNo),o=["timeStamp","nonceStr","package","signType","paySign"],n=o.filter(t=>!e[t]);if(n.length>0)return console.error("\u274c \u5fae\u4fe1\u652f\u4ed8\u53c2\u6570\u4e0d\u5b8c\u6574\uff0c\u7f3a\u5c11\u5b57\u6bb5:",n,"\u5b8c\u6574\u53c2\u6570:",e),void p.Taro.showToast({title:`\u652f\u4ed8\u53c2\u6570\u7f3a\u5931: ${n.join(", ")}`,icon:"none"});console.log("\ud83d\udcb3 \u5fae\u4fe1\u652f\u4ed8\u53c2\u6570\u9a8c\u8bc1\u901a\u8fc7:",{timeStamp:e.timeStamp,nonceStr:(null==(s=e.nonceStr)?void 0:s.substring(0,8))+"...",package:e.package,signType:e.signType,paySign:(null==(r=e.paySign)?void 0:r.substring(0,16))+"..."}),p.Taro.requestPayment(c(i({timeStamp:e.timeStamp,nonceStr:e.nonceStr,package:e.package,signType:e.signType,paySign:e.paySign},e.total_fee&&{total_fee:e.total_fee}),{success:()=>l(exports,null,function*(){yield x.orderService.updateOrderStatus(t.orderNo,"paid"),p.Taro.showToast({title:"\u652f\u4ed8\u6210\u529f",icon:"success"}),T()}),fail:e=>{"requestPayment:fail cancel"!==e.errMsg?(console.error("\ud83d\udcb3 \u5fae\u4fe1\u652f\u4ed8\u5931\u8d25:",{errMsg:e.errMsg,errCode:e.errCode,message:e.message}),p.Taro.showToast({title:e.errMsg||"\u652f\u4ed8\u5931\u8d25",icon:"none",duration:3e3})):console.log("\ud83d\udcb3 \u7528\u6237\u53d6\u6d88\u652f\u4ed8")}}))}catch(o){console.error("\u274c \u83b7\u53d6\u652f\u4ed8\u53c2\u6570\u5931\u8d25:",o),p.Taro.showToast({title:"\u83b7\u53d6\u652f\u4ed8\u53c2\u6570\u5931\u8d25",icon:"none"})}}),w=(e,t)=>l(exports,null,function*(){e.stopPropagation(),p.Taro.showModal({title:"\u53d6\u6d88\u8ba2\u5355",content:"\u786e\u5b9a\u8981\u53d6\u6d88\u8be5\u8ba2\u5355\u5417\uff1f",success:e=>l(exports,null,function*(){if(e.confirm)try{const e=yield x.orderService.cancelOrder(t.orderNo);"pending"===t.paymentStatus?p.Taro.showToast({title:"\u53d6\u6d88\u8ba2\u5355",icon:"success"}):"paid"===t.paymentStatus&&e.refundAmount&&e.refundAmount>0?(p.Taro.showToast({title:"\u53d6\u6d88\u8ba2\u5355",icon:"success"}),setTimeout(()=>{p.Taro.showToast({title:`\u9000\u6b3e\uffe5${(e.refundAmount/100).toFixed(2)}`,icon:"success",duration:2500})},500)):p.Taro.showToast({title:"\u53d6\u6d88\u8ba2\u5355",icon:"success"}),T(1)}catch(s){p.Taro.showToast({title:s.message||"\u53d6\u6d88\u5931\u8d25",icon:"none"})}})})}),S=(e,t)=>{e.stopPropagation(),p.Taro.switchTab({url:"/pages/appointment/index"})},R=e=>{const t=e.displayStatus||e.paymentStatus,s={pending:"\u5f85\u652f\u4ed8",paid:"\u5f85\u670d\u52a1",serving:"\u670d\u52a1\u4e2d",completed:"\u5df2\u5b8c\u6210",cancelled:"\u5df2\u53d6\u6d88",refunded:"\u5df2\u9000\u6b3e"};return s[t]||t},v=e=>{const t=e.displayStatus||e.paymentStatus,s={pending:"status-pending",paid:"status-paid",serving:"status-serving",completed:"status-completed",cancelled:"status-cancelled",refunded:"status-refunded"};return s[t]||""},b=e=>{const t=m(e);if(!t)return"";const s=t.getMonth()+1,r=t.getDate(),o=t.getHours(),n=t.getMinutes();return`${s}\u6708${r}\u65e5 ${o.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`},V=e=>{var t;return p.jsxRuntimeExports.jsxs(p.View,{className:"order-item",onClick:()=>N(e.orderNo),children:[p.jsxRuntimeExports.jsxs(p.View,{className:"order-header",children:["service"===e.orderType&&p.jsxRuntimeExports.jsx(p.Text,{className:"store-name",children:e.storeName}),"product"===e.orderType&&p.jsxRuntimeExports.jsx(p.Text,{className:"store-name",children:e.title}),p.jsxRuntimeExports.jsx(p.Text,{className:`order-status ${v(e)}`,children:R(e)})]}),p.jsxRuntimeExports.jsxs(p.View,{className:"order-content",children:["service"===e.orderType&&e.therapistAvatar&&p.jsxRuntimeExports.jsx(p.Image,{className:"therapist-avatar",src:e.therapistAvatar}),p.jsxRuntimeExports.jsxs(p.View,{className:"order-info "+(e.therapistAvatar||"service"!==e.orderType?"":"no-image"),children:["service"===e.orderType&&p.jsxRuntimeExports.jsxs(p.jsxRuntimeExports.Fragment,{children:[p.jsxRuntimeExports.jsxs(p.View,{className:"info-row",children:[p.jsxRuntimeExports.jsx(p.Text,{className:"therapist-name",children:e.therapistName}),p.jsxRuntimeExports.jsx(p.Text,{className:"service-name",children:e.serviceName})]}),p.jsxRuntimeExports.jsx(p.View,{className:"info-row",children:p.jsxRuntimeExports.jsxs(p.Text,{className:"appointment-time",children:["\u9884\u7ea6\u65f6\u95f4\uff1a",b(`${e.appointmentDate} ${e.startTime}`),"  "]})})]}),"product"===e.orderType&&p.jsxRuntimeExports.jsxs(p.jsxRuntimeExports.Fragment,{children:[p.jsxRuntimeExports.jsxs(p.View,{className:"info-row",children:[p.jsxRuntimeExports.jsx(p.Text,{className:"service-name",children:e.title}),(null==(t=e.extraData)?void 0:t.quantity)&&p.jsxRuntimeExports.jsxs(p.Text,{className:"quantity",children:["\xd7",e.extraData.quantity]})]}),p.jsxRuntimeExports.jsx(p.View,{className:"info-row",children:p.jsxRuntimeExports.jsxs(p.Text,{className:"appointment-time",children:["\u8d2d\u4e70\u65f6\u95f4\uff1a",b(e.createdAt)]})})]}),p.jsxRuntimeExports.jsx(p.View,{className:"info-row",children:p.jsxRuntimeExports.jsxs(p.Text,{className:"order-no",children:["\u8ba2\u5355\u53f7\uff1a",e.orderNo]})})]})]}),p.jsxRuntimeExports.jsxs(p.View,{className:"order-footer",children:[p.jsxRuntimeExports.jsxs(p.View,{className:"price-info",children:[p.jsxRuntimeExports.jsx(p.Text,{className:"label",children:"\u5b9e\u4ed8\uff1a"}),p.jsxRuntimeExports.jsx(p.Text,{className:"price",children:x.formatAmount(e.amount)}),"  "]}),p.jsxRuntimeExports.jsxs(p.View,{className:"action-buttons",children:["pending"===(e.displayStatus||e.paymentStatus)&&p.jsxRuntimeExports.jsxs(p.jsxRuntimeExports.Fragment,{children:[p.jsxRuntimeExports.jsx(p.View,{className:"button cancel",onClick:t=>w(t,e),children:"\u53d6\u6d88\u8ba2\u5355"}),p.jsxRuntimeExports.jsx(p.View,{className:"button pay",onClick:t=>f(t,e),children:"\u53bb\u652f\u4ed8"})]}),"paid"===(e.displayStatus||e.paymentStatus)&&"service"===e.orderType&&p.jsxRuntimeExports.jsx(p.View,{className:"button cancel",onClick:t=>w(t,e),children:"\u53d6\u6d88\u8ba2\u5355"}),"serving"===(e.displayStatus||e.paymentStatus)&&null,"completed"===e.displayStatus&&"service"===e.orderType&&p.jsxRuntimeExports.jsx(p.View,{className:"button rebook",onClick:e=>S(e),children:"\u518d\u6b21\u9884\u7ea6"}),["cancelled","refunded"].includes(e.displayStatus||e.paymentStatus)&&"service"===e.orderType&&p.jsxRuntimeExports.jsx(p.View,{className:"button rebook",onClick:e=>S(e),children:"\u518d\u6b21\u9884\u7ea6"})]})]})]},e.orderNo)},P=()=>p.jsxRuntimeExports.jsxs(p.View,{className:"empty-state",children:[p.jsxRuntimeExports.jsx(u.AtIcon,{value:"file-generic",size:"60",color:"#ccc"}),p.jsxRuntimeExports.jsx(p.Text,{className:"empty-text",children:"\u6682\u65e0\u8ba2\u5355"})]}),k=()=>p.jsxRuntimeExports.jsx(p.View,{className:"loading-state",children:p.jsxRuntimeExports.jsx(p.Text,{children:"\u52a0\u8f7d\u4e2d..."})});return p.jsxRuntimeExports.jsx(p.View,{className:"order-list-page",children:p.jsxRuntimeExports.jsx(u.AtTabs,{current:e,tabList:g,onClick:E,className:"order-tabs",children:g.map((t,r)=>p.jsxRuntimeExports.jsx(u.AtTabsPane,{current:e,index:r,children:p.jsxRuntimeExports.jsx(p.ScrollView,{scrollY:!0,className:"order-list",children:o?k():s.length>0?s.map(V):P()})},r))})})};var g={navigationBarTitleText:"\u6211\u7684\u8ba2\u5355",enablePullDownRefresh:!0,backgroundTextStyle:"dark"};Page(p.createPageConfig(h,"pages/order/list/index",{root:{cn:[]}},g||{}));
