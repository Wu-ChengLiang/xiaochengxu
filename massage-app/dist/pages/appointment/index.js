"use strict";var e=(e,s,t)=>new Promise((i,r)=>{var a=e=>{try{o(t.next(e))}catch(s){r(s)}},n=e=>{try{o(t.throw(e))}catch(s){r(s)}},o=e=>e.done?i(e.value):Promise.resolve(e.value).then(a,n);o((t=t.apply(e,s)).next())});const s=require("../../taro.js"),t=require("../../common.js"),i=require("../../vendors.js");class r{getCurrentLocation(){return e(this,null,function*(){var e;try{const{authSetting:e}=yield s.Taro.getSetting();e["scope.userLocation"]||(yield s.Taro.authorize({scope:"scope.userLocation"}));const t=yield s.Taro.getLocation({type:"gcj02",isHighAccuracy:!0});return{latitude:t.latitude,longitude:t.longitude}}catch(t){if(console.error("\u83b7\u53d6\u4f4d\u7f6e\u5931\u8d25:",t),null==(e=null==t?void 0:t.errMsg)?void 0:e.includes("auth deny"))return s.Taro.showModal({title:"\u63d0\u793a",content:"\u9700\u8981\u83b7\u53d6\u60a8\u7684\u4f4d\u7f6e\u4fe1\u606f\u6765\u63a8\u8350\u9644\u8fd1\u95e8\u5e97",confirmText:"\u53bb\u8bbe\u7f6e",success:e=>{e.confirm&&s.Taro.openSetting()}}),{latitude:31.2304,longitude:121.4737};throw t}})}calculateDistance(e,s,t,i){const r=Math.PI/180,a=6371,n=(t-e)*r,o=(i-s)*r,c=Math.sin(n/2)*Math.sin(n/2)+Math.cos(e*r)*Math.cos(t*r)*Math.sin(o/2)*Math.sin(o/2),x=2*Math.atan2(Math.sqrt(c),Math.sqrt(1-c));return Number((a*x).toFixed(1))}formatDistance(e){return e<1?`${Math.round(1e3*e)}m`:`${e}km`}}const a=new r,n="",o=({store:e,onClick:i})=>{const r=e=>{switch(e){case"normal":return"\u5c31\u8fd1";case"busy":return"\u7e41\u5fd9";case"full":return"\u7206\u6ee1";default:return""}},a=e=>{switch(e){case"normal":return"status-normal";case"busy":return"status-busy";case"full":return"status-full";default:return""}};return s.jsxRuntimeExports.jsx(s.View,{className:"store-card",onClick:i,children:s.jsxRuntimeExports.jsxs(s.View,{className:"card-content",children:[s.jsxRuntimeExports.jsx(s.View,{className:"store-image-wrapper",children:s.jsxRuntimeExports.jsx(s.Image,{className:"store-image",src:e.images[0],mode:"aspectFill"})}),s.jsxRuntimeExports.jsxs(s.View,{className:"store-info",children:[s.jsxRuntimeExports.jsx(s.Text,{className:"store-name",children:e.name}),s.jsxRuntimeExports.jsxs(s.View,{className:"business-hours",children:[s.jsxRuntimeExports.jsxs(s.Text,{className:"hours-text",children:[e.businessHours.start,"-",e.businessHours.end]}),s.jsxRuntimeExports.jsx(s.Text,{className:`status ${a(e.status)}`,children:r(e.status)})]}),s.jsxRuntimeExports.jsx(s.View,{className:"store-address",children:s.jsxRuntimeExports.jsx(s.Text,{className:"address-text",numberOfLines:1,children:e.address})}),s.jsxRuntimeExports.jsxs(s.View,{className:"store-footer",children:[s.jsxRuntimeExports.jsxs(s.View,{className:"distance",children:[s.jsxRuntimeExports.jsx(s.Text,{className:"icon",children:"\ud83d\udccd"}),s.jsxRuntimeExports.jsxs(s.Text,{className:"distance-text",children:[e.distance,"km"]})]}),s.jsxRuntimeExports.jsx(t.BookingButton,{size:"small"})]})]})]})})},c="",x=({therapist:e,onClick:i})=>s.jsxRuntimeExports.jsx(s.View,{className:"therapist-card",onClick:i,children:s.jsxRuntimeExports.jsxs(s.View,{className:"card-content",children:[s.jsxRuntimeExports.jsx(s.Image,{className:"therapist-avatar",src:e.avatar,mode:"aspectFill"}),s.jsxRuntimeExports.jsxs(s.View,{className:"therapist-info",children:[s.jsxRuntimeExports.jsxs(s.View,{className:"info-header",children:[s.jsxRuntimeExports.jsx(s.Text,{className:"therapist-name",children:e.name}),s.jsxRuntimeExports.jsxs(s.View,{className:"distance",children:[s.jsxRuntimeExports.jsx(s.Text,{className:"icon",children:"\ud83d\udccd"}),s.jsxRuntimeExports.jsxs(s.Text,{className:"distance-text",children:[e.distance,"km"]})]})]}),s.jsxRuntimeExports.jsx(s.View,{className:"expertise-tags",children:e.expertise.map((e,t)=>s.jsxRuntimeExports.jsx(s.Text,{className:"expertise-tag",children:e},t))}),s.jsxRuntimeExports.jsxs(s.View,{className:"therapist-footer",children:[s.jsxRuntimeExports.jsxs(s.View,{className:"rating",children:[s.jsxRuntimeExports.jsx(s.Text,{className:"icon",children:"\u2b50"}),s.jsxRuntimeExports.jsxs(s.Text,{className:"rating-text",children:[e.rating,"\u5206"]}),s.jsxRuntimeExports.jsxs(s.Text,{className:"service-count",children:["\u670d\u52a1",e.serviceCount,"\u6b21"]})]}),s.jsxRuntimeExports.jsx(t.BookingButton,{size:"small"})]})]})]})}),l="",m=({visible:e,title:t,onClose:r,children:a,height:n="70%"})=>{const[o,c]=s.reactExports.useState(!1),[x,l]=s.reactExports.useState(!1);s.reactExports.useEffect(()=>{e?(l(!0),setTimeout(()=>c(!0),50)):(c(!1),setTimeout(()=>l(!1),300))},[e]);const m=()=>{r()},u=e=>{e.stopPropagation()};return x?s.jsxRuntimeExports.jsxs(s.View,{className:"bottom-sheet",onClick:m,children:[s.jsxRuntimeExports.jsx(s.View,{className:"bottom-sheet-mask "+(o?"active":"")}),s.jsxRuntimeExports.jsxs(s.View,{className:"bottom-sheet-content "+(o?"active":""),style:{height:n},onClick:u,children:[s.jsxRuntimeExports.jsxs(s.View,{className:"sheet-header",children:[s.jsxRuntimeExports.jsx(s.Text,{className:"sheet-title",children:t}),s.jsxRuntimeExports.jsx(s.View,{className:"close-btn",onClick:r,children:s.jsxRuntimeExports.jsx(i.AtIcon,{value:"close",size:"20",color:"#999"})})]}),s.jsxRuntimeExports.jsx(s.View,{className:"sheet-body",children:a})]})]}):null},u="",j=()=>{const[i,r]=s.reactExports.useState(!0),[n,c]=s.reactExports.useState([]),[l,u]=s.reactExports.useState([]),[j,d]=s.reactExports.useState([]),[p,h]=s.reactExports.useState({latitude:0,longitude:0}),[E,R]=s.reactExports.useState("loading"),[N,g]=s.reactExports.useState("\u6b63\u5728\u83b7\u53d6\u4f4d\u7f6e..."),[w,T]=s.reactExports.useState(!1),[V,v]=s.reactExports.useState(""),y=[{id:1,image:t.bannerGoodnight,title:"\u665a\u5b89\u597d\u7720",subtitle:"\u6df1\u5ea6\u653e\u677e\u52a9\u7720\u670d\u52a1",link:""}];s.reactExports.useEffect(()=>{b()},[]);const b=()=>e(exports,null,function*(){try{r(!0),R("loading"),g("\u6b63\u5728\u83b7\u53d6\u4f4d\u7f6e...");const e=yield a.getCurrentLocation();h(e),31.2304===e.latitude&&121.4737===e.longitude?(R("error"),g("\u5b9a\u4f4d\u5931\u8d25\uff0c\u4f7f\u7528\u9ed8\u8ba4\u4f4d\u7f6e")):(R("success"),g("\u5b9a\u4f4d\u6210\u529f"),setTimeout(()=>{g("\u4e0a\u6d77\u5e02")},2e3));const s=yield t.storeService.getNearbyStores(e.latitude,e.longitude,1,2);c(s.list);const i=yield t.storeService.getNearbyStores(e.latitude,e.longitude,1,20);u(i.list);const n=yield t.therapistService.getRecommendedTherapists();d(n.list)}catch(e){console.error("\u52a0\u8f7d\u6570\u636e\u5931\u8d25:",e),R("error"),g("\u5b9a\u4f4d\u5931\u8d25"),s.Taro.showToast({title:"\u52a0\u8f7d\u5931\u8d25\uff0c\u8bf7\u91cd\u8bd5",icon:"none"})}finally{r(!1)}}),f=e=>{s.Taro.navigateTo({url:`/pages/appointment/store/index?id=${e.id}`})},k=e=>{s.Taro.navigateTo({url:`/pages/appointment/therapist/index?therapistId=${e.id}&storeId=${e.storeId}`})},C=()=>{T(!0)},S=()=>{s.Taro.showToast({title:"\u529f\u80fd\u5f00\u53d1\u4e2d",icon:"none"})},M=e=>{s.Taro.navigateTo({url:"/pages/promotion/index"})};return s.jsxRuntimeExports.jsxs(s.View,{className:"appointment-page",children:[s.jsxRuntimeExports.jsx(s.View,{className:"header",children:s.jsxRuntimeExports.jsxs(s.View,{className:"location",children:[s.jsxRuntimeExports.jsx(s.Text,{className:"icon",children:"loading"===E||"success"===E?"\ud83d\udccd":"\u26a0\ufe0f"}),s.jsxRuntimeExports.jsx(s.Text,{className:`text ${E}`,children:N}),"error"===E&&s.jsxRuntimeExports.jsx(s.Text,{className:"retry-btn",onClick:b,children:"\u91cd\u8bd5"})]})}),s.jsxRuntimeExports.jsxs(s.View,{className:"banner-section",children:[s.jsxRuntimeExports.jsx(s.Text,{className:"section-title",children:"\u4f18\u60e0\u9884\u7ea6"}),s.jsxRuntimeExports.jsx(s.Swiper,{className:"banner-swiper",autoplay:!0,interval:3e3,indicatorDots:!0,indicatorActiveColor:"#D9455F",children:y.map(e=>s.jsxRuntimeExports.jsx(s.SwiperItem,{children:s.jsxRuntimeExports.jsx(s.View,{className:"banner-item",onClick:()=>M(),children:s.jsxRuntimeExports.jsx(s.Image,{className:"banner-image",src:e.image,mode:"aspectFill"})})},e.id))})]}),s.jsxRuntimeExports.jsxs(s.View,{className:"stores-section",children:[s.jsxRuntimeExports.jsxs(s.View,{className:"section-header",children:[s.jsxRuntimeExports.jsx(s.Text,{className:"section-title",children:"\u95e8\u5e97\u9884\u7ea6"}),s.jsxRuntimeExports.jsxs(s.Text,{className:"more-link",onClick:C,children:["\u66f4\u591a\u95e8\u5e97 ",">>"]})]}),s.jsxRuntimeExports.jsx(s.View,{className:"store-list",children:n.map(e=>s.jsxRuntimeExports.jsx(o,{store:e,onClick:()=>f(e)},e.id))})]}),s.jsxRuntimeExports.jsxs(s.View,{className:"therapists-section",children:[s.jsxRuntimeExports.jsxs(s.View,{className:"section-header",children:[s.jsxRuntimeExports.jsx(s.Text,{className:"section-title",children:"\u63a8\u62ff\u5e08\u9884\u7ea6"}),s.jsxRuntimeExports.jsxs(s.Text,{className:"more-link",onClick:S,children:["\u66f4\u591a\u75c7\u72b6 ",">>"]})]}),s.jsxRuntimeExports.jsx(s.View,{className:"therapist-list",children:j.map(e=>s.jsxRuntimeExports.jsx(x,{therapist:e,onClick:()=>k(e)},e.id))})]}),s.jsxRuntimeExports.jsxs(m,{visible:w,title:"\u66f4\u591a\u95e8\u5e97",onClose:()=>T(!1),height:"80%",children:[s.jsxRuntimeExports.jsxs(s.View,{className:"store-sheet-header",children:[s.jsxRuntimeExports.jsxs(s.View,{className:"city-selector",children:[s.jsxRuntimeExports.jsx(s.Text,{className:"city-name",children:"\u4e0a\u6d77\u5e02"}),s.jsxRuntimeExports.jsx(s.Text,{className:"city-arrow",children:"\u25bc"})]}),s.jsxRuntimeExports.jsxs(s.View,{className:"search-box",children:[s.jsxRuntimeExports.jsx(s.Text,{className:"search-icon",children:"\ud83d\udd0d"}),s.jsxRuntimeExports.jsx(s.Input,{className:"search-input",placeholder:"\u641c\u7d22\u95e8\u5e97",value:V,onInput:e=>v(e.detail.value)})]})]}),s.jsxRuntimeExports.jsx(s.View,{className:"store-sheet-list",children:l.filter(e=>""===V||e.name.includes(V)||e.address.includes(V)).map(e=>s.jsxRuntimeExports.jsx(o,{store:e,onClick:()=>{f(e),T(!1)}},e.id))})]})]})};var d={};Page(s.createPageConfig(j,"pages/appointment/index",{root:{cn:[]}},d||{}));
