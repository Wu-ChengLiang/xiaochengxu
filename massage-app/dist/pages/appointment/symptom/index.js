"use strict";var e=Object.defineProperty,s=Object.defineProperties,t=Object.getOwnPropertyDescriptors,i=Object.getOwnPropertySymbols,r=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable,o=(s,t,i)=>t in s?e(s,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):s[t]=i,n=(e,s)=>{for(var t in s||(s={}))r.call(s,t)&&o(e,t,s[t]);if(i)for(var t of i(s))a.call(s,t)&&o(e,t,s[t]);return e},c=(e,i)=>s(e,t(i)),l=(e,s,t)=>new Promise((i,r)=>{var a=e=>{try{n(t.next(e))}catch(s){r(s)}},o=e=>{try{n(t.throw(e))}catch(s){r(s)}},n=e=>e.done?i(e.value):Promise.resolve(e.value).then(a,o);n((t=t.apply(e,s)).next())});const d=require("../../../taro.js"),m=require("../../../vendors.js"),p=require("../../../common.js"),u="",x=({categories:e,activeId:s,onChange:t,className:i})=>d.jsxRuntimeExports.jsx(d.ScrollView,{className:m.classNames("symptom-category-tabs",i),scrollY:!0,showScrollbar:!1,children:e.map(e=>d.jsxRuntimeExports.jsx(d.View,{className:m.classNames("category-item",{active:e.id===s}),onClick:()=>t(e.id),children:d.jsxRuntimeExports.jsx(d.Text,{className:"category-name",children:e.name})},e.id))}),h="",v=({service:e,onAdd:s,isInCart:t=!1,className:i})=>d.jsxRuntimeExports.jsxs(d.View,{className:m.classNames("symptom-service-card",i),children:[d.jsxRuntimeExports.jsx(d.View,{className:"service-header",children:d.jsxRuntimeExports.jsx(d.Text,{className:"service-name",children:e.name})}),d.jsxRuntimeExports.jsx(d.Text,{className:"service-description",children:e.description}),d.jsxRuntimeExports.jsxs(d.View,{className:"service-footer",children:[d.jsxRuntimeExports.jsxs(d.View,{className:"service-info",children:[d.jsxRuntimeExports.jsxs(d.Text,{className:"service-duration",children:[e.duration,"\u5206\u949f"]}),d.jsxRuntimeExports.jsxs(d.View,{className:"service-price",children:[d.jsxRuntimeExports.jsxs(d.Text,{className:"price-current",children:["\xa5",e.discountPrice||e.price]}),e.discountPrice&&d.jsxRuntimeExports.jsxs(d.Text,{className:"price-original",children:["\xa5",e.price]})]})]}),d.jsxRuntimeExports.jsx(d.View,{className:m.classNames("add-button",{"in-cart":t,disabled:"full"===e.availability}),onClick:"full"!==e.availability?s:void 0,children:"full"===e.availability?d.jsxRuntimeExports.jsx(d.Text,{className:"button-text",children:"\u5df2\u6ee1"}):d.jsxRuntimeExports.jsx(d.Text,{className:"iconfont icon-add"})})]})]}),j="",g=({services:e,therapists:s,selectedDate:t,selectedTime:i,onAddToCart:r,cartServiceIds:a,className:o})=>{const n=e=>{var s;if(!e.availability||!t||!i)return!0;const r=e.availability.find(e=>e.date===t);if(!r)return!0;const a=r.slots.find(e=>e.time===i);return null==(s=null==a?void 0:a.available)||s},c=e.map(e=>({service:e,availableTherapists:s}));return d.jsxRuntimeExports.jsx(d.ScrollView,{className:`symptom-service-list ${o||""}`,scrollY:!0,showScrollbar:!1,children:d.jsxRuntimeExports.jsx(d.View,{className:"service-list-content",children:c.map(e=>d.jsxRuntimeExports.jsxs(d.View,{className:"service-item-container",children:[d.jsxRuntimeExports.jsx(v,{service:e.service,onAdd:()=>{},isInCart:a.includes(e.service.id)}),d.jsxRuntimeExports.jsx(d.View,{className:"therapist-options",children:e.availableTherapists.map(s=>{const t=n(s);return d.jsxRuntimeExports.jsxs(d.View,{className:"therapist-option "+(t?"available":"booked"),onClick:()=>t&&r(e.service,s.id),children:[d.jsxRuntimeExports.jsxs(d.View,{className:"therapist-avatar-wrapper",children:[d.jsxRuntimeExports.jsx(d.Image,{className:"therapist-mini-avatar",src:s.avatar,mode:"aspectFill"}),!t&&d.jsxRuntimeExports.jsx(d.View,{className:"booked-badge",children:d.jsxRuntimeExports.jsx(d.Text,{className:"badge-text",children:"\u5df2\u9884\u7ea6"})})]}),d.jsxRuntimeExports.jsx(d.Text,{className:"therapist-name",children:s.name})]},s.id)})})]},e.service.id))})})},y=e=>new Promise(s=>setTimeout(s,e)),E={getCategories(){return l(this,null,function*(){return yield y(100),{code:200,data:p.symptomCategories,message:"success"}})},getTherapistSymptomServices(e){return l(this,null,function*(){if(yield y(200),!e)throw new Error("\u63a8\u62ff\u5e08ID\u4e0d\u80fd\u4e3a\u7a7a");const s=getTherapistSymptomServices(e);return{code:200,data:s,message:"success"}})},getStoreSymptomServices(e){return l(this,null,function*(){if(!e)throw new Error("\u95e8\u5e97ID\u4e0d\u80fd\u4e3a\u7a7a");try{const s=yield p.request(`/stores/${e}`),t=s.data.services||[],i=t.map(e=>{const s=e.name;let t="1";return s.includes("\u9888\u80a9")||s.includes("\u8170\u80cc")||s.includes("\u8170\u817f\u75db")?t="1":s.includes("\u809d")||s.includes("\u80ba")||s.includes("\u813e\u80c3")?t="2":s.includes("\u7cbe\u6cb9")||s.includes("SPA")||s.includes("\u82b3\u9999")?t="3":s.includes("\u94fa\u59dc")||s.includes("\u5bab\u5bd2")?t="4":s.includes("\u62d4\u7f50")||s.includes("\u522e\u75e7")?t="5":s.includes("\u808c\u8089")||s.includes("\u653e\u677e")||s.includes("\u758f\u901a")?t="6":s.includes("\u6574\u810a")||s.includes("\u4f53\u6001")?t="7":s.includes("\u5173\u5143\u7078")||s.includes("\u60ac\u7078")?t="2":s.includes("\u5168\u8eab")&&(t="6"),c(n({},e),{categoryId:t,availability:"available",description:e.name})});return{code:200,data:i,message:"success"}}catch(s){return console.error("\u83b7\u53d6\u95e8\u5e97\u670d\u52a1\u5931\u8d25:",s),{code:200,data:[],message:"success"}}})},getServicesByCategory(e,s){return l(this,null,function*(){yield y(150);const t=getTherapistSymptomServices(e),i=t.filter(e=>e.categoryId===s);return{code:200,data:i,message:"success"}})}},f="",N=()=>{const e=d.taroExports.useRouter(),{storeId:s,storeName:t,selectedDate:i,selectedTime:r}=e.params,a=r?decodeURIComponent(r):"",[o,m]=d.reactExports.useState([]),[u,h]=d.reactExports.useState([]),[v,j]=d.reactExports.useState([]),[y,f]=d.reactExports.useState(""),[N,b]=d.reactExports.useState([]),[T,w]=d.reactExports.useState(!0);d.reactExports.useEffect(()=>{if(s&&i){const e=()=>l(exports,null,function*(){try{const[e,t]=yield Promise.all([p.therapistService.getTherapistsByStore(s),p.therapistService.getTherapistsAvailability(s,i)]),r=e.list.map(e=>{const s=t.find(s=>s.id===e.id);return c(n({},e),{availability:(null==s?void 0:s.availability)||[]})});console.log("\u2705 \u6280\u5e08\u6570\u636e\u5408\u5e76\u6210\u529f:",r),m(r)}catch(e){console.error("\u274c \u83b7\u53d6\u6280\u5e08\u4fe1\u606f\u5931\u8d25:",e),p.therapistService.getTherapistsByStore(s).then(e=>{m(e.list)})}});e()}},[s,i]),d.reactExports.useEffect(()=>{E.getCategories().then(e=>{h(e.data),e.data.length>0&&f(e.data[0].id)})},[]),d.reactExports.useEffect(()=>{s&&(w(!0),E.getStoreSymptomServices(s).then(e=>{j(e.data),w(!1)}))},[s]);const R=d.reactExports.useMemo(()=>v.filter(e=>e.categoryId===y),[v,y]),S=d.reactExports.useMemo(()=>N.map(e=>e.serviceId),[N]),I=(e,s)=>{console.log("\ud83c\udfaf \u6dfb\u52a0\u5230\u8d2d\u7269\u8f66 - therapistId:",s);const t=o.find(e=>e.id===s);if(console.log("\ud83c\udfaf \u627e\u5230\u7684\u6280\u5e08:",t),!t)return void console.error("\u274c \u672a\u627e\u5230\u6280\u5e08\uff0ctherapistId:",s);const r={serviceId:e.id,serviceName:e.name,duration:e.duration,price:e.price,discountPrice:e.discountPrice,date:i||(new Date).toISOString().split("T")[0],time:a||"10:00",therapistId:t.id,therapistName:t.name,therapistAvatar:t.avatar};console.log("\ud83c\udfaf \u65b0\u8d2d\u7269\u8f66\u9879\u76ee:",r),console.log("\ud83c\udfaf \u65b0\u9879\u76ee\u7684therapistId:",r.therapistId),b([...N,r]),d.Taro.showToast({title:"\u5df2\u6dfb\u52a0\u5230\u8d2d\u7269\u8f66",icon:"none"})},C=()=>{b([]),d.Taro.showToast({title:"\u8d2d\u7269\u8f66\u5df2\u6e05\u7a7a",icon:"none"})},V=e=>{const s=N.filter((s,t)=>t!==e);b(s),d.Taro.showToast({title:"\u5df2\u79fb\u9664\u5546\u54c1",icon:"none"})},P=()=>{var e;if(0===N.length)return void d.Taro.showToast({title:"\u8bf7\u5148\u9009\u62e9\u670d\u52a1\u9879\u76ee",icon:"none"});console.log("\ud83d\udd04 \u51c6\u5907\u7ed3\u7b97\uff0c\u8d2d\u7269\u8f66\u5185\u5bb9:",N),console.log("\ud83d\udd04 \u7b2c\u4e00\u4e2a\u9879\u76ee:",N[0]),console.log("\ud83d\udd04 \u7b2c\u4e00\u4e2a\u9879\u76ee\u7684therapistId:",null==(e=N[0])?void 0:e.therapistId);const i={items:JSON.stringify(N),storeId:s,storeName:t,from:"symptom"};console.log("\ud83d\udd04 \u4f20\u9012\u7684\u53c2\u6570:",i),d.Taro.navigateTo({url:`/pages/booking/confirm/index?${Object.entries(i).map(([e,s])=>`${e}=${encodeURIComponent(s)}`).join("&")}`})};return T?d.jsxRuntimeExports.jsx(d.View,{className:"symptom-page loading",children:"\u52a0\u8f7d\u4e2d..."}):d.jsxRuntimeExports.jsxs(d.View,{className:"symptom-page",children:[d.jsxRuntimeExports.jsxs(d.View,{className:"symptom-content",children:[d.jsxRuntimeExports.jsx(x,{categories:u,activeId:y,onChange:f}),d.jsxRuntimeExports.jsx(g,{services:R,therapists:o,selectedDate:i,selectedTime:a,onAddToCart:I,cartServiceIds:S})]}),d.jsxRuntimeExports.jsx(p.ShoppingCart,{items:N,onCheckout:P,onMaskClick:C,onRemoveItem:V,simpleClearMode:!0})]})};var b={navigationBarTitleText:"\u63a8\u62ff\u5e08\u9884\u7ea6",navigationBarTextStyle:"black",navigationBarBackgroundColor:"#ffffff"};Page(d.createPageConfig(N,"pages/appointment/symptom/index",{root:{cn:[]}},b||{}));
