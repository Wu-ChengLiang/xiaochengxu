"use strict";var e=Object.defineProperty,s=Object.defineProperties,t=Object.getOwnPropertyDescriptors,i=Object.getOwnPropertySymbols,r=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable,o=(s,t,i)=>t in s?e(s,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):s[t]=i,n=(e,s)=>{for(var t in s||(s={}))r.call(s,t)&&o(e,t,s[t]);if(i)for(var t of i(s))a.call(s,t)&&o(e,t,s[t]);return e},c=(e,i)=>s(e,t(i)),l=(e,s,t)=>new Promise((i,r)=>{var a=e=>{try{n(t.next(e))}catch(s){r(s)}},o=e=>{try{n(t.throw(e))}catch(s){r(s)}},n=e=>e.done?i(e.value):Promise.resolve(e.value).then(a,o);n((t=t.apply(e,s)).next())});const m=require("../../../taro.js"),x=require("../../../vendors.js"),p=require("../../../common.js"),d="",u=({categories:e,activeId:s,onChange:t,className:i})=>m.jsxRuntimeExports.jsx(m.ScrollView,{className:x.classNames("symptom-category-tabs",i),scrollY:!0,showScrollbar:!1,children:e.map(e=>m.jsxRuntimeExports.jsx(m.View,{className:x.classNames("category-item",{active:e.id===s}),onClick:()=>t(e.id),children:m.jsxRuntimeExports.jsx(m.Text,{className:"category-name",children:e.name})},e.id))}),j="",v=({service:e,onAdd:s,isInCart:t=!1,className:i})=>m.jsxRuntimeExports.jsxs(m.View,{className:x.classNames("symptom-service-card",i),children:[m.jsxRuntimeExports.jsx(m.View,{className:"service-header",children:m.jsxRuntimeExports.jsx(m.Text,{className:"service-name",children:e.name})}),m.jsxRuntimeExports.jsx(m.Text,{className:"service-description",children:e.description}),m.jsxRuntimeExports.jsxs(m.View,{className:"service-footer",children:[m.jsxRuntimeExports.jsxs(m.View,{className:"service-info",children:[m.jsxRuntimeExports.jsxs(m.Text,{className:"service-duration",children:[e.duration,"\u5206\u949f"]}),m.jsxRuntimeExports.jsxs(m.View,{className:"service-price",children:[m.jsxRuntimeExports.jsxs(m.Text,{className:"price-current",children:["\xa5",e.discountPrice||e.price]}),e.discountPrice&&m.jsxRuntimeExports.jsxs(m.Text,{className:"price-original",children:["\xa5",e.price]})]})]}),m.jsxRuntimeExports.jsx(m.View,{className:x.classNames("add-button",{"in-cart":t,disabled:"full"===e.availability}),onClick:"full"!==e.availability?s:void 0,children:"full"===e.availability?m.jsxRuntimeExports.jsx(m.Text,{className:"button-text",children:"\u5df2\u6ee1"}):m.jsxRuntimeExports.jsx(m.Text,{className:"iconfont icon-add"})})]})]}),h="",g=({services:e,therapists:s,selectedDate:t,selectedTime:i,onAddToCart:r,cartServiceIds:a,className:o})=>{const n=e=>{var s;if(!e.availability||!t||!i)return!0;const r=e.availability.find(e=>e.date===t);if(!r)return!0;const a=r.slots.find(e=>e.time===i);return null==(s=null==a?void 0:a.available)||s},c=e.map(e=>({service:e,availableTherapists:s}));return m.jsxRuntimeExports.jsx(m.ScrollView,{className:`symptom-service-list ${o||""}`,scrollY:!0,showScrollbar:!1,children:m.jsxRuntimeExports.jsx(m.View,{className:"service-list-content",children:c.map(e=>m.jsxRuntimeExports.jsxs(m.View,{className:"service-item-container",children:[m.jsxRuntimeExports.jsx(v,{service:e.service,onAdd:()=>{},isInCart:a.includes(e.service.id)}),m.jsxRuntimeExports.jsx(m.View,{className:"therapist-options",children:e.availableTherapists.map(s=>{const t=n(s);return m.jsxRuntimeExports.jsxs(m.View,{className:"therapist-option "+(t?"available":"booked"),onClick:()=>t&&r(e.service,s.id),children:[m.jsxRuntimeExports.jsxs(m.View,{className:"therapist-avatar-wrapper",children:[m.jsxRuntimeExports.jsx(m.Image,{className:"therapist-mini-avatar",src:s.avatar,mode:"aspectFill"}),!t&&m.jsxRuntimeExports.jsx(m.View,{className:"booked-badge",children:m.jsxRuntimeExports.jsx(m.Text,{className:"badge-text",children:"\u5df2\u9884\u7ea6"})})]}),m.jsxRuntimeExports.jsx(m.Text,{className:"therapist-name",children:s.name})]},s.id)})})]},e.service.id))})})},E="",f=()=>{const e=m.taroExports.useRouter(),{storeId:s,storeName:t,selectedDate:i,selectedTime:r}=e.params,a=r?decodeURIComponent(r):"",[o,x]=m.reactExports.useState([]),[d,j]=m.reactExports.useState([]),[v,h]=m.reactExports.useState([]),[E,f]=m.reactExports.useState(""),[N,y]=m.reactExports.useState([]),[R,b]=m.reactExports.useState(!0);m.reactExports.useEffect(()=>{if(s&&i){const e=()=>l(exports,null,function*(){try{const[e,t]=yield Promise.all([p.therapistService.getTherapistsByStore(s),p.therapistService.getTherapistsAvailability(s,i)]),r=e.list.map(e=>{const s=t.find(s=>s.id===e.id);return c(n({},e),{availability:(null==s?void 0:s.availability)||[]})});console.log("\u2705 \u6280\u5e08\u6570\u636e\u5408\u5e76\u6210\u529f:",r),x(r)}catch(e){console.error("\u274c \u83b7\u53d6\u6280\u5e08\u4fe1\u606f\u5931\u8d25:",e),p.therapistService.getTherapistsByStore(s).then(e=>{x(e.list)})}});e()}},[s,i]),m.reactExports.useEffect(()=>{p.symptomService.getCategories().then(e=>{j(e.data),e.data.length>0&&f(e.data[0].id)})},[]),m.reactExports.useEffect(()=>{s&&(b(!0),p.symptomService.getStoreSymptomServices(s).then(e=>{h(e.data),b(!1)}))},[s]);const T=m.reactExports.useMemo(()=>v.filter(e=>e.categoryId===E),[v,E]),w=m.reactExports.useMemo(()=>N.map(e=>e.serviceId),[N]),S=(e,s)=>{console.log("\ud83c\udfaf \u6dfb\u52a0\u5230\u8d2d\u7269\u8f66 - therapistId:",s);const t=o.find(e=>e.id===s);if(console.log("\ud83c\udfaf \u627e\u5230\u7684\u6280\u5e08:",t),!t)return void console.error("\u274c \u672a\u627e\u5230\u6280\u5e08\uff0ctherapistId:",s);const r={serviceId:e.id,serviceName:e.name,duration:e.duration,price:e.price,discountPrice:e.discountPrice,date:i||(new Date).toISOString().split("T")[0],time:a||"10:00",therapistId:t.id,therapistName:t.name,therapistAvatar:t.avatar};console.log("\ud83c\udfaf \u65b0\u8d2d\u7269\u8f66\u9879\u76ee:",r),console.log("\ud83c\udfaf \u65b0\u9879\u76ee\u7684therapistId:",r.therapistId),y([...N,r]),m.Taro.showToast({title:"\u5df2\u6dfb\u52a0\u5230\u8d2d\u7269\u8f66",icon:"none"})},I=()=>{y([]),m.Taro.showToast({title:"\u8d2d\u7269\u8f66\u5df2\u6e05\u7a7a",icon:"none"})},C=e=>{const s=N.filter((s,t)=>t!==e);y(s),m.Taro.showToast({title:"\u5df2\u79fb\u9664\u5546\u54c1",icon:"none"})},V=()=>{var e;if(0===N.length)return void m.Taro.showToast({title:"\u8bf7\u5148\u9009\u62e9\u670d\u52a1\u9879\u76ee",icon:"none"});console.log("\ud83d\udd04 \u51c6\u5907\u7ed3\u7b97\uff0c\u8d2d\u7269\u8f66\u5185\u5bb9:",N),console.log("\ud83d\udd04 \u7b2c\u4e00\u4e2a\u9879\u76ee:",N[0]),console.log("\ud83d\udd04 \u7b2c\u4e00\u4e2a\u9879\u76ee\u7684therapistId:",null==(e=N[0])?void 0:e.therapistId);const i={items:JSON.stringify(N),storeId:s,storeName:t,from:"symptom"};console.log("\ud83d\udd04 \u4f20\u9012\u7684\u53c2\u6570:",i),m.Taro.navigateTo({url:`/pages/booking/confirm/index?${Object.entries(i).map(([e,s])=>`${e}=${encodeURIComponent(s)}`).join("&")}`})};return R?m.jsxRuntimeExports.jsx(m.View,{className:"symptom-page loading",children:"\u52a0\u8f7d\u4e2d..."}):m.jsxRuntimeExports.jsxs(m.View,{className:"symptom-page",children:[m.jsxRuntimeExports.jsxs(m.View,{className:"symptom-content",children:[m.jsxRuntimeExports.jsx(u,{categories:d,activeId:E,onChange:f}),m.jsxRuntimeExports.jsx(g,{services:T,therapists:o,selectedDate:i,selectedTime:a,onAddToCart:S,cartServiceIds:w})]}),m.jsxRuntimeExports.jsx(p.ShoppingCart,{items:N,onCheckout:V,onMaskClick:I,onRemoveItem:C,simpleClearMode:!0})]})};var N={navigationBarTitleText:"\u63a8\u62ff\u5e08\u9884\u7ea6",navigationBarTextStyle:"black",navigationBarBackgroundColor:"#ffffff"};Page(m.createPageConfig(f,"pages/appointment/symptom/index",{root:{cn:[]}},N||{}));
