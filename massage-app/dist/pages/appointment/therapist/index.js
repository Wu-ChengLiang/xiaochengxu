"use strict";var e=Object.defineProperty,t=Object.defineProperties,s=Object.getOwnPropertyDescriptors,a=Object.getOwnPropertySymbols,i=Object.prototype.hasOwnProperty,r=Object.prototype.propertyIsEnumerable,o=(t,s,a)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[s]=a,n=(e,t)=>{for(var s in t||(t={}))i.call(t,s)&&o(e,s,t[s]);if(a)for(var s of a(t))r.call(t,s)&&o(e,s,t[s]);return e},c=(e,a)=>t(e,s(a)),l=(e,t,s)=>new Promise((a,i)=>{var r=e=>{try{n(s.next(e))}catch(t){i(t)}},o=e=>{try{n(s.throw(e))}catch(t){i(t)}},n=e=>e.done?a(e.value):Promise.resolve(e.value).then(r,o);n((s=s.apply(e,t)).next())});const x=require("../../../taro.js"),m=require("../../../common.js"),u=require("../../../vendors.js"),p="",d=({therapist:e,stats:t,reviews:s=[],reviewsLoading:a=!1})=>{const[i,r]=x.reactExports.useState(!1),o=n({level:"LV4",rating:(null==t?void 0:t.averageRating)||e.rating||4.8,serviceCount:e.serviceCount||0,reviewCount:(null==t?void 0:t.totalCount)||0,description:e.bio||"\u4e13\u4e1a\u63a8\u62ff\u5e08\uff0c\u7ecf\u9a8c\u4e30\u5bcc\uff0c\u64c5\u957f\u5404\u7c7b\u75bc\u75db\u8c03\u7406\u548c\u5eb7\u590d\u6cbb\u7597"},e);console.log("\ud83d\udd0d TherapistInfo Debug:",{therapistId:e.id,serviceCount:e.serviceCount,originalTherapist:e,therapistDetail:o});const c=()=>{r(!i)},l=e=>{const t=new Date(e),s=t.getMonth()+1,a=t.getDate();return`${s}\u6708${a}\u65e5`};return x.jsxRuntimeExports.jsxs(x.View,{className:"therapist-info",children:[x.jsxRuntimeExports.jsxs(x.View,{className:"therapist-header",children:[x.jsxRuntimeExports.jsx(x.View,{className:"avatar-wrapper",children:x.jsxRuntimeExports.jsx(x.Image,{className:"avatar",src:e.avatar,mode:"aspectFill"})}),x.jsxRuntimeExports.jsx(x.View,{className:"basic-info",children:x.jsxRuntimeExports.jsxs(x.View,{className:"name-row",children:[x.jsxRuntimeExports.jsx(x.Text,{className:"name",children:e.name}),x.jsxRuntimeExports.jsx(x.View,{className:"level",children:o.level})]})})]}),x.jsxRuntimeExports.jsxs(x.View,{className:"description-section",children:[x.jsxRuntimeExports.jsx(x.Text,{className:"description "+(i?"expanded":"collapsed"),children:o.description}),i&&x.jsxRuntimeExports.jsxs(x.View,{className:"reviews-section",children:[t&&t.totalCount>0&&x.jsxRuntimeExports.jsx(x.View,{className:"review-stats-compact",children:x.jsxRuntimeExports.jsxs(x.View,{className:"stats-header",children:[x.jsxRuntimeExports.jsx(x.Text,{className:"stats-title",children:"\u7528\u6237\u8bc4\u4ef7"}),x.jsxRuntimeExports.jsxs(x.View,{className:"rating-info",children:[x.jsxRuntimeExports.jsx(x.Text,{className:"score",children:t.averageRating.toFixed(1)}),x.jsxRuntimeExports.jsx(u.AtRate,{value:t.averageRating,size:12}),x.jsxRuntimeExports.jsxs(x.Text,{className:"count",children:["(",t.totalCount,"\u6761)"]})]})]})}),x.jsxRuntimeExports.jsxs(x.View,{className:"review-list-compact",children:[a?x.jsxRuntimeExports.jsx(x.Text,{className:"loading-text",children:"\u52a0\u8f7d\u8bc4\u4ef7\u4e2d..."}):0===s.length?x.jsxRuntimeExports.jsx(x.Text,{className:"empty-text",children:"\u6682\u65e0\u8bc4\u4ef7"}):s.slice(0,3).map(e=>x.jsxRuntimeExports.jsxs(x.View,{className:"review-item-compact",children:[x.jsxRuntimeExports.jsxs(x.View,{className:"review-header-compact",children:[x.jsxRuntimeExports.jsxs(x.View,{className:"user-info-compact",children:[x.jsxRuntimeExports.jsx(x.Text,{className:"user-name",children:e.userName||"\u533f\u540d\u7528\u6237"}),x.jsxRuntimeExports.jsx(u.AtRate,{value:e.rating,size:10})]}),x.jsxRuntimeExports.jsx(x.Text,{className:"review-date",children:l(e.createdAt)})]}),x.jsxRuntimeExports.jsx(x.Text,{className:"review-content-compact",children:e.content}),e.tags&&e.tags.length>0&&x.jsxRuntimeExports.jsx(x.View,{className:"review-tags-compact",children:e.tags.map((e,t)=>x.jsxRuntimeExports.jsx(x.Text,{className:"tag-compact",children:e},t))})]},e.reviewId)),s.length>3&&x.jsxRuntimeExports.jsx(x.Text,{className:"more-reviews",children:"\u4ec5\u663e\u793a\u6700\u8fd13\u6761\u8bc4\u4ef7"})]})]}),x.jsxRuntimeExports.jsxs(x.View,{className:"expand-toggle",onClick:c,children:[x.jsxRuntimeExports.jsx(x.Text,{className:"expand-text",children:i?"\u6536\u8d77":"\u5c55\u5f00"}),x.jsxRuntimeExports.jsx(x.Text,{className:"expand-icon "+(i?"up":"down"),children:i?"\u25b2":"\u25bc"})]})]})]})},j="",h=({store:e})=>{const t=()=>{e.phone&&x.Taro.makePhoneCall({phoneNumber:e.phone})},s=()=>{e.latitude&&e.longitude&&x.Taro.openLocation({latitude:e.latitude,longitude:e.longitude,name:e.name,address:e.address})};return x.jsxRuntimeExports.jsx(x.View,{className:"store-info",children:x.jsxRuntimeExports.jsxs(x.View,{className:"store-header",children:[x.jsxRuntimeExports.jsxs(x.View,{className:"store-details",children:[x.jsxRuntimeExports.jsxs(x.View,{className:"name-row",children:[x.jsxRuntimeExports.jsx(x.Text,{className:"store-name",children:e.name}),void 0!==e.distance&&null!==e.distance&&x.jsxRuntimeExports.jsxs(x.Text,{className:"distance",children:[e.distance,"km"]})]}),x.jsxRuntimeExports.jsx(x.View,{className:"hours-row",children:x.jsxRuntimeExports.jsx(x.Text,{className:"business-hours",children:e.businessHours})}),x.jsxRuntimeExports.jsx(x.Text,{className:"address",children:e.address})]}),x.jsxRuntimeExports.jsxs(x.View,{className:"action-buttons",children:[x.jsxRuntimeExports.jsx(x.View,{className:"action-btn",onClick:t,children:"\ud83d\udcde"}),x.jsxRuntimeExports.jsx(x.View,{className:"action-btn",onClick:s,children:"\ud83d\udccd"})]})]})})},g="",E=x.reactExports.forwardRef(({services:e,therapistId:t,onServiceSelect:s,onTimeSelect:a},i)=>{const[r,o]=x.reactExports.useState(""),[n,c]=x.reactExports.useState(null),[u,p]=x.reactExports.useState(""),[d,j]=x.reactExports.useState(""),[h,g]=x.reactExports.useState([]),[E,v]=x.reactExports.useState(!1);x.reactExports.useImperativeHandle(i,()=>({clearSelectedTime:()=>{j("")}}),[]),x.reactExports.useEffect(()=>{u&&t&&n&&w()},[u,n,t]),x.reactExports.useEffect(()=>{const e=()=>{!x.taroDocumentProvider.hidden&&u&&t&&n&&(console.log("\u9875\u9762\u91cd\u65b0\u53ef\u89c1\uff0c\u5237\u65b0\u65f6\u95f4\u6bb5\u6570\u636e"),w())};return x.taroDocumentProvider.addEventListener("visibilitychange",e),()=>x.taroDocumentProvider.removeEventListener("visibilitychange",e)},[u,t,n]);const w=()=>l(exports,null,function*(){if(t&&u&&n){v(!0);try{const e=yield m.therapistService.getAvailableSlots(t,u,n.duration);if(console.log("\u83b7\u53d6\u5230\u7684\u53ef\u7528\u65f6\u6bb5\u6570\u636e\uff1a",e),e&&e.slots&&e.slots.length>0){const t=[],s=new Map;e.slots.forEach(e=>{const t=e.time.split(":")[0];s.set(t,{available:e.available,status:e.status})});for(let a=9;a<=21;a++){const i=a.toString().padStart(2,"0"),r=[],o=s.get(i)||{available:!0,status:"available"};for(let t=0;t<60;t+=10){const s=`${i}:${t.toString().padStart(2,"0")}`,a=e.slots.find(e=>e.time===s);a?r.push({time:s,available:a.available,status:a.status}):r.push({time:s,available:o.available,status:o.status})}t.push(r)}g(t)}else{console.log("API\u672a\u8fd4\u56de\u6709\u6548\u65f6\u6bb5\u6570\u636e\uff0c\u4f7f\u7528\u9ed8\u8ba4\u5168\u90e8\u53ef\u7528");const e=[];for(let t=9;t<=21;t++){const s=[];for(let e=0;e<60;e+=10){const a=`${t.toString().padStart(2,"0")}:${e.toString().padStart(2,"0")}`;s.push({time:a,available:!0,status:"available"})}e.push(s)}g(e)}}catch(e){console.error("Failed to fetch available slots:",e);const t=[];for(let s=9;s<=21;s++){const e=[];for(let t=0;t<60;t+=10){const a=`${s.toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`;e.push({time:a,available:!0,status:"available"})}t.push(e)}g(t)}finally{v(!1)}}}),R=()=>{const e=[],t=new Date;for(let s=0;s<5;s++){const a=new Date(t);a.setDate(t.getDate()+s);const i=a.getMonth()+1,r=a.getDate(),o=["\u5468\u65e5","\u5468\u4e00","\u5468\u4e8c","\u5468\u4e09","\u5468\u56db","\u5468\u4e94","\u5468\u516d"],n=o[a.getDay()];e.push({key:a.toISOString().split("T")[0],display:0===s?"\u4eca\u5929":`${i}\u6708${r}\u65e5`,weekDay:0===s?"":n})}return e},N=()=>{if(h.length>0){const e=h.map((e,t)=>{const s=9+t;return{hour:`${s}:00`,slots:e}});return e}const e=[];for(let t=9;t<=21;t++){const s=[];for(let e=0;e<60;e+=10){const a=`${t.toString().padStart(2,"0")}:${e.toString().padStart(2,"0")}`;s.push({time:a,available:!0})}e.push({hour:`${t}:00`,slots:s})}return e},S=e=>{if(!d||!n)return!1;const t=d,s=n.duration,a=e=>{const[t,s]=e.split(":").map(Number);return 60*t+s},i=a(t),r=a(e),o=i+s;return r>=i&&r<o},f=e=>{o(e.id),c(e),s(e),j("")},b=e=>{p(e),j(""),g([])},T=(e,t)=>{if(!t||!u||!n)return;const s=e=>{const[t,s]=e.split(":").map(Number);return 60*t+s},i=s(e),r=i+n.duration;r>1320||(j(e),a(u,e),setTimeout(()=>{const e=x.taroDocumentProvider.querySelector(".checkout-btn:not(.disabled)");e&&e.click()},300))},V=R(),y=N();return x.jsxRuntimeExports.jsxs(x.View,{className:"booking-selector",children:[x.jsxRuntimeExports.jsxs(x.View,{className:"service-section",children:[x.jsxRuntimeExports.jsx(x.View,{className:"section-title",children:"\u9009\u62e9\u670d\u52a1"}),x.jsxRuntimeExports.jsx(x.ScrollView,{className:"service-tabs",scrollX:!0,children:e.map(e=>x.jsxRuntimeExports.jsxs(x.View,{className:"service-tab "+(r===e.id?"active":""),onClick:()=>f(e),children:[x.jsxRuntimeExports.jsx(x.Text,{className:"service-name",children:e.name}),x.jsxRuntimeExports.jsxs(x.View,{className:"service-info",children:[x.jsxRuntimeExports.jsxs(x.Text,{className:"service-duration",children:[e.duration,"\u5206\u949f"]}),x.jsxRuntimeExports.jsxs(x.Text,{className:"price",children:["\xa5",e.discountPrice||e.price]})]})]},e.id))})]}),r&&x.jsxRuntimeExports.jsxs(x.View,{className:"datetime-section",children:[x.jsxRuntimeExports.jsx(x.ScrollView,{className:"date-tabs",scrollX:!0,children:V.map(e=>x.jsxRuntimeExports.jsxs(x.View,{className:"date-tab "+(u===e.key?"active":""),onClick:()=>b(e.key),children:[x.jsxRuntimeExports.jsx(x.Text,{className:"date-display",children:e.display}),e.weekDay&&x.jsxRuntimeExports.jsx(x.Text,{className:"week-day",children:e.weekDay})]},e.key))}),u&&x.jsxRuntimeExports.jsx(x.ScrollView,{className:"time-grid-container",scrollY:!0,children:x.jsxRuntimeExports.jsx(x.View,{className:"time-grid-wrapper",children:E?x.jsxRuntimeExports.jsx(x.View,{className:"loading-slots",children:x.jsxRuntimeExports.jsx(x.Text,{children:"\u52a0\u8f7d\u53ef\u7528\u65f6\u6bb5..."})}):y.map((e,t)=>x.jsxRuntimeExports.jsxs(x.View,{className:"time-row",children:[x.jsxRuntimeExports.jsx(x.Text,{className:"hour-label",children:e.hour}),x.jsxRuntimeExports.jsx(x.View,{className:"time-slots",children:e.slots.map((e,t)=>x.jsxRuntimeExports.jsx(x.View,{className:"time-slot "+(e.available?S(e.time)?"selected":"available":"disabled"),onClick:()=>T(e.time,e.available),children:x.jsxRuntimeExports.jsxs(x.Text,{className:"time-text",children:[":",e.time.split(":")[1]]})},t))})]},t))})})]})]})});E.displayName="BookingSelector";const v="",w=()=>{const e=x.taroExports.useRouter(),{therapistId:t,storeId:s}=e.params,[a,i]=x.reactExports.useState(null),[r,o]=x.reactExports.useState(null),[u,p]=x.reactExports.useState(!0),[j,g]=x.reactExports.useState(""),[v,w]=x.reactExports.useState([]),[R,N]=x.reactExports.useState(null),[S,f]=x.reactExports.useState(!1),[b,T]=x.reactExports.useState([]),[V,y]=x.reactExports.useState(null),[k,C]=x.reactExports.useState(new Set),[P,D]=x.reactExports.useState(!1),I=x.reactExports.useRef(null),$=m.symptomServices.map(e=>({id:e.id,name:e.name,duration:e.duration,price:e.price,discountPrice:e.discountPrice,description:e.description,tag:e.tag}));x.reactExports.useEffect(()=>{O()},[t,s]),x.reactExports.useEffect(()=>{t&&L()},[t]);const O=()=>l(exports,null,function*(){try{if(p(!0),g(""),console.log("TherapistBookingPage params:",{therapistId:t,storeId:s}),!t||!s)return console.error("Missing required params:",{therapistId:t,storeId:s}),void g("\u53c2\u6570\u9519\u8bef\uff0c\u8bf7\u91cd\u65b0\u8fdb\u5165");const[e,a,r]=yield Promise.all([m.therapistService.getTherapistDetail(t),m.storeService.getStoreDetail(s),m.getLocationService.getCurrentLocation()]);console.log("Store data response:",a),console.log("Therapist data response:",e);const l=e.data||e,x=(null==a?void 0:a.data)||a;let u=n({},x);if((null==x?void 0:x.latitude)&&(null==x?void 0:x.longitude)){const e=m.getLocationService.calculateDistance(r.latitude,r.longitude,x.latitude,x.longitude);u=c(n({},x),{distance:e})}i(l),o(u),console.log("Store state after setting:",u),console.log("Therapist state after setting:",l)}catch(e){console.error("Failed to load data:",e),g("\u52a0\u8f7d\u6570\u636e\u5931\u8d25\uff0c\u8bf7\u91cd\u8bd5")}finally{p(!1)}}),L=()=>l(exports,null,function*(){if(t)try{f(!0);const[e,s]=yield Promise.all([m.reviewService.getTherapistReviews(t,1,10),m.reviewService.getReviewStats(t)]);w(e.list||[]),N(s),s&&a&&i(c(n({},a),{rating:s.averageRating,ratingCount:s.totalCount}))}catch(e){console.error("\u52a0\u8f7d\u8bc4\u4ef7\u6570\u636e\u5931\u8d25:",e)}finally{f(!1)}}),A=e=>{y(e)},z=(e,t)=>{if(!V||!a)return;const s=`${e}_${t}_${Date.now()}`;0===k.size&&D(!0);const i={id:s,serviceId:V.id,serviceName:V.name,duration:V.duration,price:V.price,discountPrice:V.discountPrice,date:e,time:t,therapistId:a.id,therapistName:a.name,therapistAvatar:a.avatar},r=b.findIndex(s=>s.date===e&&s.time===t);if(r>=0){const e=b[r],t=new Set(k);t.has(e.id)&&t.delete(e.id),t.add(s),C(t);const a=[...b];a[r]=i,T(a),x.Taro.showToast({title:"\u5df2\u66f4\u65b0\u8be5\u65f6\u6bb5\u9884\u7ea6",icon:"success"})}else{const e=new Set(k);e.add(s),C(e),T([...b,i]),x.Taro.showToast({title:"\u5df2\u6dfb\u52a0\u5230\u8d2d\u7269\u8f66",icon:"success"})}},q=()=>{var e;if(P&&k.size>0){const t=b.filter(e=>!k.has(e.id));T(t),null==(e=I.current)||e.clearSelectedTime(),console.log(`\ud83d\udd19 \u64a4\u9500\u64cd\u4f5c: \u79fb\u9664\u4e86 ${k.size} \u4e2a\u9879\u76ee`),console.log("\ud83d\udd19 \u5f53\u524d\u4f1a\u8bdd\u9879ID:",Array.from(k)),console.log("\ud83d\udd19 \u64a4\u9500\u540e\u8d2d\u7269\u8f66:",t)}C(new Set),D(!1)},M=()=>{C(new Set),D(!1),console.log("\u2705 \u786e\u8ba4\u7ee7\u7eed\u9884\u7ea6\uff0c\u4f1a\u8bdd\u72b6\u6001\u5df2\u91cd\u7f6e")},F=()=>{if(0===b.length)return;C(new Set),D(!1),console.log("\ud83d\udcb3 \u53bb\u7ed3\u7b97\uff0c\u8d2d\u7269\u8f66\u9879\u76ee\u6570:",b.length),console.log("\ud83d\udcb3 \u8d2d\u7269\u8f66\u5185\u5bb9:",b);const e={therapistId:t,storeId:s,items:JSON.stringify(b)};x.Taro.navigateTo({url:`/pages/booking/confirm/index?${Object.entries(e).map(([e,t])=>`${e}=${encodeURIComponent(t)}`).join("&")}`})};return u?x.jsxRuntimeExports.jsx(x.View,{className:"therapist-booking-page",children:x.jsxRuntimeExports.jsx(x.View,{className:"loading",children:"\u52a0\u8f7d\u4e2d..."})}):!j&&a&&r?x.jsxRuntimeExports.jsxs(x.View,{className:"therapist-booking-page",children:[x.jsxRuntimeExports.jsxs(x.ScrollView,{className:"main-content",scrollY:!0,children:[x.jsxRuntimeExports.jsx(d,{therapist:a,stats:R,reviews:v,reviewsLoading:S}),r&&x.jsxRuntimeExports.jsx(h,{store:r}),x.jsxRuntimeExports.jsx(E,{ref:I,services:$,therapistId:t,onServiceSelect:A,onTimeSelect:z})]}),x.jsxRuntimeExports.jsx(m.ShoppingCart,{items:b,therapist:a,onCheckout:F,onMaskClick:q,onContinue:M,hasPendingAction:P&&k.size>0})]}):x.jsxRuntimeExports.jsx(x.View,{className:"therapist-booking-page",children:x.jsxRuntimeExports.jsx(x.View,{className:"error",children:j||"\u6570\u636e\u52a0\u8f7d\u5931\u8d25"})})};var R={navigationBarTitleText:"\u63a8\u62ff\u5e08\u9884\u7ea6"};Page(x.createPageConfig(w,"pages/appointment/therapist/index",{root:{cn:[]}},R||{}));
