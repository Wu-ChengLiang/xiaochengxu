"use strict";var e=Object.defineProperty,s=Object.getOwnPropertySymbols,t=Object.prototype.hasOwnProperty,r=Object.prototype.propertyIsEnumerable,a=(s,t,r)=>t in s?e(s,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):s[t]=r,i=(e,i)=>{for(var n in i||(i={}))t.call(i,n)&&a(e,n,i[n]);if(s)for(var n of s(i))r.call(i,n)&&a(e,n,i[n]);return e},n=(e,s,t)=>new Promise((r,a)=>{var i=e=>{try{o(t.next(e))}catch(s){a(s)}},n=e=>{try{o(t.throw(e))}catch(s){a(s)}},o=e=>e.done?r(e.value):Promise.resolve(e.value).then(i,n);o((t=t.apply(e,s)).next())});const o=require("../../../taro.js"),c=require("../../../common.js"),l="",x=({therapist:e})=>{const[s,t]=o.reactExports.useState(!1),r=i({level:"LV4",rating:e.rating||5,salesCount:e.serviceCount||10109,description:"\u6bd5\u4e1a\u4e8e\u6210\u90fd\u4e2d\u533b\u836f\u5927\u5b66\u9488\u7078\u63a8\u62ff\u4e13\u4e1a\u3002\u9ad8\u7ea7\u5eb7\u590d\u5e08 \u4ece\u4e1a18\u5e74\uff0c\u4e13\u7814\u8eab\u4f53\u75bc\u75db\u3001\u8fd0\u52a8\u5eb7\u590d\u3001\u4ea7\u540e\u5eb7\u590d\u3001\u4f53\u6001\u8c03\u7406\u3001\u7ecf\u7edc\u758f\u901a\u3001\u7f8e\u5bb9\u517b\u751f\u7b49"},e),a=()=>{t(!s)};return o.jsxRuntimeExports.jsxs(o.View,{className:"therapist-info",children:[o.jsxRuntimeExports.jsxs(o.View,{className:"therapist-header",children:[o.jsxRuntimeExports.jsx(o.View,{className:"avatar-wrapper",children:o.jsxRuntimeExports.jsx(o.Image,{className:"avatar",src:e.avatar,mode:"aspectFill"})}),o.jsxRuntimeExports.jsxs(o.View,{className:"basic-info",children:[o.jsxRuntimeExports.jsxs(o.View,{className:"name-row",children:[o.jsxRuntimeExports.jsx(o.Text,{className:"name",children:e.name}),o.jsxRuntimeExports.jsx(o.View,{className:"level",children:r.level})]}),o.jsxRuntimeExports.jsxs(o.View,{className:"stats-row",children:[o.jsxRuntimeExports.jsx(o.View,{className:"rating",children:o.jsxRuntimeExports.jsxs(o.Text,{className:"rating-score",children:[r.rating,"\u5206"]})}),o.jsxRuntimeExports.jsx(o.View,{className:"divider",children:"|"}),o.jsxRuntimeExports.jsx(o.View,{className:"sales",children:o.jsxRuntimeExports.jsxs(o.Text,{className:"sales-text",children:["\u9500\u91cf",r.salesCount,"\u5355"]})})]})]})]}),o.jsxRuntimeExports.jsxs(o.View,{className:"description-section",children:[o.jsxRuntimeExports.jsx(o.Text,{className:"description "+(s?"expanded":"collapsed"),children:r.description}),o.jsxRuntimeExports.jsxs(o.View,{className:"expand-toggle",onClick:a,children:[o.jsxRuntimeExports.jsx(o.Text,{className:"expand-text",children:s?"\u6536\u8d77":"\u5c55\u5f00"}),o.jsxRuntimeExports.jsx(o.Text,{className:"expand-icon "+(s?"up":"down"),children:s?"\u25b2":"\u25bc"})]})]})]})},m="",u=({store:e})=>{const s=e=>{switch(e){case"normal":return"\u5c31\u8fd1";case"busy":return"\u7e41\u5fd9";case"full":return"\u7206\u6ee1";default:return""}},t=e=>{switch(e){case"normal":return"status-normal";case"busy":return"status-busy";case"full":return"status-full";default:return""}},r=()=>{e.phone&&o.Taro.makePhoneCall({phoneNumber:e.phone})},a=()=>{e.location&&o.Taro.openLocation({latitude:e.location.latitude,longitude:e.location.longitude,name:e.name,address:e.address})};return o.jsxRuntimeExports.jsx(o.View,{className:"store-info",children:o.jsxRuntimeExports.jsxs(o.View,{className:"store-header",children:[o.jsxRuntimeExports.jsxs(o.View,{className:"store-details",children:[o.jsxRuntimeExports.jsxs(o.View,{className:"name-row",children:[o.jsxRuntimeExports.jsx(o.Text,{className:"store-name",children:e.name}),o.jsxRuntimeExports.jsxs(o.Text,{className:"distance",children:[e.distance||9,"km"]})]}),o.jsxRuntimeExports.jsxs(o.View,{className:"hours-row",children:[o.jsxRuntimeExports.jsx(o.Text,{className:"business-hours",children:e.businessHours?`${e.businessHours.start}-${e.businessHours.end}`:"\u8425\u4e1a\u65f6\u95f4\u672a\u77e5"}),o.jsxRuntimeExports.jsx(o.View,{className:`status ${t(e.status)}`,children:s(e.status)})]}),o.jsxRuntimeExports.jsx(o.Text,{className:"address",children:e.address})]}),o.jsxRuntimeExports.jsxs(o.View,{className:"action-buttons",children:[o.jsxRuntimeExports.jsx(o.View,{className:"action-btn",onClick:r,children:"\ud83d\udcde"}),o.jsxRuntimeExports.jsx(o.View,{className:"action-btn",onClick:a,children:"\ud83d\udccd"})]})]})})},p="",d=o.reactExports.forwardRef(({services:e,onServiceSelect:s,onTimeSelect:t},r)=>{const[a,i]=o.reactExports.useState(""),[n,c]=o.reactExports.useState(null),[l,x]=o.reactExports.useState(""),[m,u]=o.reactExports.useState("");o.reactExports.useImperativeHandle(r,()=>({clearSelectedTime:()=>{u("")}}),[]);const p=()=>{const e=[],s=new Date;for(let t=0;t<5;t++){const r=new Date(s);r.setDate(s.getDate()+t);const a=r.getMonth()+1,i=r.getDate(),n=["\u5468\u65e5","\u5468\u4e00","\u5468\u4e8c","\u5468\u4e09","\u5468\u56db","\u5468\u4e94","\u5468\u516d"],o=n[r.getDay()];e.push({key:r.toISOString().split("T")[0],display:0===t?"\u4eca\u5929":`${a}\u6708${i}\u65e5`,weekDay:0===t?"":o})}return e},d=()=>{const e=[];for(let s=9;s<=21;s++){const t=[];for(let e=0;e<60;e+=10){const r=`${s.toString().padStart(2,"0")}:${e.toString().padStart(2,"0")}`,a=Math.random()>.3;t.push({time:r,available:a})}e.push({hour:`${s}:00`,slots:t})}return e},j=e=>{if(!m||!n)return!1;const s=m,t=n.duration,r=e=>{const[s,t]=e.split(":").map(Number);return 60*s+t},a=r(s),i=r(e),o=a+t;return i>=a&&i<o},h=e=>{i(e.id),c(e),s(e),u("")},E=e=>{x(e),u("")},R=(e,s)=>{if(!s||!l||!n)return;const r=e=>{const[s,t]=e.split(":").map(Number);return 60*s+t},a=r(e),i=a+n.duration;i>1320||(u(e),t(l,e),setTimeout(()=>{const e=o.taroDocumentProvider.querySelector(".checkout-btn:not(.disabled)");e&&e.click()},300))},N=p(),w=d();return o.jsxRuntimeExports.jsxs(o.View,{className:"booking-selector",children:[o.jsxRuntimeExports.jsxs(o.View,{className:"service-section",children:[o.jsxRuntimeExports.jsx(o.View,{className:"section-title",children:"\u9009\u62e9\u670d\u52a1"}),o.jsxRuntimeExports.jsx(o.ScrollView,{className:"service-tabs",scrollX:!0,children:e.map(e=>o.jsxRuntimeExports.jsxs(o.View,{className:"service-tab "+(a===e.id?"active":""),onClick:()=>h(e),children:[o.jsxRuntimeExports.jsx(o.Text,{className:"service-name",children:e.name}),o.jsxRuntimeExports.jsxs(o.View,{className:"service-info",children:[o.jsxRuntimeExports.jsxs(o.Text,{className:"service-duration",children:[e.duration,"\u5206\u949f"]}),o.jsxRuntimeExports.jsxs(o.Text,{className:"price",children:["\xa5",e.discountPrice||e.price]})]})]},e.id))})]}),a&&o.jsxRuntimeExports.jsxs(o.View,{className:"datetime-section",children:[o.jsxRuntimeExports.jsx(o.ScrollView,{className:"date-tabs",scrollX:!0,children:N.map(e=>o.jsxRuntimeExports.jsxs(o.View,{className:"date-tab "+(l===e.key?"active":""),onClick:()=>E(e.key),children:[o.jsxRuntimeExports.jsx(o.Text,{className:"date-display",children:e.display}),e.weekDay&&o.jsxRuntimeExports.jsx(o.Text,{className:"week-day",children:e.weekDay})]},e.key))}),l&&o.jsxRuntimeExports.jsx(o.ScrollView,{className:"time-grid-container",scrollY:!0,children:o.jsxRuntimeExports.jsx(o.View,{className:"time-grid-wrapper",children:w.map((e,s)=>o.jsxRuntimeExports.jsxs(o.View,{className:"time-row",children:[o.jsxRuntimeExports.jsx(o.Text,{className:"hour-label",children:e.hour}),o.jsxRuntimeExports.jsx(o.View,{className:"time-slots",children:e.slots.map((e,s)=>o.jsxRuntimeExports.jsx(o.View,{className:"time-slot "+(e.available?j(e.time)?"selected":"available":"disabled"),onClick:()=>R(e.time,e.available),children:o.jsxRuntimeExports.jsxs(o.Text,{className:"time-text",children:[":",e.time.split(":")[1]]})},s))})]},s))})})]})]})});d.displayName="BookingSelector";const j="",h=()=>{const e=o.taroExports.useRouter(),{therapistId:s,storeId:t}=e.params,[r,a]=o.reactExports.useState(null),[i,l]=o.reactExports.useState(null),[m,p]=o.reactExports.useState(!0),[j,h]=o.reactExports.useState(""),[E,R]=o.reactExports.useState([]),[N,w]=o.reactExports.useState(null),[g,v]=o.reactExports.useState(-1),[S,V]=o.reactExports.useState(!1),b=o.reactExports.useRef(null),f=c.symptomServices.map(e=>({id:e.id,name:e.name,duration:e.duration,price:e.price,discountPrice:e.discountPrice,description:e.description,tag:e.tag}));o.reactExports.useEffect(()=>{T()},[s,t]);const T=()=>n(exports,null,function*(){try{if(p(!0),h(""),console.log("TherapistBookingPage params:",{therapistId:s,storeId:t}),!s||!t)return console.error("Missing required params:",{therapistId:s,storeId:t}),void h("\u53c2\u6570\u9519\u8bef\uff0c\u8bf7\u91cd\u65b0\u8fdb\u5165");const[e,r]=yield Promise.all([c.therapistService.getTherapistDetail(s),c.storeService.getStoreDetail(t)]);console.log("Store data response:",r),console.log("Store data.data:",r.data),a(e.data),l(r.data),console.log("Store state after setting:",r.data)}catch(e){console.error("Failed to load data:",e),h("\u52a0\u8f7d\u6570\u636e\u5931\u8d25\uff0c\u8bf7\u91cd\u8bd5")}finally{p(!1)}}),y=e=>{w(e)},k=(e,s)=>{if(!N||!r)return;-1===g&&(v(E.length),V(!0));const t={serviceId:N.id,serviceName:N.name,duration:N.duration,price:N.price,discountPrice:N.discountPrice,date:e,time:s,therapistName:r.name,therapistAvatar:r.avatar},a=E.findIndex(t=>t.date===e&&t.time===s);if(a>=0){const e=[...E];e[a]=t,R(e),o.Taro.showToast({title:"\u5df2\u66f4\u65b0\u8be5\u65f6\u6bb5\u9884\u7ea6",icon:"success"})}else R([...E,t]),o.Taro.showToast({title:"\u5df2\u6dfb\u52a0\u5230\u8d2d\u7269\u8f66",icon:"success"})},P=()=>{var e;if(S&&g>=0){const s=E.slice(0,g);R(s),null==(e=b.current)||e.clearSelectedTime()}v(-1),V(!1)},C=()=>{v(-1),V(!1)},I=()=>{if(0===E.length)return;v(-1),V(!1);const e={therapistId:s,storeId:t,items:JSON.stringify(E)};o.Taro.navigateTo({url:`/pages/booking/confirm/index?${Object.entries(e).map(([e,s])=>`${e}=${encodeURIComponent(s)}`).join("&")}`})};return m?o.jsxRuntimeExports.jsx(o.View,{className:"therapist-booking-page",children:o.jsxRuntimeExports.jsx(o.View,{className:"loading",children:"\u52a0\u8f7d\u4e2d..."})}):!j&&r&&i?o.jsxRuntimeExports.jsxs(o.View,{className:"therapist-booking-page",children:[o.jsxRuntimeExports.jsxs(o.ScrollView,{className:"main-content",scrollY:!0,children:[o.jsxRuntimeExports.jsx(x,{therapist:r}),i&&o.jsxRuntimeExports.jsx(u,{store:i}),o.jsxRuntimeExports.jsx(d,{ref:b,services:f,onServiceSelect:y,onTimeSelect:k})]}),o.jsxRuntimeExports.jsx(c.ShoppingCart,{items:E,therapist:r,onCheckout:I,onMaskClick:P,onContinue:C,hasPendingAction:S&&g>=0})]}):o.jsxRuntimeExports.jsx(o.View,{className:"therapist-booking-page",children:o.jsxRuntimeExports.jsx(o.View,{className:"error",children:j||"\u6570\u636e\u52a0\u8f7d\u5931\u8d25"})})};var E={navigationBarTitleText:"\u63a8\u62ff\u5e08\u9884\u7ea6"};Page(o.createPageConfig(h,"pages/appointment/therapist/index",{root:{cn:[]}},E||{}));
