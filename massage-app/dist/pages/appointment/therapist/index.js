"use strict";var e=Object.defineProperty,t=Object.defineProperties,s=Object.getOwnPropertyDescriptors,a=Object.getOwnPropertySymbols,r=Object.prototype.hasOwnProperty,i=Object.prototype.propertyIsEnumerable,n=(t,s,a)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[s]=a,o=(e,t)=>{for(var s in t||(t={}))r.call(t,s)&&n(e,s,t[s]);if(a)for(var s of a(t))i.call(t,s)&&n(e,s,t[s]);return e},l=(e,a)=>t(e,s(a)),c=(e,t,s)=>new Promise((a,r)=>{var i=e=>{try{o(s.next(e))}catch(t){r(t)}},n=e=>{try{o(s.throw(e))}catch(t){r(t)}},o=e=>e.done?a(e.value):Promise.resolve(e.value).then(i,n);o((s=s.apply(e,t)).next())});const x=require("../../../taro.js"),m=require("../../../common.js"),p=require("../../../vendors.js"),u="",d=({therapist:e,stats:t,reviews:s=[],reviewsLoading:a=!1})=>{const[r,i]=x.reactExports.useState(!1),n=o({level:"LV4",rating:(null==t?void 0:t.averageRating)||e.rating||4.8,serviceCount:e.serviceCount||0,reviewCount:(null==t?void 0:t.totalCount)||0,description:e.bio||"\u4e13\u4e1a\u63a8\u62ff\u5e08\uff0c\u7ecf\u9a8c\u4e30\u5bcc\uff0c\u64c5\u957f\u5404\u7c7b\u75bc\u75db\u8c03\u7406\u548c\u5eb7\u590d\u6cbb\u7597"},e);console.log("\ud83d\udd0d TherapistInfo Debug:",{therapistId:e.id,serviceCount:e.serviceCount,originalTherapist:e,therapistDetail:n});const l=()=>{i(!r)},c=e=>{const t=new Date(e),s=t.getMonth()+1,a=t.getDate();return`${s}\u6708${a}\u65e5`};return x.jsxRuntimeExports.jsxs(x.View,{className:"therapist-info",children:[x.jsxRuntimeExports.jsxs(x.View,{className:"therapist-header",children:[x.jsxRuntimeExports.jsx(x.View,{className:"avatar-wrapper",children:x.jsxRuntimeExports.jsx(x.Image,{className:"avatar",src:e.avatar,mode:"aspectFill"})}),x.jsxRuntimeExports.jsx(x.View,{className:"basic-info",children:x.jsxRuntimeExports.jsxs(x.View,{className:"name-row",children:[x.jsxRuntimeExports.jsx(x.Text,{className:"name",children:e.name}),x.jsxRuntimeExports.jsx(x.View,{className:"level",children:n.level})]})})]}),x.jsxRuntimeExports.jsxs(x.View,{className:"description-section",children:[x.jsxRuntimeExports.jsx(x.Text,{className:"description "+(r?"expanded":"collapsed"),children:n.description}),r&&x.jsxRuntimeExports.jsxs(x.View,{className:"reviews-section",children:[t&&t.totalCount>0&&x.jsxRuntimeExports.jsx(x.View,{className:"review-stats-compact",children:x.jsxRuntimeExports.jsxs(x.View,{className:"stats-header",children:[x.jsxRuntimeExports.jsx(x.Text,{className:"stats-title",children:"\u7528\u6237\u8bc4\u4ef7"}),x.jsxRuntimeExports.jsxs(x.View,{className:"rating-info",children:[x.jsxRuntimeExports.jsx(x.Text,{className:"score",children:t.averageRating.toFixed(1)}),x.jsxRuntimeExports.jsx(p.AtRate,{value:t.averageRating,size:12}),x.jsxRuntimeExports.jsxs(x.Text,{className:"count",children:["(",t.totalCount,"\u6761)"]})]})]})}),x.jsxRuntimeExports.jsxs(x.View,{className:"review-list-compact",children:[a?x.jsxRuntimeExports.jsx(x.Text,{className:"loading-text",children:"\u52a0\u8f7d\u8bc4\u4ef7\u4e2d..."}):0===s.length?x.jsxRuntimeExports.jsx(x.Text,{className:"empty-text",children:"\u6682\u65e0\u8bc4\u4ef7"}):s.slice(0,3).map(e=>x.jsxRuntimeExports.jsxs(x.View,{className:"review-item-compact",children:[x.jsxRuntimeExports.jsxs(x.View,{className:"review-header-compact",children:[x.jsxRuntimeExports.jsxs(x.View,{className:"user-info-compact",children:[x.jsxRuntimeExports.jsx(x.Text,{className:"user-name",children:e.userName||"\u533f\u540d\u7528\u6237"}),x.jsxRuntimeExports.jsx(p.AtRate,{value:e.rating,size:10})]}),x.jsxRuntimeExports.jsx(x.Text,{className:"review-date",children:c(e.createdAt)})]}),x.jsxRuntimeExports.jsx(x.Text,{className:"review-content-compact",children:e.content}),e.tags&&e.tags.length>0&&x.jsxRuntimeExports.jsx(x.View,{className:"review-tags-compact",children:e.tags.map((e,t)=>x.jsxRuntimeExports.jsx(x.Text,{className:"tag-compact",children:e},t))})]},e.reviewId)),s.length>3&&x.jsxRuntimeExports.jsx(x.Text,{className:"more-reviews",children:"\u4ec5\u663e\u793a\u6700\u8fd13\u6761\u8bc4\u4ef7"})]})]}),x.jsxRuntimeExports.jsxs(x.View,{className:"expand-toggle",onClick:l,children:[x.jsxRuntimeExports.jsx(x.Text,{className:"expand-text",children:r?"\u6536\u8d77":"\u5c55\u5f00"}),x.jsxRuntimeExports.jsx(x.Text,{className:"expand-icon "+(r?"up":"down"),children:r?"\u25b2":"\u25bc"})]})]})]})},j="",h=({store:e})=>{const t=()=>{e.phone&&x.Taro.makePhoneCall({phoneNumber:e.phone})},s=()=>{e.latitude&&e.longitude&&x.Taro.openLocation({latitude:e.latitude,longitude:e.longitude,name:e.name,address:e.address})};return x.jsxRuntimeExports.jsx(x.View,{className:"store-info",children:x.jsxRuntimeExports.jsxs(x.View,{className:"store-header",children:[x.jsxRuntimeExports.jsxs(x.View,{className:"store-details",children:[x.jsxRuntimeExports.jsxs(x.View,{className:"name-row",children:[x.jsxRuntimeExports.jsx(x.Text,{className:"store-name",children:e.name}),void 0!==e.distance&&null!==e.distance&&x.jsxRuntimeExports.jsxs(x.Text,{className:"distance",children:[e.distance,"km"]})]}),x.jsxRuntimeExports.jsx(x.View,{className:"hours-row",children:x.jsxRuntimeExports.jsx(x.Text,{className:"business-hours",children:e.businessHours})}),x.jsxRuntimeExports.jsx(x.Text,{className:"address",children:e.address})]}),x.jsxRuntimeExports.jsxs(x.View,{className:"action-buttons",children:[x.jsxRuntimeExports.jsx(x.View,{className:"action-btn",onClick:t,children:"\ud83d\udcde"}),x.jsxRuntimeExports.jsx(x.View,{className:"action-btn",onClick:s,children:"\ud83d\udccd"})]})]})})},E="",g=x.reactExports.forwardRef(({services:e,therapistId:t,onServiceSelect:s,onTimeSelect:a},r)=>{const[i,n]=x.reactExports.useState(""),[o,l]=x.reactExports.useState(null),[p,u]=x.reactExports.useState(""),[d,j]=x.reactExports.useState(""),[h,E]=x.reactExports.useState([]),[g,v]=x.reactExports.useState(!1),[R,w]=x.reactExports.useState("");x.reactExports.useImperativeHandle(r,()=>({clearSelectedTime:()=>{j("")}}),[]),x.reactExports.useEffect(()=>{p&&t&&o&&N()},[p,o,t]),x.reactExports.useEffect(()=>{const e=()=>{!x.taroDocumentProvider.hidden&&p&&t&&o&&(console.log("\u9875\u9762\u91cd\u65b0\u53ef\u89c1\uff0c\u5237\u65b0\u65f6\u95f4\u6bb5\u6570\u636e"),N())};return x.taroDocumentProvider.addEventListener("visibilitychange",e),()=>x.taroDocumentProvider.removeEventListener("visibilitychange",e)},[p,t,o]);const N=()=>c(exports,null,function*(){var e;if(t&&p&&o){v(!0),w("");try{const e=yield m.therapistService.getAvailableSlots(t,p,o.duration);if(console.log("\u83b7\u53d6\u5230\u7684\u53ef\u7528\u65f6\u6bb5\u6570\u636e\uff1a",e),e&&e.slots&&e.slots.length>0){const t=[],s=new Map;e.slots.forEach(e=>{const t=e.time.split(":")[0];s.set(t,{available:e.available,status:e.status})});for(let a=9;a<=21;a++){const r=a.toString().padStart(2,"0"),i=[],n=s.get(r)||{available:!0,status:"available"};for(let t=0;t<60;t+=10){const s=`${r}:${t.toString().padStart(2,"0")}`,a=e.slots.find(e=>e.time===s);a?i.push({time:s,available:a.available,status:a.status}):i.push({time:s,available:n.available,status:n.status})}t.push(i)}E(t)}else console.log("\u8be5\u63a8\u62ff\u5e08\u5728\u9009\u5b9a\u65f6\u95f4\u65e0\u53ef\u7528\u65f6\u6bb5"),w("\u8be5\u63a8\u62ff\u5e08\u5728\u6b64\u65f6\u95f4\u6bb5\u5df2\u6ee1\uff0c\u8bf7\u9009\u62e9\u5176\u4ed6\u65f6\u95f4\u6216\u63a8\u62ff\u5e08"),E([])}catch(s){console.error("\u274c \u83b7\u53d6\u53ef\u7528\u65f6\u6bb5\u5931\u8d25:",s),1003===s.code?w("\u8be5\u63a8\u62ff\u5e08\u4e0d\u5b58\u5728\u6216\u4e0d\u53ef\u7528\uff0c\u8bf7\u8fd4\u56de\u91cd\u65b0\u9009\u62e9"):1010===s.code?w("\u7528\u6237\u4fe1\u606f\u5f02\u5e38\uff0c\u8bf7\u91cd\u65b0\u8fdb\u5165"):(null==(e=s.response)?void 0:e.status)>=500?w("\u670d\u52a1\u5668\u5f02\u5e38\uff0c\u8bf7\u7a0d\u540e\u91cd\u8bd5"):w("\u52a0\u8f7d\u53ef\u7528\u65f6\u6bb5\u5931\u8d25\uff0c\u8bf7\u68c0\u67e5\u7f51\u7edc\u540e\u91cd\u8bd5"),E([])}finally{v(!1)}}}),S=()=>{const e=[],t=new Date;for(let s=0;s<5;s++){const a=new Date(t);a.setDate(t.getDate()+s);const r=a.getMonth()+1,i=a.getDate(),n=["\u5468\u65e5","\u5468\u4e00","\u5468\u4e8c","\u5468\u4e09","\u5468\u56db","\u5468\u4e94","\u5468\u516d"],o=n[a.getDay()];e.push({key:m.getLocalDateString(a),display:0===s?"\u4eca\u5929":`${r}\u6708${i}\u65e5`,weekDay:0===s?"":o})}return e},f=()=>{if(h.length>0){const e=h.map((e,t)=>{const s=9+t;return{hour:`${s}:00`,slots:e}});return e}const e=[];for(let t=9;t<=21;t++){const s=[];for(let e=0;e<60;e+=10){const a=`${t.toString().padStart(2,"0")}:${e.toString().padStart(2,"0")}`;s.push({time:a,available:!0})}e.push({hour:`${t}:00`,slots:s})}return e},T=e=>{if(!d||!o)return!1;const t=d,s=o.duration,a=e=>{const[t,s]=e.split(":").map(Number);return 60*t+s},r=a(t),i=a(e),n=r+s;return i>=r&&i<n},b=e=>{n(e.id),l(e),s(e),j("")},V=e=>{u(e),j(""),E([])},y=(e,t)=>{if(!t||!p||!o)return;const s=h.flat(),r=e=>{const[t,s]=e.split(":").map(Number);return 60*t+s},i=r(e),n=i+o.duration;for(let a=i;a<n;a+=10){const e=Math.floor(a/60),t=a%60,r=`${e.toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`,i=s.find(e=>e.time===r);if(!(null==i?void 0:i.available))return}j(e),a(p,e),setTimeout(()=>{const e=x.taroDocumentProvider.querySelector(".checkout-btn:not(.disabled)");e&&e.click()},300)},k=S(),C=f();return x.jsxRuntimeExports.jsxs(x.View,{className:"booking-selector",children:[x.jsxRuntimeExports.jsxs(x.View,{className:"service-section",children:[x.jsxRuntimeExports.jsx(x.View,{className:"section-title",children:"\u9009\u62e9\u670d\u52a1"}),x.jsxRuntimeExports.jsx(x.ScrollView,{className:"service-tabs",scrollX:!0,children:e.map(e=>x.jsxRuntimeExports.jsxs(x.View,{className:"service-tab "+(i===e.id?"active":""),onClick:()=>b(e),children:[x.jsxRuntimeExports.jsx(x.Text,{className:"service-name",children:e.name}),x.jsxRuntimeExports.jsxs(x.View,{className:"service-info",children:[x.jsxRuntimeExports.jsxs(x.Text,{className:"service-duration",children:[e.duration,"\u5206\u949f"]}),x.jsxRuntimeExports.jsxs(x.Text,{className:"price",children:["\xa5",e.discountPrice||e.price]})]})]},e.id))})]}),i&&x.jsxRuntimeExports.jsxs(x.View,{className:"datetime-section",children:[x.jsxRuntimeExports.jsx(x.ScrollView,{className:"date-tabs",scrollX:!0,children:k.map(e=>x.jsxRuntimeExports.jsxs(x.View,{className:"date-tab "+(p===e.key?"active":""),onClick:()=>V(e.key),children:[x.jsxRuntimeExports.jsx(x.Text,{className:"date-display",children:e.display}),e.weekDay&&x.jsxRuntimeExports.jsx(x.Text,{className:"week-day",children:e.weekDay})]},e.key))}),p&&x.jsxRuntimeExports.jsxs(x.jsxRuntimeExports.Fragment,{children:[R&&x.jsxRuntimeExports.jsx(x.View,{className:"error-message",children:x.jsxRuntimeExports.jsx(x.Text,{children:R})}),x.jsxRuntimeExports.jsx(x.ScrollView,{className:"time-grid-container",scrollY:!0,children:x.jsxRuntimeExports.jsx(x.View,{className:"time-grid-wrapper",children:g?x.jsxRuntimeExports.jsx(x.View,{className:"loading-slots",children:x.jsxRuntimeExports.jsx(x.Text,{children:"\u52a0\u8f7d\u53ef\u7528\u65f6\u6bb5..."})}):R?x.jsxRuntimeExports.jsxs(x.View,{className:"error-state",children:[x.jsxRuntimeExports.jsx(x.Text,{children:"\u6682\u65e0\u53ef\u7528\u65f6\u6bb5"}),x.jsxRuntimeExports.jsx(x.Text,{className:"error-hint",children:"\u8bf7\u9009\u62e9\u5176\u4ed6\u65e5\u671f\u6216\u63a8\u62ff\u5e08"})]}):C.map((e,t)=>x.jsxRuntimeExports.jsxs(x.View,{className:"time-row",children:[x.jsxRuntimeExports.jsx(x.Text,{className:"hour-label",children:e.hour}),x.jsxRuntimeExports.jsx(x.View,{className:"time-slots",children:e.slots.map((e,t)=>x.jsxRuntimeExports.jsx(x.View,{className:"time-slot "+(e.available?T(e.time)?"selected":"available":"disabled"),onClick:()=>y(e.time,e.available),children:x.jsxRuntimeExports.jsxs(x.Text,{className:"time-text",children:[":",e.time.split(":")[1]]})},t))})]},t))})})]})]})]})});g.displayName="BookingSelector";const v="",R=()=>{const e=x.taroExports.useRouter(),{therapistId:t,storeId:s}=e.params,[a,r]=x.reactExports.useState(null),[i,n]=x.reactExports.useState(null),[p,u]=x.reactExports.useState(!0),[j,E]=x.reactExports.useState(""),[v,R]=x.reactExports.useState([]),[w,N]=x.reactExports.useState(null),[S,f]=x.reactExports.useState(!1),[T,b]=x.reactExports.useState([]),[V,y]=x.reactExports.useState(null),k=x.reactExports.useRef(null),[C,D]=x.reactExports.useState([]);x.reactExports.useState(!1),x.reactExports.useEffect(()=>{P()},[t,s]),x.reactExports.useEffect(()=>{t&&I()},[t]),x.reactExports.useEffect(()=>{if(a&&t){const e=m.getTherapistShareConfig(t,a.name||"\u6280\u5e08");x.Taro.useShareAppMessage(()=>({title:e.title,path:e.path}));const s=m.getTherapistShareTimelineConfig(a.name||"\u6280\u5e08");x.Taro.useShareTimeline(()=>({title:s.title,imageUrl:s.imageUrl}))}},[a,t]);const P=()=>c(exports,null,function*(){try{if(u(!0),E(""),console.log("TherapistBookingPage params:",{therapistId:t,storeId:s}),!t||!s)return console.error("Missing required params:",{therapistId:t,storeId:s}),void E("\u53c2\u6570\u9519\u8bef\uff0c\u8bf7\u91cd\u65b0\u8fdb\u5165");const[e,a,i,c]=yield Promise.all([m.therapistService.getTherapistDetail(t),m.storeService.getStoreDetail(s),m.getLocationService.getCurrentLocation(),m.symptomService.getTherapistSymptomServices(t)]);console.log("Store data response:",a),console.log("Therapist data response:",e),console.log("\u2705 Services data response:",c);const x=e.data||e,p=(null==a?void 0:a.data)||a;let d=o({},p);if((null==p?void 0:p.latitude)&&(null==p?void 0:p.longitude)){const e=m.getLocationService.calculateDistance(i.latitude,i.longitude,p.latitude,p.longitude);d=l(o({},p),{distance:e})}const j=c.data||[];D(j),console.log(`\u2705 \u52a0\u8f7d\u4e86 ${j.length} \u4e2a\u670d\u52a1`),r(x),n(d),console.log("Store state after setting:",d),console.log("Therapist state after setting:",x)}catch(e){console.error("Failed to load data:",e),E("\u52a0\u8f7d\u6570\u636e\u5931\u8d25\uff0c\u8bf7\u91cd\u8bd5")}finally{u(!1)}}),I=()=>c(exports,null,function*(){if(t)try{f(!0);const[e,s]=yield Promise.all([m.reviewService.getTherapistReviews(t,1,10),m.reviewService.getReviewStats(t)]);R(e.list||[]),N(s),s&&a&&r(l(o({},a),{rating:s.averageRating,ratingCount:s.totalCount}))}catch(e){console.error("\u52a0\u8f7d\u8bc4\u4ef7\u6570\u636e\u5931\u8d25:",e)}finally{f(!1)}}),$=e=>{y(e)},O=(e,t)=>{if(!V||!a)return;const s=`${e}_${t}_${Date.now()}`,r={id:s,serviceId:V.id,serviceName:V.name,duration:V.duration,price:V.price,discountPrice:V.discountPrice,date:e,time:t,therapistId:a.id,therapistName:a.name,therapistAvatar:a.avatar};b([r]),x.Taro.showToast({title:"\u5df2\u9009\u62e9\u9884\u7ea6\u65f6\u95f4",icon:"success"})},L=()=>{var e;b([]),null==(e=k.current)||e.clearSelectedTime()},M=()=>{if(0===T.length)return;const e={therapistId:t,storeId:s,items:JSON.stringify(T)};x.Taro.navigateTo({url:`/pages/booking/confirm/index?${Object.entries(e).map(([e,t])=>`${e}=${encodeURIComponent(t)}`).join("&")}`})};return p?x.jsxRuntimeExports.jsx(x.View,{className:"therapist-booking-page",children:x.jsxRuntimeExports.jsx(x.View,{className:"loading",children:"\u52a0\u8f7d\u4e2d..."})}):!j&&a&&i?x.jsxRuntimeExports.jsxs(x.View,{className:"therapist-booking-page",children:[x.jsxRuntimeExports.jsxs(x.ScrollView,{className:"main-content",scrollY:!0,children:[x.jsxRuntimeExports.jsx(d,{therapist:a,stats:w,reviews:v,reviewsLoading:S}),i&&x.jsxRuntimeExports.jsx(h,{store:i}),x.jsxRuntimeExports.jsx(g,{ref:k,services:C,therapistId:t,onServiceSelect:$,onTimeSelect:O})]}),x.jsxRuntimeExports.jsx(m.ShoppingCart,{items:T,therapist:a,onCheckout:M,onMaskClick:L})]}):x.jsxRuntimeExports.jsx(x.View,{className:"therapist-booking-page",children:x.jsxRuntimeExports.jsx(x.View,{className:"error",children:j||"\u6570\u636e\u52a0\u8f7d\u5931\u8d25"})})};var w={navigationBarTitleText:"\u63a8\u62ff\u5e08\u9884\u7ea6",enableShareAppMessage:!0,enableShareTimeline:!0};R.enableShareTimeline=!0,R.enableShareAppMessage=!0,Page(x.createPageConfig(R,"pages/appointment/therapist/index",{root:{cn:[]}},w||{}));
