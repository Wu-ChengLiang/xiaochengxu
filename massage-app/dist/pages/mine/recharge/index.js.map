{"version":3,"file":"index.js","sources":["../../../../src/pages/mine/recharge/index.tsx"],"sourcesContent":["import React, { useState } from 'react'\nimport { View, Text, Button } from '@tarojs/components'\nimport Taro from '@tarojs/taro'\nimport { AtIcon } from 'taro-ui'\nimport { walletService } from '@/services/wallet.service'\nimport { paymentService } from '@/services/payment.service'\nimport './index.scss'\n\nconst Recharge: React.FC = () => {\n  const [customAmount, setCustomAmount] = useState('')\n  const [loading, setLoading] = useState(false)\n\n  // ❌ 已注释掉 - 预设充值选项由于后端数据重复问题而移除\n  // const [selectedAmount, setSelectedAmount] = useState(0)\n  // const [selectedBonus, setSelectedBonus] = useState(0)\n  // const [rechargeOptions, setRechargeOptions] = useState<RechargeOption[]>([])\n  // useEffect(() => { loadRechargeOptions() }, [])\n  // const loadRechargeOptions = async () => { ... }\n  // const handleAmountSelect = (amount: number, bonus: number = 0) => { ... }\n\n  const handleCustomAmountChange = (e: any) => {\n    const value = e.detail?.value || e.target?.value || ''\n    // ✅ 只允许输入数字\n    if (/^\\d*$/.test(value)) {\n      setCustomAmount(value)\n    }\n  }\n\n  const handleRecharge = async () => {\n    // ✅ 现在只使用自定义输入的金额，没有赠送金额\n    const amount = Number(customAmount)\n    const bonus = 0\n\n    if (!amount || amount <= 0) {\n      Taro.showToast({\n        title: '请输入有效的充值金额',\n        icon: 'none'\n      })\n      return\n    }\n\n    if (amount > 50000) {\n      Taro.showToast({\n        title: '单次充值金额不能超过5万元',\n        icon: 'none'\n      })\n      return\n    }\n\n    setLoading(true)\n\n    try {\n      // 创建充值订单\n      const order = await walletService.createRechargeOrder(amount, bonus)\n\n      console.log('💰 充值订单创建成功:', order)\n      console.log('💰 订单号:', order.orderNo)\n      console.log('💰 订单金额:', {\n        分: order.amount,\n        元: (order.amount / 100).toFixed(2)\n      })\n      console.log('💰 支付参数:', order.wxPayParams)\n      // ⚠️ 诊断：检查 wxPayParams 中的金额信息\n      if (order.wxPayParams?.package) {\n        console.log('💰 微信支付 package 参数:', order.wxPayParams.package)\n      }\n\n      // 调起微信支付\n      if (order.wxPayParams) {\n        // 使用统一支付服务\n        // ✅ order.amount 应该是分为单位\n        const finalAmount = order.amount || (amount * 100)\n\n        console.log('💰 最终支付金额:', {\n          分: finalAmount,\n          元: (finalAmount / 100).toFixed(2),\n          源: order.amount ? '来自订单' : '来自前端转换'\n        })\n\n        const paymentSuccess = await paymentService.pay({\n          orderNo: order.orderNo,\n          amount: finalAmount, // 使用订单中的金额（应该已是分）\n          paymentMethod: 'wechat',\n          title: `充值${amount}元${bonus > 0 ? `(赠${bonus}元)` : ''}`,\n          wxPayParams: order.wxPayParams\n        } as any)\n\n        if (paymentSuccess) {\n          Taro.showToast({\n            title: '充值成功',\n            icon: 'success',\n            duration: 2000\n          })\n\n          setTimeout(() => {\n            Taro.navigateBack()\n          }, 2000)\n        }\n      } else {\n        throw new Error('获取支付参数失败')\n      }\n    } catch (error: any) {\n      if (error.message?.includes('用户取消') || error.errMsg?.includes('cancel')) {\n        Taro.showToast({\n          title: '支付已取消',\n          icon: 'none'\n        })\n      } else {\n        Taro.showToast({\n          title: error.message || '充值失败，请重试',\n          icon: 'none'\n        })\n      }\n    } finally {\n      setLoading(false)\n    }\n  }\n\n  return (\n    <View className=\"recharge-page\">\n      {/* 充值金额选择 */}\n      <View className=\"amount-section\">\n        {/* ❌ 注释掉预设充值选项 - 因为后端数据库中有重复数据（48条重复的选项）*/}\n        {/* <Text className=\"section-title\">选择充值金额</Text>\n        <View className=\"amount-grid\">\n          {rechargeOptions.map((option) => (\n            <View\n              key={option.id || option.amount}\n              className={`amount-card ${selectedAmount === option.amount ? 'active' : ''}`}\n              onClick={() => handleAmountSelect(option.amount, option.bonus)}\n            >\n              <Text className=\"amount\">¥{(option.amount / 100).toFixed(0)}</Text>\n              {option.bonus > 0 && (\n                <Text className=\"bonus\">赠送{(option.bonus / 100).toFixed(0)}元</Text>\n              )}\n            </View>\n          ))}\n        </View> */}\n\n        {/* ✅ 只保留自定义金额输入 */}\n        <View className=\"custom-amount\">\n          <Text className=\"label\">请输入充值金额</Text>\n          <View className=\"input-wrapper\">\n            <Text className=\"prefix\">¥</Text>\n            <input\n              className=\"input\"\n              type=\"number\"\n              placeholder=\"请输入充值金额（单位：元）\"\n              value={customAmount}\n              onInput={handleCustomAmountChange}\n            />\n          </View>\n        </View>\n      </View>\n\n      {/* 充值说明 */}\n      <View className=\"tips-section\">\n        <Text className=\"section-title\">充值说明</Text>\n        <View className=\"tips-list\">\n          <View className=\"tip-item\">\n            <Text className=\"dot\">•</Text>\n            <Text className=\"text\">充值金额将实时到账，可用于支付推拿服务</Text>\n          </View>\n          <View className=\"tip-item\">\n            <Text className=\"dot\">•</Text>\n            <Text className=\"text\">余额不支持提现，请合理充值</Text>\n          </View>\n          <View className=\"tip-item\">\n            <Text className=\"dot\">•</Text>\n            <Text className=\"text\">充值赠送金额与本金同等使用</Text>\n          </View>\n        </View>\n      </View>\n\n      {/* 底部充值按钮 */}\n      <View className=\"bottom-bar\">\n        <Button\n          className=\"recharge-btn\"\n          onClick={handleRecharge}\n          disabled={loading}\n        >\n          <AtIcon value=\"credit-card\" size=\"20\" />\n          <Text>立即充值</Text>\n        </Button>\n      </View>\n    </View>\n  )\n}\n\nexport default Recharge"],"names":["Recharge","customAmount","setCustomAmount","useState","loading","setLoading","handleCustomAmountChange","e","value","detail","target","test","handleRecharge","amount","Number","bonus","Taro","showToast","title","icon","order","walletService","createRechargeOrder","log","orderNo","console","分","元","toFixed","wxPayParams","package","finalAmount","源","paymentSuccess","paymentService","pay","paymentMethod","duration","setTimeout","navigateBack","Error","error","message","includes","errMsg","jsxs","View","jsx","Text","Button","AtIcon"],"mappings":"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"}