"use strict";var e=(e,t,s)=>new Promise((r,a)=>{var i=e=>{try{n(s.next(e))}catch(t){a(t)}},o=e=>{try{n(s.throw(e))}catch(t){a(t)}},n=e=>e.done?r(e.value):Promise.resolve(e.value).then(i,o);n((s=s.apply(e,t)).next())});const t=require("../../../taro.js"),s=require("../../../common.js"),r="",a=()=>{var r,a,i,o,n;const c=t.taroExports.useRouter(),l=c.params,x=!!l.orderNo,m=!x,[d,u]=t.reactExports.useState([]),[p,h]=t.reactExports.useState(null),[j,E]=t.reactExports.useState(null),[N,w]=t.reactExports.useState(null),[v,R]=t.reactExports.useState(!0),[g,y]=t.reactExports.useState(180),[T,f]=t.reactExports.useState("wechat"),[V,S]=t.reactExports.useState(0),[D,b]=t.reactExports.useState(!1),[k,P]=t.reactExports.useState(null),[I,$]=t.reactExports.useState(!1),M=t.reactExports.useRef(null);t.reactExports.useEffect(()=>{const r=()=>e(exports,null,function*(){try{const e=yield s.requireLogin();if(!e)return;if(x)A();else{const e=JSON.parse(decodeURIComponent(l.items||"[]"));u(e),B()}L(),C()}catch(e){t.Taro.showToast({title:"\u6570\u636e\u52a0\u8f7d\u5931\u8d25",icon:"none"}),setTimeout(()=>t.Taro.navigateBack(),1500)}});r()},[l]),t.reactExports.useEffect(()=>(!v&&m&&d.length>0&&(M.current=setInterval(()=>{y(e=>e<=1?(clearInterval(M.current),t.Taro.showModal({title:"\u652f\u4ed8\u8d85\u65f6\u4e86\u5466",content:"\u5feb\u5feb\u91cd\u65b0\u4e0b\u5355\u5427~",showCancel:!1,success:()=>{t.Taro.navigateBack()}}),0):e-1)},1e3)),()=>{M.current&&clearInterval(M.current)}),[v,d,m]);const C=()=>e(exports,null,function*(){try{const e=s.getCurrentUserInfo();if(e&&e.discountRate){P(e.discountRate);const t=yield s.voucherService.getMyVouchers();$(t.length>0)}}catch(e){console.error("\u83b7\u53d6\u7528\u6237\u6298\u6263\u4fe1\u606f\u5931\u8d25:",e)}}),L=()=>e(exports,null,function*(){try{b(!0);const e=yield s.walletService.getBalance();S(e/100);const t=U();e/100>=t&&f("balance")}catch(e){console.error("\u83b7\u53d6\u4f59\u989d\u5931\u8d25:",e),S(0)}finally{b(!1)}}),A=()=>e(exports,null,function*(){var e;try{R(!0);const t=yield s.orderService.getOrderDetail(l.orderNo);if(w(t),null==(e=t.extraData)?void 0:e.storeId)try{const e=yield s.storeService.getStoreDetail(t.extraData.storeId);E(e.data)}catch(r){console.error("\u83b7\u53d6\u95e8\u5e97\u4fe1\u606f\u5931\u8d25:",r)}R(!1)}catch(r){R(!1),t.Taro.showToast({title:"\u83b7\u53d6\u8ba2\u5355\u4fe1\u606f\u5931\u8d25",icon:"none"}),setTimeout(()=>t.Taro.navigateBack(),1500)}}),B=()=>e(exports,null,function*(){try{if(R(!0),l.therapistId){const e=yield s.therapistService.getTherapistDetail(l.therapistId);h(e.data)}const e=yield s.storeService.getStoreDetail(l.storeId),t=e.data;E(t),R(!1)}catch(e){R(!1),t.Taro.showToast({title:"\u83b7\u53d6\u4fe1\u606f\u5931\u8d25",icon:"none"})}}),F=e=>{const t=Math.floor(e/60),s=e%60;return`${t.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`},q=e=>{const t=new Date(e),s=t.getMonth()+1,r=t.getDate();return`${s.toString().padStart(2,"0")}\u6708${r.toString().padStart(2,"0")}\u65e5`},O=(e,t)=>{const[s,r]=e.split(":").map(Number),a=r+t,i=s+Math.floor(a/60),o=a%60;return`${i}:${o.toString().padStart(2,"0")}`},U=()=>{if(x&&N)return N.amount/100;const e=d.reduce((e,t)=>e+t.price,0);if(k&&k<1){const t=s.calculateDiscountPrice(e,k);return t.finalPrice}return d.reduce((e,t)=>e+(t.discountPrice||t.price),0)},J=()=>x&&N?N.amount/100:d.reduce((e,t)=>e+t.price,0),Y=()=>{const e=J(),t=U();return e-t},z=()=>{if(k&&k<1){const e=Math.round(100*k);return`${e}\u6298`}return""},G=()=>{const e=U();return V>=e},H=e=>{"balance"!==e||G()?f(e):t.Taro.showToast({title:"\u4f59\u989d\u4e0d\u8db3\uff0c\u8bf7\u5145\u503c\u6216\u4f7f\u7528\u5176\u4ed6\u652f\u4ed8\u65b9\u5f0f",icon:"none",duration:2e3})},K=()=>e(exports,null,function*(){var e,s,r,a,i,o,n;if("balance"!==T||G())try{x?yield Q():yield W()}catch(c){console.error("\u274c \u652f\u4ed8\u6d41\u7a0b\u9519\u8bef:",c),t.Taro.hideLoading();let l=c.message||c.errMsg||"\u652f\u4ed8\u5931\u8d25";(1003===(null==(s=null==(e=c.response)?void 0:e.data)?void 0:s.errorCode)||1004===(null==(a=null==(r=c.response)?void 0:r.data)?void 0:a.errorCode)||(null==(i=c.message)?void 0:i.includes("\u8d44\u6e90\u4e0d\u5b58\u5728"))||(null==(o=c.message)?void 0:o.includes("\u5df2\u7ecf\u9884\u7ea6"))||(null==(n=c.message)?void 0:n.includes("\u91cd\u590d")))&&(l="\u8be5\u6280\u5e08\u5df2\u88ab\u9884\u7ea6"),t.Taro.showModal({title:"\u63d0\u793a",content:l,showCancel:!1,confirmText:"\u77e5\u9053\u4e86"})}else t.Taro.showToast({title:"\u4f59\u989d\u4e0d\u8db3\uff0c\u8bf7\u5145\u503c\u6216\u4f7f\u7528\u5176\u4ed6\u652f\u4ed8\u65b9\u5f0f",icon:"none",duration:2e3})}),Q=()=>e(exports,null,function*(){if(!N)throw new Error("\u8ba2\u5355\u4fe1\u606f\u4e22\u5931");t.Taro.showLoading({title:"\u51c6\u5907\u652f\u4ed8..."});try{const e=N.orderNo,r=N.amount;if("wechat"===T){console.log("\ud83d\udcb3 \u83b7\u53d6\u5fae\u4fe1\u652f\u4ed8\u53c2\u6570\uff0c\u8ba2\u5355\u53f7:",e);const a=yield s.orderService.getPaymentParams(e);if(console.log("\ud83d\udcb3 \u652f\u4ed8\u53c2\u6570\u83b7\u53d6\u6210\u529f:",a),!a)throw new Error("\u83b7\u53d6\u652f\u4ed8\u53c2\u6570\u5931\u8d25");t.Taro.hideLoading();const i=yield s.paymentService.pay({orderNo:e,amount:r,paymentMethod:"wechat",title:N.title,wxPayParams:a});i&&setTimeout(()=>{t.Taro.redirectTo({url:`/pages/booking/success/index?orderNo=${e}`})},1500)}else{console.log("\ud83d\udcb0 \u4f59\u989d\u652f\u4ed8\uff0c\u8ba2\u5355\u53f7:",e);const a=yield s.paymentService.pay({orderNo:e,amount:r,paymentMethod:"balance",title:N.title});t.Taro.hideLoading(),a&&(yield L(),setTimeout(()=>{t.Taro.redirectTo({url:`/pages/booking/success/index?orderNo=${e}`})},1500))}}catch(e){throw t.Taro.hideLoading(),e}}),W=()=>e(exports,null,function*(){const e="symptom"===l.from,r=!e&&!p;if(0===d.length||r||!j)throw new Error("\u8ba2\u5355\u4fe1\u606f\u4e0d\u5b8c\u6574");t.Taro.showLoading({title:"\u521b\u5efa\u8ba2\u5355..."});const a=d[0],i={therapistId:a.therapistId||l.therapistId||"symptom-mode",storeId:l.storeId,serviceId:a.serviceId,serviceName:a.serviceName,duration:a.duration,price:a.price,discountPrice:a.discountPrice,appointmentDate:a.date,appointmentTime:a.time,therapistName:a.therapistName,therapistAvatar:a.therapistAvatar||(null==p?void 0:p.avatar),paymentMethod:T};console.log("\ud83d\udcdd \u521b\u5efa\u8ba2\u5355\uff0c\u652f\u4ed8\u65b9\u5f0f:",T);const o=yield s.orderService.createAppointmentOrder(i),n=o.order;if(t.Taro.hideLoading(),!n||!n.orderNo)throw new Error("\u8ba2\u5355\u521b\u5efa\u5931\u8d25\uff0c\u672a\u8fd4\u56de\u8ba2\u5355\u53f7");if("wechat"===T&&!n.wxPayParams)throw new Error("\u5fae\u4fe1\u652f\u4ed8\u53c2\u6570\u7f3a\u5931\uff0c\u8bf7\u68c0\u67e5\u7528\u6237\u767b\u5f55\u72b6\u6001\u6216\u5c1d\u8bd5\u4f59\u989d\u652f\u4ed8");const c=yield s.paymentService.pay({orderNo:n.orderNo,amount:100*(n.totalAmount||U()),paymentMethod:T,title:`${a.serviceName} - ${a.therapistName}`,wxPayParams:n.wxPayParams});c&&("balance"===T&&(yield L()),setTimeout(()=>{t.Taro.redirectTo({url:`/pages/booking/success/index?orderNo=${n.orderNo}`})},1500))});return v?t.jsxRuntimeExports.jsx(t.View,{className:"order-confirm-page",children:t.jsxRuntimeExports.jsx(t.View,{className:"loading",children:"\u52a0\u8f7d\u4e2d..."})}):t.jsxRuntimeExports.jsxs(t.ScrollView,{className:"order-confirm-page",scrollY:!0,children:[t.jsxRuntimeExports.jsxs(t.View,{className:"store-section",children:[t.jsxRuntimeExports.jsx(t.Text,{className:"store-name",children:null==j?void 0:j.name}),t.jsxRuntimeExports.jsxs(t.Text,{className:"store-distance",children:["\ud83d\udccd ",null==j?void 0:j.distance,"km"]})]}),t.jsxRuntimeExports.jsx(t.View,{className:"booking-info",children:x&&N?t.jsxRuntimeExports.jsxs(t.View,{className:"booking-item",children:[(null==(r=N.extraData)?void 0:r.therapistAvatar)&&t.jsxRuntimeExports.jsx(t.Image,{className:"therapist-avatar",src:N.extraData.therapistAvatar}),t.jsxRuntimeExports.jsxs(t.View,{className:"booking-details",children:[t.jsxRuntimeExports.jsx(t.View,{className:"therapist-name",children:(null==(a=N.extraData)?void 0:a.therapistName)||"\u63a8\u62ff\u5e08"}),t.jsxRuntimeExports.jsx(t.View,{className:"service-time",children:(null==(i=N.extraData)?void 0:i.appointmentDate)&&(null==(o=N.extraData)?void 0:o.startTime)&&t.jsxRuntimeExports.jsxs(t.jsxRuntimeExports.Fragment,{children:[q(N.extraData.appointmentDate)," ",N.extraData.startTime,N.extraData.duration&&t.jsxRuntimeExports.jsxs(t.jsxRuntimeExports.Fragment,{children:[" \u81f3 ",O(N.extraData.startTime,N.extraData.duration)]})]})}),t.jsxRuntimeExports.jsx(t.View,{className:"service-name",children:(null==(n=N.extraData)?void 0:n.serviceName)||N.title})]}),t.jsxRuntimeExports.jsxs(t.View,{className:"service-price",children:["\xa5",(N.amount/100).toFixed(2)]})]}):d.map((e,s)=>t.jsxRuntimeExports.jsxs(t.View,{className:"booking-item",children:[t.jsxRuntimeExports.jsx(t.Image,{className:"therapist-avatar",src:e.therapistAvatar||(null==p?void 0:p.avatar)}),t.jsxRuntimeExports.jsxs(t.View,{className:"booking-details",children:[t.jsxRuntimeExports.jsx(t.View,{className:"therapist-name",children:e.therapistName}),t.jsxRuntimeExports.jsxs(t.View,{className:"service-time",children:[q(e.date)," ",e.time," \u81f3 ",O(e.time,e.duration)]}),t.jsxRuntimeExports.jsx(t.View,{className:"service-name",children:e.serviceName})]}),t.jsxRuntimeExports.jsxs(t.View,{className:"service-price",children:["\xa5",e.discountPrice||e.price]})]},s))}),t.jsxRuntimeExports.jsxs(t.View,{className:"refund-policy",children:[t.jsxRuntimeExports.jsx(t.Text,{className:"policy-title",children:"\u9000\u5355\u8bf4\u660e"}),t.jsxRuntimeExports.jsxs(t.View,{className:"policy-list",children:[t.jsxRuntimeExports.jsx(t.View,{className:"policy-item",children:"\u2022 \u4e0b\u535515\u5206\u949f\u5185\u6216\u8ddd\u8ba2\u5355\u5f00\u59cb\u65f6\u95f4>6\u5c0f\u65f6\u9000\u5355\uff0c\u9000100%"}),t.jsxRuntimeExports.jsx(t.View,{className:"policy-item",children:"\u2022 \u8ddd\u8ba2\u5355\u5f00\u59cb\u524d<6\u5c0f\u65f6\u9000\u5355\uff0c\u9000\u5b9e\u4ed8\u91d1\u989d90%"}),t.jsxRuntimeExports.jsx(t.View,{className:"policy-item",children:"\u2022 \u8ba2\u5355\u65f6\u95f4\u5f00\u59cb\u540e\u9000\u5355\uff0c\u9000\u5b9e\u4ed8\u91d1\u989d80%"})]})]}),t.jsxRuntimeExports.jsxs(t.View,{className:"customer-note",children:[t.jsxRuntimeExports.jsx(t.Text,{className:"note-title",children:"\u5ba2\u6237\u5907\u6ce8"}),t.jsxRuntimeExports.jsx(t.Text,{className:"note-hint",children:"\u60a8\u5bf9\u8336\u6c34\u3001\u623f\u95f4\u3001\u6309\u6469\u670d\u7b49\u662f\u5426\u6709\u7279\u6b8a\u9700\u6c42\uff0c\u6211\u4eec\u5c06\u63d0\u524d\u4e3a\u60a8\u505a\u597d\u51c6\u5907"})]}),t.jsxRuntimeExports.jsxs(t.View,{className:"payment-section",children:[t.jsxRuntimeExports.jsx(t.Text,{className:"section-title",children:"\u652f\u4ed8\u65b9\u5f0f"}),t.jsxRuntimeExports.jsxs(t.View,{className:"payment-methods",children:[t.jsxRuntimeExports.jsxs(t.View,{className:`payment-method ${"balance"===T?"active":""} ${G()?"":"disabled"}`,onClick:()=>H("balance"),children:[t.jsxRuntimeExports.jsxs(t.View,{className:"method-info",children:[t.jsxRuntimeExports.jsx(t.Text,{className:"method-icon",children:"\ud83d\udcb0"}),t.jsxRuntimeExports.jsx(t.Text,{className:"method-name",children:"\u4f59\u989d\u652f\u4ed8"}),t.jsxRuntimeExports.jsxs(t.Text,{className:"balance-amount",children:[D?"\u52a0\u8f7d\u4e2d...":`\xa5${V.toFixed(2)}`,!G()&&!D&&t.jsxRuntimeExports.jsx(t.Text,{className:"insufficient",children:" (\u4f59\u989d\u4e0d\u8db3)"})]})]}),t.jsxRuntimeExports.jsx(t.View,{className:"check-icon "+("balance"===T?"checked":"")})]}),t.jsxRuntimeExports.jsxs(t.View,{className:"payment-method "+("wechat"===T?"active":""),onClick:()=>H("wechat"),children:[t.jsxRuntimeExports.jsxs(t.View,{className:"method-info",children:[t.jsxRuntimeExports.jsx(t.Text,{className:"method-icon",children:"\ud83d\udc9a"}),t.jsxRuntimeExports.jsx(t.Text,{className:"method-name",children:"\u5fae\u4fe1\u652f\u4ed8"})]}),t.jsxRuntimeExports.jsx(t.View,{className:"check-icon "+("wechat"===T?"checked":"")})]})]})]}),t.jsxRuntimeExports.jsxs(t.View,{className:"payment-bar",children:[t.jsxRuntimeExports.jsxs(t.View,{className:"price-info",children:[k&&k<1&&Y()>0?t.jsxRuntimeExports.jsxs(t.View,{className:"price-with-discount",children:[t.jsxRuntimeExports.jsxs(t.View,{className:"discount-info",children:[t.jsxRuntimeExports.jsx(t.Text,{className:"discount-tag",children:z()}),t.jsxRuntimeExports.jsxs(t.Text,{className:"saved-amount",children:["\u5df2\u4f18\u60e0 \xa5",Y()]})]}),t.jsxRuntimeExports.jsxs(t.View,{className:"price-display",children:[t.jsxRuntimeExports.jsxs(t.Text,{className:"original-price",children:["\xa5",J()]}),t.jsxRuntimeExports.jsxs(t.Text,{className:"total-price",children:["\xa5",U()]})]})]}):t.jsxRuntimeExports.jsxs(t.Text,{className:"total-price",children:["\xa5",U()]}),m&&t.jsxRuntimeExports.jsxs(t.Text,{className:"countdown",children:["\u652f\u4ed8\u5012\u8ba1\u65f6: ",F(g)]})]}),t.jsxRuntimeExports.jsx(t.View,{className:"pay-button",onClick:K,children:"\u53bb\u652f\u4ed8"})]})]})};var i={navigationBarTitleText:"\u8ba2\u5355\u786e\u8ba4"};Page(t.createPageConfig(a,"pages/booking/confirm/index",{root:{cn:[]}},i||{}));
