"use strict";var e=(e,t,s)=>new Promise((o,a)=>{var r=e=>{try{i(s.next(e))}catch(t){a(t)}},n=e=>{try{i(s.throw(e))}catch(t){a(t)}},i=e=>e.done?o(e.value):Promise.resolve(e.value).then(r,n);i((s=s.apply(e,t)).next())});const t=require("../../../taro.js"),s=require("../../../common.js");class o{constructor(){this.config={useMockPayment:!1,enableBalancePayment:!0,enableWechatPayment:!0}}pay(t){return e(this,null,function*(){const{paymentMethod:e}=t;if(this.config.useMockPayment&&"wechat"===e)return this.mockWechatPayment(t);if("balance"===e)return this.payWithBalance(t);if("wechat"===e&&this.config.enableWechatPayment)return this.payWithWechat(t);throw new Error("\u4e0d\u652f\u6301\u7684\u652f\u4ed8\u65b9\u5f0f")})}mockWechatPayment(o){return e(this,null,function*(){try{const{confirm:e}=yield t.Taro.showModal({title:"\u6a21\u62df\u652f\u4ed8",content:`\u8ba2\u5355\u91d1\u989d\uff1a\xa5${(o.amount/100).toFixed(2)}\n${o.title||""}`,confirmText:"\u786e\u8ba4\u652f\u4ed8",cancelText:"\u53d6\u6d88\u652f\u4ed8",confirmColor:"#07c160"});if(e){t.Taro.showLoading({title:"\u652f\u4ed8\u4e2d..."}),yield this.delay(1500),console.log("\ud83d\udcb3 \u6a21\u62df\u5fae\u4fe1\u652f\u4ed8\u8bf7\u6c42\u53c2\u6570:",{orderNo:o.orderNo,paymentMethod:"wechat"});const e=yield s.post("/orders/pay",{orderNo:o.orderNo,paymentMethod:"wechat"});if(console.log("\ud83d\udcb3 \u6a21\u62df\u5fae\u4fe1\u652f\u4ed8\u54cd\u5e94:",e),t.Taro.hideLoading(),0===e.code)return t.Taro.showToast({title:"\u652f\u4ed8\u6210\u529f",icon:"success"}),!0;throw new Error(e.message||"\u652f\u4ed8\u5931\u8d25")}return console.log("\u7528\u6237\u53d6\u6d88\u6a21\u62df\u652f\u4ed8"),!1}catch(e){throw console.error("\ud83d\udcb3 \u6a21\u62df\u5fae\u4fe1\u652f\u4ed8\u5931\u8d25:",e),t.Taro.hideLoading(),t.Taro.showToast({title:e.message||"\u652f\u4ed8\u5931\u8d25",icon:"none"}),e}})}payWithBalance(o){return e(this,null,function*(){try{t.Taro.showLoading({title:"\u652f\u4ed8\u4e2d..."}),console.log("\ud83d\udcb0 \u4f59\u989d\u652f\u4ed8\u8bf7\u6c42\u53c2\u6570:",{orderNo:o.orderNo,paymentMethod:"balance"});const e=yield s.post("/orders/pay",{orderNo:o.orderNo,paymentMethod:"balance"});if(console.log("\ud83d\udcb0 \u4f59\u989d\u652f\u4ed8\u54cd\u5e94:",e),t.Taro.hideLoading(),0===e.code)return t.Taro.showToast({title:`\u652f\u4ed8\u6210\u529f\n\u4f59\u989d\uff1a\xa5${(e.data.balance/100).toFixed(2)}`,icon:"success",duration:2e3}),!0;throw new Error(e.message||"\u4f59\u989d\u4e0d\u8db3")}catch(e){return console.error("\ud83d\udcb0 \u4f59\u989d\u652f\u4ed8\u5931\u8d25:",e),console.error("\ud83d\udcb0 \u9519\u8bef\u8be6\u60c5:",e.response||e.message),t.Taro.hideLoading(),t.Taro.showToast({title:e.message||"\u652f\u4ed8\u5931\u8d25",icon:"none"}),!1}})}payWithWechat(s){return e(this,null,function*(){try{console.log("\ud83d\udcb3 \u5f00\u59cb\u771f\u5b9e\u5fae\u4fe1\u652f\u4ed8\uff0c\u8ba2\u5355\u53f7:",s.orderNo);const e=s.wxPayParams;if(!e)throw new Error("\u7f3a\u5c11\u5fae\u4fe1\u652f\u4ed8\u53c2\u6570\uff0c\u8bf7\u5148\u521b\u5efa\u8ba2\u5355");return console.log("\ud83d\udcb3 \u5fae\u4fe1\u652f\u4ed8\u53c2\u6570:",e),yield t.Taro.requestPayment({timeStamp:e.timeStamp,nonceStr:e.nonceStr,package:e.package,signType:e.signType,paySign:e.paySign}),console.log("\ud83d\udcb3 \u7528\u6237\u5b8c\u6210\u652f\u4ed8\uff0c\u7b49\u5f85\u5fae\u4fe1\u56de\u8c03\u540e\u7aef\u66f4\u65b0\u8ba2\u5355\u72b6\u6001"),t.Taro.showToast({title:"\u652f\u4ed8\u6210\u529f",icon:"success"}),!0}catch(e){if("requestPayment:fail cancel"===e.errMsg)return console.log("\ud83d\udcb3 \u7528\u6237\u53d6\u6d88\u652f\u4ed8"),!1;throw console.error("\ud83d\udcb3 \u5fae\u4fe1\u652f\u4ed8\u5931\u8d25:",e),t.Taro.showToast({title:"\u652f\u4ed8\u5931\u8d25",icon:"none"}),e}})}checkPaymentEnvironment(){return e(this,null,function*(){t.Taro.getAccountInfoSync();const e=!this.config.enableWechatPayment;return{canUseWechatPay:!e&&this.config.enableWechatPayment,canUseBalance:this.config.enableBalancePayment,canUseMockPay:this.config.useMockPayment,message:e?"\u5f53\u524d\u4e3a\u4e2a\u4eba\u5c0f\u7a0b\u5e8f\uff0c\u4f7f\u7528\u6a21\u62df\u652f\u4ed8\u548c\u4f59\u989d\u652f\u4ed8":"\u4f01\u4e1a\u5c0f\u7a0b\u5e8f\uff0c\u652f\u6301\u5b8c\u6574\u652f\u4ed8\u529f\u80fd"}})}generateRechargeCode(t){return e(this,null,function*(){const e=yield s.post("/recharge/generate-code",{amount:t});return e.data})}delay(e){return new Promise(t=>setTimeout(t,e))}}const a=new o,r="",n=()=>{const o=t.taroExports.useRouter(),r=o.params,[n,i]=t.reactExports.useState([]),[c,l]=t.reactExports.useState(null),[m,x]=t.reactExports.useState(null),[d,u]=t.reactExports.useState(!0),[h,p]=t.reactExports.useState(180),[j,g]=t.reactExports.useState("wechat"),[y,w]=t.reactExports.useState(0),[N,E]=t.reactExports.useState(!1),[T,f]=t.reactExports.useState(null),[R,v]=t.reactExports.useState(!1),P=t.reactExports.useRef(null);t.reactExports.useEffect(()=>{try{const e=JSON.parse(decodeURIComponent(r.items||"[]"));i(e),b(),V(),S()}catch(e){t.Taro.showToast({title:"\u6570\u636e\u89e3\u6790\u5931\u8d25",icon:"none"}),setTimeout(()=>t.Taro.navigateBack(),1500)}},[r]),t.reactExports.useEffect(()=>(!d&&n.length>0&&(P.current=setInterval(()=>{p(e=>e<=1?(clearInterval(P.current),t.Taro.showModal({title:"\u652f\u4ed8\u8d85\u65f6\u4e86\u5466",content:"\u5feb\u5feb\u91cd\u65b0\u4e0b\u5355\u5427~",showCancel:!1,success:()=>{t.Taro.navigateBack()}}),0):e-1)},1e3)),()=>{P.current&&clearInterval(P.current)}),[d,n]);const S=()=>e(exports,null,function*(){try{const e=s.getCurrentUserInfo();if(e&&e.discountRate){f(e.discountRate);const t=yield s.voucherService.getMyVouchers();v(t.length>0)}}catch(e){console.error("\u83b7\u53d6\u7528\u6237\u6298\u6263\u4fe1\u606f\u5931\u8d25:",e)}}),V=()=>e(exports,null,function*(){try{E(!0);const e=yield s.walletService.getBalance();w(e);const t=$();e>=t/100&&g("balance")}catch(e){console.error("\u83b7\u53d6\u4f59\u989d\u5931\u8d25:",e),w(0)}finally{E(!1)}}),b=()=>e(exports,null,function*(){try{if(u(!0),r.therapistId){const e=yield s.therapistService.getTherapistDetail(r.therapistId);l(e.data)}const e=yield s.storeService.getStoreDetail(r.storeId),t=e.data;x(t),u(!1)}catch(e){u(!1),t.Taro.showToast({title:"\u83b7\u53d6\u4fe1\u606f\u5931\u8d25",icon:"none"})}}),k=e=>{const t=Math.floor(e/60),s=e%60;return`${t.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`},I=e=>{const t=new Date(e),s=t.getMonth()+1,o=t.getDate();return`${s.toString().padStart(2,"0")}\u6708${o.toString().padStart(2,"0")}\u65e5`},M=(e,t)=>{const[s,o]=e.split(":").map(Number),a=o+t,r=s+Math.floor(a/60),n=a%60;return`${r}:${n.toString().padStart(2,"0")}`},$=()=>{const e=n.reduce((e,t)=>e+t.price,0);if(T&&T<1){const t=s.calculateDiscountPrice(e,T);return t.finalPrice}return n.reduce((e,t)=>e+(t.discountPrice||t.price),0)},W=()=>n.reduce((e,t)=>e+t.price,0),B=()=>{const e=W(),t=$();return e-t},C=()=>{if(T&&T<1){const e=Math.round(100*T);return`${e}\u6298`}return""},L=()=>{const e=$();return y>=e/100},A=e=>{"balance"!==e||L()?g(e):t.Taro.showToast({title:"\u4f59\u989d\u4e0d\u8db3\uff0c\u8bf7\u5145\u503c\u6216\u4f7f\u7528\u5176\u4ed6\u652f\u4ed8\u65b9\u5f0f",icon:"none",duration:2e3})},D=()=>e(exports,null,function*(){const e="symptom"===r.from,o=!e&&!c;if(0!==n.length&&!o&&m)if("balance"!==j||L())try{t.Taro.showLoading({title:"\u521b\u5efa\u8ba2\u5355..."});const e=n[0];console.log("\ud83d\uded2 \u8d2d\u7269\u8f66\u7b2c\u4e00\u4e2a\u9879\u76ee:",e),console.log("\ud83d\uded2 firstItem.therapistId:",e.therapistId),console.log("\ud83d\uded2 params.therapistId:",r.therapistId),console.log("\ud83d\uded2 params.from:",r.from);const o={therapistId:e.therapistId||r.therapistId||"symptom-mode",storeId:r.storeId,serviceId:e.serviceId,serviceName:e.serviceName,duration:e.duration,price:e.price,discountPrice:e.discountPrice,appointmentDate:e.date,appointmentTime:e.time,therapistName:e.therapistName,therapistAvatar:e.therapistAvatar||(null==c?void 0:c.avatar)};console.log("\ud83d\udce6 \u6700\u7ec8\u7684\u8ba2\u5355\u53c2\u6570:",o),console.log("\ud83d\udce6 therapistId\u5c06\u8981\u4f20\u9012\u7684\u503c:",o.therapistId);const i=yield s.orderService.createAppointmentOrder(o),l=i.order;console.log("\u2705 \u8ba2\u5355\u521b\u5efa\u6210\u529f:",i),console.log("\u2705 \u8ba2\u5355\u53f7:",l.orderNo),console.log("\u2705 \u652f\u4ed8\u53c2\u6570:",l.wxPayParams),t.Taro.hideLoading();const m=yield a.pay({orderNo:l.orderNo,amount:l.totalAmount?100*l.totalAmount:100*$(),paymentMethod:j,title:`${e.serviceName} - ${e.therapistName}`,wxPayParams:l.wxPayParams});m&&("balance"===j&&(yield V()),setTimeout(()=>{t.Taro.redirectTo({url:`/pages/booking/success/index?orderNo=${l.orderNo}`})},1500))}catch(i){t.Taro.hideLoading(),t.Taro.showToast({title:i.message||"\u8ba2\u5355\u521b\u5efa\u5931\u8d25",icon:"none"})}else t.Taro.showToast({title:"\u4f59\u989d\u4e0d\u8db3\uff0c\u8bf7\u5145\u503c\u6216\u4f7f\u7528\u5176\u4ed6\u652f\u4ed8\u65b9\u5f0f",icon:"none",duration:2e3});else t.Taro.showToast({title:"\u8ba2\u5355\u4fe1\u606f\u4e0d\u5b8c\u6574",icon:"none"})});return d?t.jsxRuntimeExports.jsx(t.View,{className:"order-confirm-page",children:t.jsxRuntimeExports.jsx(t.View,{className:"loading",children:"\u52a0\u8f7d\u4e2d..."})}):t.jsxRuntimeExports.jsxs(t.ScrollView,{className:"order-confirm-page",scrollY:!0,children:[t.jsxRuntimeExports.jsxs(t.View,{className:"store-section",children:[t.jsxRuntimeExports.jsx(t.Text,{className:"store-name",children:null==m?void 0:m.name}),t.jsxRuntimeExports.jsxs(t.Text,{className:"store-distance",children:["\ud83d\udccd ",null==m?void 0:m.distance,"km"]})]}),t.jsxRuntimeExports.jsx(t.View,{className:"booking-info",children:n.map((e,s)=>t.jsxRuntimeExports.jsxs(t.View,{className:"booking-item",children:[t.jsxRuntimeExports.jsx(t.Image,{className:"therapist-avatar",src:e.therapistAvatar||(null==c?void 0:c.avatar)}),t.jsxRuntimeExports.jsxs(t.View,{className:"booking-details",children:[t.jsxRuntimeExports.jsx(t.View,{className:"therapist-name",children:e.therapistName}),t.jsxRuntimeExports.jsxs(t.View,{className:"service-time",children:[I(e.date)," ",e.time," \u81f3 ",M(e.time,e.duration)]}),t.jsxRuntimeExports.jsx(t.View,{className:"service-name",children:e.serviceName})]}),t.jsxRuntimeExports.jsxs(t.View,{className:"service-price",children:["\xa5",e.discountPrice||e.price]})]},s))}),t.jsxRuntimeExports.jsxs(t.View,{className:"refund-policy",children:[t.jsxRuntimeExports.jsx(t.Text,{className:"policy-title",children:"\u9000\u5355\u8bf4\u660e"}),t.jsxRuntimeExports.jsxs(t.View,{className:"policy-list",children:[t.jsxRuntimeExports.jsx(t.View,{className:"policy-item",children:"\u2022 \u4e0b\u535515\u5206\u949f\u5185\u6216\u8ddd\u8ba2\u5355\u5f00\u59cb\u65f6\u95f4>6\u5c0f\u65f6\u9000\u5355\uff0c\u9000100%"}),t.jsxRuntimeExports.jsx(t.View,{className:"policy-item",children:"\u2022 \u8ddd\u8ba2\u5355\u5f00\u59cb\u524d<6\u5c0f\u65f6\u9000\u5355\uff0c\u9000\u5b9e\u4ed8\u91d1\u989d90%"}),t.jsxRuntimeExports.jsx(t.View,{className:"policy-item",children:"\u2022 \u8ba2\u5355\u65f6\u95f4\u5f00\u59cb\u540e\u9000\u5355\uff0c\u9000\u5b9e\u4ed8\u91d1\u989d80%"})]})]}),t.jsxRuntimeExports.jsxs(t.View,{className:"customer-note",children:[t.jsxRuntimeExports.jsx(t.Text,{className:"note-title",children:"\u5ba2\u6237\u5907\u6ce8"}),t.jsxRuntimeExports.jsx(t.Text,{className:"note-hint",children:"\u60a8\u5bf9\u8336\u6c34\u3001\u623f\u95f4\u3001\u6309\u6469\u670d\u7b49\u662f\u5426\u6709\u7279\u6b8a\u9700\u6c42\uff0c\u6211\u4eec\u5c06\u63d0\u524d\u4e3a\u60a8\u505a\u597d\u51c6\u5907"})]}),t.jsxRuntimeExports.jsxs(t.View,{className:"payment-section",children:[t.jsxRuntimeExports.jsx(t.Text,{className:"section-title",children:"\u652f\u4ed8\u65b9\u5f0f"}),t.jsxRuntimeExports.jsxs(t.View,{className:"payment-methods",children:[t.jsxRuntimeExports.jsxs(t.View,{className:`payment-method ${"balance"===j?"active":""} ${L()?"":"disabled"}`,onClick:()=>A("balance"),children:[t.jsxRuntimeExports.jsxs(t.View,{className:"method-info",children:[t.jsxRuntimeExports.jsx(t.Text,{className:"method-icon",children:"\ud83d\udcb0"}),t.jsxRuntimeExports.jsx(t.Text,{className:"method-name",children:"\u4f59\u989d\u652f\u4ed8"}),t.jsxRuntimeExports.jsxs(t.Text,{className:"balance-amount",children:[N?"\u52a0\u8f7d\u4e2d...":`\xa5${y.toFixed(2)}`,!L()&&!N&&t.jsxRuntimeExports.jsx(t.Text,{className:"insufficient",children:" (\u4f59\u989d\u4e0d\u8db3)"})]})]}),t.jsxRuntimeExports.jsx(t.View,{className:"check-icon "+("balance"===j?"checked":"")})]}),t.jsxRuntimeExports.jsxs(t.View,{className:"payment-method "+("wechat"===j?"active":""),onClick:()=>A("wechat"),children:[t.jsxRuntimeExports.jsxs(t.View,{className:"method-info",children:[t.jsxRuntimeExports.jsx(t.Text,{className:"method-icon",children:"\ud83d\udc9a"}),t.jsxRuntimeExports.jsx(t.Text,{className:"method-name",children:"\u5fae\u4fe1\u652f\u4ed8"})]}),t.jsxRuntimeExports.jsx(t.View,{className:"check-icon "+("wechat"===j?"checked":"")})]})]})]}),t.jsxRuntimeExports.jsxs(t.View,{className:"payment-bar",children:[t.jsxRuntimeExports.jsxs(t.View,{className:"price-info",children:[T&&T<1&&B()>0?t.jsxRuntimeExports.jsxs(t.View,{className:"price-with-discount",children:[t.jsxRuntimeExports.jsxs(t.View,{className:"discount-info",children:[t.jsxRuntimeExports.jsx(t.Text,{className:"discount-tag",children:C()}),t.jsxRuntimeExports.jsxs(t.Text,{className:"saved-amount",children:["\u5df2\u4f18\u60e0 \xa5",B()]})]}),t.jsxRuntimeExports.jsxs(t.View,{className:"price-display",children:[t.jsxRuntimeExports.jsxs(t.Text,{className:"original-price",children:["\xa5",W()]}),t.jsxRuntimeExports.jsxs(t.Text,{className:"total-price",children:["\xa5",$()]})]})]}):t.jsxRuntimeExports.jsxs(t.Text,{className:"total-price",children:["\xa5",$()]}),t.jsxRuntimeExports.jsxs(t.Text,{className:"countdown",children:["\u652f\u4ed8\u5012\u8ba1\u65f6: ",k(h)]})]}),t.jsxRuntimeExports.jsx(t.View,{className:"pay-button",onClick:D,children:"\u53bb\u652f\u4ed8"})]})]})};var i={navigationBarTitleText:"\u8ba2\u5355\u786e\u8ba4"};Page(t.createPageConfig(n,"pages/booking/confirm/index",{root:{cn:[]}},i||{}));
