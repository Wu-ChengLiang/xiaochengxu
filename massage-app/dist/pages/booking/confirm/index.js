"use strict";var e=(e,t,s)=>new Promise((a,r)=>{var i=e=>{try{n(s.next(e))}catch(t){r(t)}},o=e=>{try{n(s.throw(e))}catch(t){r(t)}},n=e=>e.done?a(e.value):Promise.resolve(e.value).then(i,o);n((s=s.apply(e,t)).next())});const t=require("../../../taro.js"),s=require("../../../common.js"),a="",r=()=>{const a=t.taroExports.useRouter(),r=a.params,[i,o]=t.reactExports.useState([]),[n,c]=t.reactExports.useState(null),[l,x]=t.reactExports.useState(null),[m,p]=t.reactExports.useState(!0),[d,u]=t.reactExports.useState(180),[h,j]=t.reactExports.useState("wechat"),[E,N]=t.reactExports.useState(0),[w,g]=t.reactExports.useState(!1),[R,y]=t.reactExports.useState(null),[T,v]=t.reactExports.useState(!1),f=t.reactExports.useRef(null);t.reactExports.useEffect(()=>{try{const e=JSON.parse(decodeURIComponent(r.items||"[]"));o(e),P(),V(),S()}catch(e){t.Taro.showToast({title:"\u6570\u636e\u89e3\u6790\u5931\u8d25",icon:"none"}),setTimeout(()=>t.Taro.navigateBack(),1500)}},[r]),t.reactExports.useEffect(()=>(!m&&i.length>0&&(f.current=setInterval(()=>{u(e=>e<=1?(clearInterval(f.current),t.Taro.showModal({title:"\u652f\u4ed8\u8d85\u65f6\u4e86\u5466",content:"\u5feb\u5feb\u91cd\u65b0\u4e0b\u5355\u5427~",showCancel:!1,success:()=>{t.Taro.navigateBack()}}),0):e-1)},1e3)),()=>{f.current&&clearInterval(f.current)}),[m,i]);const S=()=>e(exports,null,function*(){try{const e=s.getCurrentUserInfo();if(e&&e.discountRate){y(e.discountRate);const t=yield s.voucherService.getMyVouchers();v(t.length>0)}}catch(e){console.error("\u83b7\u53d6\u7528\u6237\u6298\u6263\u4fe1\u606f\u5931\u8d25:",e)}}),V=()=>e(exports,null,function*(){try{g(!0);const e=yield s.walletService.getBalance();N(e);const t=$();e>=t/100&&j("balance")}catch(e){console.error("\u83b7\u53d6\u4f59\u989d\u5931\u8d25:",e),N(0)}finally{g(!1)}}),P=()=>e(exports,null,function*(){try{if(p(!0),r.therapistId){const e=yield s.therapistService.getTherapistDetail(r.therapistId);c(e.data)}const e=yield s.storeService.getStoreDetail(r.storeId),t=e.data;x(t),p(!1)}catch(e){p(!1),t.Taro.showToast({title:"\u83b7\u53d6\u4fe1\u606f\u5931\u8d25",icon:"none"})}}),I=e=>{const t=Math.floor(e/60),s=e%60;return`${t.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`},b=e=>{const t=new Date(e),s=t.getMonth()+1,a=t.getDate();return`${s.toString().padStart(2,"0")}\u6708${a.toString().padStart(2,"0")}\u65e5`},k=(e,t)=>{const[s,a]=e.split(":").map(Number),r=a+t,i=s+Math.floor(r/60),o=r%60;return`${i}:${o.toString().padStart(2,"0")}`},$=()=>{const e=i.reduce((e,t)=>e+t.price,0);if(R&&R<1){const t=s.calculateDiscountPrice(e,R);return t.finalPrice}return i.reduce((e,t)=>e+(t.discountPrice||t.price),0)},M=()=>i.reduce((e,t)=>e+t.price,0),C=()=>{const e=M(),t=$();return e-t},A=()=>{if(R&&R<1){const e=Math.round(100*R);return`${e}\u6298`}return""},D=()=>{const e=$();return E>=e/100},B=e=>{"balance"!==e||D()?j(e):t.Taro.showToast({title:"\u4f59\u989d\u4e0d\u8db3\uff0c\u8bf7\u5145\u503c\u6216\u4f7f\u7528\u5176\u4ed6\u652f\u4ed8\u65b9\u5f0f",icon:"none",duration:2e3})},L=()=>e(exports,null,function*(){const e="symptom"===r.from,a=!e&&!n;if(0!==i.length&&!a&&l)if("balance"!==h||D())try{t.Taro.showLoading({title:"\u521b\u5efa\u8ba2\u5355..."});const e=i[0];console.log("\ud83d\uded2 \u8d2d\u7269\u8f66\u7b2c\u4e00\u4e2a\u9879\u76ee:",e),console.log("\ud83d\uded2 firstItem.therapistId:",e.therapistId),console.log("\ud83d\uded2 params.therapistId:",r.therapistId),console.log("\ud83d\uded2 params.from:",r.from);const a={therapistId:e.therapistId||r.therapistId||"symptom-mode",storeId:r.storeId,serviceId:e.serviceId,serviceName:e.serviceName,duration:e.duration,price:e.price,discountPrice:e.discountPrice,appointmentDate:e.date,appointmentTime:e.time,therapistName:e.therapistName,therapistAvatar:e.therapistAvatar||(null==n?void 0:n.avatar)};console.log("\ud83d\udce6 \u6700\u7ec8\u7684\u8ba2\u5355\u53c2\u6570:",a),console.log("\ud83d\udce6 therapistId\u5c06\u8981\u4f20\u9012\u7684\u503c:",a.therapistId);const o=yield s.orderService.createAppointmentOrder(a),c=o.order;if(console.log("\u2705 \u8ba2\u5355\u521b\u5efa\u6210\u529f:",o),console.log("\u2705 \u8ba2\u5355\u53f7:",c.orderNo),console.log("\u2705 \u652f\u4ed8\u53c2\u6570:",c.wxPayParams),t.Taro.hideLoading(),!c||!c.orderNo)throw new Error("\u8ba2\u5355\u521b\u5efa\u5931\u8d25\uff0c\u672a\u8fd4\u56de\u8ba2\u5355\u53f7");if("wechat"===h){if(!c.wxPayParams)throw new Error("\u5fae\u4fe1\u652f\u4ed8\u53c2\u6570\u7f3a\u5931\uff0c\u8bf7\u68c0\u67e5\u7528\u6237\u767b\u5f55\u72b6\u6001\u6216\u5c1d\u8bd5\u4f59\u989d\u652f\u4ed8");console.log("\u2705 \u5fae\u4fe1\u652f\u4ed8\u53c2\u6570\u5b8c\u6574\u6027\u68c0\u67e5:",{timeStamp:!!c.wxPayParams.timeStamp,nonceStr:!!c.wxPayParams.nonceStr,package:!!c.wxPayParams.package,signType:!!c.wxPayParams.signType,paySign:!!c.wxPayParams.paySign})}const l=yield s.paymentService.pay({orderNo:c.orderNo,amount:c.totalAmount?100*c.totalAmount:100*$(),paymentMethod:h,title:`${e.serviceName} - ${e.therapistName}`,wxPayParams:c.wxPayParams});l&&("balance"===h&&(yield V()),setTimeout(()=>{t.Taro.redirectTo({url:`/pages/booking/success/index?orderNo=${c.orderNo}`})},1500))}catch(o){console.error("\u274c \u652f\u4ed8\u6d41\u7a0b\u9519\u8bef:",o),t.Taro.hideLoading();const e=o.message||o.errMsg||"\u8ba2\u5355\u521b\u5efa\u5931\u8d25";t.Taro.showModal({title:"\u652f\u4ed8\u5931\u8d25",content:e,showCancel:!1,confirmText:"\u77e5\u9053\u4e86"})}else t.Taro.showToast({title:"\u4f59\u989d\u4e0d\u8db3\uff0c\u8bf7\u5145\u503c\u6216\u4f7f\u7528\u5176\u4ed6\u652f\u4ed8\u65b9\u5f0f",icon:"none",duration:2e3});else t.Taro.showToast({title:"\u8ba2\u5355\u4fe1\u606f\u4e0d\u5b8c\u6574",icon:"none"})});return m?t.jsxRuntimeExports.jsx(t.View,{className:"order-confirm-page",children:t.jsxRuntimeExports.jsx(t.View,{className:"loading",children:"\u52a0\u8f7d\u4e2d..."})}):t.jsxRuntimeExports.jsxs(t.ScrollView,{className:"order-confirm-page",scrollY:!0,children:[t.jsxRuntimeExports.jsxs(t.View,{className:"store-section",children:[t.jsxRuntimeExports.jsx(t.Text,{className:"store-name",children:null==l?void 0:l.name}),t.jsxRuntimeExports.jsxs(t.Text,{className:"store-distance",children:["\ud83d\udccd ",null==l?void 0:l.distance,"km"]})]}),t.jsxRuntimeExports.jsx(t.View,{className:"booking-info",children:i.map((e,s)=>t.jsxRuntimeExports.jsxs(t.View,{className:"booking-item",children:[t.jsxRuntimeExports.jsx(t.Image,{className:"therapist-avatar",src:e.therapistAvatar||(null==n?void 0:n.avatar)}),t.jsxRuntimeExports.jsxs(t.View,{className:"booking-details",children:[t.jsxRuntimeExports.jsx(t.View,{className:"therapist-name",children:e.therapistName}),t.jsxRuntimeExports.jsxs(t.View,{className:"service-time",children:[b(e.date)," ",e.time," \u81f3 ",k(e.time,e.duration)]}),t.jsxRuntimeExports.jsx(t.View,{className:"service-name",children:e.serviceName})]}),t.jsxRuntimeExports.jsxs(t.View,{className:"service-price",children:["\xa5",e.discountPrice||e.price]})]},s))}),t.jsxRuntimeExports.jsxs(t.View,{className:"refund-policy",children:[t.jsxRuntimeExports.jsx(t.Text,{className:"policy-title",children:"\u9000\u5355\u8bf4\u660e"}),t.jsxRuntimeExports.jsxs(t.View,{className:"policy-list",children:[t.jsxRuntimeExports.jsx(t.View,{className:"policy-item",children:"\u2022 \u4e0b\u535515\u5206\u949f\u5185\u6216\u8ddd\u8ba2\u5355\u5f00\u59cb\u65f6\u95f4>6\u5c0f\u65f6\u9000\u5355\uff0c\u9000100%"}),t.jsxRuntimeExports.jsx(t.View,{className:"policy-item",children:"\u2022 \u8ddd\u8ba2\u5355\u5f00\u59cb\u524d<6\u5c0f\u65f6\u9000\u5355\uff0c\u9000\u5b9e\u4ed8\u91d1\u989d90%"}),t.jsxRuntimeExports.jsx(t.View,{className:"policy-item",children:"\u2022 \u8ba2\u5355\u65f6\u95f4\u5f00\u59cb\u540e\u9000\u5355\uff0c\u9000\u5b9e\u4ed8\u91d1\u989d80%"})]})]}),t.jsxRuntimeExports.jsxs(t.View,{className:"customer-note",children:[t.jsxRuntimeExports.jsx(t.Text,{className:"note-title",children:"\u5ba2\u6237\u5907\u6ce8"}),t.jsxRuntimeExports.jsx(t.Text,{className:"note-hint",children:"\u60a8\u5bf9\u8336\u6c34\u3001\u623f\u95f4\u3001\u6309\u6469\u670d\u7b49\u662f\u5426\u6709\u7279\u6b8a\u9700\u6c42\uff0c\u6211\u4eec\u5c06\u63d0\u524d\u4e3a\u60a8\u505a\u597d\u51c6\u5907"})]}),t.jsxRuntimeExports.jsxs(t.View,{className:"payment-section",children:[t.jsxRuntimeExports.jsx(t.Text,{className:"section-title",children:"\u652f\u4ed8\u65b9\u5f0f"}),t.jsxRuntimeExports.jsxs(t.View,{className:"payment-methods",children:[t.jsxRuntimeExports.jsxs(t.View,{className:`payment-method ${"balance"===h?"active":""} ${D()?"":"disabled"}`,onClick:()=>B("balance"),children:[t.jsxRuntimeExports.jsxs(t.View,{className:"method-info",children:[t.jsxRuntimeExports.jsx(t.Text,{className:"method-icon",children:"\ud83d\udcb0"}),t.jsxRuntimeExports.jsx(t.Text,{className:"method-name",children:"\u4f59\u989d\u652f\u4ed8"}),t.jsxRuntimeExports.jsxs(t.Text,{className:"balance-amount",children:[w?"\u52a0\u8f7d\u4e2d...":`\xa5${E.toFixed(2)}`,!D()&&!w&&t.jsxRuntimeExports.jsx(t.Text,{className:"insufficient",children:" (\u4f59\u989d\u4e0d\u8db3)"})]})]}),t.jsxRuntimeExports.jsx(t.View,{className:"check-icon "+("balance"===h?"checked":"")})]}),t.jsxRuntimeExports.jsxs(t.View,{className:"payment-method "+("wechat"===h?"active":""),onClick:()=>B("wechat"),children:[t.jsxRuntimeExports.jsxs(t.View,{className:"method-info",children:[t.jsxRuntimeExports.jsx(t.Text,{className:"method-icon",children:"\ud83d\udc9a"}),t.jsxRuntimeExports.jsx(t.Text,{className:"method-name",children:"\u5fae\u4fe1\u652f\u4ed8"})]}),t.jsxRuntimeExports.jsx(t.View,{className:"check-icon "+("wechat"===h?"checked":"")})]})]})]}),t.jsxRuntimeExports.jsxs(t.View,{className:"payment-bar",children:[t.jsxRuntimeExports.jsxs(t.View,{className:"price-info",children:[R&&R<1&&C()>0?t.jsxRuntimeExports.jsxs(t.View,{className:"price-with-discount",children:[t.jsxRuntimeExports.jsxs(t.View,{className:"discount-info",children:[t.jsxRuntimeExports.jsx(t.Text,{className:"discount-tag",children:A()}),t.jsxRuntimeExports.jsxs(t.Text,{className:"saved-amount",children:["\u5df2\u4f18\u60e0 \xa5",C()]})]}),t.jsxRuntimeExports.jsxs(t.View,{className:"price-display",children:[t.jsxRuntimeExports.jsxs(t.Text,{className:"original-price",children:["\xa5",M()]}),t.jsxRuntimeExports.jsxs(t.Text,{className:"total-price",children:["\xa5",$()]})]})]}):t.jsxRuntimeExports.jsxs(t.Text,{className:"total-price",children:["\xa5",$()]}),t.jsxRuntimeExports.jsxs(t.Text,{className:"countdown",children:["\u652f\u4ed8\u5012\u8ba1\u65f6: ",I(d)]})]}),t.jsxRuntimeExports.jsx(t.View,{className:"pay-button",onClick:L,children:"\u53bb\u652f\u4ed8"})]})]})};var i={navigationBarTitleText:"\u8ba2\u5355\u786e\u8ba4"};Page(t.createPageConfig(r,"pages/booking/confirm/index",{root:{cn:[]}},i||{}));
