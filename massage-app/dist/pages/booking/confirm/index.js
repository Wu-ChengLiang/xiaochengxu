"use strict";var e=Object.defineProperty,t=Object.defineProperties,s=Object.getOwnPropertyDescriptors,a=Object.getOwnPropertySymbols,r=Object.prototype.hasOwnProperty,o=Object.prototype.propertyIsEnumerable,n=(t,s,a)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[s]=a,i=(e,t)=>{for(var s in t||(t={}))r.call(t,s)&&n(e,s,t[s]);if(a)for(var s of a(t))o.call(t,s)&&n(e,s,t[s]);return e},c=(e,a)=>t(e,s(a)),l=(e,t,s)=>new Promise((a,r)=>{var o=e=>{try{i(s.next(e))}catch(t){r(t)}},n=e=>{try{i(s.throw(e))}catch(t){r(t)}},i=e=>e.done?a(e.value):Promise.resolve(e.value).then(o,n);i((s=s.apply(e,t)).next())});const m=require("../../../taro.js"),d=require("../../../common.js");class u{constructor(){this.config={useMockPayment:!0,enableBalancePayment:!0,enableWechatPayment:!1}}pay(e){return l(this,null,function*(){const{paymentMethod:t}=e;if(this.config.useMockPayment&&"wechat"===t)return this.mockWechatPayment(e);if("balance"===t)return this.payWithBalance(e);if("wechat"===t&&this.config.enableWechatPayment)return this.payWithWechat(e);throw new Error("\u4e0d\u652f\u6301\u7684\u652f\u4ed8\u65b9\u5f0f")})}mockWechatPayment(e){return l(this,null,function*(){try{const{confirm:t}=yield m.Taro.showModal({title:"\u6a21\u62df\u652f\u4ed8",content:`\u8ba2\u5355\u91d1\u989d\uff1a\xa5${(e.amount/100).toFixed(2)}\n${e.title||""}`,confirmText:"\u786e\u8ba4\u652f\u4ed8",cancelText:"\u53d6\u6d88\u652f\u4ed8",confirmColor:"#07c160"});return t?(m.Taro.showLoading({title:"\u652f\u4ed8\u4e2d..."}),yield this.delay(1500),yield d.post("/orders/mock-pay",{orderNo:e.orderNo,paymentStatus:"paid"}),m.Taro.hideLoading(),m.Taro.showToast({title:"\u652f\u4ed8\u6210\u529f",icon:"success"}),!0):(console.log("\u7528\u6237\u53d6\u6d88\u6a21\u62df\u652f\u4ed8"),!1)}catch(t){throw m.Taro.hideLoading(),m.Taro.showToast({title:"\u652f\u4ed8\u5931\u8d25",icon:"none"}),t}})}payWithBalance(e){return l(this,null,function*(){try{m.Taro.showLoading({title:"\u652f\u4ed8\u4e2d..."});const t=yield d.post("/orders/pay",{orderNo:e.orderNo,paymentMethod:"balance"});if(m.Taro.hideLoading(),0===t.code)return m.Taro.showToast({title:`\u652f\u4ed8\u6210\u529f\n\u4f59\u989d\uff1a\xa5${(t.data.balance/100).toFixed(2)}`,icon:"success",duration:2e3}),!0;throw new Error(t.message||"\u4f59\u989d\u4e0d\u8db3")}catch(t){return m.Taro.hideLoading(),m.Taro.showToast({title:t.message||"\u652f\u4ed8\u5931\u8d25",icon:"none"}),!1}})}payWithWechat(e){return l(this,null,function*(){try{const{data:t}=yield d.post("/orders/wechat-pay-params",{orderNo:e.orderNo}),{wxPayParams:s}=t;return yield m.Taro.requestPayment({timeStamp:s.timeStamp,nonceStr:s.nonceStr,package:s.package,signType:s.signType,paySign:s.paySign}),m.Taro.showToast({title:"\u652f\u4ed8\u6210\u529f",icon:"success"}),!0}catch(t){if("requestPayment:fail cancel"===t.errMsg)return console.log("\u7528\u6237\u53d6\u6d88\u652f\u4ed8"),!1;throw m.Taro.showToast({title:"\u652f\u4ed8\u5931\u8d25",icon:"none"}),t}})}checkPaymentEnvironment(){return l(this,null,function*(){m.Taro.getAccountInfoSync();const e=!this.config.enableWechatPayment;return{canUseWechatPay:!e&&this.config.enableWechatPayment,canUseBalance:this.config.enableBalancePayment,canUseMockPay:this.config.useMockPayment,message:e?"\u5f53\u524d\u4e3a\u4e2a\u4eba\u5c0f\u7a0b\u5e8f\uff0c\u4f7f\u7528\u6a21\u62df\u652f\u4ed8\u548c\u4f59\u989d\u652f\u4ed8":"\u4f01\u4e1a\u5c0f\u7a0b\u5e8f\uff0c\u652f\u6301\u5b8c\u6574\u652f\u4ed8\u529f\u80fd"}})}generateRechargeCode(e){return l(this,null,function*(){const t=yield d.post("/recharge/generate-code",{amount:e});return t.data})}delay(e){return new Promise(t=>setTimeout(t,e))}}const x=new u,p="",h=()=>{const e=m.taroExports.useRouter(),t=e.params,[s,a]=m.reactExports.useState([]),[r,o]=m.reactExports.useState(null),[n,u]=m.reactExports.useState(null),[p,h]=m.reactExports.useState(!0),[j,y]=m.reactExports.useState(180),[T,w]=m.reactExports.useState("wechat"),[g,N]=m.reactExports.useState(0),[E,f]=m.reactExports.useState(!1),R=m.reactExports.useRef(null);m.reactExports.useEffect(()=>{try{const e=JSON.parse(decodeURIComponent(t.items||"[]"));a(e),b(),v()}catch(e){m.Taro.showToast({title:"\u6570\u636e\u89e3\u6790\u5931\u8d25",icon:"none"}),setTimeout(()=>m.Taro.navigateBack(),1500)}},[t]),m.reactExports.useEffect(()=>(!p&&s.length>0&&(R.current=setInterval(()=>{y(e=>e<=1?(clearInterval(R.current),m.Taro.showModal({title:"\u652f\u4ed8\u8d85\u65f6\u4e86\u5466",content:"\u5feb\u5feb\u91cd\u65b0\u4e0b\u5355\u5427~",showCancel:!1,success:()=>{m.Taro.navigateBack()}}),0):e-1)},1e3)),()=>{R.current&&clearInterval(R.current)}),[p,s]);const v=()=>l(exports,null,function*(){try{f(!0);const e=yield d.walletService.getBalance();N(e);const t=k();e>=t/100&&w("balance")}catch(e){console.error("\u83b7\u53d6\u4f59\u989d\u5931\u8d25:",e),N(0)}finally{f(!1)}}),b=()=>l(exports,null,function*(){try{if(h(!0),t.therapistId){const e=yield d.therapistService.getTherapistDetail(t.therapistId);o(e.data)}const e=yield d.storeService.getStoreDetail(t.storeId),s=e.data;u(s),h(!1)}catch(e){h(!1),m.Taro.showToast({title:"\u83b7\u53d6\u4fe1\u606f\u5931\u8d25",icon:"none"})}}),S=e=>{const t=Math.floor(e/60),s=e%60;return`${t.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`},P=e=>{const t=new Date(e),s=t.getMonth()+1,a=t.getDate();return`${s.toString().padStart(2,"0")}\u6708${a.toString().padStart(2,"0")}\u65e5`},V=(e,t)=>{const[s,a]=e.split(":").map(Number),r=a+t,o=s+Math.floor(r/60),n=r%60;return`${o}:${n.toString().padStart(2,"0")}`},k=()=>s.reduce((e,t)=>e+(t.discountPrice||t.price),0),I=()=>{const e=k();return g>=e/100},M=e=>{"balance"!==e||I()?w(e):m.Taro.showToast({title:"\u4f59\u989d\u4e0d\u8db3\uff0c\u8bf7\u5145\u503c\u6216\u4f7f\u7528\u5176\u4ed6\u652f\u4ed8\u65b9\u5f0f",icon:"none",duration:2e3})},$=()=>l(exports,null,function*(){const e="symptom"===t.from,a=!e&&!r;if(0!==s.length&&!a&&n)if("balance"!==T||I())try{m.Taro.showLoading({title:"\u521b\u5efa\u8ba2\u5355..."});const e=s[0],a={therapistId:t.therapistId||"symptom-mode",storeId:t.storeId,serviceId:e.serviceId,serviceName:e.serviceName,duration:e.duration,price:e.price,discountPrice:e.discountPrice,appointmentDate:e.date,appointmentTime:e.time,therapistName:e.therapistName,therapistAvatar:e.therapistAvatar||(null==r?void 0:r.avatar)},o=yield d.orderService.createAppointmentOrder(a),n=o.order;m.Taro.hideLoading();const u=yield x.pay({orderNo:n.orderNo,amount:n.totalAmount?100*n.totalAmount:100*k(),paymentMethod:T,title:`${e.serviceName} - ${e.therapistName}`});u?("balance"===T&&(yield v()),setTimeout(()=>{m.Taro.redirectTo({url:`/pages/booking/success/index?orderNo=${n.orderNo}`})},1500)):m.Taro.requestPayment(c(i({},paymentParams),{success:()=>l(exports,null,function*(){yield d.orderService.updateOrderStatus(n.orderNo,"paid"),m.Taro.showToast({title:"\u652f\u4ed8\u6210\u529f",icon:"success",duration:1500}),setTimeout(()=>{m.Taro.redirectTo({url:`/pages/booking/success/index?orderNo=${n.orderNo}`})},1500)}),fail:e=>{console.error("\u652f\u4ed8\u5931\u8d25:",e),"requestPayment:fail cancel"!==e.errMsg&&(e.errMsg&&e.errMsg.includes("total_fee")?m.Taro.showToast({title:"\u652f\u4ed8\u53c2\u6570\u9519\u8bef\uff1a\u7f3a\u5c11\u91d1\u989d\u4fe1\u606f",icon:"none",duration:2500}):m.Taro.showToast({title:"\u652f\u4ed8\u5931\u8d25",icon:"none"}))}}))}catch(o){m.Taro.hideLoading(),m.Taro.showToast({title:o.message||"\u8ba2\u5355\u521b\u5efa\u5931\u8d25",icon:"none"})}else m.Taro.showToast({title:"\u4f59\u989d\u4e0d\u8db3\uff0c\u8bf7\u5145\u503c\u6216\u4f7f\u7528\u5176\u4ed6\u652f\u4ed8\u65b9\u5f0f",icon:"none",duration:2e3});else m.Taro.showToast({title:"\u8ba2\u5355\u4fe1\u606f\u4e0d\u5b8c\u6574",icon:"none"})});return p?m.jsxRuntimeExports.jsx(m.View,{className:"order-confirm-page",children:m.jsxRuntimeExports.jsx(m.View,{className:"loading",children:"\u52a0\u8f7d\u4e2d..."})}):m.jsxRuntimeExports.jsxs(m.ScrollView,{className:"order-confirm-page",scrollY:!0,children:[m.jsxRuntimeExports.jsxs(m.View,{className:"store-section",children:[m.jsxRuntimeExports.jsx(m.Text,{className:"store-name",children:null==n?void 0:n.name}),m.jsxRuntimeExports.jsxs(m.Text,{className:"store-distance",children:["\ud83d\udccd ",null==n?void 0:n.distance,"km"]})]}),m.jsxRuntimeExports.jsx(m.View,{className:"booking-info",children:s.map((e,t)=>m.jsxRuntimeExports.jsxs(m.View,{className:"booking-item",children:[m.jsxRuntimeExports.jsx(m.Image,{className:"therapist-avatar",src:e.therapistAvatar||(null==r?void 0:r.avatar)}),m.jsxRuntimeExports.jsxs(m.View,{className:"booking-details",children:[m.jsxRuntimeExports.jsx(m.View,{className:"therapist-name",children:e.therapistName}),m.jsxRuntimeExports.jsxs(m.View,{className:"service-time",children:[P(e.date)," ",e.time," \u81f3 ",V(e.time,e.duration)]}),m.jsxRuntimeExports.jsx(m.View,{className:"service-name",children:e.serviceName})]}),m.jsxRuntimeExports.jsxs(m.View,{className:"service-price",children:["\xa5",e.discountPrice||e.price]})]},t))}),m.jsxRuntimeExports.jsxs(m.View,{className:"refund-policy",children:[m.jsxRuntimeExports.jsx(m.Text,{className:"policy-title",children:"\u9000\u5355\u8bf4\u660e"}),m.jsxRuntimeExports.jsxs(m.View,{className:"policy-list",children:[m.jsxRuntimeExports.jsx(m.View,{className:"policy-item",children:"\u2022 \u4e0b\u535515\u5206\u949f\u5185\u6216\u8ddd\u8ba2\u5355\u5f00\u59cb\u65f6\u95f4>6\u5c0f\u65f6\u9000\u5355\uff0c\u9000100%"}),m.jsxRuntimeExports.jsx(m.View,{className:"policy-item",children:"\u2022 \u8ddd\u8ba2\u5355\u5f00\u59cb\u524d<6\u5c0f\u65f6\u9000\u5355\uff0c\u9000\u5b9e\u4ed8\u91d1\u989d90%"}),m.jsxRuntimeExports.jsx(m.View,{className:"policy-item",children:"\u2022 \u8ba2\u5355\u65f6\u95f4\u5f00\u59cb\u540e\u9000\u5355\uff0c\u9000\u5b9e\u4ed8\u91d1\u989d80%"})]})]}),m.jsxRuntimeExports.jsxs(m.View,{className:"customer-note",children:[m.jsxRuntimeExports.jsx(m.Text,{className:"note-title",children:"\u5ba2\u6237\u5907\u6ce8"}),m.jsxRuntimeExports.jsx(m.Text,{className:"note-hint",children:"\u60a8\u5bf9\u8336\u6c34\u3001\u623f\u95f4\u3001\u6309\u6469\u670d\u7b49\u662f\u5426\u6709\u7279\u6b8a\u9700\u6c42\uff0c\u6211\u4eec\u5c06\u63d0\u524d\u4e3a\u60a8\u505a\u597d\u51c6\u5907"})]}),m.jsxRuntimeExports.jsxs(m.View,{className:"payment-section",children:[m.jsxRuntimeExports.jsx(m.Text,{className:"section-title",children:"\u652f\u4ed8\u65b9\u5f0f"}),m.jsxRuntimeExports.jsxs(m.View,{className:"payment-methods",children:[m.jsxRuntimeExports.jsxs(m.View,{className:`payment-method ${"balance"===T?"active":""} ${I()?"":"disabled"}`,onClick:()=>M("balance"),children:[m.jsxRuntimeExports.jsxs(m.View,{className:"method-info",children:[m.jsxRuntimeExports.jsx(m.Text,{className:"method-icon",children:"\ud83d\udcb0"}),m.jsxRuntimeExports.jsx(m.Text,{className:"method-name",children:"\u4f59\u989d\u652f\u4ed8"}),m.jsxRuntimeExports.jsxs(m.Text,{className:"balance-amount",children:[E?"\u52a0\u8f7d\u4e2d...":`\xa5${g.toFixed(2)}`,!I()&&!E&&m.jsxRuntimeExports.jsx(m.Text,{className:"insufficient",children:" (\u4f59\u989d\u4e0d\u8db3)"})]})]}),m.jsxRuntimeExports.jsx(m.View,{className:"check-icon "+("balance"===T?"checked":"")})]}),m.jsxRuntimeExports.jsxs(m.View,{className:"payment-method "+("wechat"===T?"active":""),onClick:()=>M("wechat"),children:[m.jsxRuntimeExports.jsxs(m.View,{className:"method-info",children:[m.jsxRuntimeExports.jsx(m.Text,{className:"method-icon",children:"\ud83d\udc9a"}),m.jsxRuntimeExports.jsx(m.Text,{className:"method-name",children:"\u5fae\u4fe1\u652f\u4ed8"})]}),m.jsxRuntimeExports.jsx(m.View,{className:"check-icon "+("wechat"===T?"checked":"")})]})]})]}),m.jsxRuntimeExports.jsxs(m.View,{className:"payment-bar",children:[m.jsxRuntimeExports.jsxs(m.View,{className:"price-info",children:[m.jsxRuntimeExports.jsxs(m.Text,{className:"total-price",children:["\xa5 ",k()]}),m.jsxRuntimeExports.jsxs(m.Text,{className:"countdown",children:["\u652f\u4ed8\u5012\u8ba1\u65f6: ",S(j)]})]}),m.jsxRuntimeExports.jsx(m.View,{className:"pay-button",onClick:$,children:"\u53bb\u652f\u4ed8"})]})]})};var j={navigationBarTitleText:"\u8ba2\u5355\u786e\u8ba4"};Page(m.createPageConfig(h,"pages/booking/confirm/index",{root:{cn:[]}},j||{}));
