"use strict";var e=Object.defineProperty,t=Object.defineProperties,s=Object.getOwnPropertyDescriptors,r=Object.getOwnPropertySymbols,o=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable,i=(t,s,r)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[s]=r,n=(e,t)=>{for(var s in t||(t={}))o.call(t,s)&&i(e,s,t[s]);if(r)for(var s of r(t))a.call(t,s)&&i(e,s,t[s]);return e},c=(e,r)=>t(e,s(r)),l=(e,t,s)=>new Promise((r,o)=>{var a=e=>{try{n(s.next(e))}catch(t){o(t)}},i=e=>{try{n(s.throw(e))}catch(t){o(t)}},n=e=>e.done?r(e.value):Promise.resolve(e.value).then(a,i);n((s=s.apply(e,t)).next())});const m=require("../../../taro.js"),x=require("../../../common.js"),p="",d=()=>{const e=m.taroExports.useRouter(),t=e.params,[s,r]=m.reactExports.useState([]),[o,a]=m.reactExports.useState(null),[i,p]=m.reactExports.useState(null),[d,u]=m.reactExports.useState(!0),[h,j]=m.reactExports.useState(180),[g,E]=m.reactExports.useState("wechat"),w=m.reactExports.useRef(null);m.reactExports.useEffect(()=>{try{console.log("\u9875\u9762\u53c2\u6570:",t),console.log("\u539f\u59cbitems\u53c2\u6570:",t.items);const e=decodeURIComponent(t.items||"[]");console.log("\u89e3\u7801\u540e\u7684items:",e);const s=JSON.parse(e);console.log("\u89e3\u6790\u540e\u7684\u8d2d\u7269\u8f66\u9879\u76ee:",s),r(s),N()}catch(e){console.error("\u6570\u636e\u89e3\u6790\u5931\u8d25:",e),m.Taro.showToast({title:`\u6570\u636e\u89e3\u6790\u5931\u8d25: ${e.message}`,icon:"none"}),setTimeout(()=>m.Taro.navigateBack(),1500)}},[t]),m.reactExports.useEffect(()=>(!d&&s.length>0&&(w.current=setInterval(()=>{j(e=>e<=1?(clearInterval(w.current),m.Taro.showModal({title:"\u652f\u4ed8\u8d85\u65f6\u4e86\u5466",content:"\u5feb\u5feb\u91cd\u65b0\u4e0b\u5355\u5427~",showCancel:!1,success:()=>{m.Taro.navigateBack()}}),0):e-1)},1e3)),()=>{w.current&&clearInterval(w.current)}),[d,s]);const N=()=>l(exports,null,function*(){try{u(!0),console.log("\u83b7\u53d6\u4fe1\u606f\u53c2\u6570:",{therapistId:t.therapistId,storeId:t.storeId});const e=yield x.therapistService.getTherapistDetail(t.therapistId),s=e.data;console.log("\u63a8\u62ff\u5e08\u4fe1\u606f:",s);const r=yield x.storeService.getStoreDetail(t.storeId),o=r.data;console.log("\u95e8\u5e97\u4fe1\u606f:",o),a(s),p(o),u(!1)}catch(e){u(!1),console.error("\u83b7\u53d6\u4fe1\u606f\u5931\u8d25:",e),m.Taro.showToast({title:`\u83b7\u53d6\u4fe1\u606f\u5931\u8d25: ${e.message||"\u672a\u77e5\u9519\u8bef"}`,icon:"none"})}}),T=e=>{const t=Math.floor(e/60),s=e%60;return`${t.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`},v=e=>{const t=new Date(e),s=t.getMonth()+1,r=t.getDate();return`${s.toString().padStart(2,"0")}\u6708${r.toString().padStart(2,"0")}\u65e5`},R=(e,t)=>{const[s,r]=e.split(":").map(Number),o=r+t,a=s+Math.floor(o/60),i=o%60;return`${a}:${i.toString().padStart(2,"0")}`},f=()=>s.reduce((e,t)=>e+(t.discountPrice||t.price),0),y=()=>l(exports,null,function*(){if(console.log("\u652f\u4ed8\u68c0\u67e5:",{cartItemsLength:s.length,hasTherapistInfo:!!o,hasStoreInfo:!!i,cartItems:s,therapistInfo:o,storeInfo:i}),0===s.length||!o||!i){const e=[];return 0===s.length&&e.push("\u8d2d\u7269\u8f66\u4e3a\u7a7a"),o||e.push("\u63a8\u62ff\u5e08\u4fe1\u606f\u7f3a\u5931"),i||e.push("\u95e8\u5e97\u4fe1\u606f\u7f3a\u5931"),void m.Taro.showToast({title:`\u8ba2\u5355\u4fe1\u606f\u4e0d\u5b8c\u6574: ${e.join(", ")}`,icon:"none",duration:3e3})}try{m.Taro.showLoading({title:"\u521b\u5efa\u8ba2\u5355..."});const e=s[0],r={therapistId:t.therapistId,storeId:t.storeId,serviceId:e.serviceId,serviceName:e.serviceName,duration:e.duration,price:e.price,discountPrice:e.discountPrice,appointmentDate:e.date,appointmentTime:e.time,therapistName:e.therapistName,therapistAvatar:e.therapistAvatar||o.avatar},a=yield x.orderService.createOrder(r);m.Taro.hideLoading(),m.Taro.showLoading({title:"\u6b63\u5728\u652f\u4ed8..."});const i=yield x.orderService.getPaymentParams(a.orderNo);m.Taro.hideLoading(),m.Taro.requestPayment(c(n({},i),{success:()=>l(exports,null,function*(){yield x.orderService.updateOrderStatus(a.orderNo,"paid"),m.Taro.showToast({title:"\u652f\u4ed8\u6210\u529f",icon:"success",duration:1500}),setTimeout(()=>{m.Taro.redirectTo({url:`/pages/booking/success/index?orderNo=${a.orderNo}`})},1500)}),fail:e=>{console.error("\u652f\u4ed8\u5931\u8d25:",e),"requestPayment:fail cancel"!==e.errMsg&&(e.errMsg&&e.errMsg.includes("total_fee")?m.Taro.showToast({title:"\u652f\u4ed8\u53c2\u6570\u9519\u8bef\uff1a\u7f3a\u5c11\u91d1\u989d\u4fe1\u606f",icon:"none",duration:2500}):m.Taro.showToast({title:"\u652f\u4ed8\u5931\u8d25",icon:"none"}))}}))}catch(e){m.Taro.hideLoading(),m.Taro.showToast({title:e.message||"\u8ba2\u5355\u521b\u5efa\u5931\u8d25",icon:"none"})}});return d?m.jsxRuntimeExports.jsx(m.View,{className:"order-confirm-page",children:m.jsxRuntimeExports.jsx(m.View,{className:"loading",children:"\u52a0\u8f7d\u4e2d..."})}):m.jsxRuntimeExports.jsxs(m.ScrollView,{className:"order-confirm-page",scrollY:!0,children:[m.jsxRuntimeExports.jsxs(m.View,{className:"store-section",children:[m.jsxRuntimeExports.jsx(m.Text,{className:"store-name",children:null==i?void 0:i.name}),m.jsxRuntimeExports.jsxs(m.Text,{className:"store-distance",children:["\ud83d\udccd ",null==i?void 0:i.distance,"km"]})]}),m.jsxRuntimeExports.jsx(m.View,{className:"booking-info",children:s.map((e,t)=>m.jsxRuntimeExports.jsxs(m.View,{className:"booking-item",children:[m.jsxRuntimeExports.jsx(m.Image,{className:"therapist-avatar",src:e.therapistAvatar||(null==o?void 0:o.avatar)}),m.jsxRuntimeExports.jsxs(m.View,{className:"booking-details",children:[m.jsxRuntimeExports.jsx(m.View,{className:"therapist-name",children:e.therapistName}),m.jsxRuntimeExports.jsxs(m.View,{className:"service-time",children:[v(e.date)," ",e.time," \u81f3 ",R(e.time,e.duration)]}),m.jsxRuntimeExports.jsx(m.View,{className:"service-name",children:e.serviceName})]}),m.jsxRuntimeExports.jsxs(m.View,{className:"service-price",children:["\xa5",e.discountPrice||e.price]})]},t))}),m.jsxRuntimeExports.jsxs(m.View,{className:"refund-policy",children:[m.jsxRuntimeExports.jsx(m.Text,{className:"policy-title",children:"\u9000\u5355\u8bf4\u660e"}),m.jsxRuntimeExports.jsxs(m.View,{className:"policy-list",children:[m.jsxRuntimeExports.jsx(m.View,{className:"policy-item",children:"\u2022 \u4e0b\u535515\u5206\u949f\u5185\u6216\u8ddd\u8ba2\u5355\u5f00\u59cb\u65f6\u95f4>6\u5c0f\u65f6\u9000\u5355\uff0c\u9000100%"}),m.jsxRuntimeExports.jsx(m.View,{className:"policy-item",children:"\u2022 \u8ddd\u8ba2\u5355\u5f00\u59cb\u524d<6\u5c0f\u65f6\u9000\u5355\uff0c\u9000\u5b9e\u4ed8\u91d1\u989d90%"}),m.jsxRuntimeExports.jsx(m.View,{className:"policy-item",children:"\u2022 \u8ba2\u5355\u65f6\u95f4\u5f00\u59cb\u540e\u9000\u5355\uff0c\u9000\u5b9e\u4ed8\u91d1\u989d80%"})]})]}),m.jsxRuntimeExports.jsxs(m.View,{className:"customer-note",children:[m.jsxRuntimeExports.jsx(m.Text,{className:"note-title",children:"\u5ba2\u6237\u5907\u6ce8"}),m.jsxRuntimeExports.jsx(m.Text,{className:"note-hint",children:"\u60a8\u5bf9\u8336\u6c34\u3001\u623f\u95f4\u3001\u6309\u6469\u670d\u7b49\u662f\u5426\u6709\u7279\u6b8a\u9700\u6c42\uff0c\u6211\u4eec\u5c06\u63d0\u524d\u4e3a\u60a8\u505a\u597d\u51c6\u5907"})]}),m.jsxRuntimeExports.jsxs(m.View,{className:"payment-section",children:[m.jsxRuntimeExports.jsx(m.Text,{className:"section-title",children:"\u652f\u4ed8\u65b9\u5f0f"}),m.jsxRuntimeExports.jsx(m.View,{className:"payment-methods",children:m.jsxRuntimeExports.jsxs(m.View,{className:"payment-method "+("wechat"===g?"active":""),onClick:()=>E("wechat"),children:[m.jsxRuntimeExports.jsxs(m.View,{className:"method-info",children:[m.jsxRuntimeExports.jsx(m.Text,{className:"method-icon",children:"\u2705"}),m.jsxRuntimeExports.jsx(m.Text,{className:"method-name",children:"\u5fae\u4fe1\u652f\u4ed8"})]}),m.jsxRuntimeExports.jsx(m.View,{className:"check-icon "+("wechat"===g?"checked":"")})]})})]}),m.jsxRuntimeExports.jsxs(m.View,{className:"payment-bar",children:[m.jsxRuntimeExports.jsxs(m.View,{className:"price-info",children:[m.jsxRuntimeExports.jsxs(m.Text,{className:"total-price",children:["\xa5 ",f()]}),m.jsxRuntimeExports.jsxs(m.Text,{className:"countdown",children:["\u652f\u4ed8\u5012\u8ba1\u65f6: ",T(h)]})]}),m.jsxRuntimeExports.jsx(m.View,{className:"pay-button",onClick:y,children:"\u53bb\u652f\u4ed8"})]})]})};var u={navigationBarTitleText:"\u8ba2\u5355\u786e\u8ba4"};Page(m.createPageConfig(d,"pages/booking/confirm/index",{root:{cn:[]}},u||{}));
