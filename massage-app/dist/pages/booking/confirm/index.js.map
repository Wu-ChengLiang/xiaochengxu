{"version":3,"file":"index.js","sources":["../../../../src/pages/booking/confirm/index.tsx"],"sourcesContent":["import React, { useState, useEffect, useRef } from 'react'\nimport { View, Text, Image, ScrollView } from '@tarojs/components'\nimport Taro, { useRouter } from '@tarojs/taro'\nimport { orderService, CreateOrderParams } from '@/services/order'\nimport { storeService } from '@/services/store'\nimport { therapistService } from '@/services/therapist'\nimport { walletService } from '@/services/wallet.service'\nimport { paymentService } from '@/services/payment.service'\nimport { voucherService } from '@/services/voucher.service'\nimport { calculateDiscountPrice } from '@/types/voucher'\nimport { getCurrentUserInfo, requireLogin } from '@/utils/user'\nimport './index.scss'\n\ninterface CartItem {\n  id?: string  // ÂîØ‰∏ÄÊ†áËØÜÁ¨¶ÔºàÂèØÈÄâÔºåÂêëÂêéÂÖºÂÆπÔºâ\n  serviceId: string\n  serviceName: string\n  duration: number\n  price: number\n  discountPrice?: number\n  date: string\n  time: string\n  therapistId?: string\n  therapistName: string\n  therapistAvatar?: string\n}\n\ninterface OrderConfirmPageParams {\n  // Ê®°Âºè1ÔºöÊñ∞È¢ÑÁ∫¶\n  therapistId?: string\n  storeId?: string\n  items?: string // JSON string of CartItem[]\n  from?: string  // Êù•Ê∫êÊ†áËØÜÔºåÂ¶Ç 'symptom'\n\n  // Ê®°Âºè2ÔºöÂ∑≤ÊúâËÆ¢Âçï\n  orderNo?: string  // ËÆ¢ÂçïÂè∑\n}\n\ninterface ExistingOrder {\n  orderNo: string\n  amount: number  // ÂàÜ‰∏∫Âçï‰Ωç\n  title: string\n  paymentMethod: 'wechat' | 'balance'\n  paymentStatus: string\n  extraData?: {\n    therapistName?: string\n    therapistAvatar?: string\n    serviceName?: string\n    appointmentDate?: string\n    startTime?: string\n    duration?: number\n    storeId?: string\n    storeName?: string\n    storeAddress?: string\n  }\n}\n\nconst OrderConfirmPage: React.FC = () => {\n  const router = useRouter()\n  const params = router.params as unknown as OrderConfirmPageParams\n\n  // ‚úÖ Âà§Êñ≠Ê®°ÂºèÔºöÊñ∞È¢ÑÁ∫¶ vs Â∑≤ÊúâËÆ¢Âçï\n  const isExistingOrderMode = !!params.orderNo\n  const isNewAppointmentMode = !isExistingOrderMode\n\n  const [cartItems, setCartItems] = useState<CartItem[]>([])\n  const [therapistInfo, setTherapistInfo] = useState<any>(null)\n  const [storeInfo, setStoreInfo] = useState<any>(null)\n  const [existingOrder, setExistingOrder] = useState<ExistingOrder | null>(null)  // ‚úÖ Êñ∞Â¢ûÔºöÂ∑≤ÊúâËÆ¢Âçï\n  const [loading, setLoading] = useState(true)\n  const [countdown, setCountdown] = useState(180) // 3ÂàÜÈíüÂÄíËÆ°Êó∂\n  const [paymentMethod, setPaymentMethod] = useState<'wechat' | 'balance'>('wechat')\n  const [userBalance, setUserBalance] = useState(0) // Áî®Êà∑‰ΩôÈ¢ù\n  const [balanceLoading, setBalanceLoading] = useState(false)\n  const [userDiscountRate, setUserDiscountRate] = useState<number | null>(null) // Áî®Êà∑ÊäòÊâ£Áéá\n  const [hasVoucher, setHasVoucher] = useState(false) // ÊòØÂê¶Êúâ‰ºòÊÉ†Âà∏\n  const timerRef = useRef<any>(null)\n\n  useEffect(() => {\n    // ‚úÖ Âú®ÊîØ‰ªòÂâçÊ£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅ\n    const initializePage = async () => {\n      try {\n        // ÂÖàÊ£ÄÊü•Áî®Êà∑ÁôªÂΩïÁä∂ÊÄÅ\n        const isLoggedIn = await requireLogin()\n        if (!isLoggedIn) {\n          return\n        }\n\n        // ‚úÖ Âå∫ÂàÜÊ®°ÂºèÂàùÂßãÂåñ\n        if (isExistingOrderMode) {\n          // Ê®°Âºè2ÔºöÂ∑≤ÊúâËÆ¢Âçï - Âä†ËΩΩËÆ¢ÂçïËØ¶ÊÉÖ\n          fetchExistingOrder()\n        } else {\n          // Ê®°Âºè1ÔºöÊñ∞È¢ÑÁ∫¶ - Ëß£ÊûêË¥≠Áâ©ËΩ¶Êï∞ÊçÆ\n          const items = JSON.parse(decodeURIComponent(params.items || '[]'))\n          setCartItems(items)\n          fetchTherapistAndStoreInfo()\n        }\n\n        // ‰∏§‰∏™Ê®°ÂºèÈÉΩÈúÄË¶ÅËé∑ÂèñÁî®Êà∑‰ΩôÈ¢ùÂíåÊäòÊâ£\n        fetchUserBalance()\n        fetchUserDiscount()\n      } catch (error) {\n        Taro.showToast({\n          title: 'Êï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•',\n          icon: 'none'\n        })\n        setTimeout(() => Taro.navigateBack(), 1500)\n      }\n    }\n\n    initializePage()\n  }, [params])\n\n  // ÂÄíËÆ°Êó∂ÈÄªËæëÔºà‰ªÖÊñ∞È¢ÑÁ∫¶Ê®°ÂºèÈúÄË¶ÅÔºâ\n  useEffect(() => {\n    // ‚úÖ Â∑≤ÊúâËÆ¢ÂçïÊ®°Âºè‰∏çÈúÄË¶ÅÂÄíËÆ°Êó∂\n    if (!loading && isNewAppointmentMode && cartItems.length > 0) {\n      timerRef.current = setInterval(() => {\n        setCountdown((prev) => {\n          if (prev <= 1) {\n            clearInterval(timerRef.current)\n            Taro.showModal({\n              title: 'ÊîØ‰ªòË∂ÖÊó∂‰∫ÜÂë¶',\n              content: 'Âø´Âø´ÈáçÊñ∞‰∏ãÂçïÂêß~',\n              showCancel: false,\n              success: () => {\n                Taro.navigateBack()\n              }\n            })\n            return 0\n          }\n          return prev - 1\n        })\n      }, 1000)\n    }\n\n    return () => {\n      if (timerRef.current) {\n        clearInterval(timerRef.current)\n      }\n    }\n  }, [loading, cartItems, isNewAppointmentMode])\n\n  // Ëé∑ÂèñÁî®Êà∑ÊäòÊâ£‰ø°ÊÅØ\n  const fetchUserDiscount = async () => {\n    try {\n      const userInfo = getCurrentUserInfo()\n      if (userInfo && userInfo.discountRate) {\n        setUserDiscountRate(userInfo.discountRate)\n        // Ê£ÄÊü•ÊòØÂê¶Êúâ‰ºòÊÉ†Âà∏\n        const vouchers = await voucherService.getMyVouchers()\n        setHasVoucher(vouchers.length > 0)\n      }\n    } catch (error) {\n      console.error('Ëé∑ÂèñÁî®Êà∑ÊäòÊâ£‰ø°ÊÅØÂ§±Ë¥•:', error)\n    }\n  }\n\n  // Ëé∑ÂèñÁî®Êà∑‰ΩôÈ¢ù\n  const fetchUserBalance = async () => {\n    try {\n      setBalanceLoading(true)\n      const balance = await walletService.getBalance()  // ËøîÂõûÂàÜ‰∏∫Âçï‰Ωç\n      setUserBalance(balance / 100)  // ‚úÖ ËΩ¨Êç¢‰∏∫ÂÖÉÂ≠òÂÇ®\n\n      // Â¶ÇÊûú‰ΩôÈ¢ùÂÖÖË∂≥ÔºåÈªòËÆ§ÈÄâÊã©‰ΩôÈ¢ùÊîØ‰ªò\n      // ‚úÖ ‰∏§‰∏™ÈÉΩÊòØÂÖÉÔºåÁõ¥Êé•ÊØîËæÉ\n      const totalPrice = getTotalPrice()  // ÂÖÉ\n      if (balance / 100 >= totalPrice) { // balance(ÂÖÉ) >= totalPrice(ÂÖÉ)\n        setPaymentMethod('balance')\n      }\n    } catch (error) {\n      console.error('Ëé∑Âèñ‰ΩôÈ¢ùÂ§±Ë¥•:', error)\n      setUserBalance(0)\n    } finally {\n      setBalanceLoading(false)\n    }\n  }\n\n  // ‚úÖ Êñ∞Â¢ûÔºöËé∑ÂèñÂ∑≤ÊúâËÆ¢ÂçïËØ¶ÊÉÖ\n  const fetchExistingOrder = async () => {\n    try {\n      setLoading(true)\n      const order = await orderService.getOrderDetail(params.orderNo!)\n      setExistingOrder(order)\n\n      // Ëé∑ÂèñÈó®Â∫ó‰ø°ÊÅØÔºàÂ¶ÇÊûúËÆ¢Âçï‰∏≠ÊúâstoreIdÔºâ\n      if (order.extraData?.storeId) {\n        try {\n          const storeRes = await storeService.getStoreDetail(order.extraData.storeId)\n          setStoreInfo(storeRes.data)\n        } catch (error) {\n          console.error('Ëé∑ÂèñÈó®Â∫ó‰ø°ÊÅØÂ§±Ë¥•:', error)\n        }\n      }\n\n      setLoading(false)\n    } catch (error) {\n      setLoading(false)\n      Taro.showToast({\n        title: 'Ëé∑ÂèñËÆ¢Âçï‰ø°ÊÅØÂ§±Ë¥•',\n        icon: 'none'\n      })\n      setTimeout(() => Taro.navigateBack(), 1500)\n    }\n  }\n\n  const fetchTherapistAndStoreInfo = async () => {\n    try {\n      setLoading(true)\n\n      // Ëé∑ÂèñÊé®ÊãøÂ∏à‰ø°ÊÅØÔºà‰ªÖÂú®ÊúâtherapistIdÊó∂Ëé∑ÂèñÔºâ\n      if (params.therapistId) {\n        const therapistRes = await therapistService.getTherapistDetail(params.therapistId)\n        setTherapistInfo(therapistRes.data)\n      }\n\n      // Ëé∑ÂèñÈó®Â∫ó‰ø°ÊÅØ\n      const storeRes = await storeService.getStoreDetail(params.storeId!)\n      const storeData = storeRes.data\n\n      setStoreInfo(storeData)\n      setLoading(false)\n    } catch (error) {\n      setLoading(false)\n      Taro.showToast({\n        title: 'Ëé∑Âèñ‰ø°ÊÅØÂ§±Ë¥•',\n        icon: 'none'\n      })\n    }\n  }\n\n  const formatCountdown = (seconds: number) => {\n    const mins = Math.floor(seconds / 60)\n    const secs = seconds % 60\n    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`\n  }\n\n  const formatDate = (dateStr: string) => {\n    const date = new Date(dateStr)\n    const month = date.getMonth() + 1\n    const day = date.getDate()\n    return `${month.toString().padStart(2, '0')}Êúà${day.toString().padStart(2, '0')}Êó•`\n  }\n\n  const calculateEndTime = (time: string, duration: number) => {\n    const [hour, minute] = time.split(':').map(Number)\n    const endMinute = minute + duration\n    const endHour = hour + Math.floor(endMinute / 60)\n    const finalMinute = endMinute % 60\n    return `${endHour}:${finalMinute.toString().padStart(2, '0')}`\n  }\n\n  const getTotalPrice = () => {\n    // ‚úÖ Â∑≤ÊúâËÆ¢ÂçïÊ®°ÂºèÔºöÁõ¥Êé•‰ΩøÁî®ËÆ¢ÂçïÈáëÈ¢ùÔºàËΩ¨‰∏∫ÂÖÉÔºâ\n    if (isExistingOrderMode && existingOrder) {\n      return existingOrder.amount / 100  // ËÆ¢ÂçïÈáëÈ¢ùÊòØÂàÜÔºåËΩ¨‰∏∫ÂÖÉ\n    }\n\n    // Êñ∞È¢ÑÁ∫¶Ê®°ÂºèÔºöËÆ°ÁÆóË¥≠Áâ©ËΩ¶ÊÄª‰ª∑\n    const originalTotal = cartItems.reduce((sum, item) => sum + item.price, 0)\n    // Â¶ÇÊûúÊúâÊäòÊâ£ÁéáÔºåËÆ°ÁÆóÊäòÂêé‰ª∑\n    if (userDiscountRate && userDiscountRate < 1) {\n      const discountInfo = calculateDiscountPrice(originalTotal, userDiscountRate)\n      return discountInfo.finalPrice\n    }\n    // Âê¶Âàô‰ΩøÁî®Âéü‰ª∑ÊàñÂ∑≤ÊúâÁöÑÊäòÊâ£‰ª∑\n    return cartItems.reduce((sum, item) => sum + (item.discountPrice || item.price), 0)\n  }\n\n  // Ëé∑ÂèñÂéü‰ª∑ÔºàÁî®‰∫éÂ±ïÁ§∫ÂàíÁ∫ø‰ª∑Ôºâ\n  const getOriginalPrice = () => {\n    // ‚úÖ Â∑≤ÊúâËÆ¢ÂçïÊ®°ÂºèÔºö‰∏éÊÄª‰ª∑Áõ∏ÂêåÔºà‰∏çÊòæÁ§∫ÂàíÁ∫ø‰ª∑Ôºâ\n    if (isExistingOrderMode && existingOrder) {\n      return existingOrder.amount / 100\n    }\n\n    // Êñ∞È¢ÑÁ∫¶Ê®°ÂºèÔºöËÆ°ÁÆóÂéü‰ª∑\n    return cartItems.reduce((sum, item) => sum + item.price, 0)\n  }\n\n  // Ëé∑ÂèñËäÇÁúÅÈáëÈ¢ù\n  const getSavedAmount = () => {\n    const originalTotal = getOriginalPrice()\n    const finalTotal = getTotalPrice()\n    return originalTotal - finalTotal\n  }\n\n  // Ëé∑ÂèñÊäòÊâ£ÊèèËø∞\n  const getDiscountDisplay = () => {\n    if (userDiscountRate && userDiscountRate < 1) {\n      const percentage = Math.round(userDiscountRate * 100)\n      return `${percentage}Êäò`\n    }\n    return ''\n  }\n\n  // Ê£ÄÊü•‰ΩôÈ¢ùÊòØÂê¶ÂÖÖË∂≥\n  const isBalanceSufficient = () => {\n    const totalPrice = getTotalPrice()  // ÂÖÉ\n    return userBalance >= totalPrice   // ‰∏§‰∏™ÈÉΩÊòØÂÖÉÔºåÁõ¥Êé•ÊØîËæÉ\n  }\n\n  // Â§ÑÁêÜÊîØ‰ªòÊñπÂºèÂàáÊç¢\n  const handlePaymentMethodChange = (method: 'wechat' | 'balance') => {\n    if (method === 'balance' && !isBalanceSufficient()) {\n      Taro.showToast({\n        title: '‰ΩôÈ¢ù‰∏çË∂≥ÔºåËØ∑ÂÖÖÂÄºÊàñ‰ΩøÁî®ÂÖ∂‰ªñÊîØ‰ªòÊñπÂºè',\n        icon: 'none',\n        duration: 2000\n      })\n      return\n    }\n    setPaymentMethod(method)\n  }\n\n  const handlePayment = async () => {\n    // ‰ΩôÈ¢ùÊîØ‰ªòÂâçÂÜçÊ¨°Ê£ÄÊü•‰ΩôÈ¢ù\n    if (paymentMethod === 'balance' && !isBalanceSufficient()) {\n      Taro.showToast({\n        title: '‰ΩôÈ¢ù‰∏çË∂≥ÔºåËØ∑ÂÖÖÂÄºÊàñ‰ΩøÁî®ÂÖ∂‰ªñÊîØ‰ªòÊñπÂºè',\n        icon: 'none',\n        duration: 2000\n      })\n      return\n    }\n\n    try {\n      // ‚úÖ Âå∫ÂàÜ‰∏§‰∏™Ê®°Âºè\n      if (isExistingOrderMode) {\n        // Ê®°Âºè2ÔºöÂ∑≤ÊúâËÆ¢Âçï - Áõ¥Êé•ÊîØ‰ªò\n        await handleExistingOrderPayment()\n      } else {\n        // Ê®°Âºè1ÔºöÊñ∞È¢ÑÁ∫¶ - ÂàõÂª∫ËÆ¢ÂçïÂêéÊîØ‰ªò\n        await handleNewAppointmentPayment()\n      }\n    } catch (error) {\n      console.error('‚ùå ÊîØ‰ªòÊµÅÁ®ãÈîôËØØ:', error)\n      Taro.hideLoading()\n\n      const errorMessage = error.message || error.errMsg || 'ÊîØ‰ªòÂ§±Ë¥•'\n      Taro.showModal({\n        title: 'ÊîØ‰ªòÂ§±Ë¥•',\n        content: errorMessage,\n        showCancel: false,\n        confirmText: 'Áü•ÈÅì‰∫Ü'\n      })\n    }\n  }\n\n  // ‚úÖ Êñ∞Â¢ûÔºöÂ§ÑÁêÜÂ∑≤ÊúâËÆ¢ÂçïÁöÑÊîØ‰ªò\n  const handleExistingOrderPayment = async () => {\n    if (!existingOrder) {\n      throw new Error('ËÆ¢Âçï‰ø°ÊÅØ‰∏¢Â§±')\n    }\n\n    Taro.showLoading({\n      title: 'ÂáÜÂ§áÊîØ‰ªò...'\n    })\n\n    try {\n      const orderNo = existingOrder.orderNo\n      const amount = existingOrder.amount  // ÂàÜ‰∏∫Âçï‰Ωç\n\n      // Ê†πÊçÆÊîØ‰ªòÊñπÂºèÂ§ÑÁêÜ\n      if (paymentMethod === 'wechat') {\n        // Ëé∑ÂèñÂæÆ‰ø°ÊîØ‰ªòÂèÇÊï∞\n        console.log('üí≥ Ëé∑ÂèñÂæÆ‰ø°ÊîØ‰ªòÂèÇÊï∞ÔºåËÆ¢ÂçïÂè∑:', orderNo)\n        const paymentParams = await orderService.getPaymentParams(orderNo)\n\n        console.log('üí≥ ÊîØ‰ªòÂèÇÊï∞Ëé∑ÂèñÊàêÂäü:', paymentParams)\n\n        if (!paymentParams) {\n          throw new Error('Ëé∑ÂèñÊîØ‰ªòÂèÇÊï∞Â§±Ë¥•')\n        }\n\n        Taro.hideLoading()\n\n        // Ë∞ÉÁî®Áªü‰∏ÄÊîØ‰ªòÊé•Âè£\n        const paymentSuccess = await paymentService.pay({\n          orderNo: orderNo,\n          amount: amount,\n          paymentMethod: 'wechat',\n          title: existingOrder.title,\n          wxPayParams: paymentParams\n        } as any)\n\n        if (paymentSuccess) {\n          // ÊîØ‰ªòÊàêÂäüÔºåË∑≥ËΩ¨Á°ÆËÆ§È°µ\n          setTimeout(() => {\n            Taro.redirectTo({\n              url: `/pages/booking/success/index?orderNo=${orderNo}`\n            })\n          }, 1500)\n        }\n      } else {\n        // ‰ΩôÈ¢ùÊîØ‰ªò - Áõ¥Êé•Ë∞ÉÁî®ÊîØ‰ªòÊé•Âè£\n        console.log('üí∞ ‰ΩôÈ¢ùÊîØ‰ªòÔºåËÆ¢ÂçïÂè∑:', orderNo)\n\n        const paymentSuccess = await paymentService.pay({\n          orderNo: orderNo,\n          amount: amount,\n          paymentMethod: 'balance',\n          title: existingOrder.title\n        } as any)\n\n        Taro.hideLoading()\n\n        if (paymentSuccess) {\n          // ÊîØ‰ªòÊàêÂäüÔºåÊõ¥Êñ∞‰ΩôÈ¢ùÂπ∂Ë∑≥ËΩ¨Á°ÆËÆ§È°µ\n          await fetchUserBalance()\n\n          setTimeout(() => {\n            Taro.redirectTo({\n              url: `/pages/booking/success/index?orderNo=${orderNo}`\n            })\n          }, 1500)\n        }\n      }\n    } catch (error) {\n      Taro.hideLoading()\n      throw error\n    }\n  }\n\n  // ‚úÖ ÊîπÈÄ†ÔºöÂ§ÑÁêÜÊñ∞È¢ÑÁ∫¶ÁöÑÊîØ‰ªòÔºàÁé∞ÊúâÈÄªËæëÔºâ\n  const handleNewAppointmentPayment = async () => {\n    // ÁóáÁä∂Ë∞ÉÁêÜÊ®°Âºè‰∏ãÊé®ÊãøÂ∏à‰ø°ÊÅØÂú®cartItems‰∏≠Ôºå‰∏çÈúÄË¶ÅtherapistInfo\n    const isSymptomMode = params.from === 'symptom'\n    const needTherapistInfo = !isSymptomMode && !therapistInfo\n\n    if (cartItems.length === 0 || needTherapistInfo || !storeInfo) {\n      throw new Error('ËÆ¢Âçï‰ø°ÊÅØ‰∏çÂÆåÊï¥')\n    }\n\n    Taro.showLoading({\n      title: 'ÂàõÂª∫ËÆ¢Âçï...'\n    })\n\n    // ‰ΩøÁî®Á¨¨‰∏Ä‰∏™Ë¥≠Áâ©È°πÁöÑ‰ø°ÊÅØÔºàÂ¶ÇÊûúÊúâÂ§ö‰∏™ÊúçÂä°ÔºåÂèØ‰ª•ÂêéÁª≠‰ºòÂåñÔºâ\n    const firstItem = cartItems[0]\n\n    const orderParams: CreateOrderParams = {\n      therapistId: firstItem.therapistId || params.therapistId || 'symptom-mode',\n      storeId: params.storeId!,\n      serviceId: firstItem.serviceId,\n      serviceName: firstItem.serviceName,\n      duration: firstItem.duration,\n      price: firstItem.price,\n      discountPrice: firstItem.discountPrice,\n      appointmentDate: firstItem.date,\n      appointmentTime: firstItem.time,\n      therapistName: firstItem.therapistName,\n      therapistAvatar: firstItem.therapistAvatar || (therapistInfo?.avatar),\n      paymentMethod: paymentMethod  // ‚úÖ Êñ∞Â¢ûÔºö‰º†ÈÄíÁî®Êà∑ÈÄâÊã©ÁöÑÊîØ‰ªòÊñπÂºè\n    }\n\n    // ÂàõÂª∫ËÆ¢Âçï\n    console.log('üìù ÂàõÂª∫ËÆ¢ÂçïÔºåÊîØ‰ªòÊñπÂºè:', paymentMethod)\n    const result = await orderService.createAppointmentOrder(orderParams)\n    const order = result.order\n\n    Taro.hideLoading()\n\n    if (!order || !order.orderNo) {\n      throw new Error('ËÆ¢ÂçïÂàõÂª∫Â§±Ë¥•ÔºåÊú™ËøîÂõûËÆ¢ÂçïÂè∑')\n    }\n\n    // ÂæÆ‰ø°ÊîØ‰ªòÈúÄË¶ÅÊ£ÄÊü•wxPayParams\n    if (paymentMethod === 'wechat') {\n      if (!order.wxPayParams) {\n        throw new Error('ÂæÆ‰ø°ÊîØ‰ªòÂèÇÊï∞Áº∫Â§±ÔºåËØ∑Ê£ÄÊü•Áî®Êà∑ÁôªÂΩïÁä∂ÊÄÅÊàñÂ∞ùËØï‰ΩôÈ¢ùÊîØ‰ªò')\n      }\n    }\n\n    // Ë∞ÉÁî®Áªü‰∏ÄÊîØ‰ªòÊé•Âè£\n    const paymentSuccess = await paymentService.pay({\n      orderNo: order.orderNo,\n      amount: (order.totalAmount || getTotalPrice()) * 100,\n      paymentMethod: paymentMethod,\n      title: `${firstItem.serviceName} - ${firstItem.therapistName}`,\n      wxPayParams: order.wxPayParams\n    } as any)\n\n    if (paymentSuccess) {\n      // ÊîØ‰ªòÊàêÂäüÂêéÊõ¥Êñ∞‰ΩôÈ¢ùÊòæÁ§∫\n      if (paymentMethod === 'balance') {\n        await fetchUserBalance()\n      }\n\n      setTimeout(() => {\n        Taro.redirectTo({\n          url: `/pages/booking/success/index?orderNo=${order.orderNo}`\n        })\n      }, 1500)\n    }\n  }\n\n  if (loading) {\n    return (\n      <View className=\"order-confirm-page\">\n        <View className=\"loading\">Âä†ËΩΩ‰∏≠...</View>\n      </View>\n    )\n  }\n\n  return (\n    <ScrollView className=\"order-confirm-page\" scrollY>\n      {/* Èó®Â∫ó‰ø°ÊÅØ */}\n      <View className=\"store-section\">\n        <Text className=\"store-name\">{storeInfo?.name}</Text>\n        <Text className=\"store-distance\">üìç {storeInfo?.distance}km</Text>\n      </View>\n\n      {/* È¢ÑÁ∫¶‰ø°ÊÅØ */}\n      <View className=\"booking-info\">\n        {isExistingOrderMode && existingOrder ? (\n          // ‚úÖ Â∑≤ÊúâËÆ¢ÂçïÊòæÁ§∫ÊñπÂºè\n          <View className=\"booking-item\">\n            {existingOrder.extraData?.therapistAvatar && (\n              <Image\n                className=\"therapist-avatar\"\n                src={existingOrder.extraData.therapistAvatar}\n              />\n            )}\n            <View className=\"booking-details\">\n              <View className=\"therapist-name\">{existingOrder.extraData?.therapistName || 'Êé®ÊãøÂ∏à'}</View>\n              <View className=\"service-time\">\n                {existingOrder.extraData?.appointmentDate && existingOrder.extraData?.startTime && (\n                  <>\n                    {formatDate(existingOrder.extraData.appointmentDate)} {existingOrder.extraData.startTime}\n                    {existingOrder.extraData.duration && (\n                      <> Ëá≥ {calculateEndTime(existingOrder.extraData.startTime, existingOrder.extraData.duration)}</>\n                    )}\n                  </>\n                )}\n              </View>\n              <View className=\"service-name\">{existingOrder.extraData?.serviceName || existingOrder.title}</View>\n            </View>\n            <View className=\"service-price\">¬•{(existingOrder.amount / 100).toFixed(2)}</View>\n          </View>\n        ) : (\n          // Êñ∞È¢ÑÁ∫¶ÊòæÁ§∫ÊñπÂºè\n          cartItems.map((item, index) => (\n            <View key={index} className=\"booking-item\">\n              <Image\n                className=\"therapist-avatar\"\n                src={item.therapistAvatar || therapistInfo?.avatar}\n              />\n              <View className=\"booking-details\">\n                <View className=\"therapist-name\">{item.therapistName}</View>\n                <View className=\"service-time\">\n                  {formatDate(item.date)} {item.time} Ëá≥ {calculateEndTime(item.time, item.duration)}\n                </View>\n                <View className=\"service-name\">{item.serviceName}</View>\n              </View>\n              <View className=\"service-price\">¬•{item.discountPrice || item.price}</View>\n            </View>\n          ))\n        )}\n      </View>\n\n      {/* ÈÄÄÂçïËØ¥Êòé */}\n      <View className=\"refund-policy\">\n        <Text className=\"policy-title\">ÈÄÄÂçïËØ¥Êòé</Text>\n        <View className=\"policy-list\">\n          <View className=\"policy-item\">\n            ‚Ä¢ ‰∏ãÂçï15ÂàÜÈíüÂÜÖÊàñË∑ùËÆ¢ÂçïÂºÄÂßãÊó∂Èó¥&gt;6Â∞èÊó∂ÈÄÄÂçïÔºåÈÄÄ100%\n          </View>\n          <View className=\"policy-item\">\n            ‚Ä¢ Ë∑ùËÆ¢ÂçïÂºÄÂßãÂâç&lt;6Â∞èÊó∂ÈÄÄÂçïÔºåÈÄÄÂÆû‰ªòÈáëÈ¢ù90%\n          </View>\n          <View className=\"policy-item\">\n            ‚Ä¢ ËÆ¢ÂçïÊó∂Èó¥ÂºÄÂßãÂêéÈÄÄÂçïÔºåÈÄÄÂÆû‰ªòÈáëÈ¢ù80%\n          </View>\n        </View>\n      </View>\n\n      {/* ÂÆ¢Êà∑Â§áÊ≥® */}\n      <View className=\"customer-note\">\n        <Text className=\"note-title\">ÂÆ¢Êà∑Â§áÊ≥®</Text>\n        <Text className=\"note-hint\">ÊÇ®ÂØπËå∂Ê∞¥„ÄÅÊàøÈó¥„ÄÅÊåâÊë©ÊúçÁ≠âÊòØÂê¶ÊúâÁâπÊÆäÈúÄÊ±ÇÔºåÊàë‰ª¨Â∞ÜÊèêÂâç‰∏∫ÊÇ®ÂÅöÂ•ΩÂáÜÂ§á</Text>\n      </View>\n\n      {/* ÊîØ‰ªòÊñπÂºè */}\n      <View className=\"payment-section\">\n        <Text className=\"section-title\">ÊîØ‰ªòÊñπÂºè</Text>\n        <View className=\"payment-methods\">\n          {/* ‰ΩôÈ¢ùÊîØ‰ªò */}\n          <View\n            className={`payment-method ${paymentMethod === 'balance' ? 'active' : ''} ${!isBalanceSufficient() ? 'disabled' : ''}`}\n            onClick={() => handlePaymentMethodChange('balance')}\n          >\n            <View className=\"method-info\">\n              <Text className=\"method-icon\">üí∞</Text>\n              <Text className=\"method-name\">‰ΩôÈ¢ùÊîØ‰ªò</Text>\n              <Text className=\"balance-amount\">\n                {balanceLoading ? 'Âä†ËΩΩ‰∏≠...' : `¬•${userBalance.toFixed(2)}`}\n                {!isBalanceSufficient() && !balanceLoading && (\n                  <Text className=\"insufficient\"> (‰ΩôÈ¢ù‰∏çË∂≥)</Text>\n                )}\n              </Text>\n            </View>\n            <View className={`check-icon ${paymentMethod === 'balance' ? 'checked' : ''}`} />\n          </View>\n\n          {/* ÂæÆ‰ø°ÊîØ‰ªò */}\n          <View\n            className={`payment-method ${paymentMethod === 'wechat' ? 'active' : ''}`}\n            onClick={() => handlePaymentMethodChange('wechat')}\n          >\n            <View className=\"method-info\">\n              <Text className=\"method-icon\">üíö</Text>\n              <Text className=\"method-name\">ÂæÆ‰ø°ÊîØ‰ªò</Text>\n            </View>\n            <View className={`check-icon ${paymentMethod === 'wechat' ? 'checked' : ''}`} />\n          </View>\n        </View>\n      </View>\n\n      {/* Â∫ïÈÉ®ÊîØ‰ªòÊ†è */}\n      <View className=\"payment-bar\">\n        <View className=\"price-info\">\n          {userDiscountRate && userDiscountRate < 1 && getSavedAmount() > 0 ? (\n            <View className=\"price-with-discount\">\n              <View className=\"discount-info\">\n                <Text className=\"discount-tag\">{getDiscountDisplay()}</Text>\n                <Text className=\"saved-amount\">Â∑≤‰ºòÊÉ† ¬•{getSavedAmount()}</Text>\n              </View>\n              <View className=\"price-display\">\n                <Text className=\"original-price\">¬•{getOriginalPrice()}</Text>\n                <Text className=\"total-price\">¬•{getTotalPrice()}</Text>\n              </View>\n            </View>\n          ) : (\n            <Text className=\"total-price\">¬•{getTotalPrice()}</Text>\n          )}\n          {/* ‚úÖ ‰ªÖÊñ∞È¢ÑÁ∫¶Ê®°ÂºèÊòæÁ§∫ÂÄíËÆ°Êó∂ */}\n          {isNewAppointmentMode && (\n            <Text className=\"countdown\">ÊîØ‰ªòÂÄíËÆ°Êó∂: {formatCountdown(countdown)}</Text>\n          )}\n        </View>\n        <View className=\"pay-button\" onClick={handlePayment}>\n          ÂéªÊîØ‰ªò\n        </View>\n      </View>\n    </ScrollView>\n  )\n}\n\nexport default OrderConfirmPage"],"names":["OrderConfirmPage","router","useRouter","params","isExistingOrderMode","orderNo","isNewAppointmentMode","cartItems","setCartItems","useState","therapistInfo","setTherapistInfo","storeInfo","setStoreInfo","existingOrder","setExistingOrder","loading","setLoading","countdown","setCountdown","paymentMethod","setPaymentMethod","userBalance","setUserBalance","balanceLoading","setBalanceLoading","userDiscountRate","setUserDiscountRate","hasVoucher","setHasVoucher","timerRef","useRef","useEffect","initializePage","isLoggedIn","requireLogin","items","JSON","parse","decodeURIComponent","error","Taro","showToast","title","icon","setTimeout","navigateBack","length","current","setInterval","prev","clearInterval","showModal","content","showCancel","success","fetchUserDiscount","userInfo","getCurrentUserInfo","discountRate","vouchers","voucherService","getMyVouchers","fetchUserBalance","balance","walletService","getBalance","totalPrice","getTotalPrice","fetchExistingOrder","order","orderService","getOrderDetail","extraData","storeId","storeRes","storeService","getStoreDetail","data","fetchTherapistAndStoreInfo","therapistId","therapistRes","therapistService","getTherapistDetail","storeData","formatCountdown","seconds","mins","Math","floor","secs","toString","padStart","formatDate","dateStr","date","Date","month","getMonth","day","getDate","calculateEndTime","time","duration","hour","minute","split","map","Number","endMinute","endHour","finalMinute","amount","originalTotal","reduce","sum","item","price","discountInfo","calculateDiscountPrice","finalPrice","discountPrice","getOriginalPrice","getSavedAmount","finalTotal","getDiscountDisplay","percentage","round","isBalanceSufficient","handlePaymentMethodChange","method","handlePayment","handleExistingOrderPayment","handleNewAppointmentPayment","hideLoading","errorMessage","message","errMsg","confirmText","Error","showLoading","log","paymentParams","getPaymentParams","paymentSuccess","paymentService","pay","wxPayParams","redirectTo","url","isSymptomMode","from","needTherapistInfo","firstItem","orderParams","serviceId","serviceName","appointmentDate","appointmentTime","therapistName","therapistAvatar","avatar","result","createAppointmentOrder","totalAmount","jsx","View","jsxs","ScrollView","Text","name","distance","Image","startTime","Fragment","toFixed","index"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;AAyDA,MAAMA,mBAA6BA,MAAM;;AACvC,QAAMC,SAASC,KAAAA,YAAAA;AACf,QAAMC,SAASF,OAAOE;AAGhBC,QAAAA,sBAAsB,CAAC,CAACD,OAAOE;AACrC,QAAMC,uBAAuB,CAACF;AAE9B,QAAM,CAACG,WAAWC,YAAY,IAAIC,KAAAA,SAAqB,CAAE,CAAA;AACzD,QAAM,CAACC,eAAeC,gBAAgB,IAAIF,cAAc,IAAI;AAC5D,QAAM,CAACG,WAAWC,YAAY,IAAIJ,cAAc,IAAI;AACpD,QAAM,CAACK,eAAeC,gBAAgB,IAAIN,cAA+B,IAAI;AAC7E,QAAM,CAACO,SAASC,UAAU,IAAIR,cAAS,IAAI;AAC3C,QAAM,CAACS,WAAWC,YAAY,IAAIV,cAAS,GAAG;AAC9C,QAAM,CAACW,eAAeC,gBAAgB,IAAIZ,cAA+B,QAAQ;AACjF,QAAM,CAACa,aAAaC,cAAc,IAAId,cAAS,CAAC;AAChD,QAAM,CAACe,gBAAgBC,iBAAiB,IAAIhB,cAAS,KAAK;AAC1D,QAAM,CAACiB,kBAAkBC,mBAAmB,IAAIlB,cAAwB,IAAI;AAC5E,QAAM,CAACmB,YAAYC,aAAa,IAAIpB,cAAS,KAAK;AAC5CqB,QAAAA,WAAWC,YAAY,IAAI;AAEjCC,OAAAA,UAAU,MAAM;AAEd,UAAMC,iBAAiB,MAAY;AAC7B,UAAA;AAEIC,cAAAA,aAAa,MAAMC,OAAAA;AACzB,YAAI,CAACD,YAAY;AACf;AAAA,QACF;AAGA,YAAI9B,qBAAqB;AAEJ;QAAA,OACd;AAEL,gBAAMgC,QAAQC,KAAKC,MAAMC,mBAAmBpC,OAAOiC,SAAS,IAAI,CAAC;AACjE5B,uBAAa4B,KAAK;AACS;QAC7B;AAGiB;AACC;eACXI,OAAO;AACdC,aAAAA,KAAKC,UAAU;AAAA,UACbC,OAAO;AAAA,UACPC,MAAM;AAAA,QAAA,CACP;AACDC,mBAAW,MAAMJ,KAAAA,KAAKK,aAAa,GAAG,IAAI;AAAA,MAC5C;AAAA,IAAA;AAGa;EAAA,GACd,CAAC3C,MAAM,CAAC;AAGX6B,OAAAA,UAAU,MAAM;AAEd,QAAI,CAAChB,WAAWV,wBAAwBC,UAAUwC,SAAS,GAAG;AACnDC,eAAAA,UAAUC,YAAY,MAAM;AACnC9B,qBAAa,CAAC+B,SAAS;AACrB,cAAIA,QAAQ,GAAG;AACbC,0BAAcrB,SAASkB,OAAO;AAC9BP,iBAAAA,KAAKW,UAAU;AAAA,cACbT,OAAO;AAAA,cACPU,SAAS;AAAA,cACTC,YAAY;AAAA,cACZC,SAASA,MAAM;AACbd,qBAAAA,KAAKK,aAAa;AAAA,cACpB;AAAA,YAAA,CACD;AACM,mBAAA;AAAA,UACT;AACA,iBAAOI,OAAO;AAAA,QAAA,CACf;AAAA,SACA,GAAI;AAAA,IACT;AAEA,WAAO,MAAM;AACX,UAAIpB,SAASkB,SAAS;AACpBG,sBAAcrB,SAASkB,OAAO;AAAA,MAChC;AAAA,IAAA;AAAA,EAED,GAAA,CAAChC,SAAST,WAAWD,oBAAoB,CAAC;AAG7C,QAAMkD,oBAAoB,MAAY;AAChC,QAAA;AACF,YAAMC,WAAWC,OAAAA;AACbD,UAAAA,YAAYA,SAASE,cAAc;AACrChC,4BAAoB8B,SAASE,YAAY;AAEnCC,cAAAA,WAAW,MAAMC,sBAAeC;AACxBF,sBAAAA,SAASb,SAAS,CAAC;AAAA,MACnC;AAAA,aACOP,OAAO;AACNA,cAAAA,MAAM,eAAeA,KAAK;AAAA,IACpC;AAAA,EAAA;AAIF,QAAMuB,mBAAmB,MAAY;AAC/B,QAAA;AACFtC,wBAAkB,IAAI;AAChBuC,YAAAA,UAAU,MAAMC,qBAAcC;AACpC3C,qBAAeyC,UAAU,GAAG;AAI5B,YAAMG,aAAaC;AACfJ,UAAAA,UAAU,OAAOG,YAAY;AAC/B9C,yBAAiB,SAAS;AAAA,MAC5B;AAAA,aACOmB,OAAO;AACNA,cAAAA,MAAM,WAAWA,KAAK;AAC9BjB,qBAAe,CAAC;AAAA,IAAA,UACR;AACRE,wBAAkB,KAAK;AAAA,IACzB;AAAA,EAAA;AAIF,QAAM4C,qBAAqB,MAAY;;AACjC,QAAA;AACFpD,iBAAW,IAAI;AACf,YAAMqD,QAAQ,MAAMC,OAAaC,aAAAA,eAAerE,OAAOE,OAAQ;AAC/DU,uBAAiBuD,KAAK;AAGlBA,WAAAA,MAAAA,MAAMG,cAANH,gBAAAA,IAAiBI,SAAS;AACxB,YAAA;AACF,gBAAMC,WAAW,MAAMC,oBAAaC,eAAeP,MAAMG,UAAUC,OAAO;AAC1E7D,uBAAa8D,SAASG,IAAI;AAAA,iBACnBtC,OAAO;AACNA,kBAAAA,MAAM,aAAaA,KAAK;AAAA,QAClC;AAAA,MACF;AAEAvB,iBAAW,KAAK;AAAA,aACTuB,OAAO;AACdvB,iBAAW,KAAK;AAChBwB,WAAAA,KAAKC,UAAU;AAAA,QACbC,OAAO;AAAA,QACPC,MAAM;AAAA,MAAA,CACP;AACDC,iBAAW,MAAMJ,KAAAA,KAAKK,aAAa,GAAG,IAAI;AAAA,IAC5C;AAAA,EAAA;AAGF,QAAMiC,6BAA6B,MAAY;AACzC,QAAA;AACF9D,iBAAW,IAAI;AAGf,UAAId,OAAO6E,aAAa;AACtB,cAAMC,eAAe,MAAMC,OAAiBC,iBAAAA,mBAAmBhF,OAAO6E,WAAW;AACjFrE,yBAAiBsE,aAAaH,IAAI;AAAA,MACpC;AAGA,YAAMH,WAAW,MAAMC,OAAaC,aAAAA,eAAe1E,OAAOuE,OAAQ;AAClE,YAAMU,YAAYT,SAASG;AAE3BjE,mBAAauE,SAAS;AACtBnE,iBAAW,KAAK;AAAA,aACTuB,OAAO;AACdvB,iBAAW,KAAK;AAChBwB,WAAAA,KAAKC,UAAU;AAAA,QACbC,OAAO;AAAA,QACPC,MAAM;AAAA,MAAA,CACP;AAAA,IACH;AAAA,EAAA;AAGIyC,QAAAA,kBAAkBA,CAACC,YAAoB;AAC3C,UAAMC,OAAOC,KAAKC,MAAMH,UAAU,EAAE;AACpC,UAAMI,OAAOJ,UAAU;AACvB,WAAO,GAAGC,KAAKI,SAAS,EAAEC,SAAS,GAAG,GAAG,CAAC,IAAIF,KAAKC,SAAS,EAAEC,SAAS,GAAG,GAAG,CAAC;AAAA,EAAA;AAG1EC,QAAAA,aAAaA,CAACC,YAAoB;AAChCC,UAAAA,OAAO,IAAIC,KAAKF,OAAO;AACvBG,UAAAA,QAAQF,KAAKG,SAAAA,IAAa;AAC1BC,UAAAA,MAAMJ,KAAKK;AACjB,WAAO,GAAGH,MAAMN,SAAS,EAAEC,SAAS,GAAG,GAAG,CAAC,IAAIO,IAAIR,SAAS,EAAEC,SAAS,GAAG,GAAG,CAAC;AAAA,EAAA;AAG1ES,QAAAA,mBAAmBA,CAACC,MAAcC,aAAqB;AACrD,UAAA,CAACC,MAAMC,MAAM,IAAIH,KAAKI,MAAM,GAAG,EAAEC,IAAIC,MAAM;AACjD,UAAMC,YAAYJ,SAASF;AAC3B,UAAMO,UAAUN,OAAOhB,KAAKC,MAAMoB,YAAY,EAAE;AAChD,UAAME,cAAcF,YAAY;AACzB,WAAA,GAAGC,OAAO,IAAIC,YAAYpB,WAAWC,SAAS,GAAG,GAAG,CAAC;AAAA,EAAA;AAG9D,QAAMxB,gBAAgBA,MAAM;AAE1B,QAAIhE,uBAAuBU,eAAe;AACxC,aAAOA,cAAckG,SAAS;AAAA,IAChC;AAGMC,UAAAA,gBAAgB1G,UAAU2G,OAAO,CAACC,KAAKC,SAASD,MAAMC,KAAKC,OAAO,CAAC;AAErE3F,QAAAA,oBAAoBA,mBAAmB,GAAG;AACtC4F,YAAAA,eAAeC,OAAAA,uBAAuBN,eAAevF,gBAAgB;AAC3E,aAAO4F,aAAaE;AAAAA,IACtB;AAEOjH,WAAAA,UAAU2G,OAAO,CAACC,KAAKC,SAASD,OAAOC,KAAKK,iBAAiBL,KAAKC,QAAQ,CAAC;AAAA,EAAA;AAIpF,QAAMK,mBAAmBA,MAAM;AAE7B,QAAItH,uBAAuBU,eAAe;AACxC,aAAOA,cAAckG,SAAS;AAAA,IAChC;AAGOzG,WAAAA,UAAU2G,OAAO,CAACC,KAAKC,SAASD,MAAMC,KAAKC,OAAO,CAAC;AAAA,EAAA;AAI5D,QAAMM,iBAAiBA,MAAM;AAC3B,UAAMV,gBAAgBS;AACtB,UAAME,aAAaxD;AACnB,WAAO6C,gBAAgBW;AAAAA,EAAAA;AAIzB,QAAMC,qBAAqBA,MAAM;AAC3BnG,QAAAA,oBAAoBA,mBAAmB,GAAG;AAC5C,YAAMoG,aAAatC,KAAKuC,MAAMrG,mBAAmB,GAAG;AACpD,aAAO,GAAGoG,UAAU;AAAA,IACtB;AACO,WAAA;AAAA,EAAA;AAIT,QAAME,sBAAsBA,MAAM;AAChC,UAAM7D,aAAaC;AACnB,WAAO9C,eAAe6C;AAAAA,EAAAA;AAIlB8D,QAAAA,4BAA4BA,CAACC,WAAiC;AAClE,QAAIA,WAAW,aAAa,CAACF,uBAAuB;AAClDvF,WAAAA,KAAKC,UAAU;AAAA,QACbC,OAAO;AAAA,QACPC,MAAM;AAAA,QACN2D,UAAU;AAAA,MAAA,CACX;AACD;AAAA,IACF;AACAlF,qBAAiB6G,MAAM;AAAA,EAAA;AAGzB,QAAMC,gBAAgB,MAAY;AAEhC,QAAI/G,kBAAkB,aAAa,CAAC4G,uBAAuB;AACzDvF,WAAAA,KAAKC,UAAU;AAAA,QACbC,OAAO;AAAA,QACPC,MAAM;AAAA,QACN2D,UAAU;AAAA,MAAA,CACX;AACD;AAAA,IACF;AAEI,QAAA;AAEF,UAAInG,qBAAqB;AAEvB,cAAMgI,2BAA2B;AAAA,MAAA,OAC5B;AAEL,cAAMC,4BAA4B;AAAA,MACpC;AAAA,aACO7F,OAAO;AACNA,cAAAA,MAAM,aAAaA,KAAK;AAChCC,WAAAA,KAAK6F,YAAY;AAEjB,YAAMC,eAAe/F,MAAMgG,WAAWhG,MAAMiG,UAAU;AACtDhG,WAAAA,KAAKW,UAAU;AAAA,QACbT,OAAO;AAAA,QACPU,SAASkF;AAAAA,QACTjF,YAAY;AAAA,QACZoF,aAAa;AAAA,MAAA,CACd;AAAA,IACH;AAAA,EAAA;AAIF,QAAMN,6BAA6B,MAAY;AAC7C,QAAI,CAACtH,eAAe;AACZ,YAAA,IAAI6H,MAAM,QAAQ;AAAA,IAC1B;AAEAlG,SAAAA,KAAKmG,YAAY;AAAA,MACfjG,OAAO;AAAA,IAAA,CACR;AAEG,QAAA;AACF,YAAMtC,UAAUS,cAAcT;AAC9B,YAAM2G,SAASlG,cAAckG;AAG7B,UAAI5F,kBAAkB,UAAU;AAEtByH,gBAAAA,IAAI,oBAAoBxI,OAAO;AACvC,cAAMyI,gBAAgB,MAAMvE,OAAAA,aAAawE,iBAAiB1I,OAAO;AAEzDwI,gBAAAA,IAAI,gBAAgBC,aAAa;AAEzC,YAAI,CAACA,eAAe;AACZ,gBAAA,IAAIH,MAAM,UAAU;AAAA,QAC5B;AAEAlG,aAAAA,KAAK6F,YAAY;AAGXU,cAAAA,iBAAiB,MAAMC,OAAAA,eAAeC,IAAI;AAAA,UAC9C7I;AAAAA,UACA2G;AAAAA,UACA5F,eAAe;AAAA,UACfuB,OAAO7B,cAAc6B;AAAAA,UACrBwG,aAAaL;AAAAA,QAAAA,CACP;AAER,YAAIE,gBAAgB;AAElBnG,qBAAW,MAAM;AACfJ,iBAAAA,KAAK2G,WAAW;AAAA,cACdC,KAAK,wCAAwChJ,OAAO;AAAA,YAAA,CACrD;AAAA,aACA,IAAI;AAAA,QACT;AAAA,MAAA,OACK;AAEGwI,gBAAAA,IAAI,gBAAgBxI,OAAO;AAE7B2I,cAAAA,iBAAiB,MAAMC,OAAAA,eAAeC,IAAI;AAAA,UAC9C7I;AAAAA,UACA2G;AAAAA,UACA5F,eAAe;AAAA,UACfuB,OAAO7B,cAAc6B;AAAAA,QAAAA,CACf;AAERF,aAAAA,KAAK6F,YAAY;AAEjB,YAAIU,gBAAgB;AAElB,gBAAMjF,iBAAiB;AAEvBlB,qBAAW,MAAM;AACfJ,iBAAAA,KAAK2G,WAAW;AAAA,cACdC,KAAK,wCAAwChJ,OAAO;AAAA,YAAA,CACrD;AAAA,aACA,IAAI;AAAA,QACT;AAAA,MACF;AAAA,aACOmC,OAAO;AACdC,WAAAA,KAAK6F,YAAY;AACX9F,YAAAA;AAAAA,IACR;AAAA,EAAA;AAIF,QAAM6F,8BAA8B,MAAY;AAExCiB,UAAAA,gBAAgBnJ,OAAOoJ,SAAS;AAChCC,UAAAA,oBAAoB,CAACF,iBAAiB,CAAC5I;AAE7C,QAAIH,UAAUwC,WAAW,KAAKyG,qBAAqB,CAAC5I,WAAW;AACvD,YAAA,IAAI+H,MAAM,SAAS;AAAA,IAC3B;AAEAlG,SAAAA,KAAKmG,YAAY;AAAA,MACfjG,OAAO;AAAA,IAAA,CACR;AAGK8G,UAAAA,YAAYlJ,UAAU,CAAC;AAE7B,UAAMmJ,cAAiC;AAAA,MACrC1E,aAAayE,UAAUzE,eAAe7E,OAAO6E,eAAe;AAAA,MAC5DN,SAASvE,OAAOuE;AAAAA,MAChBiF,WAAWF,UAAUE;AAAAA,MACrBC,aAAaH,UAAUG;AAAAA,MACvBrD,UAAUkD,UAAUlD;AAAAA,MACpBc,OAAOoC,UAAUpC;AAAAA,MACjBI,eAAegC,UAAUhC;AAAAA,MACzBoC,iBAAiBJ,UAAU1D;AAAAA,MAC3B+D,iBAAiBL,UAAUnD;AAAAA,MAC3ByD,eAAeN,UAAUM;AAAAA,MACzBC,iBAAiBP,UAAUO,oBAAoBtJ,+CAAeuJ;AAAAA,MAC9D7I;AAAAA;AAAAA,IAAAA;AAIMyH,YAAAA,IAAI,iBAAiBzH,aAAa;AAC1C,UAAM8I,SAAS,MAAM3F,OAAAA,aAAa4F,uBAAuBT,WAAW;AACpE,UAAMpF,QAAQ4F,OAAO5F;AAErB7B,SAAAA,KAAK6F,YAAY;AAEjB,QAAI,CAAChE,SAAS,CAACA,MAAMjE,SAAS;AACtB,YAAA,IAAIsI,MAAM,eAAe;AAAA,IACjC;AAGA,QAAIvH,kBAAkB,UAAU;AAC1B,UAAA,CAACkD,MAAM6E,aAAa;AAChB,cAAA,IAAIR,MAAM,2BAA2B;AAAA,MAC7C;AAAA,IACF;AAGMK,UAAAA,iBAAiB,MAAMC,OAAAA,eAAeC,IAAI;AAAA,MAC9C7I,SAASiE,MAAMjE;AAAAA,MACf2G,SAAS1C,MAAM8F,eAAehG,cAAmB,KAAA;AAAA,MACjDhD;AAAAA,MACAuB,OAAO,GAAG8G,UAAUG,WAAW,MAAMH,UAAUM,aAAa;AAAA,MAC5DZ,aAAa7E,MAAM6E;AAAAA,IAAAA,CACb;AAER,QAAIH,gBAAgB;AAElB,UAAI5H,kBAAkB,WAAW;AAC/B,cAAM2C,iBAAiB;AAAA,MACzB;AAEAlB,iBAAW,MAAM;AACfJ,aAAAA,KAAK2G,WAAW;AAAA,UACdC,KAAK,wCAAwC/E,MAAMjE,OAAO;AAAA,QAAA,CAC3D;AAAA,SACA,IAAI;AAAA,IACT;AAAA,EAAA;AAGF,MAAIW,SAAS;AAET,WAAAqJ,qBAAAA,IAACC,KAAAA,QAAK,WAAU,sBACd,mCAACA,KAAK,MAAA,EAAA,WAAU,WAAU,UAAA,SAAM,CAAA,EAClC,CAAA;AAAA,EAEJ;AAEA,SACGC,qBAAAA,KAAAC,KAAAA,YAAA,EAAW,WAAU,sBAAqB,SAAO,MAEhD,UAAA;AAAA,IAACD,qBAAAA,KAAAD,KAAAA,MAAA,EAAK,WAAU,iBACd,UAAA;AAAA,MAAAD,qBAAA,IAACI,KAAK,MAAA,EAAA,WAAU,cAAc7J,UAAAA,uCAAW8J,MAAK;AAAA,MAC9CH,qBAAAA,KAACE,KAAAA,MAAK,EAAA,WAAU,kBAAiB,UAAA;AAAA,QAAA;AAAA,QAAI7J,uCAAW+J;AAAAA,QAAS;AAAA,MAAA,GAAE;AAAA,IAAA,GAC7D;AAAA,IAGCN,qBAAA,IAAAC,KAAA,MAAA,EAAK,WAAU,gBACblK,UAAuBU,uBAAAA;AAAAA;AAAAA,MAEtByJ,qBAAAA,KAACD,KAAAA,MAAK,EAAA,WAAU,gBACbxJ,UAAAA;AAAAA,UAAAA,mBAAc2D,cAAd3D,mBAAyBkJ,oBACxBK,qBAAA;AAAA,UAACO,KAAA;AAAA,UAAA;AAAA,YACC,WAAU;AAAA,YACV,KAAK9J,cAAc2D,UAAUuF;AAAAA,UAAAA;AAAAA,QAAgB;AAAA,QAGjDO,qBAAAA,KAACD,KAAAA,MAAK,EAAA,WAAU,mBACd,UAAA;AAAA,UAAAD,yBAACC,KAAAA,QAAK,WAAU,kBAAkBxJ,YAAc2D,mBAAAA,cAAAA,mBAAWsF,kBAAiB,OAAM;AAAA,UAClFM,qBAAA,IAACC,KAAK,MAAA,EAAA,WAAU,gBACbxJ,YAAAA,mBAAc2D,cAAd3D,mBAAyB+I,sBAAmB/I,mBAAc2D,cAAd3D,mBAAyB+J,cAEjEhF,qBAAAA,KAAAA,KAAAA,UAAAA,EAAAA,UAAAA;AAAAA,YAAW/E,WAAAA,cAAc2D,UAAUoF,eAAe;AAAA,YAAE;AAAA,YAAE/I,cAAc2D,UAAUoG;AAAAA,YAC9E/J,cAAc2D,UAAU8B,YACrBgE,qBAAA,KAAAO,KAAA,UAAA,EAAA,UAAA;AAAA,cAAA;AAAA,cAAIzE,iBAAiBvF,cAAc2D,UAAUoG,WAAW/J,cAAc2D,UAAU8B,QAAQ;AAAA,YAAA,GAAE;AAAA,UAAA,EAAA,CAEhG,EAEJ,CAAA;AAAA,UACA8D,qBAAAA,IAACC,aAAK,WAAU,gBAAgBxJ,+BAAc2D,iCAAWmF,gBAAe9I,cAAc6B,MAAM,CAAA;AAAA,QAAA,GAC9F;AAAA,QACA4H,qBAAAA,KAACD,KAAAA,MAAK,EAAA,WAAU,iBAAgB,UAAA;AAAA,UAAA;AAAA,WAAGxJ,cAAckG,SAAS,KAAK+D,QAAQ,CAAC;AAAA,QAAA,GAAE;AAAA,MAAA,GAC5E;AAAA;AAAA;AAAA,MAGAxK,UAAUoG;AAAAA,QAAI,CAACS,MAAM4D,WAClBT,qBAAA,KAAAD,KAAA,MAAA,EAAiB,WAAU,gBAC1B,UAAA;AAAA,UAAAD,qBAAA;AAAA,YAACO,KAAA;AAAA,YAAA;AAAA,cACC,WAAU;AAAA,cACV,KAAKxD,KAAK4C,oBAAmBtJ,+CAAeuJ;AAAAA,YAAAA;AAAAA,UAAO;AAAA,UAErDM,qBAAAA,KAACD,KAAAA,MAAK,EAAA,WAAU,mBACd,UAAA;AAAA,YAAAD,qBAAA,IAACC,KAAK,MAAA,EAAA,WAAU,kBAAkBlD,UAAAA,KAAK2C,eAAc;AAAA,YACrDQ,qBAAAA,KAACD,KAAAA,MAAK,EAAA,WAAU,gBACbzE,UAAAA;AAAAA,cAAAA,WAAWuB,KAAKrB,IAAI;AAAA,cAAE;AAAA,cAAEqB,KAAKd;AAAAA,cAAK;AAAA,cAAID,iBAAiBe,KAAKd,MAAMc,KAAKb,QAAQ;AAAA,YAAA,GAClF;AAAA,YACC8D,qBAAA,IAAAC,KAAA,MAAA,EAAK,WAAU,gBAAgBlD,eAAKwC,aAAY;AAAA,UAAA,GACnD;AAAA,UACAW,qBAAAA,KAACD,KAAAA,MAAK,EAAA,WAAU,iBAAgB,UAAA;AAAA,YAAA;AAAA,YAAElD,KAAKK,iBAAiBL,KAAKC;AAAAA,UAAAA,GAAM;AAAA,QAAA,EAAA,GAZ1D2D,MAaX;AAAA,MACD;AAAA,OAEL;AAAA,IAGAT,qBAAAA,KAACD,KAAAA,MAAK,EAAA,WAAU,iBACd,UAAA;AAAA,MAACD,qBAAA,IAAAI,KAAA,MAAA,EAAK,WAAU,gBAAe,UAAI,QAAA;AAAA,MACnCF,qBAAAA,KAACD,KAAAA,MAAK,EAAA,WAAU,eACd,UAAA;AAAA,QAACD,qBAAA,IAAAC,KAAA,MAAA,EAAK,WAAU,eAAa,UAE7B,iCAAA;AAAA,QACCD,qBAAA,IAAAC,KAAA,MAAA,EAAK,WAAU,eAAa,UAE7B,2BAAA;AAAA,QACCD,qBAAA,IAAAC,KAAA,MAAA,EAAK,WAAU,eAAa,UAE7B,wBAAA;AAAA,MAAA,GACF;AAAA,IAAA,GACF;AAAA,IAGAC,qBAAAA,KAACD,KAAAA,MAAK,EAAA,WAAU,iBACd,UAAA;AAAA,MAACD,qBAAA,IAAAI,KAAA,MAAA,EAAK,WAAU,cAAa,UAAI,QAAA;AAAA,MAChCJ,qBAAA,IAAAI,KAAA,MAAA,EAAK,WAAU,aAAY,UAA+B,mCAAA;AAAA,IAAA,GAC7D;AAAA,IAGAF,qBAAAA,KAACD,KAAAA,MAAK,EAAA,WAAU,mBACd,UAAA;AAAA,MAACD,qBAAA,IAAAI,KAAA,MAAA,EAAK,WAAU,iBAAgB,UAAI,QAAA;AAAA,MACpCF,qBAAAA,KAACD,KAAAA,MAAK,EAAA,WAAU,mBAEd,UAAA;AAAA,QAAAC,qBAAA;AAAA,UAACD,KAAA;AAAA,UAAA;AAAA,YACC,WAAW,kBAAkBlJ,kBAAkB,YAAY,WAAW,EAAE,IAAI,CAAC4G,oBAAAA,IAAwB,aAAa,EAAE;AAAA,YACpH,SAAS,MAAMC,0BAA0B,SAAS;AAAA,YAElD,UAAA;AAAA,cAACsC,qBAAAA,KAAAD,KAAAA,MAAA,EAAK,WAAU,eACd,UAAA;AAAA,gBAACD,qBAAA,IAAAI,KAAA,MAAA,EAAK,WAAU,eAAc,UAAE,MAAA;AAAA,gBAC/BJ,qBAAA,IAAAI,KAAA,MAAA,EAAK,WAAU,eAAc,UAAI,QAAA;AAAA,gBAClCF,qBAAAA,KAACE,KAAAA,MAAK,EAAA,WAAU,kBACbjJ,UAAAA;AAAAA,kBAAAA,iBAAiB,WAAW,IAAIF,YAAYyJ,QAAQ,CAAC,CAAC;AAAA,kBACtD,CAAC/C,oBAAyB,KAAA,CAACxG,kBACzB6I,yBAAAI,KAAAA,MAAA,EAAK,WAAU,gBAAe,UAAO,WAAA;AAAA,gBAAA,GAE1C;AAAA,cAAA,GACF;AAAA,cACAJ,qBAAAA,IAACC,aAAK,WAAW,cAAclJ,kBAAkB,YAAY,YAAY,EAAE,IAAG;AAAA,YAAA;AAAA,UAAA;AAAA,QAChF;AAAA,QAGAmJ,qBAAA;AAAA,UAACD,KAAA;AAAA,UAAA;AAAA,YACC,WAAW,kBAAkBlJ,kBAAkB,WAAW,WAAW,EAAE;AAAA,YACvE,SAAS,MAAM6G,0BAA0B,QAAQ;AAAA,YAEjD,UAAA;AAAA,cAACsC,qBAAAA,KAAAD,KAAAA,MAAA,EAAK,WAAU,eACd,UAAA;AAAA,gBAACD,qBAAA,IAAAI,KAAA,MAAA,EAAK,WAAU,eAAc,UAAE,MAAA;AAAA,gBAC/BJ,qBAAA,IAAAI,KAAA,MAAA,EAAK,WAAU,eAAc,UAAI,QAAA;AAAA,cAAA,GACpC;AAAA,cACAJ,qBAAAA,IAACC,aAAK,WAAW,cAAclJ,kBAAkB,WAAW,YAAY,EAAE,IAAG;AAAA,YAAA;AAAA,UAAA;AAAA,QAC/E;AAAA,MAAA,GACF;AAAA,IAAA,GACF;AAAA,IAGAmJ,qBAAAA,KAACD,KAAAA,MAAK,EAAA,WAAU,eACd,UAAA;AAAA,MAACC,qBAAAA,KAAAD,KAAAA,MAAA,EAAK,WAAU,cACb5I,UAAAA;AAAAA,QAAoBA,oBAAAA,mBAAmB,KAAKiG,mBAAmB,IAC7D4C,qBAAA,KAAAD,WAAA,EAAK,WAAU,uBACd,UAAA;AAAA,UAACC,qBAAAA,KAAAD,KAAAA,MAAA,EAAK,WAAU,iBACd,UAAA;AAAA,YAAAD,qBAAA,IAACI,KAAK,MAAA,EAAA,WAAU,gBAAgB5C,UAAAA,mBAAAA,GAAqB;AAAA,YACrD0C,qBAAAA,KAACE,KAAAA,MAAK,EAAA,WAAU,gBAAe,UAAA;AAAA,cAAA;AAAA,cAAM9C,eAAe;AAAA,YAAA,GAAE;AAAA,UAAA,GACxD;AAAA,UACA4C,qBAAAA,KAACD,KAAAA,MAAK,EAAA,WAAU,iBACd,UAAA;AAAA,YAACC,qBAAAA,KAAAE,KAAAA,MAAA,EAAK,WAAU,kBAAiB,UAAA;AAAA,cAAA;AAAA,cAAE/C,iBAAiB;AAAA,YAAA,GAAE;AAAA,YACtD6C,qBAAAA,KAACE,KAAAA,MAAK,EAAA,WAAU,eAAc,UAAA;AAAA,cAAA;AAAA,cAAErG,cAAc;AAAA,YAAA,GAAE;AAAA,UAAA,GAClD;AAAA,QAAA,EACF,CAAA,IAEAmG,qBAAAA,KAACE,KAAAA,MAAK,EAAA,WAAU,eAAc,UAAA;AAAA,UAAA;AAAA,UAAErG,cAAc;AAAA,QAAA,GAAE;AAAA,QAGjD9D,wBACCiK,qBAAA,KAACE,KAAK,MAAA,EAAA,WAAU,aAAY,UAAA;AAAA,UAAA;AAAA,UAAQpF,gBAAgBnE,SAAS;AAAA,QAAA,GAAE;AAAA,MAAA,GAEnE;AAAA,+BACCoJ,KAAAA,MAAK,EAAA,WAAU,cAAa,SAASnC,eAAc,UAEpD,OAAA;AAAA,IAAA,GACF;AAAA,EACF,EAAA,CAAA;AAEJ;;;;;;;;"}