{"version":3,"file":"index.js","sources":["../../../../src/pages/gift/order-confirm/index.tsx"],"sourcesContent":["import React, { useState, useEffect } from 'react'\nimport { View, Text, Image, Button } from '@tarojs/components'\nimport Taro, { useRouter } from '@tarojs/taro'\nimport { AtIcon } from 'taro-ui'\nimport { paymentService } from '@/services/payment.service'\nimport { walletService } from '@/services/wallet.service'\nimport './index.scss'\n\nconst OrderConfirm: React.FC = () => {\n  const router = useRouter()\n  const { orderNo, amount, quantity } = router.params\n  const [paymentMethod, setPaymentMethod] = useState<'wechat' | 'balance'>('wechat')\n  const [userBalance, setUserBalance] = useState(0)\n  const [balanceLoading, setBalanceLoading] = useState(false)\n\n  const totalAmount = Number(amount) * Number(quantity)\n\n  // Ëé∑ÂèñÁî®Êà∑‰ΩôÈ¢ù\n  useEffect(() => {\n    fetchUserBalance()\n  }, [])\n\n  const fetchUserBalance = async () => {\n    try {\n      setBalanceLoading(true)\n      const balance = await walletService.getBalance()\n      setUserBalance(balance)\n\n      // Â¶ÇÊûú‰ΩôÈ¢ùÂÖÖË∂≥ÔºåÈªòËÆ§ÈÄâÊã©‰ΩôÈ¢ùÊîØ‰ªò\n      if (balance >= totalAmount) {\n        setPaymentMethod('balance')\n      }\n    } catch (error) {\n      console.error('Ëé∑Âèñ‰ΩôÈ¢ùÂ§±Ë¥•:', error)\n      setUserBalance(0)\n    } finally {\n      setBalanceLoading(false)\n    }\n  }\n\n  // Ê£ÄÊü•‰ΩôÈ¢ùÊòØÂê¶ÂÖÖË∂≥\n  const isBalanceSufficient = () => {\n    return userBalance >= totalAmount\n  }\n\n  // Â§ÑÁêÜÊîØ‰ªòÊñπÂºèÂàáÊç¢\n  const handlePaymentMethodChange = (method: 'wechat' | 'balance') => {\n    if (method === 'balance' && !isBalanceSufficient()) {\n      Taro.showToast({\n        title: '‰ΩôÈ¢ù‰∏çË∂≥ÔºåËØ∑ÂÖÖÂÄºÊàñ‰ΩøÁî®ÂÖ∂‰ªñÊîØ‰ªòÊñπÂºè',\n        icon: 'none',\n        duration: 2000\n      })\n      return\n    }\n    setPaymentMethod(method)\n  }\n\n  const handlePayment = async () => {\n    if (!orderNo) {\n      Taro.showToast({\n        title: 'ËÆ¢Âçï‰ø°ÊÅØÈîôËØØ',\n        icon: 'none'\n      })\n      return\n    }\n\n    // ‰ΩôÈ¢ùÊîØ‰ªòÂâçÂÜçÊ¨°Ê£ÄÊü•‰ΩôÈ¢ù\n    if (paymentMethod === 'balance' && !isBalanceSufficient()) {\n      Taro.showToast({\n        title: '‰ΩôÈ¢ù‰∏çË∂≥ÔºåËØ∑ÂÖÖÂÄºÊàñ‰ΩøÁî®ÂÖ∂‰ªñÊîØ‰ªòÊñπÂºè',\n        icon: 'none',\n        duration: 2000\n      })\n      return\n    }\n\n    try {\n      console.log('üéÅ ÂºÄÂßãÁ§ºÂç°ËÆ¢ÂçïÊîØ‰ªò:', {\n        orderNo,\n        paymentMethod,\n        totalAmount\n      })\n\n      // ‰ΩøÁî®Áªü‰∏ÄÁöÑÊîØ‰ªòÊúçÂä°Â§ÑÁêÜÊîØ‰ªò\n      // paymentService ÂÜÖÈÉ®‰ºöË∞ÉÁî®ÂêéÁ´ØËé∑ÂèñÊîØ‰ªòÂèÇÊï∞\n      const paymentSuccess = await paymentService.pay({\n        orderNo: orderNo as string,\n        amount: totalAmount * 100, // ËΩ¨Êç¢‰∏∫ÂàÜ\n        paymentMethod: paymentMethod,\n        title: `ÁîµÂ≠êÁ§ºÂç° ¬•${amount} √ó ${quantity}`\n      })\n\n      if (paymentSuccess) {\n        // ÊîØ‰ªòÊàêÂäüÂêéÊõ¥Êñ∞‰ΩôÈ¢ùÊòæÁ§∫\n        if (paymentMethod === 'balance') {\n          await fetchUserBalance()\n        }\n\n        setTimeout(() => {\n          // ÊîØ‰ªòÊàêÂäüÂêéË∑≥ËΩ¨Âà∞Á§ºÂç°ÂàóË°®ÊàñÊàëÁöÑÈ°µÈù¢\n          Taro.navigateBack({ delta: 2 })\n        }, 1500)\n      }\n      // Ê≥®ÊÑè: Â¶ÇÊûúÊîØ‰ªòÂ§±Ë¥•ÊàñÁî®Êà∑ÂèñÊ∂à, paymentService.pay() ÂÜÖÈÉ®Â∑≤ÁªèÊòæÁ§∫ÈîôËØØÊèêÁ§∫\n    } catch (error: any) {\n      console.error('‚ùå Á§ºÂç°ÊîØ‰ªòÊµÅÁ®ãÈîôËØØ:', error)\n      Taro.hideLoading()\n\n      // ÊòæÁ§∫ËØ¶ÁªÜÈîôËØØ‰ø°ÊÅØ\n      const errorMessage = error.message || error.errMsg || 'ÊîØ‰ªòÂ§±Ë¥•'\n      Taro.showModal({\n        title: 'ÊîØ‰ªòÂ§±Ë¥•',\n        content: errorMessage,\n        showCancel: false,\n        confirmText: 'Áü•ÈÅì‰∫Ü'\n      })\n    }\n  }\n\n  return (\n    <View className=\"order-confirm\">\n      {/* ËÆ¢Âçï‰ø°ÊÅØ */}\n      <View className=\"order-info\">\n        <Text className=\"section-title\">ÁîµÂ≠êÁ§ºÂç°</Text>\n        \n        <View className=\"card-item\">\n          <View className=\"card-preview\">\n            <Image \n              className=\"card-thumb\"\n              src=\"https://mingyitang1024.com/static/card/gift-card.png\"\n              mode=\"aspectFill\"\n            />\n            <View className=\"card-badge\">\n              <AtIcon value=\"tag\" size=\"12\" color=\"#fff\" />\n              <Text>‰∏ñÁïå‰∏äÊúÄÂ•ΩÁöÑÁà∏Áà∏</Text>\n            </View>\n          </View>\n          \n          <View className=\"card-details\">\n            <Text className=\"card-name\">ÁîµÂ≠êÁ§ºÂç°</Text>\n            <View className=\"price-quantity\">\n              <Text className=\"price\">¬• {amount}</Text>\n              <Text className=\"quantity\">√ó{quantity}</Text>\n            </View>\n          </View>\n        </View>\n      </View>\n\n      {/* ÊîØ‰ªòÊñπÂºè */}\n      <View className=\"payment-section\">\n        <Text className=\"section-title\">ÊîØ‰ªòÊñπÂºè</Text>\n\n        {/* ‰ΩôÈ¢ùÊîØ‰ªò */}\n        <View\n          className={`payment-method ${paymentMethod === 'balance' ? 'selected' : ''} ${!isBalanceSufficient() ? 'disabled' : ''}`}\n          onClick={() => handlePaymentMethodChange('balance')}\n        >\n          <View className=\"method-info\">\n            <AtIcon value=\"money\" size=\"20\" color=\"#FF6B00\" />\n            <Text className=\"method-name\">‰ΩôÈ¢ùÊîØ‰ªò</Text>\n            <Text className=\"balance-amount\">\n              {balanceLoading ? 'Âä†ËΩΩ‰∏≠...' : `¬•${userBalance.toFixed(2)}`}\n              {!isBalanceSufficient() && !balanceLoading && (\n                <Text className=\"insufficient\"> (‰ΩôÈ¢ù‰∏çË∂≥)</Text>\n              )}\n            </Text>\n          </View>\n          <AtIcon\n            value={paymentMethod === 'balance' ? 'check-circle' : 'circle'}\n            size=\"20\"\n            color={paymentMethod === 'balance' ? '#a40035' : '#999'}\n          />\n        </View>\n\n        {/* ÂæÆ‰ø°ÊîØ‰ªò */}\n        <View\n          className={`payment-method ${paymentMethod === 'wechat' ? 'selected' : ''}`}\n          onClick={() => handlePaymentMethodChange('wechat')}\n        >\n          <View className=\"method-info\">\n            <AtIcon value=\"sketch\" size=\"20\" color=\"#1AAD19\" />\n            <Text className=\"method-name\">ÂæÆ‰ø°ÊîØ‰ªò</Text>\n          </View>\n          <AtIcon\n            value={paymentMethod === 'wechat' ? 'check-circle' : 'circle'}\n            size=\"20\"\n            color={paymentMethod === 'wechat' ? '#a40035' : '#999'}\n          />\n        </View>\n      </View>\n\n      {/* Â∫ïÈÉ®ÊîØ‰ªòÊ†è */}\n      <View className=\"payment-bar\">\n        <View className=\"total-amount\">\n          <Text className=\"amount-symbol\">¬•</Text>\n          <Text className=\"amount-value\">{totalAmount}</Text>\n        </View>\n        <Button className=\"pay-btn\" onClick={handlePayment}>\n          ÂéªÊîØ‰ªò\n        </Button>\n      </View>\n    </View>\n  )\n}\n\nexport default OrderConfirm"],"names":["OrderConfirm","router","useRouter","orderNo","amount","quantity","params","paymentMethod","setPaymentMethod","useState","userBalance","setUserBalance","balanceLoading","setBalanceLoading","totalAmount","Number","useEffect","fetchUserBalance","balance","walletService","getBalance","error","isBalanceSufficient","handlePaymentMethodChange","method","Taro","showToast","title","icon","duration","handlePayment","console","log","paymentSuccess","paymentService","pay","setTimeout","navigateBack","delta","hideLoading","errorMessage","message","errMsg","showModal","content","showCancel","confirmText","jsxs","View","jsx","Text","Image","AtIcon","toFixed","Button"],"mappings":"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"}