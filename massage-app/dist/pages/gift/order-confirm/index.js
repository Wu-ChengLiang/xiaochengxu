"use strict";var e=(e,s,t)=>new Promise((a,o)=>{var n=e=>{try{i(t.next(e))}catch(s){o(s)}},r=e=>{try{i(t.throw(e))}catch(s){o(s)}},i=e=>e.done?a(e.value):Promise.resolve(e.value).then(n,r);i((t=t.apply(e,s)).next())});const s=require("../../../taro.js"),t=require("../../../vendors.js"),a=require("../../../common.js"),o="",n=()=>{const o=s.taroExports.useRouter(),{orderNo:n,amount:r,quantity:i}=o.params,[c,l]=s.reactExports.useState("wechat"),[x,m]=s.reactExports.useState(0),[d,u]=s.reactExports.useState(!1),j=Number(r)*Number(i);s.reactExports.useEffect(()=>{p()},[]);const p=()=>e(exports,null,function*(){try{u(!0);const e=yield a.walletService.getBalance();m(e),e>=j&&l("balance")}catch(e){console.error("\u83b7\u53d6\u4f59\u989d\u5931\u8d25:",e),m(0)}finally{u(!1)}}),h=()=>x>=j,E=e=>{"balance"!==e||h()?l(e):s.Taro.showToast({title:"\u4f59\u989d\u4e0d\u8db3\uff0c\u8bf7\u5145\u503c\u6216\u4f7f\u7528\u5176\u4ed6\u652f\u4ed8\u65b9\u5f0f",icon:"none",duration:2e3})},R=()=>e(exports,null,function*(){if(n)if("balance"!==c||h())try{console.log("\ud83c\udf81 \u5f00\u59cb\u793c\u5361\u8ba2\u5355\u652f\u4ed8:",{orderNo:n,paymentMethod:c,totalAmount:j}),s.Taro.showLoading({title:"\u51c6\u5907\u652f\u4ed8..."});const e=yield a.GiftService.payOrder({orderNo:n,paymentMethod:c});console.log("\ud83c\udf81 \u8ba2\u5355\u652f\u4ed8\u63a5\u53e3\u8fd4\u56de:",e),s.Taro.hideLoading();const t=yield a.paymentService.pay({orderNo:n,amount:100*j,paymentMethod:c,title:`\u7535\u5b50\u793c\u5361 \xa5${r} \xd7 ${i}`,wxPayParams:e.wxPayParams});t&&("balance"===c&&(yield p()),setTimeout(()=>{s.Taro.navigateBack({delta:2})},1500))}catch(e){console.error("\u274c \u793c\u5361\u652f\u4ed8\u6d41\u7a0b\u9519\u8bef:",e),s.Taro.hideLoading();const t=e.message||e.errMsg||"\u652f\u4ed8\u5931\u8d25";s.Taro.showModal({title:"\u652f\u4ed8\u5931\u8d25",content:t,showCancel:!1,confirmText:"\u77e5\u9053\u4e86"})}else s.Taro.showToast({title:"\u4f59\u989d\u4e0d\u8db3\uff0c\u8bf7\u5145\u503c\u6216\u4f7f\u7528\u5176\u4ed6\u652f\u4ed8\u65b9\u5f0f",icon:"none",duration:2e3});else s.Taro.showToast({title:"\u8ba2\u5355\u4fe1\u606f\u9519\u8bef",icon:"none"})});return s.jsxRuntimeExports.jsxs(s.View,{className:"order-confirm",children:[s.jsxRuntimeExports.jsxs(s.View,{className:"order-info",children:[s.jsxRuntimeExports.jsx(s.Text,{className:"section-title",children:"\u7535\u5b50\u793c\u5361"}),s.jsxRuntimeExports.jsxs(s.View,{className:"card-item",children:[s.jsxRuntimeExports.jsxs(s.View,{className:"card-preview",children:[s.jsxRuntimeExports.jsx(s.Image,{className:"card-thumb",src:"https://mingyitang1024.com/static/card/gift-card.png",mode:"aspectFill"}),s.jsxRuntimeExports.jsxs(s.View,{className:"card-badge",children:[s.jsxRuntimeExports.jsx(t.AtIcon,{value:"tag",size:"12",color:"#fff"}),s.jsxRuntimeExports.jsx(s.Text,{children:"\u4e16\u754c\u4e0a\u6700\u597d\u7684\u7238\u7238"})]})]}),s.jsxRuntimeExports.jsxs(s.View,{className:"card-details",children:[s.jsxRuntimeExports.jsx(s.Text,{className:"card-name",children:"\u7535\u5b50\u793c\u5361"}),s.jsxRuntimeExports.jsxs(s.View,{className:"price-quantity",children:[s.jsxRuntimeExports.jsxs(s.Text,{className:"price",children:["\xa5 ",r]}),s.jsxRuntimeExports.jsxs(s.Text,{className:"quantity",children:["\xd7",i]})]})]})]})]}),s.jsxRuntimeExports.jsxs(s.View,{className:"payment-section",children:[s.jsxRuntimeExports.jsx(s.Text,{className:"section-title",children:"\u652f\u4ed8\u65b9\u5f0f"}),s.jsxRuntimeExports.jsxs(s.View,{className:`payment-method ${"balance"===c?"selected":""} ${h()?"":"disabled"}`,onClick:()=>E("balance"),children:[s.jsxRuntimeExports.jsxs(s.View,{className:"method-info",children:[s.jsxRuntimeExports.jsx(t.AtIcon,{value:"money",size:"20",color:"#FF6B00"}),s.jsxRuntimeExports.jsx(s.Text,{className:"method-name",children:"\u4f59\u989d\u652f\u4ed8"}),s.jsxRuntimeExports.jsxs(s.Text,{className:"balance-amount",children:[d?"\u52a0\u8f7d\u4e2d...":`\xa5${x.toFixed(2)}`,!h()&&!d&&s.jsxRuntimeExports.jsx(s.Text,{className:"insufficient",children:" (\u4f59\u989d\u4e0d\u8db3)"})]})]}),s.jsxRuntimeExports.jsx(t.AtIcon,{value:"balance"===c?"check-circle":"circle",size:"20",color:"balance"===c?"#a40035":"#999"})]}),s.jsxRuntimeExports.jsxs(s.View,{className:"payment-method "+("wechat"===c?"selected":""),onClick:()=>E("wechat"),children:[s.jsxRuntimeExports.jsxs(s.View,{className:"method-info",children:[s.jsxRuntimeExports.jsx(t.AtIcon,{value:"sketch",size:"20",color:"#1AAD19"}),s.jsxRuntimeExports.jsx(s.Text,{className:"method-name",children:"\u5fae\u4fe1\u652f\u4ed8"})]}),s.jsxRuntimeExports.jsx(t.AtIcon,{value:"wechat"===c?"check-circle":"circle",size:"20",color:"wechat"===c?"#a40035":"#999"})]})]}),s.jsxRuntimeExports.jsxs(s.View,{className:"payment-bar",children:[s.jsxRuntimeExports.jsxs(s.View,{className:"total-amount",children:[s.jsxRuntimeExports.jsx(s.Text,{className:"amount-symbol",children:"\xa5"}),s.jsxRuntimeExports.jsx(s.Text,{className:"amount-value",children:j})]}),s.jsxRuntimeExports.jsx(s.Button,{className:"pay-btn",onClick:R,children:"\u53bb\u652f\u4ed8"})]})]})};var r={navigationBarTitleText:"\u8ba2\u5355\u786e\u8ba4"};Page(s.createPageConfig(n,"pages/gift/order-confirm/index",{root:{cn:[]}},r||{}));
