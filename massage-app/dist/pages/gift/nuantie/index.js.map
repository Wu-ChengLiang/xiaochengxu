{"version":3,"file":"index.js","sources":["../../../../src/pages/gift/nuantie/index.tsx"],"sourcesContent":["import React, { useState, useEffect } from 'react'\nimport { View, Text, Image, Button } from '@tarojs/components'\nimport Taro from '@tarojs/taro'\nimport { AtIcon } from 'taro-ui'\nimport { GiftService } from '@/services/gift.service'\nimport { paymentService } from '@/services/payment.service'\nimport { Product } from '@/types'\nimport './index.scss'\n\nconst NuantieDetail: React.FC = () => {\n  const [products, setProducts] = useState<Product[]>([])\n  const [selectedProduct, setSelectedProduct] = useState<Product | null>(null)\n  const [quantity, setQuantity] = useState(1)\n\n  useEffect(() => {\n    const nuantieProducts = GiftService.getNuantieProducts()\n    setProducts(nuantieProducts)\n    if (nuantieProducts.length > 0) {\n      setSelectedProduct(nuantieProducts[0])\n    }\n  }, [])\n\n  const handleProductSelect = (product: Product) => {\n    setSelectedProduct(product)\n    setQuantity(1)\n  }\n\n  const handleQuantityChange = (type: 'increase' | 'decrease') => {\n    if (type === 'increase') {\n      setQuantity(quantity + 1)\n    } else if (type === 'decrease' && quantity > 1) {\n      setQuantity(quantity - 1)\n    }\n  }\n\n  const handleBuyNow = async () => {\n    if (!selectedProduct) return\n\n    try {\n      Taro.showLoading({ title: '创建订单...' })\n\n      // 创建商品订单\n      const order = await GiftService.createProductOrder({\n        productId: selectedProduct.id,\n        quantity,\n        paymentMethod: 'wechat'\n      })\n\n      Taro.hideLoading()\n\n      // 使用统一的支付服务处理支付\n      const paymentSuccess = await paymentService.pay({\n        orderNo: order.orderNo,\n        amount: selectedProduct.price * quantity,\n        paymentMethod: 'wechat',\n        title: selectedProduct.name,\n        wxPayParams: order.wxPayParams\n      })\n\n      if (paymentSuccess) {\n        Taro.showToast({\n          title: '购买成功',\n          icon: 'success',\n          duration: 1500\n        })\n\n        setTimeout(() => {\n          Taro.navigateBack()\n        }, 1500)\n      }\n    } catch (error: any) {\n      Taro.hideLoading()\n\n      const errorMessage = error.message || error.errMsg || '购买失败'\n      Taro.showModal({\n        title: '购买失败',\n        content: errorMessage,\n        showCancel: false,\n        confirmText: '知道了'\n      })\n    }\n  }\n\n  const getTotalPrice = () => {\n    return selectedProduct ? (selectedProduct.price / 100 * quantity).toFixed(0) : '0'\n  }\n\n  if (!selectedProduct) {\n    return (\n      <View className=\"nuantie-page\">\n        <View className=\"loading\">加载中...</View>\n      </View>\n    )\n  }\n\n  return (\n    <View className=\"nuantie-page\">\n      {/* 产品信息 */}\n      <View className=\"product-info-section\">\n        <View className=\"product-image\">\n          <Image\n            className=\"product-pic\"\n            src={selectedProduct.image}\n            mode=\"aspectFill\"\n          />\n        </View>\n        <Text className=\"product-name\">{selectedProduct.name}</Text>\n        <Text className=\"product-desc\">{selectedProduct.description}</Text>\n      </View>\n\n      {/* 产品列表 */}\n      <View className=\"product-section\">\n        <Text className=\"section-title\">选择产品</Text>\n        <View className=\"product-grid\">\n          {products.map((item) => (\n            <View\n              key={item.id}\n              className={`product-card ${selectedProduct.id === item.id ? 'active' : ''}`}\n              onClick={() => handleProductSelect(item)}\n            >\n              <View className=\"product-header\">\n                <Text className=\"name\">{item.name}</Text>\n                <Text className=\"price\">¥{(item.price / 100).toFixed(0)}</Text>\n              </View>\n              <Text className=\"desc\">{item.description}</Text>\n              {selectedProduct.id === item.id && (\n                <AtIcon value=\"check-circle\" size=\"24\" color=\"#a40035\" />\n              )}\n            </View>\n          ))}\n        </View>\n      </View>\n\n      {/* 数量选择 */}\n      <View className=\"quantity-section\">\n        <Text className=\"section-title\">购买数量</Text>\n        <View className=\"quantity-selector\">\n          <View\n            className=\"quantity-btn\"\n            onClick={() => handleQuantityChange('decrease')}\n          >\n            <AtIcon value=\"subtract-circle\" size=\"20\" color={quantity === 1 ? '#ccc' : '#a40035'} />\n          </View>\n          <Text className=\"quantity-value\">{quantity}</Text>\n          <View\n            className=\"quantity-btn\"\n            onClick={() => handleQuantityChange('increase')}\n          >\n            <AtIcon value=\"add-circle\" size=\"20\" color=\"#a40035\" />\n          </View>\n        </View>\n      </View>\n\n      {/* 底部结算栏 */}\n      <View className=\"purchase-bar\">\n        <View className=\"price-info\">\n          <AtIcon value=\"shopping-bag-2\" size=\"24\" color=\"#a40035\" />\n          <Text className=\"total-price\">¥ {getTotalPrice()}</Text>\n          <View className=\"quantity-badge\">{quantity}</View>\n        </View>\n        <Button className=\"purchase-btn\" onClick={handleBuyNow}>\n          去结算\n        </Button>\n      </View>\n    </View>\n  )\n}\n\nexport default NuantieDetail\n"],"names":["NuantieDetail","products","setProducts","useState","selectedProduct","setSelectedProduct","quantity","setQuantity","useEffect","nuantieProducts","GiftService","getNuantieProducts","length","handleProductSelect","product","handleQuantityChange","type","handleBuyNow","Taro","showLoading","title","order","createProductOrder","productId","id","paymentMethod","hideLoading","paymentSuccess","paymentService","pay","orderNo","amount","price","name","wxPayParams","showToast","icon","duration","setTimeout","navigateBack","error","errorMessage","message","errMsg","showModal","content","showCancel","confirmText","getTotalPrice","toFixed","jsx","View","jsxs","Image","image","Text","description","map","item","AtIcon","Button"],"mappings":"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"}