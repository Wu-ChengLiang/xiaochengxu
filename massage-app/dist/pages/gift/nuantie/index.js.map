{"version":3,"file":"index.js","sources":["../../../../src/pages/gift/nuantie/index.tsx"],"sourcesContent":["import React, { useState, useEffect } from 'react'\nimport { View, Text, Image, Button, Swiper, SwiperItem } from '@tarojs/components'\nimport Taro from '@tarojs/taro'\nimport { AtIcon } from 'taro-ui'\nimport { GiftService } from '@/services/gift.service'\nimport { paymentService } from '@/services/payment.service'\nimport { Product } from '@/types'\nimport './index.scss'\n\nconst NuantieDetail: React.FC = () => {\n  const [products, setProducts] = useState<Product[]>([])\n  const [selectedProduct, setSelectedProduct] = useState<Product | null>(null)\n  const [quantity, setQuantity] = useState(1)\n  const [currentIndex, setCurrentIndex] = useState(0)\n  const [showModal, setShowModal] = useState(false)\n\n  useEffect(() => {\n    const nuantieProducts = GiftService.getNuantieProducts()\n    setProducts(nuantieProducts)\n    if (nuantieProducts.length > 0) {\n      setSelectedProduct(nuantieProducts[0])\n      // 自动弹出模态框\n      setShowModal(true)\n    }\n  }, [])\n\n  const handleProductSelect = (index: number) => {\n    setCurrentIndex(index)\n    setSelectedProduct(products[index])\n    setQuantity(1)\n  }\n\n  const handleSwiperChange = (e: any) => {\n    setCurrentIndex(e.detail.current)\n  }\n\n  const handleQuantityChange = (type: 'increase' | 'decrease') => {\n    if (type === 'increase') {\n      setQuantity(quantity + 1)\n    } else if (type === 'decrease' && quantity > 1) {\n      setQuantity(quantity - 1)\n    }\n  }\n\n  const handleBuyNow = async () => {\n    if (!selectedProduct) return\n\n    try {\n      Taro.showLoading({ title: '创建订单...' })\n\n      // 创建商品订单\n      const order = await GiftService.createProductOrder({\n        productId: selectedProduct.id,\n        quantity,\n        paymentMethod: 'wechat'\n      })\n\n      Taro.hideLoading()\n\n      // 使用统一的支付服务处理支付\n      const paymentSuccess = await paymentService.pay({\n        orderNo: order.orderNo,\n        amount: selectedProduct.price * 100 * quantity,\n        paymentMethod: 'wechat',\n        title: selectedProduct.name,\n        wxPayParams: order.wxPayParams\n      })\n\n      if (paymentSuccess) {\n        Taro.showToast({\n          title: '购买成功',\n          icon: 'success',\n          duration: 1500\n        })\n\n        setTimeout(() => {\n          Taro.navigateBack()\n        }, 1500)\n      }\n    } catch (error: any) {\n      Taro.hideLoading()\n\n      const errorMessage = error.message || error.errMsg || '购买失败'\n      Taro.showModal({\n        title: '购买失败',\n        content: errorMessage,\n        showCancel: false,\n        confirmText: '知道了'\n      })\n    }\n  }\n\n  const handleCloseModal = () => {\n    setShowModal(false)\n    Taro.navigateBack()\n  }\n\n  if (!selectedProduct) {\n    return (\n      <View className=\"nuantie-page\">\n        <View className=\"loading\">加载中...</View>\n      </View>\n    )\n  }\n\n  return (\n    <View className=\"nuantie-page\">\n      {showModal && (\n        <View className=\"modal-overlay\" onClick={handleCloseModal}>\n          <View className=\"modal-content\" onClick={(e) => e.stopPropagation()}>\n            {/* 上半部分：图片轮播卡片 */}\n            <View className=\"modal-top\">\n              <View className=\"carousel-container\">\n                <Swiper\n                  className=\"product-swiper\"\n                  circular\n                  current={currentIndex}\n                  onChange={handleSwiperChange}\n                >\n                  {products.map((product, index) => (\n                    <SwiperItem key={product.id}>\n                      <Image\n                        className=\"product-image\"\n                        src={product.image}\n                        mode=\"aspectFill\"\n                      />\n                    </SwiperItem>\n                  ))}\n                </Swiper>\n\n                {/* 分页指示器 */}\n                <View className=\"pagination-dots\">\n                  {products.map((_, index) => (\n                    <View\n                      key={index}\n                      className={`dot ${currentIndex === index ? 'active' : ''}`}\n                    />\n                  ))}\n                </View>\n              </View>\n\n              <View className=\"close-btn\" onClick={handleCloseModal}>\n                <AtIcon value=\"close\" size=\"24\" color=\"#fff\" />\n              </View>\n            </View>\n\n            {/* 下半部分：产品选择和购买 */}\n            <View className=\"modal-bottom\">\n              {/* 产品列表 */}\n              <View className=\"product-list\">\n                {products.map((product, index) => (\n                  <View\n                    key={product.id}\n                    className={`product-item ${selectedProduct.id === product.id ? 'active' : ''}`}\n                    onClick={() => handleProductSelect(index)}\n                  >\n                    <View className=\"product-header\">\n                      <Text className=\"product-name\">{product.name}</Text>\n                      <Text className=\"product-price\">¥{(product.price / 100).toFixed(0)}</Text>\n                    </View>\n                    <Text className=\"product-desc\">{product.description}</Text>\n                  </View>\n                ))}\n              </View>\n\n              {/* 数量选择 */}\n              <View className=\"quantity-section\">\n                <Text className=\"label\">购买数量</Text>\n                <View className=\"quantity-selector\">\n                  <View\n                    className=\"quantity-btn\"\n                    onClick={() => handleQuantityChange('decrease')}\n                  >\n                    <AtIcon value=\"subtract\" size=\"20\" color={quantity === 1 ? '#ccc' : '#333'} />\n                  </View>\n                  <Text className=\"quantity-value\">{quantity}</Text>\n                  <View\n                    className=\"quantity-btn\"\n                    onClick={() => handleQuantityChange('increase')}\n                  >\n                    <AtIcon value=\"add\" size=\"20\" color=\"#333\" />\n                  </View>\n                </View>\n              </View>\n\n              {/* 购买按钮 */}\n              <View className=\"action-bar\">\n                <Button className=\"buy-btn\" onClick={handleBuyNow}>\n                  立即购买 ¥{(selectedProduct.price / 100 * quantity).toFixed(0)}\n                </Button>\n              </View>\n            </View>\n          </View>\n        </View>\n      )}\n    </View>\n  )\n}\n\nexport default NuantieDetail\n"],"names":["NuantieDetail","products","setProducts","useState","selectedProduct","setSelectedProduct","quantity","setQuantity","currentIndex","setCurrentIndex","showModal","setShowModal","useEffect","nuantieProducts","GiftService","getNuantieProducts","length","handleProductSelect","index","handleSwiperChange","e","detail","current","handleQuantityChange","type","handleBuyNow","Taro","showLoading","title","order","createProductOrder","productId","id","paymentMethod","hideLoading","paymentSuccess","paymentService","pay","orderNo","amount","price","name","wxPayParams","showToast","icon","duration","setTimeout","navigateBack","error","errorMessage","message","errMsg","content","showCancel","confirmText","handleCloseModal","jsx","View","jsxs","stopPropagation","Swiper","map","product","SwiperItem","Image","image","_","AtIcon","Text","toFixed","description","Button"],"mappings":"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"}