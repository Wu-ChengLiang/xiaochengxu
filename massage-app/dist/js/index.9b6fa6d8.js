var e=Object.defineProperty,t=Object.defineProperties,s=Object.getOwnPropertyDescriptors,a=Object.getOwnPropertySymbols,r=Object.prototype.hasOwnProperty,c=Object.prototype.propertyIsEnumerable,i=(t,s,a)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[s]=a,n=(e,t)=>{for(var s in t||(t={}))r.call(t,s)&&i(e,s,t[s]);if(a)for(var s of a(t))c.call(t,s)&&i(e,s,t[s]);return e},l=(e,a)=>t(e,s(a)),o=(e,t,s)=>new Promise((a,r)=>{var c=e=>{try{n(s.next(e))}catch(t){r(t)}},i=e=>{try{n(s.throw(e))}catch(t){r(t)}},n=e=>e.done?a(e.value):Promise.resolve(e.value).then(c,i);n((s=s.apply(e,t)).next())});import{w as d,a as m,q as h,o as p,j as u,V as N,D as j,T as x,I as v,H as y,J as f,K as g}from"./vendors.b1a33877.js";import{t as S,s as b,o as w}from"./common.d37aa707.js";const I=()=>{const e=d.useRouter(),t=e.params,[s,a]=m.useState([]),[r,c]=m.useState(null),[i,I]=m.useState(null),[P,O]=m.useState(!0),[k,D]=m.useState(180),[$,M]=m.useState("wechat"),T=m.useRef(null);m.useEffect(()=>{try{const e=JSON.parse(decodeURIComponent(t.items||"[]"));a(e),C()}catch(e){h({title:"\u6570\u636e\u89e3\u6790\u5931\u8d25",icon:"none"}),setTimeout(()=>d.navigateBack(),1500)}},[t]),m.useEffect(()=>(!P&&s.length>0&&(T.current=setInterval(()=>{D(e=>e<=1?(clearInterval(T.current),p({title:"\u652f\u4ed8\u8d85\u65f6\u4e86\u5466",content:"\u5feb\u5feb\u91cd\u65b0\u4e0b\u5355\u5427~",showCancel:!1,success:()=>{d.navigateBack()}}),0):e-1)},1e3)),()=>{T.current&&clearInterval(T.current)}),[P,s]);const C=()=>o(void 0,null,function*(){try{O(!0);const e=yield S.getTherapistDetail(t.therapistId),s=e.data,a=yield b.getStoreDetail(t.storeId),r=a.data;c(s),I(r),O(!1)}catch(e){O(!1),h({title:"\u83b7\u53d6\u4fe1\u606f\u5931\u8d25",icon:"none"})}}),A=e=>{const t=Math.floor(e/60),s=e%60;return`${t.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`},E=e=>{const t=new Date(e),s=t.getMonth()+1,a=t.getDate();return`${s.toString().padStart(2,"0")}\u6708${a.toString().padStart(2,"0")}\u65e5`},R=(e,t)=>{const[s,a]=e.split(":").map(Number),r=a+t,c=s+Math.floor(r/60),i=r%60;return`${c}:${i.toString().padStart(2,"0")}`},q=()=>s.reduce((e,t)=>e+(t.discountPrice||t.price),0),B=()=>o(void 0,null,function*(){if(0!==s.length&&r&&i)try{y({title:"\u521b\u5efa\u8ba2\u5355..."});const e=s[0],a={therapistId:t.therapistId,storeId:t.storeId,serviceId:e.serviceId,serviceName:e.serviceName,duration:e.duration,price:e.price,discountPrice:e.discountPrice,appointmentDate:e.date,appointmentTime:e.time,therapistName:e.therapistName,therapistAvatar:e.therapistAvatar||r.avatar},c=yield w.createOrder(a);f(),y({title:"\u6b63\u5728\u652f\u4ed8..."});const i=yield w.getPaymentParams(c.orderNo);f(),g(l(n({},i),{success:()=>o(void 0,null,function*(){yield w.updateOrderStatus(c.orderNo,"paid"),h({title:"\u652f\u4ed8\u6210\u529f",icon:"success",duration:1500}),setTimeout(()=>{d.redirectTo({url:`/pages/booking/success/index?orderNo=${c.orderNo}`})},1500)}),fail:e=>{console.error("\u652f\u4ed8\u5931\u8d25:",e),"requestPayment:fail cancel"!==e.errMsg&&(e.errMsg&&e.errMsg.includes("total_fee")?h({title:"\u652f\u4ed8\u53c2\u6570\u9519\u8bef\uff1a\u7f3a\u5c11\u91d1\u989d\u4fe1\u606f",icon:"none",duration:2500}):h({title:"\u652f\u4ed8\u5931\u8d25",icon:"none"}))}}))}catch(e){f(),h({title:e.message||"\u8ba2\u5355\u521b\u5efa\u5931\u8d25",icon:"none"})}else h({title:"\u8ba2\u5355\u4fe1\u606f\u4e0d\u5b8c\u6574",icon:"none"})});return P?u.jsx(N,{className:"order-confirm-page",children:u.jsx(N,{className:"loading",children:"\u52a0\u8f7d\u4e2d..."})}):u.jsxs(j,{className:"order-confirm-page",scrollY:!0,children:[u.jsxs(N,{className:"store-section",children:[u.jsx(x,{className:"store-name",children:null==i?void 0:i.name}),u.jsxs(x,{className:"store-distance",children:["\ud83d\udccd ",null==i?void 0:i.distance,"km"]})]}),u.jsx(N,{className:"booking-info",children:s.map((e,t)=>u.jsxs(N,{className:"booking-item",children:[u.jsx(v,{className:"therapist-avatar",src:e.therapistAvatar||(null==r?void 0:r.avatar)}),u.jsxs(N,{className:"booking-details",children:[u.jsx(N,{className:"therapist-name",children:e.therapistName}),u.jsxs(N,{className:"service-time",children:[E(e.date)," ",e.time," \u81f3 ",R(e.time,e.duration)]}),u.jsx(N,{className:"service-name",children:e.serviceName})]}),u.jsxs(N,{className:"service-price",children:["\xa5",e.discountPrice||e.price]})]},t))}),u.jsxs(N,{className:"refund-policy",children:[u.jsx(x,{className:"policy-title",children:"\u9000\u5355\u8bf4\u660e"}),u.jsxs(N,{className:"policy-list",children:[u.jsx(N,{className:"policy-item",children:"\u2022 \u4e0b\u535515\u5206\u949f\u5185\u6216\u8ddd\u8ba2\u5355\u5f00\u59cb\u65f6\u95f4>6\u5c0f\u65f6\u9000\u5355\uff0c\u9000100%"}),u.jsx(N,{className:"policy-item",children:"\u2022 \u8ddd\u8ba2\u5355\u5f00\u59cb\u524d<6\u5c0f\u65f6\u9000\u5355\uff0c\u9000\u5b9e\u4ed8\u91d1\u989d90%"}),u.jsx(N,{className:"policy-item",children:"\u2022 \u8ba2\u5355\u65f6\u95f4\u5f00\u59cb\u540e\u9000\u5355\uff0c\u9000\u5b9e\u4ed8\u91d1\u989d80%"})]})]}),u.jsxs(N,{className:"customer-note",children:[u.jsx(x,{className:"note-title",children:"\u5ba2\u6237\u5907\u6ce8"}),u.jsx(x,{className:"note-hint",children:"\u60a8\u5bf9\u8336\u6c34\u3001\u623f\u95f4\u3001\u6309\u6469\u670d\u7b49\u662f\u5426\u6709\u7279\u6b8a\u9700\u6c42\uff0c\u6211\u4eec\u5c06\u63d0\u524d\u4e3a\u60a8\u505a\u597d\u51c6\u5907"})]}),u.jsxs(N,{className:"payment-section",children:[u.jsx(x,{className:"section-title",children:"\u652f\u4ed8\u65b9\u5f0f"}),u.jsx(N,{className:"payment-methods",children:u.jsxs(N,{className:"payment-method "+("wechat"===$?"active":""),onClick:()=>M("wechat"),children:[u.jsxs(N,{className:"method-info",children:[u.jsx(x,{className:"method-icon",children:"\u2705"}),u.jsx(x,{className:"method-name",children:"\u5fae\u4fe1\u652f\u4ed8"})]}),u.jsx(N,{className:"check-icon "+("wechat"===$?"checked":"")})]})})]}),u.jsxs(N,{className:"payment-bar",children:[u.jsxs(N,{className:"price-info",children:[u.jsxs(x,{className:"total-price",children:["\xa5 ",q()]}),u.jsxs(x,{className:"countdown",children:["\u652f\u4ed8\u5012\u8ba1\u65f6: ",A(k)]})]}),u.jsx(N,{className:"pay-button",onClick:B,children:"\u53bb\u652f\u4ed8"})]})]})};export{I as default};
