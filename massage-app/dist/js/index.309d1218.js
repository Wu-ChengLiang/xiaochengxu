var e=Object.defineProperty,s=Object.defineProperties,t=Object.getOwnPropertyDescriptors,a=Object.getOwnPropertySymbols,l=Object.prototype.hasOwnProperty,c=Object.prototype.propertyIsEnumerable,r=(s,t,a)=>t in s?e(s,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):s[t]=a,i=(e,s)=>{for(var t in s||(s={}))l.call(s,t)&&r(e,t,s[t]);if(a)for(var t of a(s))c.call(s,t)&&r(e,t,s[t]);return e},n=(e,a)=>s(e,t(a)),o=(e,s,t)=>new Promise((a,l)=>{var c=e=>{try{i(t.next(e))}catch(s){l(s)}},r=e=>{try{i(t.throw(e))}catch(s){l(s)}},i=e=>e.done?a(e.value):Promise.resolve(e.value).then(c,r);i((t=t.apply(e,s)).next())});import{j as d,V as h,I as u,T as m,C as x,n as j,k as p,D as N,t as y}from"./vendors.fcaa4701.js";import{n as v,B as f,r as g,g as b,s as S,t as k}from"./common.326c60a3.js";const C=({store:e,onClick:s})=>{const t=e=>{switch(e){case"normal":return"\u5c31\u8fd1";case"busy":return"\u7e41\u5fd9";case"full":return"\u7206\u6ee1";default:return""}},a=e=>{switch(e){case"normal":return"status-normal";case"busy":return"status-busy";case"full":return"status-full";default:return""}};return d.jsx(h,{className:"store-card",onClick:s,children:d.jsxs(h,{className:"card-content",children:[d.jsx(h,{className:"store-image-wrapper",children:d.jsx(u,{className:"store-image",src:v(e.image),mode:"aspectFill"})}),d.jsxs(h,{className:"store-info",children:[d.jsx(m,{className:"store-name",children:e.name}),d.jsxs(h,{className:"business-hours",children:[d.jsx(m,{className:"hours-text",children:e.businessHours}),d.jsx(m,{className:`status ${a(e.status)}`,children:t(e.status)})]}),d.jsx(h,{className:"store-address",children:d.jsx(m,{className:"address-text",numberOfLines:1,children:e.address})}),d.jsxs(h,{className:"store-footer",children:[void 0!==e.distance&&null!==e.distance&&d.jsxs(h,{className:"distance",children:[d.jsx(x,{value:"map-pin",size:"12",color:"#999"}),d.jsxs(m,{className:"distance-text",children:[e.distance,"km"]})]}),d.jsx(f,{size:"small"})]})]})]})})},w=({therapist:e,onClick:s})=>{const[t,a]=j.useState(null),[l,c]=j.useState(!0);j.useEffect(()=>{const s=()=>o(void 0,null,function*(){try{const s=yield g.getReviewStats(e.id);a(s)}catch(s){console.error("\u83b7\u53d6\u63a8\u62ff\u5e08\u8bc4\u4ef7\u7edf\u8ba1\u5931\u8d25:",s),a(null)}finally{c(!1)}});s()},[e.id]);const r=()=>l?"...":t&&0!==t.totalCount?`${t.averageRating}\u5206`:"\u5f85\u8bc4\u4ef7";return d.jsx(h,{className:"therapist-card",onClick:s,children:d.jsxs(h,{className:"card-content",children:[d.jsx(u,{className:"therapist-avatar",src:e.avatar,mode:"aspectFill"}),d.jsxs(h,{className:"therapist-info",children:[d.jsxs(h,{className:"info-header",children:[d.jsx(m,{className:"therapist-name",children:e.name}),void 0!==e.distance&&null!==e.distance&&d.jsxs(h,{className:"distance",children:[d.jsx(x,{value:"map-pin",size:"12",color:"#999"}),d.jsxs(m,{className:"distance-text",children:[e.distance,"km"]})]})]}),d.jsx(h,{className:"expertise-tags",children:e.expertise.map((e,s)=>d.jsx(m,{className:"expertise-tag",children:e},s))}),d.jsxs(h,{className:"therapist-footer",children:[d.jsxs(h,{className:"rating",children:[d.jsx(x,{value:"star-2",size:"12",color:"#faad14"}),d.jsx(m,{className:"rating-text",children:r()})]}),d.jsx(f,{size:"small"})]})]})]})})},z=({visible:e,title:s,onClose:t,children:a,height:l="70%"})=>{const[c,r]=j.useState(!1),[i,n]=j.useState(!1);j.useEffect(()=>{e?(n(!0),setTimeout(()=>r(!0),50)):(r(!1),setTimeout(()=>n(!1),300))},[e]);const o=()=>{t()},u=e=>{e.stopPropagation()};return i?d.jsxs(h,{className:"bottom-sheet",onClick:o,children:[d.jsx(h,{className:"bottom-sheet-mask "+(c?"active":"")}),d.jsxs(h,{className:"bottom-sheet-content "+(c?"active":""),style:{height:l},onClick:u,children:[d.jsxs(h,{className:"sheet-header",children:[d.jsx(m,{className:"sheet-title",children:s}),d.jsx(h,{className:"close-btn",onClick:t,children:d.jsx(x,{value:"close",size:"20",color:"#999"})})]}),d.jsx(h,{className:"sheet-body",children:a})]})]}):null},O=()=>{const[e,s]=j.useState(!0),[t,a]=j.useState([]),[l,c]=j.useState([]),[r,u]=j.useState([]),[v,f]=j.useState(!1),[g,O]=j.useState(""),[P,I]=j.useState(!1),[T,D]=j.useState(""),[$,E]=j.useState([]),[R,F]=j.useState(!1),[L,W]=j.useState(null);j.useEffect(()=>{B()},[]);const B=()=>o(void 0,null,function*(){try{s(!0);const t=yield b.getCurrentLocation();W(t);try{const e=yield S.getNearbyStores(t.latitude,t.longitude,1,2);a(e.list)}catch(e){console.error("\u274c \u83b7\u53d6\u9644\u8fd1\u95e8\u5e97\u5931\u8d25:",e),p({title:"\u83b7\u53d6\u9644\u8fd1\u95e8\u5e97\u5931\u8d25\uff0c\u8bf7\u68c0\u67e5\u7f51\u7edc",icon:"none"}),a([])}try{const e=yield S.getNearbyStores(t.latitude,t.longitude,1,20);c(e.list)}catch(e){console.error("\u274c \u83b7\u53d6\u6240\u6709\u95e8\u5e97\u5931\u8d25:",e),c([])}try{const e=yield k.getRecommendedTherapistsWithDistance(1,10);u(e.list)}catch(e){console.error("\u274c \u83b7\u53d6\u63a8\u8350\u63a8\u62ff\u5e08\u5931\u8d25:",e),p({title:"\u83b7\u53d6\u63a8\u62ff\u5e08\u5217\u8868\u5931\u8d25\uff0c\u8bf7\u68c0\u67e5\u7f51\u7edc",icon:"none"}),u([])}}catch(e){console.error("\u274c \u52a0\u8f7d\u9875\u9762\u6570\u636e\u5931\u8d25:",e),p({title:"\u9875\u9762\u52a0\u8f7d\u5931\u8d25\uff0c\u8bf7\u5237\u65b0\u91cd\u8bd5",icon:"none"})}finally{s(!1)}}),H=e=>{y.navigateTo({url:`/pages/appointment/store/index?id=${e.id}`})},V=e=>{y.navigateTo({url:`/pages/appointment/therapist/index?therapistId=${e.id}&storeId=${e.storeId}`})},q=()=>{f(!0)},A=()=>o(void 0,null,function*(){I(!0),D(""),F(!0);try{const e=yield k.getRecommendedTherapistsWithDistance(1,100),s=yield G(e.list||[]);E(s)}catch(e){console.error("\u83b7\u53d6\u5168\u90e8\u6280\u5e08\u5931\u8d25:",e),E([])}finally{F(!1)}}),G=e=>o(void 0,null,function*(){if(!L)return e;try{const s=yield Promise.all(e.map(e=>o(void 0,null,function*(){try{const s=yield S.getStoreDetail(e.storeId),t=(null==s?void 0:s.data)||s;let a=null;return(null==t?void 0:t.latitude)&&(null==t?void 0:t.longitude)&&(a=b.calculateDistance(L.latitude,L.longitude,t.latitude,t.longitude)),n(i({},e),{distance:a})}catch(s){return console.warn(`\u83b7\u53d6\u6280\u5e08 ${e.id} \u95e8\u5e97\u4fe1\u606f\u5931\u8d25:`,s),n(i({},e),{distance:null})}})));return s}catch(s){return console.error("\u8ba1\u7b97\u8ddd\u79bb\u5931\u8d25:",s),e}}),J=e=>o(void 0,null,function*(){if(D(e),""!==e.trim())try{F(!0);const s=yield k.searchTherapists(e,1,10);console.log("\u2705 \u641c\u7d22\u6280\u5e08\u7ed3\u679c:",s);const t=yield G(s.list||[]);E(t)}catch(s){console.error("\u641c\u7d22\u6280\u5e08\u5931\u8d25:",s),p({title:"\u641c\u7d22\u5931\u8d25\uff0c\u8bf7\u91cd\u8bd5",icon:"none"}),E([])}finally{F(!1)}else E([])});return d.jsxs(h,{className:"appointment-page",children:[d.jsxs(h,{className:"stores-section",children:[d.jsxs(h,{className:"section-header",children:[d.jsx(m,{className:"section-title",children:"\u95e8\u5e97\u9884\u7ea6"}),d.jsxs(m,{className:"more-link",onClick:q,children:["\u66f4\u591a\u95e8\u5e97",d.jsx(x,{value:"chevron-right",size:"14",color:"#a40035"})]})]}),d.jsx(h,{className:"store-list",children:t.map(e=>d.jsx(C,{store:e,onClick:()=>H(e)},e.id))})]}),d.jsxs(h,{className:"therapists-section",children:[d.jsxs(h,{className:"section-header",children:[d.jsx(m,{className:"section-title",children:"\u63a8\u62ff\u5e08\u9884\u7ea6"}),d.jsxs(m,{className:"more-link",onClick:A,children:["\u66f4\u591a\u6280\u5e08",d.jsx(x,{value:"chevron-right",size:"14",color:"#a40035"})]})]}),d.jsx(h,{className:"therapist-list",children:r.map(e=>d.jsx(w,{therapist:e,onClick:()=>V(e)},e.id))})]}),d.jsxs(z,{visible:v,title:"\u66f4\u591a\u95e8\u5e97",onClose:()=>f(!1),height:"80%",children:[d.jsxs(h,{className:"store-sheet-header",children:[d.jsxs(h,{className:"city-selector",children:[d.jsx(m,{className:"city-name",children:"\u4e0a\u6d77\u5e02"}),d.jsx(m,{className:"city-arrow",children:"\u25bc"})]}),d.jsxs(h,{className:"search-box",children:[d.jsx(x,{value:"search",size:"16",color:"#999"}),d.jsx(N,{className:"search-input",placeholder:"\u641c\u7d22\u95e8\u5e97",value:g,onInput:e=>O(e.detail.value)})]})]}),d.jsx(h,{className:"store-sheet-list",children:l.filter(e=>""===g||e.name.includes(g)||e.address.includes(g)).map(e=>d.jsx(C,{store:e,onClick:()=>{H(e),f(!1)}},e.id))})]}),d.jsxs(z,{visible:P,title:"\u66f4\u591a\u6280\u5e08",onClose:()=>I(!1),height:"80%",children:[d.jsx(h,{className:"therapist-sheet-header",children:d.jsxs(h,{className:"search-box",children:[d.jsx(x,{value:"search",size:"16",color:"#999"}),d.jsx(N,{className:"search-input",placeholder:"\u641c\u7d22\u63a8\u62ff\u5e08",value:T,onInput:e=>J(e.detail.value)})]})}),R&&d.jsx(h,{className:"therapist-sheet-list loading",children:d.jsx(m,{children:"\u641c\u7d22\u4e2d..."})}),!R&&d.jsx(h,{className:"therapist-sheet-list",children:0===$.length?d.jsx(h,{className:"empty-state",children:d.jsx(m,{children:"\u672a\u627e\u5230\u5339\u914d\u7684\u63a8\u62ff\u5e08"})}):$.map(e=>d.jsx(w,{therapist:e,onClick:()=>{V(e),I(!1)}},e.id))})]})]})};export{O as default};
