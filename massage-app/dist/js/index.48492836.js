var s=(s,e,a)=>new Promise((t,c)=>{var i=s=>{try{n(a.next(s))}catch(e){c(e)}},l=s=>{try{n(a.throw(s))}catch(e){c(e)}},n=s=>s.done?t(s.value):Promise.resolve(s.value).then(i,l);n((a=a.apply(s,e)).next())});import{l as e,m as a,n as t,o as c,p as i,j as l,V as n,I as r,T as o,a as d,A as h,q as m,S as u,u as x,v as j,w as N}from"./vendors.b1a33877.js";import{B as p,s as g,t as y,b as v}from"./common.d37aa707.js";class f{getCurrentLocation(){return s(this,null,function*(){var s;try{const{authSetting:s}=yield e();s["scope.userLocation"]||(yield a({scope:"scope.userLocation"}));const c=yield t({type:"gcj02",isHighAccuracy:!0});return{latitude:c.latitude,longitude:c.longitude}}catch(l){if(console.error("\u83b7\u53d6\u4f4d\u7f6e\u5931\u8d25:",l),null==(s=null==l?void 0:l.errMsg)?void 0:s.includes("auth deny"))return c({title:"\u63d0\u793a",content:"\u9700\u8981\u83b7\u53d6\u60a8\u7684\u4f4d\u7f6e\u4fe1\u606f\u6765\u63a8\u8350\u9644\u8fd1\u95e8\u5e97",confirmText:"\u53bb\u8bbe\u7f6e",success:s=>{s.confirm&&i()}}),{latitude:31.2304,longitude:121.4737};throw l}})}calculateDistance(s,e,a,t){const c=Math.PI/180,i=6371,l=(a-s)*c,n=(t-e)*c,r=Math.sin(l/2)*Math.sin(l/2)+Math.cos(s*c)*Math.cos(a*c)*Math.sin(n/2)*Math.sin(n/2),o=2*Math.atan2(Math.sqrt(r),Math.sqrt(1-r));return Number((i*o).toFixed(1))}formatDistance(s){return s<1?`${Math.round(1e3*s)}m`:`${s}km`}}const b=new f,k=({store:s,onClick:e})=>{const a=s=>{switch(s){case"normal":return"\u5c31\u8fd1";case"busy":return"\u7e41\u5fd9";case"full":return"\u7206\u6ee1";default:return""}},t=s=>{switch(s){case"normal":return"status-normal";case"busy":return"status-busy";case"full":return"status-full";default:return""}};return l.jsx(n,{className:"store-card",onClick:e,children:l.jsxs(n,{className:"card-content",children:[l.jsx(n,{className:"store-image-wrapper",children:l.jsx(r,{className:"store-image",src:s.images[0],mode:"aspectFill"})}),l.jsxs(n,{className:"store-info",children:[l.jsx(o,{className:"store-name",children:s.name}),l.jsxs(n,{className:"business-hours",children:[l.jsxs(o,{className:"hours-text",children:[s.businessHours.start,"-",s.businessHours.end]}),l.jsx(o,{className:`status ${t(s.status)}`,children:a(s.status)})]}),l.jsx(n,{className:"store-address",children:l.jsx(o,{className:"address-text",numberOfLines:1,children:s.address})}),l.jsxs(n,{className:"store-footer",children:[l.jsxs(n,{className:"distance",children:[l.jsx(o,{className:"icon",children:"\ud83d\udccd"}),l.jsxs(o,{className:"distance-text",children:[s.distance,"km"]})]}),l.jsx(p,{size:"small"})]})]})]})})},C=({therapist:s,onClick:e})=>l.jsx(n,{className:"therapist-card",onClick:e,children:l.jsxs(n,{className:"card-content",children:[l.jsx(r,{className:"therapist-avatar",src:s.avatar,mode:"aspectFill"}),l.jsxs(n,{className:"therapist-info",children:[l.jsxs(n,{className:"info-header",children:[l.jsx(o,{className:"therapist-name",children:s.name}),l.jsxs(n,{className:"distance",children:[l.jsx(o,{className:"icon",children:"\ud83d\udccd"}),l.jsxs(o,{className:"distance-text",children:[s.distance,"km"]})]})]}),l.jsx(n,{className:"expertise-tags",children:s.expertise.map((s,e)=>l.jsx(o,{className:"expertise-tag",children:s},e))}),l.jsxs(n,{className:"therapist-footer",children:[l.jsxs(n,{className:"rating",children:[l.jsx(o,{className:"icon",children:"\u2b50"}),l.jsxs(o,{className:"rating-text",children:[s.rating,"\u5206"]}),l.jsxs(o,{className:"service-count",children:["\u670d\u52a1",s.serviceCount,"\u6b21"]})]}),l.jsx(p,{size:"small"})]})]})]})}),S=({visible:s,title:e,onClose:a,children:t,height:c="70%"})=>{const[i,r]=d.useState(!1),[m,u]=d.useState(!1);d.useEffect(()=>{s?(u(!0),setTimeout(()=>r(!0),50)):(r(!1),setTimeout(()=>u(!1),300))},[s]);const x=()=>{a()},j=s=>{s.stopPropagation()};return m?l.jsxs(n,{className:"bottom-sheet",onClick:x,children:[l.jsx(n,{className:"bottom-sheet-mask "+(i?"active":"")}),l.jsxs(n,{className:"bottom-sheet-content "+(i?"active":""),style:{height:c},onClick:j,children:[l.jsxs(n,{className:"sheet-header",children:[l.jsx(o,{className:"sheet-title",children:e}),l.jsx(n,{className:"close-btn",onClick:a,children:l.jsx(h,{value:"close",size:"20",color:"#999"})})]}),l.jsx(n,{className:"sheet-body",children:t})]})]}):null},M=()=>{const[e,a]=d.useState(!0),[t,c]=d.useState([]),[i,h]=d.useState([]),[p,f]=d.useState([]),[M,w]=d.useState({latitude:0,longitude:0}),[T,$]=d.useState("loading"),[I,F]=d.useState("\u6b63\u5728\u83b7\u53d6\u4f4d\u7f6e..."),[L,D]=d.useState(!1),[P,q]=d.useState(""),z=[{id:1,image:v,title:"\u665a\u5b89\u597d\u7720",subtitle:"\u6df1\u5ea6\u653e\u677e\u52a9\u7720\u670d\u52a1",link:""}];d.useEffect(()=>{A()},[]);const A=()=>s(void 0,null,function*(){try{a(!0),$("loading"),F("\u6b63\u5728\u83b7\u53d6\u4f4d\u7f6e...");const s=yield b.getCurrentLocation();w(s),31.2304===s.latitude&&121.4737===s.longitude?($("error"),F("\u5b9a\u4f4d\u5931\u8d25\uff0c\u4f7f\u7528\u9ed8\u8ba4\u4f4d\u7f6e")):($("success"),F("\u5b9a\u4f4d\u6210\u529f"),setTimeout(()=>{F("\u4e0a\u6d77\u5e02")},2e3));const e=yield g.getNearbyStores(s.latitude,s.longitude,1,2);c(e.list);const t=yield g.getNearbyStores(s.latitude,s.longitude,1,20);h(t.list);const i=yield y.getRecommendedTherapists(1,10,s);f(i.list)}catch(s){console.error("\u52a0\u8f7d\u6570\u636e\u5931\u8d25:",s),$("error"),F("\u5b9a\u4f4d\u5931\u8d25"),m({title:"\u52a0\u8f7d\u5931\u8d25\uff0c\u8bf7\u91cd\u8bd5",icon:"none"})}finally{a(!1)}}),H=s=>{N.navigateTo({url:`/pages/appointment/store/index?id=${s.id}`})},E=s=>{N.navigateTo({url:`/pages/appointment/therapist/index?therapistId=${s.id}&storeId=${s.storeId}`})},B=()=>{D(!0)},O=()=>{m({title:"\u529f\u80fd\u5f00\u53d1\u4e2d",icon:"none"})},R=s=>{N.navigateTo({url:"/pages/promotion/index"})};return l.jsxs(n,{className:"appointment-page",children:[l.jsx(n,{className:"header",children:l.jsxs(n,{className:"location",children:[l.jsx(o,{className:"icon",children:"loading"===T||"success"===T?"\ud83d\udccd":"\u26a0\ufe0f"}),l.jsx(o,{className:`text ${T}`,children:I}),"error"===T&&l.jsx(o,{className:"retry-btn",onClick:A,children:"\u91cd\u8bd5"})]})}),l.jsxs(n,{className:"banner-section",children:[l.jsx(o,{className:"section-title",children:"\u4f18\u60e0\u9884\u7ea6"}),l.jsx(u,{className:"banner-swiper",autoplay:!0,interval:3e3,indicatorDots:!0,indicatorActiveColor:"#D9455F",children:z.map(s=>l.jsx(x,{children:l.jsx(n,{className:"banner-item",onClick:()=>R(),children:l.jsx(r,{className:"banner-image",src:s.image,mode:"aspectFill"})})},s.id))})]}),l.jsxs(n,{className:"stores-section",children:[l.jsxs(n,{className:"section-header",children:[l.jsx(o,{className:"section-title",children:"\u95e8\u5e97\u9884\u7ea6"}),l.jsxs(o,{className:"more-link",onClick:B,children:["\u66f4\u591a\u95e8\u5e97 ",">>"]})]}),l.jsx(n,{className:"store-list",children:t.map(s=>l.jsx(k,{store:s,onClick:()=>H(s)},s.id))})]}),l.jsxs(n,{className:"therapists-section",children:[l.jsxs(n,{className:"section-header",children:[l.jsx(o,{className:"section-title",children:"\u63a8\u62ff\u5e08\u9884\u7ea6"}),l.jsxs(o,{className:"more-link",onClick:O,children:["\u66f4\u591a\u75c7\u72b6 ",">>"]})]}),l.jsx(n,{className:"therapist-list",children:p.map(s=>l.jsx(C,{therapist:s,onClick:()=>E(s)},s.id))})]}),l.jsxs(S,{visible:L,title:"\u66f4\u591a\u95e8\u5e97",onClose:()=>D(!1),height:"80%",children:[l.jsxs(n,{className:"store-sheet-header",children:[l.jsxs(n,{className:"city-selector",children:[l.jsx(o,{className:"city-name",children:"\u4e0a\u6d77\u5e02"}),l.jsx(o,{className:"city-arrow",children:"\u25bc"})]}),l.jsxs(n,{className:"search-box",children:[l.jsx(o,{className:"search-icon",children:"\ud83d\udd0d"}),l.jsx(j,{className:"search-input",placeholder:"\u641c\u7d22\u95e8\u5e97",value:P,onInput:s=>q(s.detail.value)})]})]}),l.jsx(n,{className:"store-sheet-list",children:i.filter(s=>""===P||s.name.includes(P)||s.address.includes(P)).map(s=>l.jsx(k,{store:s,onClick:()=>{H(s),D(!1)}},s.id))})]})]})};export{M as default};
