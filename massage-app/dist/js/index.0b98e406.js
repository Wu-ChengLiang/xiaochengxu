var e=(e,t,a)=>new Promise((s,r)=>{var n=e=>{try{i(a.next(e))}catch(t){r(t)}},c=e=>{try{i(a.throw(e))}catch(t){r(t)}},i=e=>e.done?s(e.value):Promise.resolve(e.value).then(n,c);i((a=a.apply(e,t)).next())});import{t,n as a,s,j as r,V as n,U as c,T as i,I as o,k as l,h as d,c as m}from"./vendors.fcaa4701.js";import{j as h,b as u,v as p,w as x,o as N,s as v,t as j,k as y,l as f}from"./common.326c60a3.js";const g=()=>{var g,w,S,b,D;const k=t.useRouter(),I=k.params,P=!!I.orderNo,T=!P,[$,M]=a.useState([]),[C,A]=a.useState(null),[E,R]=a.useState(null),[B,F]=a.useState(null),[O,U]=a.useState(!0),[V,J]=a.useState(180),[Y,q]=a.useState("wechat"),[z,G]=a.useState(0),[H,K]=a.useState(!1),[L,Q]=a.useState(null),[W,X]=a.useState(!1),Z=a.useRef(null);a.useEffect(()=>{const a=()=>e(void 0,null,function*(){try{const e=yield h();if(!e)return;if(P)te();else{const e=JSON.parse(decodeURIComponent(I.items||"[]"));M(e),ae()}ee(),_()}catch(e){l({title:"\u6570\u636e\u52a0\u8f7d\u5931\u8d25",icon:"none"}),setTimeout(()=>t.navigateBack(),1500)}});a()},[I]),a.useEffect(()=>(!O&&T&&$.length>0&&(Z.current=setInterval(()=>{J(e=>e<=1?(clearInterval(Z.current),s({title:"\u652f\u4ed8\u8d85\u65f6\u4e86\u5466",content:"\u5feb\u5feb\u91cd\u65b0\u4e0b\u5355\u5427~",showCancel:!1,success:()=>{t.navigateBack()}}),0):e-1)},1e3)),()=>{Z.current&&clearInterval(Z.current)}),[O,$,T]);const _=()=>e(void 0,null,function*(){try{const e=u();if(e&&e.discountRate){Q(e.discountRate);const t=yield p.getMyVouchers();X(t.length>0)}}catch(e){console.error("\u83b7\u53d6\u7528\u6237\u6298\u6263\u4fe1\u606f\u5931\u8d25:",e)}}),ee=()=>e(void 0,null,function*(){try{K(!0);const e=yield x.getBalance();G(e/100);const t=ce();e/100>=t&&q("balance")}catch(e){console.error("\u83b7\u53d6\u4f59\u989d\u5931\u8d25:",e),G(0)}finally{K(!1)}}),te=()=>e(void 0,null,function*(){var e;try{U(!0);const t=yield N.getOrderDetail(I.orderNo);if(F(t),null==(e=t.extraData)?void 0:e.storeId)try{const e=yield v.getStoreDetail(t.extraData.storeId);R(e.data)}catch(a){console.error("\u83b7\u53d6\u95e8\u5e97\u4fe1\u606f\u5931\u8d25:",a)}U(!1)}catch(a){U(!1),l({title:"\u83b7\u53d6\u8ba2\u5355\u4fe1\u606f\u5931\u8d25",icon:"none"}),setTimeout(()=>t.navigateBack(),1500)}}),ae=()=>e(void 0,null,function*(){try{if(U(!0),I.therapistId){const e=yield j.getTherapistDetail(I.therapistId);A(e.data)}const e=yield v.getStoreDetail(I.storeId),t=e.data;R(t),U(!1)}catch(e){U(!1),l({title:"\u83b7\u53d6\u4fe1\u606f\u5931\u8d25",icon:"none"})}}),se=e=>{const t=Math.floor(e/60),a=e%60;return`${t.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}`},re=e=>{const t=new Date(e),a=t.getMonth()+1,s=t.getDate();return`${a.toString().padStart(2,"0")}\u6708${s.toString().padStart(2,"0")}\u65e5`},ne=(e,t)=>{const[a,s]=e.split(":").map(Number),r=s+t,n=a+Math.floor(r/60),c=r%60;return`${n}:${c.toString().padStart(2,"0")}`},ce=()=>{if(P&&B)return B.amount/100;const e=$.reduce((e,t)=>e+t.price,0);if(L&&L<1){const t=f(e,L);return t.finalPrice}return $.reduce((e,t)=>e+(t.discountPrice||t.price),0)},ie=()=>P&&B?B.amount/100:$.reduce((e,t)=>e+t.price,0),oe=()=>{const e=ie(),t=ce();return e-t},le=()=>{if(L&&L<1){const e=Math.round(100*L);return`${e}\u6298`}return""},de=()=>{const e=ce();return z>=e},me=e=>{"balance"!==e||de()?q(e):l({title:"\u4f59\u989d\u4e0d\u8db3\uff0c\u8bf7\u5145\u503c\u6216\u4f7f\u7528\u5176\u4ed6\u652f\u4ed8\u65b9\u5f0f",icon:"none",duration:2e3})},he=()=>e(void 0,null,function*(){var e,t,a,r,n,c,i;if("balance"!==Y||de())try{P?yield ue():yield pe()}catch(o){console.error("\u274c \u652f\u4ed8\u6d41\u7a0b\u9519\u8bef:",o),d();let l=o.message||o.errMsg||"\u652f\u4ed8\u5931\u8d25";(1003===(null==(t=null==(e=o.response)?void 0:e.data)?void 0:t.errorCode)||1004===(null==(r=null==(a=o.response)?void 0:a.data)?void 0:r.errorCode)||(null==(n=o.message)?void 0:n.includes("\u8d44\u6e90\u4e0d\u5b58\u5728"))||(null==(c=o.message)?void 0:c.includes("\u5df2\u7ecf\u9884\u7ea6"))||(null==(i=o.message)?void 0:i.includes("\u91cd\u590d")))&&(l="\u8be5\u6280\u5e08\u5df2\u88ab\u9884\u7ea6"),s({title:"\u63d0\u793a",content:l,showCancel:!1,confirmText:"\u77e5\u9053\u4e86"})}else l({title:"\u4f59\u989d\u4e0d\u8db3\uff0c\u8bf7\u5145\u503c\u6216\u4f7f\u7528\u5176\u4ed6\u652f\u4ed8\u65b9\u5f0f",icon:"none",duration:2e3})}),ue=()=>e(void 0,null,function*(){if(!B)throw new Error("\u8ba2\u5355\u4fe1\u606f\u4e22\u5931");m({title:"\u51c6\u5907\u652f\u4ed8..."});try{const e=B.orderNo,a=B.amount;if("wechat"===Y){console.log("\ud83d\udcb3 \u83b7\u53d6\u5fae\u4fe1\u652f\u4ed8\u53c2\u6570\uff0c\u8ba2\u5355\u53f7:",e);const s=yield N.getPaymentParams(e);if(console.log("\ud83d\udcb3 \u652f\u4ed8\u53c2\u6570\u83b7\u53d6\u6210\u529f:",s),!s)throw new Error("\u83b7\u53d6\u652f\u4ed8\u53c2\u6570\u5931\u8d25");d();const r=yield y.pay({orderNo:e,amount:a,paymentMethod:"wechat",title:B.title,wxPayParams:s});r&&setTimeout(()=>{t.redirectTo({url:`/pages/booking/success/index?orderNo=${e}`})},1500)}else{console.log("\ud83d\udcb0 \u4f59\u989d\u652f\u4ed8\uff0c\u8ba2\u5355\u53f7:",e);const s=yield y.pay({orderNo:e,amount:a,paymentMethod:"balance",title:B.title});d(),s&&(yield ee(),setTimeout(()=>{t.redirectTo({url:`/pages/booking/success/index?orderNo=${e}`})},1500))}}catch(e){throw d(),e}}),pe=()=>e(void 0,null,function*(){const e="symptom"===I.from,a=!e&&!C;if(0===$.length||a||!E)throw new Error("\u8ba2\u5355\u4fe1\u606f\u4e0d\u5b8c\u6574");m({title:"\u521b\u5efa\u8ba2\u5355..."});const s=$[0],r={therapistId:s.therapistId||I.therapistId||"symptom-mode",storeId:I.storeId,serviceId:s.serviceId,serviceName:s.serviceName,duration:s.duration,price:s.price,discountPrice:s.discountPrice,appointmentDate:s.date,appointmentTime:s.time,therapistName:s.therapistName,therapistAvatar:s.therapistAvatar||(null==C?void 0:C.avatar),paymentMethod:Y};console.log("\ud83d\udcdd \u521b\u5efa\u8ba2\u5355\uff0c\u652f\u4ed8\u65b9\u5f0f:",Y);const n=yield N.createAppointmentOrder(r),c=n.order;if(d(),!c||!c.orderNo)throw new Error("\u8ba2\u5355\u521b\u5efa\u5931\u8d25\uff0c\u672a\u8fd4\u56de\u8ba2\u5355\u53f7");if("wechat"===Y&&!c.wxPayParams)throw new Error("\u5fae\u4fe1\u652f\u4ed8\u53c2\u6570\u7f3a\u5931\uff0c\u8bf7\u68c0\u67e5\u7528\u6237\u767b\u5f55\u72b6\u6001\u6216\u5c1d\u8bd5\u4f59\u989d\u652f\u4ed8");const i=yield y.pay({orderNo:c.orderNo,amount:100*(c.totalAmount||ce()),paymentMethod:Y,title:`${s.serviceName} - ${s.therapistName}`,wxPayParams:c.wxPayParams});i&&("balance"===Y&&(yield ee()),setTimeout(()=>{t.redirectTo({url:`/pages/booking/success/index?orderNo=${c.orderNo}`})},1500))});return O?r.jsx(n,{className:"order-confirm-page",children:r.jsx(n,{className:"loading",children:"\u52a0\u8f7d\u4e2d..."})}):r.jsxs(c,{className:"order-confirm-page",scrollY:!0,children:[r.jsxs(n,{className:"store-section",children:[r.jsx(i,{className:"store-name",children:null==E?void 0:E.name}),r.jsxs(i,{className:"store-distance",children:["\ud83d\udccd ",null==E?void 0:E.distance,"km"]})]}),r.jsx(n,{className:"booking-info",children:P&&B?r.jsxs(n,{className:"booking-item",children:[(null==(g=B.extraData)?void 0:g.therapistAvatar)&&r.jsx(o,{className:"therapist-avatar",src:B.extraData.therapistAvatar}),r.jsxs(n,{className:"booking-details",children:[r.jsx(n,{className:"therapist-name",children:(null==(w=B.extraData)?void 0:w.therapistName)||"\u63a8\u62ff\u5e08"}),r.jsx(n,{className:"service-time",children:(null==(S=B.extraData)?void 0:S.appointmentDate)&&(null==(b=B.extraData)?void 0:b.startTime)&&r.jsxs(r.Fragment,{children:[re(B.extraData.appointmentDate)," ",B.extraData.startTime,B.extraData.duration&&r.jsxs(r.Fragment,{children:[" \u81f3 ",ne(B.extraData.startTime,B.extraData.duration)]})]})}),r.jsx(n,{className:"service-name",children:(null==(D=B.extraData)?void 0:D.serviceName)||B.title})]}),r.jsxs(n,{className:"service-price",children:["\xa5",(B.amount/100).toFixed(2)]})]}):$.map((e,t)=>r.jsxs(n,{className:"booking-item",children:[r.jsx(o,{className:"therapist-avatar",src:e.therapistAvatar||(null==C?void 0:C.avatar)}),r.jsxs(n,{className:"booking-details",children:[r.jsx(n,{className:"therapist-name",children:e.therapistName}),r.jsxs(n,{className:"service-time",children:[re(e.date)," ",e.time," \u81f3 ",ne(e.time,e.duration)]}),r.jsx(n,{className:"service-name",children:e.serviceName})]}),r.jsxs(n,{className:"service-price",children:["\xa5",e.discountPrice||e.price]})]},t))}),r.jsxs(n,{className:"refund-policy",children:[r.jsx(i,{className:"policy-title",children:"\u9000\u5355\u8bf4\u660e"}),r.jsxs(n,{className:"policy-list",children:[r.jsx(n,{className:"policy-item",children:"\u2022 \u4e0b\u535515\u5206\u949f\u5185\u6216\u8ddd\u8ba2\u5355\u5f00\u59cb\u65f6\u95f4>6\u5c0f\u65f6\u9000\u5355\uff0c\u9000100%"}),r.jsx(n,{className:"policy-item",children:"\u2022 \u8ddd\u8ba2\u5355\u5f00\u59cb\u524d<6\u5c0f\u65f6\u9000\u5355\uff0c\u9000\u5b9e\u4ed8\u91d1\u989d90%"}),r.jsx(n,{className:"policy-item",children:"\u2022 \u8ba2\u5355\u65f6\u95f4\u5f00\u59cb\u540e\u9000\u5355\uff0c\u9000\u5b9e\u4ed8\u91d1\u989d80%"})]})]}),r.jsxs(n,{className:"customer-note",children:[r.jsx(i,{className:"note-title",children:"\u5ba2\u6237\u5907\u6ce8"}),r.jsx(i,{className:"note-hint",children:"\u60a8\u5bf9\u8336\u6c34\u3001\u623f\u95f4\u3001\u6309\u6469\u670d\u7b49\u662f\u5426\u6709\u7279\u6b8a\u9700\u6c42\uff0c\u6211\u4eec\u5c06\u63d0\u524d\u4e3a\u60a8\u505a\u597d\u51c6\u5907"})]}),r.jsxs(n,{className:"payment-section",children:[r.jsx(i,{className:"section-title",children:"\u652f\u4ed8\u65b9\u5f0f"}),r.jsxs(n,{className:"payment-methods",children:[r.jsxs(n,{className:`payment-method ${"balance"===Y?"active":""} ${de()?"":"disabled"}`,onClick:()=>me("balance"),children:[r.jsxs(n,{className:"method-info",children:[r.jsx(i,{className:"method-icon",children:"\ud83d\udcb0"}),r.jsx(i,{className:"method-name",children:"\u4f59\u989d\u652f\u4ed8"}),r.jsxs(i,{className:"balance-amount",children:[H?"\u52a0\u8f7d\u4e2d...":`\xa5${z.toFixed(2)}`,!de()&&!H&&r.jsx(i,{className:"insufficient",children:" (\u4f59\u989d\u4e0d\u8db3)"})]})]}),r.jsx(n,{className:"check-icon "+("balance"===Y?"checked":"")})]}),r.jsxs(n,{className:"payment-method "+("wechat"===Y?"active":""),onClick:()=>me("wechat"),children:[r.jsxs(n,{className:"method-info",children:[r.jsx(i,{className:"method-icon",children:"\ud83d\udc9a"}),r.jsx(i,{className:"method-name",children:"\u5fae\u4fe1\u652f\u4ed8"})]}),r.jsx(n,{className:"check-icon "+("wechat"===Y?"checked":"")})]})]})]}),r.jsxs(n,{className:"payment-bar",children:[r.jsxs(n,{className:"price-info",children:[L&&L<1&&oe()>0?r.jsxs(n,{className:"price-with-discount",children:[r.jsxs(n,{className:"discount-info",children:[r.jsx(i,{className:"discount-tag",children:le()}),r.jsxs(i,{className:"saved-amount",children:["\u5df2\u4f18\u60e0 \xa5",oe()]})]}),r.jsxs(n,{className:"price-display",children:[r.jsxs(i,{className:"original-price",children:["\xa5",ie()]}),r.jsxs(i,{className:"total-price",children:["\xa5",ce()]})]})]}):r.jsxs(i,{className:"total-price",children:["\xa5",ce()]}),T&&r.jsxs(i,{className:"countdown",children:["\u652f\u4ed8\u5012\u8ba1\u65f6: ",se(V)]})]}),r.jsx(n,{className:"pay-button",onClick:he,children:"\u53bb\u652f\u4ed8"})]})]})};export{g as default};
