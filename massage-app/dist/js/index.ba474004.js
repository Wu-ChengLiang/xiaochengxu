var e=Object.defineProperty,s=Object.getOwnPropertySymbols,a=Object.prototype.hasOwnProperty,t=Object.prototype.propertyIsEnumerable,c=(s,a,t)=>a in s?e(s,a,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[a]=t,r=(e,r)=>{for(var n in r||(r={}))a.call(r,n)&&c(e,n,r[n]);if(s)for(var n of s(r))t.call(r,n)&&c(e,n,r[n]);return e},n=(e,s,a)=>new Promise((t,c)=>{var r=e=>{try{i(a.next(e))}catch(s){c(s)}},n=e=>{try{i(a.throw(e))}catch(s){c(s)}},i=e=>e.done?t(e.value):Promise.resolve(e.value).then(r,n);i((a=a.apply(e,s)).next())});import{a as i,j as l,V as o,I as d,T as m,B as h,C as u,D as x,q as j,w as N}from"./vendors.b1a33877.js";import{c as p,t as g,s as f}from"./common.d37aa707.js";const v=({therapist:e})=>{const[s,a]=i.useState(!1),t=r({level:"LV4",rating:e.rating||5,salesCount:e.serviceCount||10109,description:"\u6bd5\u4e1a\u4e8e\u6210\u90fd\u4e2d\u533b\u836f\u5927\u5b66\u9488\u7078\u63a8\u62ff\u4e13\u4e1a\u3002\u9ad8\u7ea7\u5eb7\u590d\u5e08 \u4ece\u4e1a18\u5e74\uff0c\u4e13\u7814\u8eab\u4f53\u75bc\u75db\u3001\u8fd0\u52a8\u5eb7\u590d\u3001\u4ea7\u540e\u5eb7\u590d\u3001\u4f53\u6001\u8c03\u7406\u3001\u7ecf\u7edc\u758f\u901a\u3001\u7f8e\u5bb9\u517b\u751f\u7b49"},e),c=()=>{a(!s)};return l.jsxs(o,{className:"therapist-info",children:[l.jsxs(o,{className:"therapist-header",children:[l.jsx(o,{className:"avatar-wrapper",children:l.jsx(d,{className:"avatar",src:e.avatar,mode:"aspectFill"})}),l.jsxs(o,{className:"basic-info",children:[l.jsxs(o,{className:"name-row",children:[l.jsx(m,{className:"name",children:e.name}),l.jsx(o,{className:"level",children:t.level})]}),l.jsxs(o,{className:"stats-row",children:[l.jsx(o,{className:"rating",children:l.jsxs(m,{className:"rating-score",children:[t.rating,"\u5206"]})}),l.jsx(o,{className:"divider",children:"|"}),l.jsx(o,{className:"sales",children:l.jsxs(m,{className:"sales-text",children:["\u9500\u91cf",t.salesCount,"\u5355"]})})]})]})]}),l.jsxs(o,{className:"description-section",children:[l.jsx(m,{className:"description "+(s?"expanded":"collapsed"),children:t.description}),l.jsxs(o,{className:"expand-toggle",onClick:c,children:[l.jsx(m,{className:"expand-text",children:s?"\u6536\u8d77":"\u5c55\u5f00"}),l.jsx(m,{className:"expand-icon "+(s?"up":"down"),children:s?"\u25b2":"\u25bc"})]})]})]})},b=({store:e})=>{const s=e=>{switch(e){case"normal":return"\u5c31\u8fd1";case"busy":return"\u7e41\u5fd9";case"full":return"\u7206\u6ee1";default:return""}},a=e=>{switch(e){case"normal":return"status-normal";case"busy":return"status-busy";case"full":return"status-full";default:return""}},t=()=>{e.phone&&h({phoneNumber:e.phone})},c=()=>{e.location&&u({latitude:e.location.latitude,longitude:e.location.longitude,name:e.name,address:e.address})};return l.jsx(o,{className:"store-info",children:l.jsxs(o,{className:"store-header",children:[l.jsxs(o,{className:"store-details",children:[l.jsxs(o,{className:"name-row",children:[l.jsx(m,{className:"store-name",children:e.name}),l.jsxs(m,{className:"distance",children:[e.distance||9,"km"]})]}),l.jsxs(o,{className:"hours-row",children:[l.jsx(m,{className:"business-hours",children:e.businessHours?`${e.businessHours.start}-${e.businessHours.end}`:"\u8425\u4e1a\u65f6\u95f4\u672a\u77e5"}),l.jsx(o,{className:`status ${a(e.status)}`,children:s(e.status)})]}),l.jsx(m,{className:"address",children:e.address})]}),l.jsxs(o,{className:"action-buttons",children:[l.jsx(o,{className:"action-btn",onClick:t,children:"\ud83d\udcde"}),l.jsx(o,{className:"action-btn",onClick:c,children:"\ud83d\udccd"})]})]})})},S=i.forwardRef(({services:e,onServiceSelect:s,onTimeSelect:a},t)=>{const[c,r]=i.useState(""),[n,d]=i.useState(null),[h,u]=i.useState(""),[j,N]=i.useState("");i.useImperativeHandle(t,()=>({clearSelectedTime:()=>{N("")}}),[]);const p=()=>{const e=[],s=new Date;for(let a=0;a<5;a++){const t=new Date(s);t.setDate(s.getDate()+a);const c=t.getMonth()+1,r=t.getDate(),n=["\u5468\u65e5","\u5468\u4e00","\u5468\u4e8c","\u5468\u4e09","\u5468\u56db","\u5468\u4e94","\u5468\u516d"],i=n[t.getDay()];e.push({key:t.toISOString().split("T")[0],display:0===a?"\u4eca\u5929":`${c}\u6708${r}\u65e5`,weekDay:0===a?"":i})}return e},g=()=>{const e=[];for(let s=9;s<=21;s++){const a=[];for(let e=0;e<60;e+=10){const t=`${s.toString().padStart(2,"0")}:${e.toString().padStart(2,"0")}`,c=Math.random()>.3;a.push({time:t,available:c})}e.push({hour:`${s}:00`,slots:a})}return e},f=e=>{if(!j||!n)return!1;const s=j,a=n.duration,t=e=>{const[s,a]=e.split(":").map(Number);return 60*s+a},c=t(s),r=t(e),i=c+a;return r>=c&&r<i},v=e=>{r(e.id),d(e),s(e),N("")},b=e=>{u(e),N("")},S=(e,s)=>{if(!s||!h||!n)return;const t=e=>{const[s,a]=e.split(":").map(Number);return 60*s+a},c=t(e),r=c+n.duration;r>1320||(N(e),a(h,e),setTimeout(()=>{const e=document.querySelector(".checkout-btn:not(.disabled)");e&&e.click()},300))},k=p(),y=g();return l.jsxs(o,{className:"booking-selector",children:[l.jsxs(o,{className:"service-section",children:[l.jsx(o,{className:"section-title",children:"\u9009\u62e9\u670d\u52a1"}),l.jsx(x,{className:"service-tabs",scrollX:!0,children:e.map(e=>l.jsxs(o,{className:"service-tab "+(c===e.id?"active":""),onClick:()=>v(e),children:[l.jsx(m,{className:"service-name",children:e.name}),l.jsxs(o,{className:"service-info",children:[l.jsxs(m,{className:"service-duration",children:[e.duration,"\u5206\u949f"]}),l.jsxs(m,{className:"price",children:["\xa5",e.discountPrice||e.price]})]})]},e.id))})]}),c&&l.jsxs(o,{className:"datetime-section",children:[l.jsx(x,{className:"date-tabs",scrollX:!0,children:k.map(e=>l.jsxs(o,{className:"date-tab "+(h===e.key?"active":""),onClick:()=>b(e.key),children:[l.jsx(m,{className:"date-display",children:e.display}),e.weekDay&&l.jsx(m,{className:"week-day",children:e.weekDay})]},e.key))}),h&&l.jsx(x,{className:"time-grid-container",scrollY:!0,children:l.jsx(o,{className:"time-grid-wrapper",children:y.map((e,s)=>l.jsxs(o,{className:"time-row",children:[l.jsx(m,{className:"hour-label",children:e.hour}),l.jsx(o,{className:"time-slots",children:e.slots.map((e,s)=>l.jsx(o,{className:"time-slot "+(e.available?f(e.time)?"selected":"available":"disabled"),onClick:()=>S(e.time,e.available),children:l.jsxs(m,{className:"time-text",children:[":",e.time.split(":")[1]]})},s))})]},s))})})]})]})});S.displayName="BookingSelector";const k=({items:e,therapist:s,onCheckout:a,onMaskClick:t,onContinue:c,hasPendingAction:r=!1})=>{const[n,h]=i.useState(!1),[u,x]=i.useState(180),N=i.useRef(null),p=e.reduce((e,s)=>e+s.price,0),g=e.reduce((e,s)=>e+(s.discountPrice||s.price),0),f=p-g,v=e.length>0;i.useEffect(()=>(v&&n?N.current=setInterval(()=>{x(e=>e<=1?(clearInterval(N.current),j({title:"\u652f\u4ed8\u8d85\u65f6\u4e86\u5466\uff0c\u5feb\u5feb\u91cd\u65b0\u4e0b\u5355\u5427~",icon:"none"}),h(!1),180):e-1)},1e3):N.current&&clearInterval(N.current),()=>{N.current&&clearInterval(N.current)}),[v,n]);const b=e=>{const s=Math.floor(e/60),a=e%60;return`${s.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}`},S=e=>{const s=new Date(e),a=new Date,t=s.toDateString()===a.toDateString();if(t)return"\u4eca\u5929";const c=s.getMonth()+1,r=s.getDate();return`${c}\u6708${r}\u65e5`},k=()=>{v?h(!0):j({title:"\u8bf7\u5148\u9009\u62e9\u670d\u52a1",icon:"none"})},y=()=>{t&&r&&t(),h(!1)},w=()=>{c&&c(),h(!1)},C=()=>{a()};return l.jsxs(l.Fragment,{children:[n&&l.jsx(o,{className:"cart-mask",onClick:y}),l.jsx(o,{className:"shopping-cart",children:l.jsxs(o,{className:"cart-bar",children:[l.jsx(o,{className:"cart-info",children:v?l.jsxs(l.Fragment,{children:[l.jsxs(m,{className:"total-price",children:["\xa5",g]}),f>0&&l.jsxs(m,{className:"savings",children:["\u5df2\u4f18\u60e0\xa5",f]})]}):l.jsx(m,{className:"empty-text",children:"\u8bf7\u9009\u62e9\u670d\u52a1\u9879\u76ee"})}),l.jsx(o,{className:"checkout-btn "+(v?"":"disabled"),onClick:k,children:"\u53bb\u7ed3\u7b97"})]})}),n&&l.jsxs(o,{className:"cart-expanded",children:[l.jsxs(o,{className:"expanded-header",children:[l.jsxs(m,{className:"title",children:["\u5df2\u9009\u63a8\u62ff\u5e08(",e.length,")\u4f4d"]}),l.jsx(m,{className:"action",onClick:w,children:"\u7ee7\u7eed\u9884\u7ea6"})]}),l.jsx(o,{className:"service-list",children:e.map((e,a)=>l.jsxs(o,{className:"service-item",children:[l.jsx(d,{className:"therapist-avatar",src:e.therapistAvatar||(null==s?void 0:s.avatar)||""}),l.jsxs(o,{className:"service-info",children:[l.jsxs(o,{className:"info-header",children:[l.jsx(m,{className:"therapist-name",children:e.therapistName}),l.jsxs(m,{className:"duration",children:[e.duration,"\u5206\u949f"]})]}),l.jsx(o,{className:"info-detail",children:l.jsx(m,{className:"service-name",children:e.serviceName})}),l.jsx(o,{className:"info-time",children:l.jsxs(m,{className:"time-text",children:[S(e.date)," ",e.time," \u81f3 ",(()=>{const[s,a]=e.time.split(":").map(Number),t=a+e.duration,c=s+Math.floor(t/60),r=t%60;return`${c}:${r.toString().padStart(2,"0")}`})()]})})]}),l.jsx(o,{className:"price-info",children:l.jsxs(m,{className:"price",children:["\xa5",e.discountPrice||e.price]})})]},a))}),l.jsxs(o,{className:"addon-section",children:[l.jsx(m,{className:"section-title",children:"\u53ef\u9009\u589e\u503c\u9879\u76ee"}),l.jsxs(o,{className:"addon-list",children:[l.jsxs(o,{className:"addon-item",children:[l.jsxs(o,{className:"addon-info",children:[l.jsx(m,{className:"addon-name",children:"\u522e\u75e720\u5206\u949f"}),l.jsx(m,{className:"addon-price",children:"\xa5 99"})]}),l.jsx(o,{className:"addon-action",children:"+"})]}),l.jsxs(o,{className:"addon-item",children:[l.jsxs(o,{className:"addon-info",children:[l.jsx(m,{className:"addon-name",children:"\u52a0\u949f20\u5206\u949f"}),l.jsx(m,{className:"addon-price",children:"\xa5 99"})]}),l.jsx(o,{className:"addon-action",children:"+"})]})]})]}),l.jsxs(o,{className:"checkout-section",children:[l.jsxs(o,{className:"price-summary",children:[l.jsxs(o,{className:"cart-icon",children:[l.jsx(m,{className:"icon",children:"\ud83d\uded2"}),l.jsx(o,{className:"badge",children:"1"})]}),l.jsxs(o,{className:"price-detail",children:[l.jsxs(m,{className:"final-price",children:["\xa5 ",g]}),p>g&&l.jsxs(m,{className:"original-price",children:["\xa5 ",p]})]}),l.jsx(m,{className:"discount-tip",children:"\u5df2\u4eab\u53d7\u6700\u5927\u4f18\u60e0\u51cf20\u5143"})]}),l.jsxs(o,{className:"checkout-footer",children:[l.jsxs(m,{className:"countdown",children:["\u652f\u4ed8\u5012\u8ba1\u65f6: ",b(u)]}),l.jsx(o,{className:"confirm-btn",onClick:C,children:"\u53bb\u7ed3\u7b97"})]})]})]})]})},y=()=>{const e=N.useRouter(),{therapistId:s,storeId:a}=e.params,[t,c]=i.useState(null),[r,d]=i.useState(null),[m,h]=i.useState(!0),[u,y]=i.useState(""),[w,C]=i.useState([]),[I,D]=i.useState(null),[$,P]=i.useState(-1),[T,O]=i.useState(!1),M=i.useRef(null),R=p.map(e=>({id:e.id,name:e.name,duration:e.duration,price:e.price,discountPrice:e.discountPrice,description:e.description,tag:e.tag}));i.useEffect(()=>{A()},[s,a]);const A=()=>n(void 0,null,function*(){try{if(h(!0),y(""),console.log("TherapistBookingPage params:",{therapistId:s,storeId:a}),!s||!a)return console.error("Missing required params:",{therapistId:s,storeId:a}),void y("\u53c2\u6570\u9519\u8bef\uff0c\u8bf7\u91cd\u65b0\u8fdb\u5165");const[e,t]=yield Promise.all([g.getTherapistDetail(s),f.getStoreDetail(a)]);console.log("Store data response:",t),console.log("Store data.data:",t.data),c(e.data),d(t.data),console.log("Store state after setting:",t.data)}catch(e){console.error("Failed to load data:",e),y("\u52a0\u8f7d\u6570\u636e\u5931\u8d25\uff0c\u8bf7\u91cd\u8bd5")}finally{h(!1)}}),F=e=>{D(e)},H=(e,s)=>{if(!I||!t)return;-1===$&&(P(w.length),O(!0));const a={serviceId:I.id,serviceName:I.name,duration:I.duration,price:I.price,discountPrice:I.discountPrice,date:e,time:s,therapistName:t.name,therapistAvatar:t.avatar},c=w.findIndex(a=>a.date===e&&a.time===s);if(c>=0){const e=[...w];e[c]=a,C(e),j({title:"\u5df2\u66f4\u65b0\u8be5\u65f6\u6bb5\u9884\u7ea6",icon:"success"})}else C([...w,a]),j({title:"\u5df2\u6dfb\u52a0\u5230\u8d2d\u7269\u8f66",icon:"success"})},q=()=>{var e;if(T&&$>=0){const s=w.slice(0,$);C(s),null==(e=M.current)||e.clearSelectedTime()}P(-1),O(!1)},B=()=>{P(-1),O(!1)},E=()=>{if(0===w.length)return;P(-1),O(!1);const e={therapistId:s,storeId:a,items:JSON.stringify(w)};N.navigateTo({url:`/pages/booking/confirm/index?${Object.entries(e).map(([e,s])=>`${e}=${encodeURIComponent(s)}`).join("&")}`})};return m?l.jsx(o,{className:"therapist-booking-page",children:l.jsx(o,{className:"loading",children:"\u52a0\u8f7d\u4e2d..."})}):!u&&t&&r?l.jsxs(o,{className:"therapist-booking-page",children:[l.jsxs(x,{className:"main-content",scrollY:!0,children:[l.jsx(v,{therapist:t}),r&&l.jsx(b,{store:r}),l.jsx(S,{ref:M,services:R,onServiceSelect:F,onTimeSelect:H})]}),l.jsx(k,{items:w,therapist:t,onCheckout:E,onMaskClick:q,onContinue:B,hasPendingAction:T&&$>=0})]}):l.jsx(o,{className:"therapist-booking-page",children:l.jsx(o,{className:"error",children:u||"\u6570\u636e\u52a0\u8f7d\u5931\u8d25"})})};export{y as default};
