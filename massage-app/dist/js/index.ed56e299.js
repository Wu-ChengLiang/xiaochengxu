var e=Object.defineProperty,s=Object.defineProperties,a=Object.getOwnPropertyDescriptors,t=Object.getOwnPropertySymbols,i=Object.prototype.hasOwnProperty,r=Object.prototype.propertyIsEnumerable,c=(s,a,t)=>a in s?e(s,a,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[a]=t,o=(e,s)=>{for(var a in s||(s={}))i.call(s,a)&&c(e,a,s[a]);if(t)for(var a of t(s))r.call(s,a)&&c(e,a,s[a]);return e},l=(e,t)=>s(e,a(t)),n=(e,s,a)=>new Promise((t,i)=>{var r=e=>{try{o(a.next(e))}catch(s){i(s)}},c=e=>{try{o(a.throw(e))}catch(s){i(s)}},o=e=>e.done?t(e.value):Promise.resolve(e.value).then(r,c);o((a=a.apply(e,s)).next())});import{j as d,U as m,W as p,V as h,T as v,I as u,t as j,n as x,k as f}from"./vendors.fcaa4701.js";import{i as g,S as N,t as b,e as y}from"./common.326c60a3.js";const I=({categories:e,activeId:s,onChange:a,className:t})=>d.jsx(m,{className:p("symptom-category-tabs",t),scrollY:!0,showScrollbar:!1,children:e.map(e=>d.jsx(h,{className:p("category-item",{active:e.id===s}),onClick:()=>a(e.id),children:d.jsx(v,{className:"category-name",children:e.name})},e.id))}),S=({service:e,onAdd:s,isInCart:a=!1,className:t})=>d.jsxs(h,{className:p("symptom-service-card",t),children:[d.jsx(h,{className:"service-header",children:d.jsx(v,{className:"service-name",children:e.name})}),d.jsx(v,{className:"service-description",children:e.description}),d.jsxs(h,{className:"service-footer",children:[d.jsxs(h,{className:"service-info",children:[d.jsxs(v,{className:"service-duration",children:[e.duration,"\u5206\u949f"]}),d.jsxs(h,{className:"service-price",children:[d.jsxs(v,{className:"price-current",children:["\xa5",e.discountPrice||e.price]}),e.discountPrice&&d.jsxs(v,{className:"price-original",children:["\xa5",e.price]})]})]}),d.jsx(h,{className:p("add-button",{"in-cart":a,disabled:"full"===e.availability}),onClick:"full"!==e.availability?s:void 0,children:"full"===e.availability?d.jsx(v,{className:"button-text",children:"\u5df2\u6ee1"}):d.jsx(v,{className:"iconfont icon-add"})})]})]}),C=({services:e,therapists:s,selectedDate:a,selectedTime:t,onAddToCart:i,cartServiceIds:r,className:c})=>{const o=e=>{if(!e.availability)return console.warn("\u6280\u5e08\u6392\u73ed\u6570\u636e\u7f3a\u5931:",e.id),!0;if(!a||!t)return console.warn("\u672a\u9009\u62e9\u65e5\u671f\u6216\u65f6\u95f4",{selectedDate:a,selectedTime:t}),!0;const s=e.availability.find(e=>e.date===a);if(!s)return console.warn(`\u6280\u5e08 ${e.id} \u5728 ${a} \u65e0\u6392\u73ed\u6570\u636e`),!0;const i=s.slots.find(e=>e.time===t);return i?i.available:(console.warn(`\u6280\u5e08 ${e.id} \u5728 ${a} ${t} \u65e0\u6b64\u65f6\u6bb5`,{availableSlots:s.slots.map(e=>e.time)}),!1)},l=e.map(e=>({service:e,availableTherapists:s}));return d.jsx(m,{className:`symptom-service-list ${c||""}`,scrollY:!0,showScrollbar:!1,children:d.jsx(h,{className:"service-list-content",children:l.map(e=>d.jsxs(h,{className:"service-item-container",children:[d.jsx(S,{service:e.service,onAdd:()=>{},isInCart:r.includes(e.service.id)}),d.jsx(h,{className:"therapist-options",children:e.availableTherapists.map(s=>{const a=o(s);return d.jsxs(h,{className:"therapist-option "+(a?"available":"booked"),onClick:()=>a&&i(e.service,s.id),children:[d.jsxs(h,{className:"therapist-avatar-wrapper",children:[d.jsx(u,{className:"therapist-mini-avatar",src:s.avatar,mode:"aspectFill"}),!a&&d.jsx(h,{className:"booked-badge",children:d.jsx(v,{className:"badge-text",children:"\u5df2\u9884\u7ea6"})})]}),d.jsx(v,{className:"therapist-name",children:s.name})]},s.id)})})]},e.service.id))})})},w=()=>{const e=j.useRouter(),{storeId:s,storeName:a,selectedDate:t,selectedTime:i}=e.params,r=i?decodeURIComponent(i):"",[c,m]=x.useState([]),[p,v]=x.useState([]),[u,S]=x.useState([]),[w,T]=x.useState(""),[P,O]=x.useState([]),[k,$]=x.useState(!0);x.useEffect(()=>{if(s&&t){const e=()=>n(void 0,null,function*(){try{const[e,a]=yield Promise.all([b.getTherapistsByStore(s),b.getTherapistsAvailability(s,t)]),i=e.list.map(e=>{const s=a.find(s=>s.id===e.id);return l(o({},e),{availability:(null==s?void 0:s.availability)||[]})});console.log("\u2705 \u6280\u5e08\u6570\u636e\u5408\u5e76\u6210\u529f:",i),m(i)}catch(e){console.error("\u274c \u83b7\u53d6\u6280\u5e08\u4fe1\u606f\u5931\u8d25:",e),b.getTherapistsByStore(s).then(e=>{m(e.list)})}});e()}},[s,t]),x.useEffect(()=>{g.getCategories().then(e=>{v(e.data),e.data.length>0&&T(e.data[0].id)})},[]),x.useEffect(()=>{s&&($(!0),g.getStoreSymptomServices(s).then(e=>{S(e.data),$(!1)}))},[s]);const A=x.useMemo(()=>u.filter(e=>e.categoryId===w),[u,w]),D=x.useMemo(()=>P.map(e=>e.serviceId),[P]),E=(e,s)=>{console.log("\ud83c\udfaf \u6dfb\u52a0\u5230\u8d2d\u7269\u8f66 - therapistId:",s);const a=c.find(e=>e.id===s);if(console.log("\ud83c\udfaf \u627e\u5230\u7684\u6280\u5e08:",a),!a)return void console.error("\u274c \u672a\u627e\u5230\u6280\u5e08\uff0ctherapistId:",s);const i={serviceId:e.id,serviceName:e.name,duration:e.duration,price:e.price,discountPrice:e.discountPrice,date:t||y(),time:r||"10:00",therapistId:a.id,therapistName:a.name,therapistAvatar:a.avatar};console.log("\ud83c\udfaf \u65b0\u8d2d\u7269\u8f66\u9879\u76ee:",i),console.log("\ud83c\udfaf \u65b0\u9879\u76ee\u7684therapistId:",i.therapistId),O([...P,i]),f({title:"\u5df2\u6dfb\u52a0\u5230\u8d2d\u7269\u8f66",icon:"none"})},M=()=>{O([]),f({title:"\u8d2d\u7269\u8f66\u5df2\u6e05\u7a7a",icon:"none"})},R=e=>{const s=P.filter((s,a)=>a!==e);O(s),f({title:"\u5df2\u79fb\u9664\u5546\u54c1",icon:"none"})},U=()=>{var e;if(0===P.length)return void f({title:"\u8bf7\u5148\u9009\u62e9\u670d\u52a1\u9879\u76ee",icon:"none"});console.log("\ud83d\udd04 \u51c6\u5907\u7ed3\u7b97\uff0c\u8d2d\u7269\u8f66\u5185\u5bb9:",P),console.log("\ud83d\udd04 \u7b2c\u4e00\u4e2a\u9879\u76ee:",P[0]),console.log("\ud83d\udd04 \u7b2c\u4e00\u4e2a\u9879\u76ee\u7684therapistId:",null==(e=P[0])?void 0:e.therapistId);const t={items:JSON.stringify(P),storeId:s,storeName:a,from:"symptom"};console.log("\ud83d\udd04 \u4f20\u9012\u7684\u53c2\u6570:",t),j.navigateTo({url:`/pages/booking/confirm/index?${Object.entries(t).map(([e,s])=>`${e}=${encodeURIComponent(s)}`).join("&")}`})};return k?d.jsx(h,{className:"symptom-page loading",children:"\u52a0\u8f7d\u4e2d..."}):d.jsxs(h,{className:"symptom-page",children:[d.jsxs(h,{className:"symptom-content",children:[d.jsx(I,{categories:p,activeId:w,onChange:T}),d.jsx(C,{services:A,therapists:c,selectedDate:t,selectedTime:r,onAddToCart:E,cartServiceIds:D})]}),d.jsx(N,{items:P,onCheckout:U,onMaskClick:M,onRemoveItem:R,simpleClearMode:!0})]})};export{w as default};
