var e=Object.defineProperty,s=Object.defineProperties,a=Object.getOwnPropertyDescriptors,t=Object.getOwnPropertySymbols,n=Object.prototype.hasOwnProperty,c=Object.prototype.propertyIsEnumerable,r=(s,a,t)=>a in s?e(s,a,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[a]=t,i=(e,s)=>{for(var a in s||(s={}))n.call(s,a)&&r(e,a,s[a]);if(t)for(var a of t(s))c.call(s,a)&&r(e,a,s[a]);return e},l=(e,t)=>s(e,a(t)),o=(e,s,a)=>new Promise((t,n)=>{var c=e=>{try{i(a.next(e))}catch(s){n(s)}},r=e=>{try{i(a.throw(e))}catch(s){n(s)}},i=e=>e.done?t(e.value):Promise.resolve(e.value).then(c,r);i((a=a.apply(e,s)).next())});import{n as d,j as m,$ as u,V as h,I as p,T as x,S as j,a0 as N,k as v,s as f,t as g,C as y,a1 as b,O as S,Q as k}from"./vendors.fcaa4701.js";import{o as C,r as w,q as A}from"./common.326c60a3.js";const I=({visible:e,orderInfo:s,onClose:a,onSubmit:t})=>{const[n,c]=d.useState(5),[r,i]=d.useState(""),[l,g]=d.useState([]),[y,b]=d.useState(!1),S=["\u624b\u6cd5\u4e13\u4e1a","\u670d\u52a1\u6001\u5ea6\u597d","\u6548\u679c\u663e\u8457","\u73af\u5883\u8212\u9002","\u51c6\u65f6\u5b88\u7ea6","\u7269\u8d85\u6240\u503c"],k=e=>{const s={1:"\u5f88\u4e0d\u6ee1\u610f",2:"\u4e0d\u6ee1\u610f",3:"\u4e00\u822c",4:"\u6ee1\u610f",5:"\u975e\u5e38\u6ee1\u610f"};return s[e]||""},C=e=>{g(s=>s.includes(e)?s.filter(s=>s!==e):[...s,e])},w=r.length>=10&&!y,A=()=>o(void 0,null,function*(){var e;if(w){b(!0);try{const o=s.appointmentId||(null==(e=s.extraData)?void 0:e.appointmentId);if(!o)throw new Error("\u65e0\u6cd5\u83b7\u53d6\u9884\u7ea6\u4fe1\u606f\uff0c\u65e0\u6cd5\u63d0\u4ea4\u8bc4\u4ef7\u3002\u8bf7\u7a0d\u540e\u91cd\u8bd5\u3002");yield t({appointmentId:o,rating:n,content:r,tags:l}),c(5),i(""),g([]),v({title:"\u8bc4\u4ef7\u6210\u529f",icon:"success",duration:2e3}),setTimeout(()=>{a()},2e3)}catch(o){v({title:o.message||"\u8bc4\u4ef7\u5931\u8d25",icon:"none",duration:2e3})}finally{b(!1)}}}),I=()=>{r.length>0||l.length>0?f({title:"\u786e\u8ba4\u53d6\u6d88",content:"\u5df2\u586b\u5199\u7684\u5185\u5bb9\u5c06\u4e0d\u4f1a\u4fdd\u5b58\uff0c\u786e\u5b9a\u53d6\u6d88\u5417\uff1f",success:e=>{e.confirm&&(c(5),i(""),g([]),a())}}):a()};return m.jsx(u,{isOpened:e,title:"\u8bc4\u4ef7\u670d\u52a1",onClose:I,children:m.jsxs(h,{className:"review-modal",children:[m.jsx(h,{className:"modal-header",children:m.jsxs(h,{className:"therapist-info",children:[m.jsx(p,{className:"avatar",src:s.therapistAvatar||"https://img.yzcdn.cn/vant/cat.jpeg",mode:"aspectFill"}),m.jsxs(h,{className:"info",children:[m.jsx(x,{className:"name",children:s.therapistName}),m.jsx(x,{className:"service",children:s.serviceName})]})]})}),m.jsxs(h,{className:"rating-section",children:[m.jsx(x,{className:"rating-label",children:"\u670d\u52a1\u8bc4\u5206"}),m.jsxs(h,{className:"star-container",children:[m.jsx(j,{value:n,onChange:e=>c(e),size:28,max:5}),m.jsx(x,{className:"rating-text",children:k(n)})]})]}),n>=4&&m.jsxs(h,{className:"quick-tags",children:[m.jsx(x,{className:"tags-label",children:"\u5feb\u901f\u8bc4\u4ef7"}),m.jsx(h,{className:"tags-container",children:S.map(e=>m.jsx(h,{className:"tag "+(l.includes(e)?"active":""),onClick:()=>C(e),children:e},e))})]}),m.jsxs(h,{className:"content-section",children:[m.jsx(x,{className:"content-label",children:"\u8be6\u7ec6\u8bc4\u4ef7"}),m.jsx(N,{value:r,onChange:e=>i(e),placeholder:"\u5206\u4eab\u60a8\u7684\u670d\u52a1\u4f53\u9a8c\uff0c\u5e2e\u52a9\u5176\u4ed6\u987e\u5ba2\uff081-500\u5b57\uff09",maxLength:500,height:120,count:!0,className:"content-textarea"})]}),m.jsx(h,{className:"modal-footer",children:m.jsxs(h,{className:"buttons",children:[m.jsx(h,{className:"btn-cancel",onClick:I,children:"\u53d6\u6d88"}),m.jsx(h,{className:"btn-submit "+(w?"":"disabled"),onClick:A,children:y?"\u63d0\u4ea4\u4e2d...":"\u63d0\u4ea4\u8bc4\u4ef7"})]})})]})})},O=()=>{const e=g.useRouter(),{orderNo:s}=e.params,[a,t]=d.useState(null),[n,c]=d.useState(!0),[r,u]=d.useState(!1),[j,N]=d.useState(!1);d.useEffect(()=>{O()},[s]);const O=()=>o(void 0,null,function*(){var e;if(!s)return v({title:"\u8ba2\u5355\u53f7\u7f3a\u5931",icon:"none"}),void setTimeout(()=>{g.navigateBack()},1500);try{const a=yield C.getOrderDetail(s);if(console.log("\ud83d\udccb \u8ba2\u5355\u8be6\u60c5\u83b7\u53d6\u6210\u529f:",{orderNo:a.orderNo,amount:a.amount,amountType:typeof a.amount,therapistAvatar:a.therapistAvatar,therapistName:a.therapistName,displayStatus:a.displayStatus}),a.amount||0===a.amount||console.warn("\u26a0\ufe0f \u8b66\u544a\uff1a\u8ba2\u5355\u91d1\u989d\u4e3a\u7a7a",{orderNo:s,amount:a.amount}),"number"!==typeof a.amount&&console.error("\u274c \u9519\u8bef\uff1a\u8ba2\u5355\u91d1\u989d\u7c7b\u578b\u4e0d\u6b63\u786e",{orderNo:s,amount:a.amount,type:typeof a.amount}),t(a),null==(e=a.extraData)?void 0:e.appointmentId){const e=yield w.checkCanReview(a.extraData.appointmentId);N(!e)}else N(!1);c(!1)}catch(a){c(!1),console.error("\u274c \u83b7\u53d6\u8ba2\u5355\u8be6\u60c5\u5931\u8d25:",a),v({title:"\u83b7\u53d6\u8ba2\u5355\u5931\u8d25",icon:"none"})}}),D=()=>{S({phoneNumber:"4008888888"})},$=()=>o(void 0,null,function*(){f({title:"\u53d6\u6d88\u8ba2\u5355",content:"\u786e\u5b9a\u8981\u53d6\u6d88\u8be5\u8ba2\u5355\u5417\uff1f",success:e=>o(void 0,null,function*(){if(e.confirm)try{const e=yield C.cancelOrder(s);"pending"===(null==a?void 0:a.paymentStatus)?v({title:"\u53d6\u6d88\u8ba2\u5355",icon:"success"}):"paid"===(null==a?void 0:a.paymentStatus)&&e.refundAmount&&e.refundAmount>0?(v({title:"\u53d6\u6d88\u8ba2\u5355",icon:"success"}),setTimeout(()=>{v({title:`\u9000\u6b3e\uffe5${(e.refundAmount/100).toFixed(2)}`,icon:"success",duration:2500})},500)):v({title:"\u53d6\u6d88\u8ba2\u5355",icon:"success"}),setTimeout(()=>{O()},1500)}catch(t){v({title:"\u53d6\u6d88\u5931\u8d25",icon:"none"})}})})}),q=()=>{g.switchTab({url:"/pages/appointment/index"})},z=()=>{u(!0)},T=()=>o(void 0,null,function*(){var e;if(null==(e=null==a?void 0:a.extraData)?void 0:e.appointmentId)try{const e=yield w.getReviewDetail(a.extraData.appointmentId);f({title:"\u6211\u7684\u8bc4\u4ef7",content:`\u8bc4\u5206\uff1a${e.rating}\u661f\n${e.content}`,showCancel:!1})}catch(s){v({title:"\u8bc4\u4ef7\u4fe1\u606f\u83b7\u53d6\u5931\u8d25",icon:"none"})}else v({title:"\u6682\u65e0\u8bc4\u4ef7",icon:"none"})}),P=e=>o(void 0,null,function*(){try{const s=l(i({},e),{therapistId:null==a?void 0:a.therapistId});yield w.createReview(s),N(!0),u(!1),O()}catch(s){throw s}}),F=()=>{a&&k({latitude:31.189,longitude:121.43,name:a.storeName,address:a.storeAddress})},R=e=>`https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${e}`,E=e=>{const s=e.displayStatus||e.paymentStatus,a={pending:"\u5f85\u652f\u4ed8",paid:"\u5f85\u670d\u52a1",serving:"\u670d\u52a1\u4e2d",completed:"\u5df2\u5b8c\u6210",cancelled:"\u5df2\u53d6\u6d88",refunded:"\u5df2\u9000\u6b3e"};return a[s]||s},M=e=>{const s=e.displayStatus||e.paymentStatus,a=["\u4e0b\u5355","\u652f\u4ed8","\u5230\u5e97\u670d\u52a1","\u5b8c\u6210"];let t=0;switch(s){case"pending":t=0;break;case"paid":t=1;break;case"serving":t=2;break;case"completed":t=3;break;case"cancelled":case"refunded":return{steps:["\u5df2\u53d6\u6d88"],current:0}}return{steps:a,current:t}},B=e=>{const s=new Date(e),a=s.getFullYear(),t=s.getMonth()+1,n=s.getDate(),c=s.getHours(),r=s.getMinutes();return`${a}-${t.toString().padStart(2,"0")}-${n.toString().padStart(2,"0")} ${c.toString().padStart(2,"0")}:${r.toString().padStart(2,"0")}`};if(n)return m.jsx(h,{className:"order-detail-page",children:m.jsx(h,{className:"loading",children:"\u52a0\u8f7d\u4e2d..."})});if(!a)return m.jsx(h,{className:"order-detail-page",children:m.jsx(h,{className:"empty",children:"\u8ba2\u5355\u4e0d\u5b58\u5728"})});const{steps:H,current:L}=M(a),Q=a.displayStatus||a.paymentStatus;return m.jsxs(h,{className:"order-detail-page",children:[m.jsxs(h,{className:"status-section",children:[m.jsxs(h,{className:"status-header",children:[m.jsx(y,{value:"paid"===Q?"check-circle":"clock",size:"40",color:"#fff"}),m.jsx(x,{className:"status-text",children:E(a)})]}),"cancelled"!==Q&&"refunded"!==Q&&m.jsx(h,{className:"steps-container",children:m.jsx(b,{items:H.map(e=>({title:e})),current:L,className:"order-steps"})})]}),"paid"===Q&&m.jsxs(h,{className:"qrcode-section",children:[m.jsx(x,{className:"section-title",children:"\u5230\u5e97\u6838\u9500\u7801"}),m.jsxs(h,{className:"qrcode-card",children:[m.jsx(p,{className:"qrcode-image",src:R(a.orderNo),mode:"aspectFit"}),m.jsx(x,{className:"qrcode-no",children:a.orderNo}),m.jsx(x,{className:"qrcode-tip",children:"\u8bf7\u5411\u95e8\u5e97\u5de5\u4f5c\u4eba\u5458\u51fa\u793a\u6b64\u4e8c\u7ef4\u7801"})]})]}),m.jsxs(h,{className:"info-section",children:[m.jsx(x,{className:"section-title",children:"\u8ba2\u5355\u4fe1\u606f"}),m.jsxs(h,{className:"info-card",children:[m.jsxs(h,{className:"info-item",children:[m.jsx(x,{className:"label",children:"\u8ba2\u5355\u7f16\u53f7"}),m.jsx(x,{className:"value",children:a.orderNo})]}),m.jsxs(h,{className:"info-item",children:[m.jsx(x,{className:"label",children:"\u4e0b\u5355\u65f6\u95f4"}),m.jsx(x,{className:"value",children:B(a.createdAt)})]}),a.paidAt&&m.jsxs(h,{className:"info-item",children:[m.jsx(x,{className:"label",children:"\u652f\u4ed8\u65f6\u95f4"}),m.jsx(x,{className:"value",children:B(a.paidAt)})]}),m.jsxs(h,{className:"info-item",children:[m.jsx(x,{className:"label",children:"\u9884\u7ea6\u65f6\u95f4"}),m.jsxs(x,{className:"value highlight",children:[a.appointmentDate," ",a.startTime,"  "]})]})]})]}),m.jsxs(h,{className:"store-section",children:[m.jsx(x,{className:"section-title",children:"\u95e8\u5e97\u4fe1\u606f"}),m.jsxs(h,{className:"store-card",onClick:F,children:[m.jsxs(h,{className:"store-info",children:[m.jsx(x,{className:"store-name",children:a.storeName}),m.jsx(x,{className:"store-address",children:a.storeAddress})]}),m.jsx(y,{value:"map-pin",size:"20",color:"#a40035"})]})]}),m.jsxs(h,{className:"therapist-section",children:[m.jsx(x,{className:"section-title",children:"\u63a8\u62ff\u5e08\u4fe1\u606f"}),m.jsxs(h,{className:"therapist-card",children:[a.therapistAvatar&&m.jsx(p,{className:"therapist-avatar",src:a.therapistAvatar}),m.jsxs(h,{className:"therapist-info",children:[m.jsx(x,{className:"therapist-name",children:a.therapistName}),m.jsx(x,{className:"service-name",children:a.serviceName}),m.jsxs(x,{className:"service-duration",children:["\u670d\u52a1\u65f6\u957f\uff1a",a.duration,"\u5206\u949f"]})]}),m.jsx(x,{className:"price",children:A(a.amount)}),"  "]})]}),m.jsxs(h,{className:"action-section",children:["paid"===Q&&m.jsxs(m.Fragment,{children:[m.jsxs(h,{className:"button secondary",onClick:D,children:[m.jsx(y,{value:"phone",size:"18"}),m.jsx(x,{children:"\u8054\u7cfb\u95e8\u5e97"})]}),m.jsx(h,{className:"button danger",onClick:$,children:"\u53d6\u6d88\u8ba2\u5355"})]}),"serving"===Q&&m.jsxs(h,{className:"button secondary",onClick:D,children:[m.jsx(y,{value:"phone",size:"18"}),m.jsx(x,{children:"\u8054\u7cfb\u95e8\u5e97"})]}),("completed"===Q||"paid"===Q)&&m.jsxs(m.Fragment,{children:[j?m.jsx(h,{className:"button secondary",onClick:T,children:"\u67e5\u770b\u8bc4\u4ef7"}):m.jsxs(h,{className:"button primary",onClick:z,children:[m.jsx(y,{value:"star",size:"16"}),m.jsx(x,{children:" \u8bc4\u4ef7\u670d\u52a1"})]}),m.jsx(h,{className:"button primary",onClick:q,children:"\u518d\u6b21\u9884\u7ea6"})]}),["cancelled","refunded"].includes(Q)&&m.jsx(h,{className:"button primary",onClick:q,children:"\u518d\u6b21\u9884\u7ea6"})]}),a&&m.jsx(I,{visible:r,orderInfo:a,onClose:()=>u(!1),onSubmit:P})]})};export{O as default};
