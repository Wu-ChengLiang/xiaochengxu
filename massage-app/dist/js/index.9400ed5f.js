var e=Object.defineProperty,s=Object.defineProperties,t=Object.getOwnPropertyDescriptors,a=Object.getOwnPropertySymbols,i=Object.prototype.hasOwnProperty,l=Object.prototype.propertyIsEnumerable,r=(s,t,a)=>t in s?e(s,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):s[t]=a,n=(e,s)=>{for(var t in s||(s={}))i.call(s,t)&&r(e,t,s[t]);if(a)for(var t of a(s))l.call(s,t)&&r(e,t,s[t]);return e},c=(e,a)=>s(e,t(a)),o=(e,s,t)=>new Promise((a,i)=>{var l=e=>{try{n(t.next(e))}catch(s){i(s)}},r=e=>{try{n(t.throw(e))}catch(s){i(s)}},n=e=>e.done?a(e.value):Promise.resolve(e.value).then(l,r);n((t=t.apply(e,s)).next())});import{n as d,j as m,V as u,I as h,T as p,S as g,O as x,Q as j,U as v,t as N,k as f}from"./vendors.fcaa4701.js";import{t as S,h as b,s as w,g as y,i as k,r as C,S as I}from"./common.326c60a3.js";const $=({therapist:e,stats:s,reviews:t=[],reviewsLoading:a=!1})=>{const[i,l]=d.useState(!1),r=n({level:"LV4",rating:(null==s?void 0:s.averageRating)||e.rating||4.8,serviceCount:e.serviceCount||0,reviewCount:(null==s?void 0:s.totalCount)||0,description:e.bio||"\u4e13\u4e1a\u63a8\u62ff\u5e08\uff0c\u7ecf\u9a8c\u4e30\u5bcc\uff0c\u64c5\u957f\u5404\u7c7b\u75bc\u75db\u8c03\u7406\u548c\u5eb7\u590d\u6cbb\u7597"},e);console.log("\ud83d\udd0d TherapistInfo Debug:",{therapistId:e.id,serviceCount:e.serviceCount,originalTherapist:e,therapistDetail:r});const c=()=>{l(!i)},o=e=>{const s=new Date(e),t=s.getMonth()+1,a=s.getDate();return`${t}\u6708${a}\u65e5`};return m.jsxs(u,{className:"therapist-info",children:[m.jsxs(u,{className:"therapist-header",children:[m.jsx(u,{className:"avatar-wrapper",children:m.jsx(h,{className:"avatar",src:e.avatar,mode:"aspectFill"})}),m.jsx(u,{className:"basic-info",children:m.jsxs(u,{className:"name-row",children:[m.jsx(p,{className:"name",children:e.name}),m.jsx(u,{className:"level",children:r.level})]})})]}),m.jsxs(u,{className:"description-section",children:[m.jsx(p,{className:"description "+(i?"expanded":"collapsed"),children:r.description}),i&&m.jsxs(u,{className:"reviews-section",children:[s&&s.totalCount>0&&m.jsx(u,{className:"review-stats-compact",children:m.jsxs(u,{className:"stats-header",children:[m.jsx(p,{className:"stats-title",children:"\u7528\u6237\u8bc4\u4ef7"}),m.jsxs(u,{className:"rating-info",children:[m.jsx(p,{className:"score",children:s.averageRating.toFixed(1)}),m.jsx(g,{value:s.averageRating,size:12}),m.jsxs(p,{className:"count",children:["(",s.totalCount,"\u6761)"]})]})]})}),m.jsxs(u,{className:"review-list-compact",children:[a?m.jsx(p,{className:"loading-text",children:"\u52a0\u8f7d\u8bc4\u4ef7\u4e2d..."}):0===t.length?m.jsx(p,{className:"empty-text",children:"\u6682\u65e0\u8bc4\u4ef7"}):t.slice(0,3).map(e=>m.jsxs(u,{className:"review-item-compact",children:[m.jsxs(u,{className:"review-header-compact",children:[m.jsxs(u,{className:"user-info-compact",children:[m.jsx(p,{className:"user-name",children:e.userName||"\u533f\u540d\u7528\u6237"}),m.jsx(g,{value:e.rating,size:10})]}),m.jsx(p,{className:"review-date",children:o(e.createdAt)})]}),m.jsx(p,{className:"review-content-compact",children:e.content}),e.tags&&e.tags.length>0&&m.jsx(u,{className:"review-tags-compact",children:e.tags.map((e,s)=>m.jsx(p,{className:"tag-compact",children:e},s))})]},e.reviewId)),t.length>3&&m.jsx(p,{className:"more-reviews",children:"\u4ec5\u663e\u793a\u6700\u8fd13\u6761\u8bc4\u4ef7"})]})]}),m.jsxs(u,{className:"expand-toggle",onClick:c,children:[m.jsx(p,{className:"expand-text",children:i?"\u6536\u8d77":"\u5c55\u5f00"}),m.jsx(p,{className:"expand-icon "+(i?"up":"down"),children:i?"\u25b2":"\u25bc"})]})]})]})},D=({store:e})=>{const s=()=>{e.phone&&x({phoneNumber:e.phone})},t=()=>{e.latitude&&e.longitude&&j({latitude:e.latitude,longitude:e.longitude,name:e.name,address:e.address})};return m.jsx(u,{className:"store-info",children:m.jsxs(u,{className:"store-header",children:[m.jsxs(u,{className:"store-details",children:[m.jsxs(u,{className:"name-row",children:[m.jsx(p,{className:"store-name",children:e.name}),void 0!==e.distance&&null!==e.distance&&m.jsxs(p,{className:"distance",children:[e.distance,"km"]})]}),m.jsx(u,{className:"hours-row",children:m.jsx(p,{className:"business-hours",children:e.businessHours})}),m.jsx(p,{className:"address",children:e.address})]}),m.jsxs(u,{className:"action-buttons",children:[m.jsx(u,{className:"action-btn",onClick:s,children:"\ud83d\udcde"}),m.jsx(u,{className:"action-btn",onClick:t,children:"\ud83d\udccd"})]})]})})},T=d.forwardRef(({services:e,therapistId:s,onServiceSelect:t,onTimeSelect:a},i)=>{const[l,r]=d.useState(""),[n,c]=d.useState(null),[h,g]=d.useState(""),[x,j]=d.useState(""),[N,f]=d.useState([]),[w,y]=d.useState(!1),[k,C]=d.useState("");d.useImperativeHandle(i,()=>({clearSelectedTime:()=>{j("")}}),[]),d.useEffect(()=>{h&&s&&n&&I()},[h,n,s]),d.useEffect(()=>{const e=()=>{!document.hidden&&h&&s&&n&&(console.log("\u9875\u9762\u91cd\u65b0\u53ef\u89c1\uff0c\u5237\u65b0\u65f6\u95f4\u6bb5\u6570\u636e"),I())};return document.addEventListener("visibilitychange",e),()=>document.removeEventListener("visibilitychange",e)},[h,s,n]);const I=()=>o(void 0,null,function*(){var e;if(s&&h&&n){y(!0),C("");try{const e=yield S.getAvailableSlots(s,h,n.duration);if(console.log("\u83b7\u53d6\u5230\u7684\u53ef\u7528\u65f6\u6bb5\u6570\u636e\uff1a",e),e&&e.slots&&e.slots.length>0){const s=[],t=new Map;e.slots.forEach(e=>{const s=e.time.split(":")[0];t.set(s,{available:e.available,status:e.status})});for(let a=9;a<=21;a++){const i=a.toString().padStart(2,"0"),l=[],r=t.get(i)||{available:!0,status:"available"};for(let s=0;s<60;s+=10){const t=`${i}:${s.toString().padStart(2,"0")}`,a=e.slots.find(e=>e.time===t);a?l.push({time:t,available:a.available,status:a.status}):l.push({time:t,available:r.available,status:r.status})}s.push(l)}f(s)}else console.log("\u8be5\u63a8\u62ff\u5e08\u5728\u9009\u5b9a\u65f6\u95f4\u65e0\u53ef\u7528\u65f6\u6bb5"),C("\u8be5\u63a8\u62ff\u5e08\u5728\u6b64\u65f6\u95f4\u6bb5\u5df2\u6ee1\uff0c\u8bf7\u9009\u62e9\u5176\u4ed6\u65f6\u95f4\u6216\u63a8\u62ff\u5e08"),f([])}catch(t){console.error("\u274c \u83b7\u53d6\u53ef\u7528\u65f6\u6bb5\u5931\u8d25:",t),1003===t.code?C("\u8be5\u63a8\u62ff\u5e08\u4e0d\u5b58\u5728\u6216\u4e0d\u53ef\u7528\uff0c\u8bf7\u8fd4\u56de\u91cd\u65b0\u9009\u62e9"):1010===t.code?C("\u7528\u6237\u4fe1\u606f\u5f02\u5e38\uff0c\u8bf7\u91cd\u65b0\u8fdb\u5165"):(null==(e=t.response)?void 0:e.status)>=500?C("\u670d\u52a1\u5668\u5f02\u5e38\uff0c\u8bf7\u7a0d\u540e\u91cd\u8bd5"):C("\u52a0\u8f7d\u53ef\u7528\u65f6\u6bb5\u5931\u8d25\uff0c\u8bf7\u68c0\u67e5\u7f51\u7edc\u540e\u91cd\u8bd5"),f([])}finally{y(!1)}}}),$=()=>{const e=[],s=new Date;for(let t=0;t<5;t++){const a=new Date(s);a.setDate(s.getDate()+t);const i=a.getMonth()+1,l=a.getDate(),r=["\u5468\u65e5","\u5468\u4e00","\u5468\u4e8c","\u5468\u4e09","\u5468\u56db","\u5468\u4e94","\u5468\u516d"],n=r[a.getDay()];e.push({key:b(a),display:0===t?"\u4eca\u5929":`${i}\u6708${l}\u65e5`,weekDay:0===t?"":n})}return e},D=()=>{if(N.length>0){const e=N.map((e,s)=>{const t=9+s;return{hour:`${t}:00`,slots:e}});return e}const e=[];for(let s=9;s<=21;s++){const t=[];for(let e=0;e<60;e+=10){const a=`${s.toString().padStart(2,"0")}:${e.toString().padStart(2,"0")}`;t.push({time:a,available:!0})}e.push({hour:`${s}:00`,slots:t})}return e},T=e=>{if(!x||!n)return!1;const s=x,t=n.duration,a=e=>{const[s,t]=e.split(":").map(Number);return 60*s+t},i=a(s),l=a(e),r=i+t;return l>=i&&l<r},P=e=>{r(e.id),c(e),t(e),j("")},O=e=>{g(e),j(""),f([])},R=(e,s)=>{if(!s||!h||!n)return;const t=N.flat(),i=e=>{const[s,t]=e.split(":").map(Number);return 60*s+t},l=i(e),r=l+n.duration;for(let a=l;a<r;a+=10){const e=Math.floor(a/60),s=a%60,i=`${e.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`,l=t.find(e=>e.time===i);if(!(null==l?void 0:l.available))return}j(e),a(h,e),setTimeout(()=>{const e=document.querySelector(".checkout-btn:not(.disabled)");e&&e.click()},300)},E=$(),L=D();return m.jsxs(u,{className:"booking-selector",children:[m.jsxs(u,{className:"service-section",children:[m.jsx(u,{className:"section-title",children:"\u9009\u62e9\u670d\u52a1"}),m.jsx(v,{className:"service-tabs",scrollX:!0,children:e.map(e=>m.jsxs(u,{className:"service-tab "+(l===e.id?"active":""),onClick:()=>P(e),children:[m.jsx(p,{className:"service-name",children:e.name}),m.jsxs(u,{className:"service-info",children:[m.jsxs(p,{className:"service-duration",children:[e.duration,"\u5206\u949f"]}),m.jsxs(p,{className:"price",children:["\xa5",e.discountPrice||e.price]})]})]},e.id))})]}),l&&m.jsxs(u,{className:"datetime-section",children:[m.jsx(v,{className:"date-tabs",scrollX:!0,children:E.map(e=>m.jsxs(u,{className:"date-tab "+(h===e.key?"active":""),onClick:()=>O(e.key),children:[m.jsx(p,{className:"date-display",children:e.display}),e.weekDay&&m.jsx(p,{className:"week-day",children:e.weekDay})]},e.key))}),h&&m.jsxs(m.Fragment,{children:[k&&m.jsx(u,{className:"error-message",children:m.jsx(p,{children:k})}),m.jsx(v,{className:"time-grid-container",scrollY:!0,children:m.jsx(u,{className:"time-grid-wrapper",children:w?m.jsx(u,{className:"loading-slots",children:m.jsx(p,{children:"\u52a0\u8f7d\u53ef\u7528\u65f6\u6bb5..."})}):k?m.jsxs(u,{className:"error-state",children:[m.jsx(p,{children:"\u6682\u65e0\u53ef\u7528\u65f6\u6bb5"}),m.jsx(p,{className:"error-hint",children:"\u8bf7\u9009\u62e9\u5176\u4ed6\u65e5\u671f\u6216\u63a8\u62ff\u5e08"})]}):L.map((e,s)=>m.jsxs(u,{className:"time-row",children:[m.jsx(p,{className:"hour-label",children:e.hour}),m.jsx(u,{className:"time-slots",children:e.slots.map((e,s)=>m.jsx(u,{className:"time-slot "+(e.available?T(e.time)?"selected":"available":"disabled"),onClick:()=>R(e.time,e.available),children:m.jsxs(p,{className:"time-text",children:[":",e.time.split(":")[1]]})},s))})]},s))})})]})]})]})});T.displayName="BookingSelector";const P=()=>{const e=N.useRouter(),{therapistId:s,storeId:t}=e.params,[a,i]=d.useState(null),[l,r]=d.useState(null),[h,p]=d.useState(!0),[g,x]=d.useState(""),[j,b]=d.useState([]),[P,O]=d.useState(null),[R,E]=d.useState(!1),[L,M]=d.useState([]),[F,A]=d.useState(null),q=d.useRef(null),[z,B]=d.useState([]);d.useState(!1),d.useEffect(()=>{H()},[s,t]),d.useEffect(()=>{s&&U()},[s]);const H=()=>o(void 0,null,function*(){try{if(p(!0),x(""),console.log("TherapistBookingPage params:",{therapistId:s,storeId:t}),!s||!t)return console.error("Missing required params:",{therapistId:s,storeId:t}),void x("\u53c2\u6570\u9519\u8bef\uff0c\u8bf7\u91cd\u65b0\u8fdb\u5165");const[e,a,l,o]=yield Promise.all([S.getTherapistDetail(s),w.getStoreDetail(t),y.getCurrentLocation(),k.getTherapistSymptomServices(s)]);console.log("Store data response:",a),console.log("Therapist data response:",e),console.log("\u2705 Services data response:",o);const d=e.data||e,m=(null==a?void 0:a.data)||a;let u=n({},m);if((null==m?void 0:m.latitude)&&(null==m?void 0:m.longitude)){const e=y.calculateDistance(l.latitude,l.longitude,m.latitude,m.longitude);u=c(n({},m),{distance:e})}const h=o.data||[];B(h),console.log(`\u2705 \u52a0\u8f7d\u4e86 ${h.length} \u4e2a\u670d\u52a1`),i(d),r(u),console.log("Store state after setting:",u),console.log("Therapist state after setting:",d)}catch(e){console.error("Failed to load data:",e),x("\u52a0\u8f7d\u6570\u636e\u5931\u8d25\uff0c\u8bf7\u91cd\u8bd5")}finally{p(!1)}}),U=()=>o(void 0,null,function*(){if(s)try{E(!0);const[e,t]=yield Promise.all([C.getTherapistReviews(s,1,10),C.getReviewStats(s)]);b(e.list||[]),O(t),t&&a&&i(c(n({},a),{rating:t.averageRating,ratingCount:t.totalCount}))}catch(e){console.error("\u52a0\u8f7d\u8bc4\u4ef7\u6570\u636e\u5931\u8d25:",e)}finally{E(!1)}}),V=e=>{A(e)},X=(e,s)=>{if(!F||!a)return;const t=`${e}_${s}_${Date.now()}`,i={id:t,serviceId:F.id,serviceName:F.name,duration:F.duration,price:F.price,discountPrice:F.discountPrice,date:e,time:s,therapistId:a.id,therapistName:a.name,therapistAvatar:a.avatar};M([i]),f({title:"\u5df2\u9009\u62e9\u9884\u7ea6\u65f6\u95f4",icon:"success"})},Y=()=>{var e;M([]),null==(e=q.current)||e.clearSelectedTime()},_=()=>{if(0===L.length)return;const e={therapistId:s,storeId:t,items:JSON.stringify(L)};N.navigateTo({url:`/pages/booking/confirm/index?${Object.entries(e).map(([e,s])=>`${e}=${encodeURIComponent(s)}`).join("&")}`})};return h?m.jsx(u,{className:"therapist-booking-page",children:m.jsx(u,{className:"loading",children:"\u52a0\u8f7d\u4e2d..."})}):!g&&a&&l?m.jsxs(u,{className:"therapist-booking-page",children:[m.jsxs(v,{className:"main-content",scrollY:!0,children:[m.jsx($,{therapist:a,stats:P,reviews:j,reviewsLoading:R}),l&&m.jsx(D,{store:l}),m.jsx(T,{ref:q,services:z,therapistId:s,onServiceSelect:V,onTimeSelect:X})]}),m.jsx(I,{items:L,therapist:a,onCheckout:_,onMaskClick:Y})]}):m.jsx(u,{className:"therapist-booking-page",children:m.jsx(u,{className:"error",children:g||"\u6570\u636e\u52a0\u8f7d\u5931\u8d25"})})};export{P as default};
