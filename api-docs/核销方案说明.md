# 预约核销方案说明

## 原方案（二维码核销）的问题

1. **开发复杂度高**
   - 需要生成二维码接口
   - 需要存储二维码图片或动态生成
   - 需要开发扫码核销功能

2. **依赖额外服务**
   - 需要二维码生成库
   - 可能需要CDN存储
   - 增加系统复杂性

## 新方案：预约单号核销

### 核销流程

1. **用户到店**
   - 出示预约订单详情页
   - 显示预约单号：202401201400001
   - 显示手机号：138****8000

2. **门店核销**
   - 前台输入预约单号
   - 验证手机号后4位
   - 确认预约信息
   - 更新状态为"serving"

### 实现方式

#### 1. 添加核销接口

```javascript
// POST /api/v2/appointments/verify
{
  "orderNo": "202401201400001",
  "phoneLastFour": "8000"  // 手机号后4位
}

// 响应
{
  "code": 0,
  "message": "success",
  "data": {
    "verified": true,
    "appointment": {
      // 预约详情
    }
  }
}
```

#### 2. 预约单号生成规则

```javascript
function generateOrderNo(appointmentId, date, time) {
  // 格式：YYYYMMDDHHNN + 3位流水号
  // 202401201400001
  const dateStr = date.replace(/-/g, '');
  const timeStr = time.replace(':', '');
  const seq = String(appointmentId % 1000).padStart(3, '0');
  return `${dateStr}${timeStr}${seq}`;
}
```

#### 3. 小程序端显示

```javascript
// 预约详情页
<View className="order-info">
  <View className="order-no">
    <Text>预约单号</Text>
    <Text className="highlight">{appointment.id}</Text>
  </View>
  <View className="verify-info">
    <Text>到店报单号即可</Text>
  </View>
</View>
```

### 优势

1. **实现简单**
   - 无需额外依赖
   - 纯文本显示
   - 容易理解和使用

2. **用户体验好**
   - 无需截图保存二维码
   - 单号容易记忆和输入
   - 手机号验证增加安全性

3. **门店操作简便**
   - 简单的表单输入
   - 快速验证
   - 减少培训成本

### 后续优化

1. **短码优化**
   - 可以生成更短的核销码（如6位数字）
   - 当日有效，避免重复

2. **自动核销**
   - 门店端开发简单的核销页面
   - 输入单号自动查询和核销

3. **批量核销**
   - 支持扫描输入
   - 支持语音输入

## 实施建议

1. **第一阶段**：使用完整预约单号
2. **第二阶段**：优化为短码
3. **第三阶段**：开发门店端工具

这种方案更适合快速上线，降低开发成本，同时保证核销的可靠性。