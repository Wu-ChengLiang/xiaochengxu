# API实施指南

## 总体原则

1. **最小改动**：优先使用现有数据结构，通过API层做转换
2. **渐进实施**：先实现核心功能，后续逐步完善
3. **兼容并存**：v1接口保持不变，v2接口服务小程序

## 实施步骤

### 第一阶段：基础改造（2天）

#### 1. 后端API版本化

```javascript
// src/app.js 添加v2路由
const clientV2Router = require('./routes/v2/client');
app.use('/api/v2', clientV2Router);
```

#### 2. 创建转换中间件

```javascript
// src/middleware/transform.js
function transformResponse(req, res, next) {
  const originalJson = res.json;
  res.json = function(data) {
    if (data.success && req.baseUrl.includes('/v2/')) {
      data = transformToV2Format(data);
    }
    originalJson.call(this, data);
  };
  next();
}

function transformToV2Format(data) {
  return {
    code: 0,
    message: 'success',
    data: data.data
  };
}
```

#### 3. 实现核心API

优先实现：
- GET /api/v2/stores/nearby
- GET /api/v2/therapists/recommended
- POST /api/v2/appointments

### 第二阶段：数据补充（1天）

#### 1. 添加默认值逻辑

```javascript
// src/services/v2/therapistService.js
function enhanceTherapistData(therapist) {
  return {
    ...therapist,
    id: String(therapist.id),
    avatar: therapist.avatar_url || `/images/therapists/${therapist.id}.jpg`,
    rating: therapist.rating || 4.8,
    ratingCount: therapist.review_count || 100,
    expertise: parseExpertise(therapist.specialties),
    yearsOfExperience: therapist.experience_years
  };
}

function parseExpertise(specialties) {
  if (!specialties) return ['推拿按摩'];
  if (typeof specialties === 'string') {
    try {
      return JSON.parse(specialties);
    } catch {
      return specialties.split(',').map(s => s.trim());
    }
  }
  return specialties;
}
```

#### 2. 静态资源准备

```bash
# 创建图片目录
mkdir -p public/images/stores
mkdir -p public/images/therapists
mkdir -p public/images/avatars

# 准备占位图片
# stores: 1.jpg, 2.jpg, ...
# therapists: 1.jpg, 2.jpg, ...
```

### 第三阶段：功能完善（2天）

#### 1. 实现时段计算

```javascript
// src/utils/schedule.js
function generateTimeSlots(startTime, endTime, duration = 60) {
  const slots = [];
  let current = parseTime(startTime);
  const end = parseTime(endTime);
  
  while (current < end) {
    slots.push({
      time: formatTime(current),
      available: true
    });
    current.setMinutes(current.getMinutes() + duration);
  }
  
  return slots;
}

async function getAvailableSlots(therapistId, date) {
  // 1. 获取推拿师工作时间
  const workTime = { start: '10:00', end: '18:00' };
  
  // 2. 生成所有时段
  const allSlots = generateTimeSlots(workTime.start, workTime.end);
  
  // 3. 查询已有预约
  const appointments = await getTherapistAppointments(therapistId, date);
  
  // 4. 标记已占用时段
  appointments.forEach(apt => {
    const slot = allSlots.find(s => s.time === apt.start_time);
    if (slot) slot.available = false;
  });
  
  return allSlots;
}
```

#### 2. 简化预约流程

```javascript
// src/services/v2/appointmentService.js
async function createAppointment(data) {
  // 1. 验证时间是否可用
  const isAvailable = await checkTimeSlot(
    data.therapistId, 
    data.appointmentDate, 
    data.startTime
  );
  
  if (!isAvailable) {
    throw new Error('该时段已被预约');
  }
  
  // 2. 创建预约
  const appointment = await db.run(`
    INSERT INTO appointments (
      user_phone, user_name, therapist_id, store_id,
      appointment_date, start_time, end_time,
      service_type, price, status
    ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, 'pending')
  `, [...params]);
  
  // 3. 生成预约单号
  const orderNo = generateOrderNo(appointment.lastID);
  
  // 4. 返回完整信息
  return formatAppointmentResponse(appointment.lastID);
}
```

## 数据迁移建议

### 最小必要改动

```sql
-- 1. 专长字段格式化（可选）
UPDATE therapists 
SET specialties = '["推拿按摩", "颈椎调理"]' 
WHERE specialties = '推拿按摩,颈椎调理';

-- 2. 添加索引优化查询
CREATE INDEX idx_appointments_date_therapist 
ON appointments(appointment_date, therapist_id);

-- 3. 添加用户手机号字段（如果没有）
ALTER TABLE appointments 
ADD COLUMN user_phone VARCHAR(20);
```

## 测试计划

### 1. 单元测试

```javascript
// test/v2/therapist.test.js
describe('Therapist API v2', () => {
  it('should return therapists with correct format', async () => {
    const res = await request(app)
      .get('/api/v2/therapists/recommended')
      .expect(200);
    
    expect(res.body).toHaveProperty('code', 0);
    expect(res.body.data.list[0]).toHaveProperty('id');
    expect(res.body.data.list[0]).toHaveProperty('expertise');
  });
});
```

### 2. 集成测试清单

- [ ] 门店列表能正常显示
- [ ] 推拿师信息完整
- [ ] 预约流程能走通
- [ ] 时间冲突检测正常
- [ ] 数据格式符合预期

## 部署建议

### 1. 灰度发布

```nginx
# nginx配置示例
location /api/v2/ {
  # 10%流量到新版本
  split_clients "${remote_addr}${request_uri}" $api_backend {
    10% new_backend;
    *   old_backend;
  }
  
  proxy_pass http://$api_backend;
}
```

### 2. 监控指标

- API响应时间
- 错误率
- 预约成功率
- 用户反馈

## 常见问题

### Q: 如何处理现有网页前端？
A: 保持v1接口不变，网页前端继续使用 `/api/v1/`

### Q: 位置信息如何处理？
A: 第一阶段返回默认排序，后续可添加位置字段

### Q: 图片资源如何管理？
A: 初期使用静态文件，后续可接入云存储

### Q: 评分系统如何实现？
A: 第一阶段使用默认值，后续实现完整评价系统

## 时间线

| 阶段 | 任务 | 时间 | 完成标准 |
|------|------|------|----------|
| 第一阶段 | 基础API改造 | 2天 | 核心功能可用 |
| 第二阶段 | 数据补充 | 1天 | 字段完整 |
| 第三阶段 | 功能完善 | 2天 | 预约流程顺畅 |
| 测试 | 联调测试 | 1天 | 无阻塞问题 |
| **总计** | | **6天** | 小程序可正常使用 |

## 后续优化

1. **性能优化**
   - 添加Redis缓存
   - 数据库查询优化

2. **功能增强**
   - 评价系统
   - 会员系统
   - 优惠券系统

3. **运营支持**
   - 数据统计
   - 营销工具
   - 推送通知